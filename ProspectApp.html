<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230066cc' width='100' height='100'/><text y='70' x='50' text-anchor='middle' font-size='60' fill='white'>AL</text></svg>">
    <title>Altech Field Lead</title>
    <style>
        /* === ALTECH THEME === */
        :root {
            --primary: #0066cc;
            --primary-dark: #0052a3;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #0a0e27;
            --bg-card: #141b3d;
            --bg-input: #1e2849;
            --text: #ffffff;
            --text-dim: #94a3b8;
            --border: #2d3b5e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overscroll-behavior-y: none;
        }

        /* === HEADER === */
        header {
            background: rgba(20, 27, 61, 0.95);
            backdrop-filter: blur(20px);
            padding: calc(env(safe-area-inset-top) + 12px) 20px 12px;
            border-bottom: 1px solid var(--border);
            z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 18px; }
        .logo-icon { width: 32px; height: 32px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .save-indicator { font-size: 12px; color: var(--success); opacity: 0; transition: opacity 0.3s; }
        
        .progress-track { height: 4px; background: var(--bg-input); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        /* === MAIN === */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; }
        .hidden { display: none !important; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        h2 { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: white; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        
        /* === INPUTS === */
        input, select, textarea {
            width: 100%; padding: 14px; font-size: 16px !important; 
            background: var(--bg-input); border: 1px solid transparent; border-radius: 10px; 
            color: white; margin-bottom: 16px; transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: #232d50; }
        .label { font-size: 12px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 6px; display: block; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* === RADIO CARDS === */
        .radio-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .radio-card input { display: none; }
        .radio-card-content {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--bg-input); padding: 16px 8px; border-radius: 12px; border: 2px solid transparent;
        }
        .radio-card input:checked + .radio-card-content { border-color: var(--primary); background: rgba(0, 102, 204, 0.15); }

        /* === FOOTER === */
        footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(20, 27, 61, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 12px 20px calc(12px + env(safe-area-inset-bottom));
            display: flex; gap: 12px; z-index: 100;
        }
        .btn { flex: 1; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4); }
        .btn-secondary { background: var(--bg-input); color: white; border: 1px solid var(--border); }
        .btn-secondary:disabled { opacity: 0.5; }

        /* === UTILS === */
        .toast {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            background: var(--success); color: white; padding: 10px 20px; border-radius: 20px;
            font-weight: 600; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 200;
        }
        .toast.show { opacity: 1; }
        .hint { font-size: 13px; color: #60a5fa; background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 16px; }
    </style>
</head>
<body>

    <header>
        <div class="header-top">
            <div class="logo"><div class="logo-icon">AL</div> Altech Field Lead</div>
            <div id="saveIndicator" class="save-indicator">‚úì Saved</div>
        </div>
        <div class="progress-track"><div id="progressBar" class="progress-fill"></div></div>
    </header>

    <main id="mainContainer">
        <div id="step-1" class="step">
            <div class="card">
                <div class="radio-grid">
                    <label class="radio-card"><input type="radio" name="qType" value="auto" onchange="App.handleType()">
                        <div class="radio-card-content"><span>üöó</span><span style="font-size:12px;font-weight:700;margin-top:4px">AUTO</span></div></label>
                    <label class="radio-card"><input type="radio" name="qType" value="home" onchange="App.handleType()">
                        <div class="radio-card-content"><span>üè†</span><span style="font-size:12px;font-weight:700;margin-top:4px">HOME</span></div></label>
                    <label class="radio-card"><input type="radio" name="qType" value="both" checked onchange="App.handleType()">
                        <div class="radio-card-content"><span>üöÄ</span><span style="font-size:12px;font-weight:700;margin-top:4px">BOTH</span></div></label>
                </div>
                
                <h2>Client Details</h2>
                <div class="grid-2">
                    <div><label class="label">First Name</label><input type="text" id="firstName" placeholder="John" autocomplete="given-name"></div>
                    <div><label class="label">Last Name</label><input type="text" id="lastName" placeholder="Smith" autocomplete="family-name"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Phone</label><input type="tel" id="phone" placeholder="(555) 123-4567" autocomplete="tel"></div>
                    <div><label class="label">DOB</label><input type="date" id="dob"></div>
                </div>
                <label class="label">Email</label><input type="email" id="email" placeholder="john@example.com" autocomplete="email">
            </div>
            
            <div class="card">
                <h2>Driver History</h2>
                <div class="grid-2">
                    <div><label class="label">License #</label><input type="text" id="dlNum" style="text-transform:uppercase;font-family:monospace"></div>
                    <div><label class="label">State</label><input type="text" id="dlState" value="WA"></div>
                </div>
                <label class="label">Prior Insurance</label>
                <div class="grid-2">
                    <input type="text" id="priorCarrier" placeholder="Current Carrier">
                    <input type="date" id="priorExp">
                </div>
                <label class="label">Violations / Notes</label>
                <textarea id="violations" rows="3" placeholder="Speeding 2023, Accident 2021..."></textarea>
            </div>
        </div>

        <div id="step-2" class="step hidden">
            <div class="card">
                <h2>Vehicle Info</h2>
                <label class="label">VIN (17 Chars)</label>
                <input type="text" id="vin" maxlength="17" style="text-transform:uppercase;font-family:monospace" placeholder="1HG..." oninput="App.decodeVin(this)">
                <div id="vinResult" style="color:var(--success); font-size:13px; margin:-10px 0 16px 0; min-height:18px"></div>
                
                <label class="label">Vehicle Description</label>
                <input type="text" id="vehDesc" placeholder="Year Make Model">
                
                <div class="grid-2">
                    <div><label class="label">Usage</label><select id="use"><option value="Commute">Commute</option><option value="Pleasure">Pleasure</option><option value="Business">Business</option></select></div>
                    <div><label class="label">Annual Miles</label><input type="tel" id="miles" value="12000"></div>
                </div>
            </div>
        </div>

        <div id="step-3" class="step hidden">
            <div class="card">
                <h2>Property Address</h2>
                <div class="hint">üí° Address is split for EZLynx Import</div>
                
                <label class="label">Street Address</label>
                <input type="text" id="addrStreet" placeholder="123 Main St" autocomplete="address-line1">
                
                <div class="grid-2">
                    <div><label class="label">City</label><input type="text" id="addrCity" placeholder="Vancouver"></div>
                    <div><label class="label">State</label><input type="text" id="addrState" value="WA"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Zip Code</label><input type="tel" id="addrZip" placeholder="98686"></div>
                    <button class="btn-secondary" onclick="App.openZillow()" style="padding:10px; margin-bottom:16px">üîç Zillow</button>
                </div>
            </div>

            <div class="card">
                <h2>Home Specs</h2>
                <div class="grid-2">
                    <div><label class="label">Year Built</label><input type="tel" id="yrBuilt"></div>
                    <div><label class="label">Sq. Ft.</label><input type="tel" id="sqFt"></div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Roof Year</label><input type="tel" id="roofYr"></div>
                    <div><label class="label">Roof Mat</label><select id="roofMat"><option value="Comp/Asphalt">Asphalt</option><option value="Metal">Metal</option><option value="Tile">Tile</option></select></div>
                </div>
                <label class="label">Updates (Heat/Plumb/Elec)</label>
                <div class="grid-2">
                    <input type="tel" id="heatYr" placeholder="Heat Yr">
                    <input type="tel" id="plumbYr" placeholder="Plumb Yr">
                </div>
                <label class="label">Hazards (Dog/Pool/Trampoline)</label>
                <input type="text" id="hazards" placeholder="None">
            </div>
        </div>

        <div id="step-4" class="step hidden">
            <div class="card">
                <h2>Export for EZLynx</h2>
                
                <div style="margin-bottom:20px">
                    <label class="label">Option 1: Import File</label>
                    <button class="btn-primary" onclick="App.exportCSV()" style="width:100%">üì• Download CSV</button>
                    <div style="font-size:12px; color:#94a3b8; margin-top:8px; text-align:center">
                        Upload to Sales Center to create Name/Address
                    </div>
                </div>

                <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:20px; margin-bottom:20px">
                    <label class="label">Option 2: HawkSoft Import</label>
                    <button class="btn-primary" onclick="App.exportCMSMTF()" style="width:100%; background:#10b981">üì• Download CMSMTF</button>
                    <div style="font-size:12px; color:#94a3b8; margin-top:8px; text-align:center">
                        Drag and drop this file into HawkSoft to create a new client
                    </div>
                </div>

                <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:20px">
                    <label class="label">Option 3: The "Cheat Sheet"</label>
                    <button class="btn-secondary" onclick="App.copyNotes()" style="width:100%; color:#60a5fa; border-color:#60a5fa">
                        üìã Copy Notes
                    </button>
                    <div style="font-size:12px; color:#94a3b8; margin-top:8px; text-align:center">
                        Paste this into EZLynx "Remarks" or "Notes"
                    </div>
                </div>
            </div>

            <div class="card" style="border-color:var(--danger)">
                <button onclick="App.reset()" style="background:none; border:none; color:var(--danger); width:100%; font-weight:700">
                    üóëÔ∏è Clear & Start New
                </button>
            </div>
        </div>
    </main>

    <footer>
        <button id="btnBack" class="btn btn-secondary" onclick="App.prev()">Back</button>
        <button id="btnNext" class="btn btn-primary" onclick="App.next()">Next</button>
    </footer>

    <div id="toast" class="toast">Message</div>

    <script>
        const App = {
            data: {},
            step: 0,
            flow: [],
            
            workflows: {
                auto: ['step-1', 'step-2', 'step-4'],
                home: ['step-1', 'step-3', 'step-4'],
                both: ['step-1', 'step-2', 'step-3', 'step-4']
            },

            init() {
                this.load();
                this.handleType(); // Set initial flow
                
                // Auto-save listeners
                document.querySelectorAll('input, select, textarea').forEach(el => {
                    el.addEventListener('input', (e) => this.save(e));
                });
                // Phone format
                document.getElementById('phone').addEventListener('input', this.fmtPhone);
            },

            handleType() {
                const t = document.querySelector('input[name="qType"]:checked').value;
                this.flow = this.workflows[t];
                // Reset step if out of bounds
                if (this.step >= this.flow.length) this.step = 0;
                this.updateUI();
                this.save({ target: document.querySelector('input[name="qType"]:checked') });
            },

            updateUI() {
                document.querySelectorAll('.step').forEach(e => e.classList.add('hidden'));
                const curId = this.flow[this.step];
                document.getElementById(curId).classList.remove('hidden');
                
                // Progress
                const pct = ((this.step + 1) / this.flow.length) * 100;
                document.getElementById('progressBar').style.width = pct + '%';
                
                // Buttons
                const back = document.getElementById('btnBack');
                const next = document.getElementById('btnNext');
                back.disabled = this.step === 0;
                next.textContent = this.step === this.flow.length - 1 ? 'Finish' : 'Next';
                
                document.getElementById('mainContainer').scrollTo(0,0);
            },

            next() {
                if (this.step < this.flow.length - 1) {
                    this.step++;
                    this.updateUI();
                }
            },
            prev() {
                if (this.step > 0) {
                    this.step--;
                    this.updateUI();
                }
            },

            save(e) {
                const k = e.target.id || e.target.name;
                this.data[k] = e.target.value;
                localStorage.setItem('altech_v5', JSON.stringify(this.data));
                
                const ind = document.getElementById('saveIndicator');
                ind.style.opacity = 1;
                setTimeout(() => ind.style.opacity = 0, 1500);
            },

            load() {
                const s = localStorage.getItem('altech_v5');
                if(s) {
                    this.data = JSON.parse(s);
                    Object.keys(this.data).forEach(k => {
                        const el = document.getElementById(k);
                        if(el) el.value = this.data[k];
                        if(k === 'qType') {
                            const r = document.querySelector(`input[name="qType"][value="${this.data[k]}"]`);
                            if(r) r.checked = true;
                        }
                    });
                }
            },

            // === FEATURES ===
            async decodeVin(el) {
                const v = el.value.toUpperCase();
                if(v.length === 17) {
                    try {
                        document.getElementById('vinResult').innerText = "Decoding...";
                        const r = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${v}?format=json`);
                        const d = await r.json();
                        const r1 = d.Results[0];
                        const desc = `${r1.ModelYear} ${r1.Make} ${r1.Model}`;
                        document.getElementById('vehDesc').value = desc;
                        document.getElementById('vinResult').innerText = "‚úì " + desc;
                        this.data.vehDesc = desc; // Force save
                    } catch(e) { document.getElementById('vinResult').innerText = "Decode Error"; }
                }
            },

            fmtPhone(e) {
                let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            },

            openZillow() {
                const a = `${this.data.addrStreet} ${this.data.addrCity} ${this.data.addrState} ${this.data.addrZip}`;
                window.open(`https://www.zillow.com/homes/${encodeURIComponent(a)}_rb/`);
            },

            // === NOTES & EXPORT ===
            getNotes() {
                return `
CLIENT: ${this.data.firstName} ${this.data.lastName}
DOB: ${this.data.dob}
DL: ${this.data.dlNum} (${this.data.dlState})
Prior: ${this.data.priorCarrier} (Exp: ${this.data.priorExp})
Notes: ${this.data.violations || 'None'}

AUTO:
${this.data.vehDesc || ''}
VIN: ${this.data.vin}
Use: ${this.data.use} / ${this.data.miles}mi

HOME:
${this.data.addrStreet}, ${this.data.addrCity}
Built: ${this.data.yrBuilt} (${this.data.sqFt}sqft)
Roof: ${this.data.roofMat} (${this.data.roofYr})
Updates: Heat ${this.data.heatYr} / Plumb ${this.data.plumbYr}
Hazards: ${this.data.hazards || 'None'}
                `.trim();
            },

            copyNotes() {
                navigator.clipboard.writeText(this.getNotes());
                this.toast('üìã Copied to Clipboard!');
            },

            exportCSV() {
                // EZLynx Specific Headers
                const h = ["First Name","Last Name","Address Line 1","City","State Code","Zip Code","Mobile Phone","Email","Date of Birth","Notes"];
                
                // Collapse notes into one line for the CSV "Notes" column
                const flatNotes = this.getNotes().replace(/\n/g, ' | ');
                
                const row = [
                    this.data.firstName, this.data.lastName, this.data.addrStreet, this.data.addrCity, this.data.addrState, this.data.addrZip,
                    this.data.phone, this.data.email, this.data.dob, flatNotes
                ].map(v => `"${v||''}"`).join(',');

                const csv = h.join(',') + "\n" + row;
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Lead_${this.data.lastName}.csv`;
                a.click();
                this.toast('üì• CSV Generated!');
            },

            exportCMSMTF() {
                // HawkSoft CMSMTF Tagged Format
                const fields = [
                    { tag: 'NAM', value: `${this.data.firstName || ''} ${this.data.lastName || ''}`.trim() },
                    { tag: 'ADD', value: this.data.addrStreet },
                    { tag: 'CTY', value: this.data.addrCity },
                    { tag: 'STA', value: this.data.addrState },
                    { tag: 'ZIP', value: this.data.addrZip },
                    { tag: 'PHN', value: this.data.phone ? this.data.phone.replace(/\D/g, '') : '' },
                    { tag: 'EML', value: this.data.email },
                    { tag: 'VIN', value: this.data.vin },
                    { tag: 'VEH', value: this.data.vehDesc }
                ];

                // Only include fields with data
                const content = fields
                    .filter(f => f.value && f.value.trim() !== '')
                    .map(f => `[${f.tag}]${f.value}`)
                    .join('\n');

                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Lead_${this.data.lastName || 'Export'}.cmsmtf`;
                a.click();
                URL.revokeObjectURL(url);
                this.toast('üì• CMSMTF Generated!');
            },

            toast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2500);
            },
            
            reset() {
                if(confirm("Delete all data?")) {
                    localStorage.removeItem('altech_v5');
                    location.reload();
                }
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>