<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230066cc' width='100' height='100'/><text y='70' x='50' text-anchor='middle' font-size='60' fill='white'>AL</text></svg>">
    <title>Altech Field Lead</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/compliance.css">
    <link rel="stylesheet" href="css/email.css">
    <link rel="stylesheet" href="css/quickref.css">
    <link rel="stylesheet" href="css/accounting.css">
    <link rel="stylesheet" href="css/ezlynx.css">
    <link rel="stylesheet" href="css/quote-compare.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/reminders.css">
    <link rel="stylesheet" href="css/hawksoft.css">
    <link rel="stylesheet" href="css/vin-decoder.css">

    <!-- Firebase SDK (compat mode ‚Äî no build step needed) -->
    <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
    <!-- ‚ïë  LANDING PAGE ‚Äî Dashboard Shell                          ‚ïë -->
    <!-- ‚ïë  Sections: Header ¬∑ App Grid ¬∑ Quick Reference ¬∑ Footer  ‚ïë -->
    <!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
    <div id="landingPage" class="landing-page">

        <!-- ‚îÄ‚îÄ Section: Hero Header ‚îÄ‚îÄ -->
        <section id="landingHero" class="landing-header" aria-label="Dashboard header">
            <div class="landing-header-pill">
                <div class="landing-header-left">
                    <div class="landing-brand-name">Altech Applications</div>
                    <p class="landing-brand-tagline">Your insurance toolkit &mdash; simple, fast, organized</p>
                </div>
                <div class="landing-header-right">
                    <p class="landing-greeting" id="landingGreeting"></p>
                    <button class="dark-mode-toggle landing-theme-toggle" onclick="App.toggleDarkMode()" title="Toggle dark mode" aria-label="Toggle dark mode">
                        <span class="dark-mode-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></span>
                    </button>
                    <button id="authUserBtn" class="auth-user-btn" onclick="Auth.showModal()" title="Sign in to sync across devices" aria-label="Account">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </button>
                    <span id="authUserIndicator" class="auth-user-indicator" style="display:none"></span>
                </div>
            </div>
        </section>

        <!-- ‚îÄ‚îÄ Section: Bento App Grid ‚îÄ‚îÄ -->
        <!-- Rendered dynamically from App.toolConfig ‚Üí renderLandingTools() -->
        <!-- Each category gets a labeled group; cards are self-contained components -->
        <section id="landingAppGrid" class="landing-app-grid" aria-label="Tool grid">
            <div class="tools-container" id="toolsGrid">
                <!-- JS injects .bento-category groups here -->
            </div>
        </section>

        <!-- ‚îÄ‚îÄ Section: Quick Reference (always accessible) ‚îÄ‚îÄ -->
        <section id="landingQuickRef" class="landing-quickref" aria-label="Quick reference">
            <div id="quickrefGrid"></div>
        </section>

        <!-- ‚îÄ‚îÄ Section: Footer ‚îÄ‚îÄ -->
        <footer id="landingFooter" class="landing-footer" aria-label="Footer">
            <div style="text-align:center;font-size:10px;color:#94a3b8;opacity:0.5;letter-spacing:0.5px;">v2.18.1</div>
        </footer>
    </div>

    <!-- BACK BUTTON (shared across all plugins) -->
    <a id="backToHome" href="#home" onclick="App.goHome(); return false;">‚Üê Exit Tool</a>
    <div id="breadcrumbBar"></div>

    <!-- QUOTING TOOL CONTAINER -->
    <div id="quotingTool" class="plugin-container">

    <header>
        <div class="header-top">
            <div class="logo tool-header-brand">
                <span class="logo-controls">
                    <a class="logo-icon-button" href="#home" onclick="App.goHome(); return false;" aria-label="Back to home">
                        <span class="logo-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span>
                    </a>
                    <button class="dark-mode-toggle" onclick="App.toggleDarkMode()" title="Toggle dark mode" aria-label="Toggle dark mode">
                        <span class="dark-mode-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></span>
                    </button>
                </span>
                <span>Insurance Intake</span>
            </div>
            <div class="header-right">
                <div id="saveIndicator" class="save-indicator">‚úì Saved</div>
            </div>
        </div>
        <div id="stepTitle" class="step-title">Step 1 of 4: Client Information</div>
        <div class="progress-track"><div id="progressBar" class="progress-fill"></div></div>
    </header>

    <main id="mainContainer">
        <!-- STEP 0: QUICK START -->
        <div id="step-0" class="step">
            <div class="card">
                <h2>üöÄ Quick Start</h2>
                <p class="section-subtitle">Upload a policy document or driver license to auto-fill the form, or skip to start manually.</p>

                <!-- Desktop drag-and-drop zone for policy documents -->
                <div id="scanDropZone" class="scan-drop-zone" style="display:none;">
                    <div class="drop-icon">üìÑ</div>
                    <div class="drop-label">Drop policy documents here</div>
                    <div class="drop-hint">PDF or image files ‚Ä¢ Drag from your desktop</div>
                </div>

                <div class="scan-actions">
                    <button class="btn btn-primary" onclick="App.openScanPicker()">üì∏ Upload Policy Document</button>
                    <button class="btn btn-primary" onclick="App.openInitialDriverLicensePicker()">ü™™ Upload Driver License</button>
                    <input id="policyScanInput" type="file" accept="image/*,application/pdf" capture="environment" multiple class="hidden" />
                    <input id="initialDlScanInput" type="file" accept="image/*" capture="environment" class="hidden" onchange="App.handleInitialDriverLicenseFile(this.files[0])" />
                    <input id="docIntelInput" type="file" accept="image/*,application/pdf" multiple class="hidden" />
                </div>

                <div id="scanPreview" class="scan-preview"></div>
                <div id="initialDlPreview" class="scan-preview"></div>
                <div id="docIntelPreview" class="scan-preview"></div>
                
                <div id="scanStatus" class="hint hidden"></div>
                <div id="initialDlStatus" class="hint hidden"></div>
                <div id="docIntelStatus" class="hint hidden"></div>
                
                <div id="scanResults"></div>
                <div id="initialDlResults"></div>
                <div id="docIntelResults"></div>
                
                <div id="scanCoverage" class="hint" style="margin-top:12px; display:none;">Scan coverage: 0/0 fields applied</div>
            </div>

            <!-- Recent Clients & Fresh Start -->
            <div class="card" id="step0ClientCard">
                <h2>üë§ Begin Intake</h2>
                <p class="section-subtitle">Start fresh or restore a previous client</p>
                <button class="btn btn-primary" onclick="App.startFresh()" style="width:100%;margin-bottom:12px;">‚ú® New Client ‚Äî Start Fresh</button>
                <div id="step0ClientHistoryList"></div>
            </div>

            <!-- Saved Drafts (Quick Load) -->
            <div class="card" id="quickStartDraftsCard" style="display:none;">
                <h2>üìã Saved Drafts</h2>
                <p class="section-subtitle">Tap a draft to resume editing</p>
                <div id="quickStartDraftList"></div>
            </div>
        </div>

        <!-- STEP 1: CLIENT INFORMATION -->
        <div id="step-1" class="step hidden">
            <div class="hint" style="margin-bottom:16px;">
                üí° Tip: Use the policy/document scans on the previous step to auto-fill this form.
            </div>
            <div class="card">
                <h2>About You</h2>
                <p class="section-subtitle">Let's start with your basic information</p>
                
                <div class="grid-2-full">
                    <div>
                        <label class="label">First Name</label>
                        <div class="input-with-action">
                            <input type="text" id="firstName" placeholder="John" autocomplete="given-name">
                            <button type="button" class="input-action-btn pronunciation-btn" id="pronBtnFirst" onclick="App.togglePronunciation('first')" title="Name pronunciation">üîä</button>
                            <div class="pronunciation-popup" id="pronPopupFirst">
                                <input type="text" id="firstNamePhonetic" placeholder="e.g. AW-stin" readonly>
                                <div class="popup-actions">
                                    <button type="button" class="popup-btn-gen" onclick="App.generateNamePronunciation()">Generate</button>
                                    <button type="button" class="popup-btn-close" onclick="App.togglePronunciation('first')">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="label">Last Name</label>
                        <div class="input-with-action">
                            <input type="text" id="lastName" placeholder="Smith" autocomplete="family-name">
                            <button type="button" class="input-action-btn pronunciation-btn" id="pronBtnLast" onclick="App.togglePronunciation('last')" title="Name pronunciation">üîä</button>
                            <div class="pronunciation-popup" id="pronPopupLast">
                                <input type="text" id="lastNamePhonetic" placeholder="e.g. SMITH" readonly>
                                <div class="popup-actions">
                                    <button type="button" class="popup-btn-gen" onclick="App.generateNamePronunciation()">Generate</button>
                                    <button type="button" class="popup-btn-close" onclick="App.togglePronunciation('last')">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="label">Prefix</label>
                        <select id="prefix">
                            <option value="">--</option>
                            <option value="MR">Mr.</option>
                            <option value="MRS">Mrs.</option>
                            <option value="MS">Ms.</option>
                            <option value="DR">Dr.</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Suffix</label>
                        <select id="suffix">
                            <option value="">--</option>
                            <option value="JR">Jr.</option>
                            <option value="SR">Sr.</option>
                            <option value="I">I</option>
                            <option value="II">II</option>
                            <option value="III">III</option>
                        </select>
                    </div>

                    <div><label class="label">Date of Birth</label><input type="date" id="dob"></div>
                    <div>
                        <label class="label">Gender</label>
                        <select id="gender">
                            <option value="">Select...</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                            <option value="X">Not Specified</option>
                        </select>
                    </div>

                    <div><label class="label">Email Address</label><input type="email" id="email" placeholder="john@example.com" autocomplete="email"></div>
                    <div><label class="label">Phone Number</label><input type="tel" id="phone" placeholder="(555) 123-4567" autocomplete="tel"></div>

                    <div>
                        <label class="label">Marital Status</label>
                        <select id="maritalStatus">
                            <option value="">Select...</option>
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                            <option value="Domestic Partner">Domestic Partner</option>
                            <option value="Widowed">Widowed</option>
                            <option value="Separated">Separated</option>
                            <option value="Divorced">Divorced</option>
                        </select>
                    </div>
                    <div></div>
                </div>

                <!-- Co-Applicant Toggle -->
                <div class="co-applicant-toggle">
                    <label class="checkbox-row">
                        <input type="checkbox" id="hasCoApplicant" onchange="App.toggleCoApplicant()">
                        <span style="font-weight:600;">Add Co-Applicant / Spouse</span>
                    </label>
                </div>

                <!-- Co-Applicant Fields -->
                <div id="coApplicantSection" class="co-applicant-section">
                    <h3>Co-Applicant Information</h3>
                    <div class="grid-2-full">
                        <div>
                            <label class="label">First Name</label>
                            <input type="text" id="coFirstName" placeholder="Jane">
                        </div>
                        <div>
                            <label class="label">Last Name</label>
                            <input type="text" id="coLastName" placeholder="Smith">
                        </div>
                        <div>
                            <label class="label">Date of Birth</label>
                            <input type="date" id="coDob">
                        </div>
                        <div>
                            <label class="label">Gender</label>
                            <select id="coGender">
                                <option value="">Select...</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Email</label>
                            <input type="email" id="coEmail" placeholder="jane@email.com">
                        </div>
                        <div>
                            <label class="label">Phone</label>
                            <input type="tel" id="coPhone" placeholder="(555) 555-5555">
                        </div>
                        <div>
                            <label class="label">Relationship</label>
                            <select id="coRelationship">
                                <option value="Spouse">Spouse</option>
                                <option value="Domestic Partner">Domestic Partner</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: COVERAGE TYPE -->
        <div id="step-2" class="step hidden">
            <div class="card">
                <h2>What would you like to insure?</h2>
                <p class="section-subtitle">Select the coverage type(s) you need</p>
                
                <div class="radio-grid">
                    <label class="radio-card"><input type="radio" name="qType" value="home" onchange="App.handleType()">
                        <div class="radio-card-content">
                            <span style="font-size:48px">üè†</span>
                            <span style="margin-top:12px; font-size:16px; font-weight:600">HOME</span>
                            <span style="font-size:13px; color:var(--text-secondary); margin-top:4px">Property insurance</span>
                        </div>
                    </label>
                    <label class="radio-card"><input type="radio" name="qType" value="auto" onchange="App.handleType()">
                        <div class="radio-card-content">
                            <span style="font-size:48px">üöó</span>
                            <span style="margin-top:12px; font-size:16px; font-weight:600">AUTO</span>
                            <span style="font-size:13px; color:var(--text-secondary); margin-top:4px">Vehicle insurance</span>
                        </div>
                    </label>
                    <label class="radio-card"><input type="radio" name="qType" value="both" checked onchange="App.handleType()">
                        <div class="radio-card-content">
                            <span style="font-size:48px">üéØ</span>
                            <span style="margin-top:12px; font-size:16px; font-weight:600">HOME & AUTO</span>
                            <span style="font-size:13px; color:var(--text-secondary); margin-top:4px">Bundle coverage</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="card">
                <h2>Demographics</h2>
                <p class="section-subtitle">This helps us find the best coverage options</p>
                
                <div class="grid-2">
                    <div>
                        <label class="label">Education Level</label>
                        <select id="education">
                            <option value="">Select...</option>
                            <option value="No High School Diploma">No High School Diploma</option>
                            <option value="High School Diploma">High School Diploma</option>
                            <option value="Some College - No Degree">Some College - No Degree</option>
                            <option value="Vocational/Technical Degree">Vocational/Technical Degree</option>
                            <option value="Associates Degree">Associates Degree</option>
                            <option value="Bachelors">Bachelors</option>
                            <option value="Masters">Masters</option>
                            <option value="Phd">PhD</option>
                            <option value="Medical Degree">Medical Degree</option>
                            <option value="Law Degree">Law Degree</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Occupation</label>
                        <input type="text" id="occupation" placeholder="e.g. Insurance Agent" oninput="App.save(event)">
                    </div>
                    <div>
                        <label class="label">Industry</label>
                        <select id="industry">
                            <option value="">Select...</option>
                            <option value="Homemaker/House person">Homemaker/House person</option>
                            <option value="Retired">Retired</option>
                            <option value="Disabled">Disabled</option>
                            <option value="Unemployed">Unemployed</option>
                            <option value="Student">Student</option>
                            <option value="Agriculture/Forestry/Fishing">Agriculture/Forestry/Fishing</option>
                            <option value="Art/Design/Media">Art/Design/Media</option>
                            <option value="Banking/Finance/Real Estate">Banking/Finance/Real Estate</option>
                            <option value="Business/Sales/Office">Business/Sales/Office</option>
                            <option value="Construction/Energy Trades">Construction/Energy Trades</option>
                            <option value="Education/Library">Education/Library</option>
                            <option value="Engineer/Architect/Science/Math">Engineer/Architect/Science/Math</option>
                            <option value="Government/Military">Government/Military</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Legal/Law Enforcement/Security">Legal/Law Enforcement/Security</option>
                            <option value="Maintenance/Repair/Housekeeping">Maintenance/Repair/Housekeeping</option>
                            <option value="Manufacturing/Production">Manufacturing/Production</option>
                            <option value="Medical/Social Services/Religion">Medical/Social Services/Religion</option>
                            <option value="Personal Care/Service">Personal Care/Service</option>
                            <option value="Restaurant/Hotel Services">Restaurant/Hotel Services</option>
                            <option value="Sports/Recreation">Sports/Recreation</option>
                            <option value="Travel/Transportation/Warehousing">Travel/Transportation/Warehousing</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 3: PROPERTY DETAILS -->
        <div id="step-3" class="step hidden">
          <div class="prop-layout">
            <!-- ‚ïê‚ïê‚ïê LEFT COLUMN: Form Fields ‚ïê‚ïê‚ïê -->
            <div class="prop-main">

            <div class="card">
                <h2>Property Location</h2>
                <p class="section-subtitle">Where is the property located?</p>
                
                <div class="grid-addr-row1">
                    <div><label class="label">Street Address</label><input type="text" id="addrStreet" placeholder="123 Main St" autocomplete="off"></div>
                </div>
                <div class="grid-addr-row2">
                    <div><label class="label">City</label><input type="text" id="addrCity" placeholder="Vancouver" autocomplete="off"></div>
                    <div><label class="label">State</label><input type="text" id="addrState" value="WA" autocomplete="off"></div>
                    <div><label class="label">Zip</label><input type="tel" id="addrZip" placeholder="98686"></div>
                    <div><label class="label">County</label>
                        <select id="county" style="font-size: 13px !important; padding: 8px 8px;">
                            <option value="">Auto-fills ‚ú®</option>
                            <option value="Adams">Adams</option>
                            <option value="Asotin">Asotin</option>
                            <option value="Benton">Benton</option>
                            <option value="Chelan">Chelan</option>
                            <option value="Clallam">Clallam</option>
                            <option value="Clark">Clark</option>
                            <option value="Columbia">Columbia</option>
                            <option value="Cowlitz">Cowlitz</option>
                            <option value="Douglas">Douglas</option>
                            <option value="Ferry">Ferry</option>
                            <option value="Franklin">Franklin</option>
                            <option value="Garfield">Garfield</option>
                            <option value="Grant">Grant</option>
                            <option value="Grays Harbor">Grays Harbor</option>
                            <option value="Island">Island</option>
                            <option value="Jefferson">Jefferson</option>
                            <option value="King">King</option>
                            <option value="Kitsap">Kitsap</option>
                            <option value="Kittitas">Kittitas</option>
                            <option value="Klickitat">Klickitat</option>
                            <option value="Lewis">Lewis</option>
                            <option value="Lincoln">Lincoln</option>
                            <option value="Mason">Mason</option>
                            <option value="Okanogan">Okanogan</option>
                            <option value="Pacific">Pacific</option>
                            <option value="Pend Oreille">Pend Oreille</option>
                            <option value="Pierce">Pierce</option>
                            <option value="San Juan">San Juan</option>
                            <option value="Skagit">Skagit</option>
                            <option value="Skamania">Skamania</option>
                            <option value="Snohomish">Snohomish</option>
                            <option value="Spokane">Spokane</option>
                            <option value="Stevens">Stevens</option>
                            <option value="Thurston">Thurston</option>
                            <option value="Wahkiakum">Wahkiakum</option>
                            <option value="Walla Walla">Walla Walla</option>
                            <option value="Whatcom">Whatcom</option>
                            <option value="Whitman">Whitman</option>
                            <option value="Yakima">Yakima</option>
                        </select>
                    </div>
                </div>

                <!-- Smart Scan: hero button -->
                <div style="margin-top: 14px;">
                    <button class="btn-smart-scan" onclick="App.smartAutoFill()" title="AI-powered property lookup ‚Äî auto-fills county, year built, sqft, hazards & more" id="smartFillBtn">‚ú® Smart Scan</button>
                </div>

                <!-- Secondary tools row -->
                <div class="utility-buttons" style="margin-top: 8px; justify-content: center;">
                    <button class="btn-utility" onclick="App.openZillow()" title="Search this address on Zillow" style="flex: 0 1 auto; font-size: 12px; padding: 7px 14px;">üîç Zillow</button>
                    <button class="btn-utility" onclick="App.openPropertyRecords()" title="Copies address to clipboard & opens county assessor site" style="flex: 0 1 auto; font-size: 12px; padding: 7px 14px;">üèõÔ∏è Assessor</button>
                    <button class="btn-utility" onclick="App.importPropertyFromExtension()" title="Import property data scraped by the Chrome Extension from Zillow/GIS" style="flex: 0 1 auto; font-size: 12px; padding: 7px 14px; background: linear-gradient(135deg, #ff9500, #e68600); color: white;">üì• Import</button>
                </div>

                <!-- Hidden file input kept for backward compatibility -->
                <input type="file" id="gisUploadInput" accept="image/*,.pdf" multiple style="display:none" onchange="App.handleGISUpload(event)">
                <div id="gisUploadStatus" class="hidden" style="margin-top: 8px; padding: 10px; border-radius: 8px; background: var(--card-bg); font-size: 13px; text-align: center;"></div>
                <div id="gisUploadResults" style="margin-top: 8px;"></div>
            </div>

            <div class="card">
                <h2>Home Basics</h2>
                <p class="section-subtitle">Tell us about your property</p>
                
                <label class="label">Dwelling Usage</label>
                <select id="dwellingUsage">
                    <option value="">Select...</option>
                    <option value="Primary">Primary</option>
                    <option value="Secondary">Secondary</option>
                    <option value="Seasonal">Seasonal</option>
                    <option value="Farm">Farm</option>
                    <option value="COC">COC</option>
                    <option value="Rental">Rental</option>
                    <option value="Vacant">Vacant</option>
                </select>
                
                <label class="label">Occupancy Type</label>
                <select id="occupancyType">
                    <option value="">Select...</option>
                    <option value="Owner Occupied">Owner Occupied</option>
                    <option value="Renter Occupied">Renter Occupied</option>
                    <option value="Unoccupied">Unoccupied</option>
                    <option value="Vacant">Vacant</option>
                </select>
                
                <label class="label">Dwelling Type</label>
                <select id="dwellingType">
                    <option value="">Select...</option>
                    <option value="One Family">One Family</option>
                    <option value="Two Family">Two Family</option>
                    <option value="Three Family">Three Family</option>
                    <option value="Four Family">Four Family</option>
                    <option value="Condo">Condo</option>
                    <option value="Townhome">Townhome</option>
                    <option value="Row House">Row House</option>
                </select>
                
                <div class="grid-2">
                    <div><label class="label">Number of Stories</label>
                        <select id="numStories">
                            <option value="">Select...</option>
                            <option value="1">1</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                            <option value="3.5">3.5</option>
                            <option value="4">4</option>
                            <option value="Bi-Level">Bi-Level</option>
                            <option value="Tri-Level">Tri-Level</option>
                        </select>
                    </div>
                    <div><label class="label">Bedrooms</label><input type="number" id="bedrooms" min="1" max="20" value="3"></div>
                </div>

                <div class="grid-2">
                    <div><label class="label">Full Bathrooms</label><input type="number" id="fullBaths" min="1" max="10" value="2"></div>
                    <div><label class="label">Half Bathrooms</label><input type="number" id="halfBaths" min="0" max="5" value="0"></div>
                </div>
                
                <div class="grid-2">
                    <div><label class="label">Square Footage</label><input type="tel" id="sqFt" placeholder="2000"></div>
                    <div><label class="label">Year Built</label><input type="tel" id="yrBuilt" placeholder="1990" oninput="App.checkUpdates()"></div>
                </div>

                <div class="grid-2">
                    <div><label class="label">Lot Size (acres)</label><input type="text" id="lotSize" placeholder="0.25"></div>
                    <div><label class="label">Number of Occupants</label><input type="number" id="numOccupants" min="1" max="20" placeholder="2"></div>
                </div>
                
                <div class="grid-2">
                    <div><label class="label">Home Purchase Date</label>
                    <input type="date" id="purchaseDate" onchange="App.calculateResidenceTime()">
                    <span id="residenceTimeDisplay" style="font-size: 12px; color: var(--text-secondary); margin-top: 2px; display: block;"></span></div>
                    <div><label class="label">Years at Address</label><input type="text" id="yearsAtAddress" placeholder="5"></div>
                </div>
            </div>

            <details class="card section-accordion" open>
                <summary>
                    <div><h2 style="margin:0">Construction &amp; Roof</h2>
                    <p class="section-subtitle" style="margin:4px 0 0">Materials, foundation, garage, and roofing</p></div>
                </summary>
                <div class="accordion-body">

                <div class="grid-2">
                    <div><label class="label">Construction Style</label>
                    <select id="constructionStyle">
                        <option value="">Select...</option>
                        <option value="Ranch">Ranch</option>
                        <option value="Colonial">Colonial</option>
                        <option value="Cape Cod">Cape Cod</option>
                        <option value="Bi-Level">Bi-Level</option>
                        <option value="Bi-Level/Row Center">Bi-Level / Row Center</option>
                        <option value="Bi-Level/Row End">Bi-Level / Row End</option>
                        <option value="Split Level">Split Level</option>
                        <option value="Split Foyer">Split Foyer</option>
                        <option value="Tri-Level">Tri-Level</option>
                        <option value="Tri-Level Center">Tri-Level Center</option>
                        <option value="Raised Ranch">Raised Ranch</option>
                        <option value="Rambler">Rambler</option>
                        <option value="Bungalow">Bungalow</option>
                        <option value="Cottage">Cottage</option>
                        <option value="Contemporary">Contemporary</option>
                        <option value="Victorian">Victorian</option>
                        <option value="Ornate Victorian">Ornate Victorian</option>
                        <option value="Queen Anne">Queen Anne</option>
                        <option value="Federal Colonial">Federal Colonial</option>
                        <option value="Mediterranean">Mediterranean</option>
                        <option value="Southwest Adobe">Southwest Adobe</option>
                        <option value="Townhouse">Townhouse</option>
                        <option value="Townhouse Center">Townhouse Center</option>
                        <option value="Townhouse End">Townhouse End</option>
                        <option value="Rowhouse">Rowhouse</option>
                        <option value="Rowhouse Center">Rowhouse Center</option>
                        <option value="Rowhouse End">Rowhouse End</option>
                        <option value="Condo">Condo</option>
                        <option value="Coop">Coop</option>
                        <option value="Apartment">Apartment</option>
                        <option value="Dwelling">Dwelling</option>
                        <option value="Backsplit">Backsplit</option>
                        <option value="Substandard">Substandard</option>
                    </select></div>
                    <div><label class="label">Exterior Walls</label>
                    <select id="exteriorWalls">
                        <option value="">Select...</option>
                        <option value="Aluminum/Vinyl">Aluminum / Vinyl</option>
                        <option value="Siding, Vinyl">Siding, Vinyl</option>
                        <option value="Siding, Aluminum">Siding, Aluminum</option>
                        <option value="Siding, Wood">Siding, Wood</option>
                        <option value="Siding, Hardboard">Siding, Hardboard</option>
                        <option value="Siding, Steel">Siding, Steel</option>
                        <option value="Siding, T-111">Siding, T-111</option>
                        <option value="Siding, Plywood">Siding, Plywood</option>
                        <option value="Brick">Brick</option>
                        <option value="Brick Veneer">Brick Veneer</option>
                        <option value="Brick Veneer, Custom">Brick Veneer, Custom</option>
                        <option value="Brick on Block">Brick on Block</option>
                        <option value="Brick on Block, Custom">Brick on Block, Custom</option>
                        <option value="Solid Brick">Solid Brick</option>
                        <option value="Solid Brick, Custom">Solid Brick, Custom</option>
                        <option value="Stucco">Stucco</option>
                        <option value="Stucco on Block">Stucco on Block</option>
                        <option value="Stucco on Frame">Stucco on Frame</option>
                        <option value="Stone Veneer">Stone Veneer</option>
                        <option value="Stone Veneer, Custom">Stone Veneer, Custom</option>
                        <option value="Stone on Block">Stone on Block</option>
                        <option value="Stone on Block, Custom Stone">Stone on Block, Custom Stone</option>
                        <option value="Solid Stone">Solid Stone</option>
                        <option value="Solid Stone, Custom">Solid Stone, Custom</option>
                        <option value="Solid Brownstone">Solid Brownstone</option>
                        <option value="Cement Fiber Shingles">Cement Fiber Shingles</option>
                        <option value="Clapboard">Clapboard</option>
                        <option value="Concrete Decorative Block, Painted">Concrete Decorative Block</option>
                        <option value="Ext Insul and Finish Sys (EIFS)">EIFS (Synthetic Stucco)</option>
                        <option value="Fire Resistant">Fire Resistant</option>
                        <option value="Logs">Logs</option>
                        <option value="Poured Concrete">Poured Concrete</option>
                        <option value="Adobe">Adobe</option>
                        <option value="Barn Plank">Barn Plank</option>
                        <option value="Slump Block">Slump Block</option>
                        <option value="Victorian Scalloped Shakes">Victorian Scalloped Shakes</option>
                        <option value="Wood Shakes">Wood Shakes</option>
                        <option value="Window Wall">Window Wall</option>
                    </select></div>
                </div>

                <div class="grid-2">
                    <div><label class="label">Foundation Type</label>
                    <select id="foundation">
                        <option value="">Select...</option>
                        <option value="Slab">Slab</option>
                        <option value="Crawl Space - Enclosed">Crawl Space - Enclosed</option>
                        <option value="Crawl Space - Open">Crawl Space - Open</option>
                        <option value="Basement - Finished">Basement - Finished</option>
                        <option value="Basement - Partially Finished">Basement - Partially Finished</option>
                        <option value="Basement - Unfinished">Basement - Unfinished</option>
                        <option value="Basement - Walkout">Basement - Walkout</option>
                        <option value="Daylight Basement - Finished">Daylight Basement - Finished</option>
                        <option value="Daylight Basement - Partially Finished">Daylight Basement - Partially Finished</option>
                        <option value="Daylight Basement - Unfinished">Daylight Basement - Unfinished</option>
                        <option value="Hillside Foundation">Hillside Foundation</option>
                        <option value="Piers">Piers</option>
                        <option value="Pilings/stilts">Pilings / Stilts</option>
                        <option value="Other">Other</option>
                    </select></div>
                    <div><label class="label">Kitchen/Bath Quality</label>
                    <select id="kitchenQuality">
                        <option value="">Select...</option>
                        <option value="Builder's Grade">Builder's Grade</option>
                        <option value="Semi-Custom">Semi-Custom</option>
                        <option value="Custom">Custom</option>
                    </select></div>
                </div>

                <div class="grid-2">
                    <div><label class="label">Garage Type</label>
                    <select id="garageType">
                        <option value="">Select...</option>
                        <option value="Attached">Attached</option>
                        <option value="Detached">Detached</option>
                        <option value="Built-in">Built-in</option>
                        <option value="Carport">Carport</option>
                        <option value="None">None</option>
                    </select></div>
                    <div><label class="label">Garage Spaces</label>
                    <input type="number" id="garageSpaces" min="0" max="10" placeholder="2"></div>
                </div>

                <div class="divider" style="margin:12px 0;"></div>
                <h3 style="font-size:15px; font-weight:600; margin-bottom:8px;">Roof</h3>

                <div class="grid-12">
                    <div class="span-8"><label class="label">Roof Type</label>
                        <select id="roofType">
                            <option value="">Select...</option>
                            <option value="Architectural Shingles">Architectural Shingles</option>
                            <option value="Asphalt Shingles">Asphalt Shingles</option>
                            <option value="Composition">Composition</option>
                            <option value="Metal(pitched)">Metal (Pitched)</option>
                            <option value="Metal(flat)">Metal (Flat)</option>
                            <option value="Tile(clay)">Tile (Clay)</option>
                            <option value="Tile(concrete)">Tile (Concrete)</option>
                            <option value="Tile(spanish)">Tile (Spanish)</option>
                            <option value="Wood Shake">Wood Shake</option>
                            <option value="Wood Shingles">Wood Shingles</option>
                            <option value="Wood Fiberglass Shingles">Wood Fiberglass Shingles</option>
                            <option value="Slate">Slate</option>
                            <option value="Tar And Gravel">Tar and Gravel</option>
                            <option value="Tar">Tar</option>
                            <option value="Rubber Flat">Rubber (Flat)</option>
                            <option value="Rubber(pitched)">Rubber (Pitched)</option>
                            <option value="Rolled Paper(flat)">Rolled Paper (Flat)</option>
                            <option value="Rolled Paper(pitched)">Rolled Paper (Pitched)</option>
                            <option value="Corrugated Steel(pitched)">Corrugated Steel (Pitched)</option>
                            <option value="Corrugated Steel(flat)">Corrugated Steel (Flat)</option>
                            <option value="Copper(pitched)">Copper (Pitched)</option>
                            <option value="Copper(flat)">Copper (Flat)</option>
                            <option value="Tin(pitched)">Tin (Pitched)</option>
                            <option value="Tin(flat)">Tin (Flat)</option>
                            <option value="Fiberglass">Fiberglass</option>
                            <option value="Mineral Fiber Shake">Mineral Fiber Shake</option>
                            <option value="Solar">Solar</option>
                            <option value="Foam">Foam</option>
                            <option value="Gravel">Gravel</option>
                            <option value="Rock">Rock</option>
                            <option value="Plastic(flat)">Plastic (Flat)</option>
                            <option value="Plastic(pitched)">Plastic (Pitched)</option>
                            <option value="Thatch">Thatch</option>
                            <option value="Asbestos">Asbestos</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="span-4"><label class="label">Roof Shape</label>
                        <select id="roofShape">
                            <option value="">Select...</option>
                            <option value="Gable">Gable</option>
                            <option value="Hip">Hip</option>
                            <option value="Flat">Flat</option>
                            <option value="Gambrel">Gambrel</option>
                            <option value="Mansard">Mansard</option>
                            <option value="Shed">Shed</option>
                            <option value="Dormer">Dormer</option>
                            <option value="Pyramid">Pyramid</option>
                            <option value="Turret">Turret</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="grid-12">
                    <div class="span-4"><label class="label">Year Roof Updated</label>
                    <input type="tel" id="roofYr" placeholder="2015"></div>
                </div>

                </div> <!-- end .accordion-body -->
            </details>

            <div id="updatesCard" class="card hidden">
                <h2>System Updates</h2>
                <p class="section-subtitle">When were these systems last updated? (Home built before 2000)</p>
                
                <div class="grid-2">
                    <div><label class="label">Heating Update</label>
                        <select id="heatYr">
                            <option value="">Select...</option>
                            <option value="Complete Update">Complete Update</option>
                            <option value="Partial Update">Partial Update</option>
                            <option value="Not Updated">Not Updated</option>
                        </select>
                    </div>
                    <div><label class="label">Plumbing Update</label>
                        <select id="plumbYr">
                            <option value="">Select...</option>
                            <option value="Complete Update">Complete Update</option>
                            <option value="Partial Update">Partial Update</option>
                            <option value="Not Updated">Not Updated</option>
                        </select>
                    </div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Electrical Update</label>
                        <select id="elecYr">
                            <option value="">Select...</option>
                            <option value="Complete Update">Complete Update</option>
                            <option value="Partial Update">Partial Update</option>
                            <option value="Not Updated">Not Updated</option>
                        </select>
                    </div>
                    <div><label class="label">Roofing Update</label>
                        <select id="roofUpdate">
                            <option value="">Select...</option>
                            <option value="Complete Update">Complete Update</option>
                            <option value="Partial Update">Partial Update</option>
                            <option value="Not Updated">Not Updated</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card">
            <details class="section-accordion" open>
                <summary>Systems &amp; Utilities</summary>
                <div class="accordion-body">
                    <div class="grid-12">
                        <div class="span-6">
                            <label class="label">Heating Type</label>
                            <select id="heatingType">
                                <option value="">Select...</option>
                                <option value="Gas - Forced Air">Gas - Forced Air</option>
                                <option value="Gas - Hot Water">Gas - Hot Water</option>
                                <option value="Gas">Gas (Other)</option>
                                <option value="Electric">Electric</option>
                                <option value="Oil - Forced Air">Oil - Forced Air</option>
                                <option value="Oil - Hot Water">Oil - Hot Water</option>
                                <option value="Oil">Oil (Other)</option>
                                <option value="Other - Forced Air">Other - Forced Air</option>
                                <option value="Other - Hot Water">Other - Hot Water</option>
                                <option value="Solid Fuel">Solid Fuel</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="span-6">
                            <label class="label">Cooling System</label>
                            <select id="cooling">
                                <option value="">Select...</option>
                                <option value="Central Air">Central Air</option>
                                <option value="Window Units">Window Units</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                    </div>

                    <label class="disclosure-check" id="secondaryHeatToggle">
                        <input type="checkbox" id="hasSecondaryHeating">
                        <span>Has Secondary Heating?</span>
                    </label>
                    <div id="secondaryHeatingWrapper" class="disclosure-hidden">
                        <label class="label">Secondary Heating Source</label>
                        <select id="secondaryHeating">
                            <option value="">None</option>
                            <option value="Wood Professionally Installed">Wood (Professionally Installed)</option>
                            <option value="Wood Non-Professionally Installed">Wood (Non-Professionally Installed)</option>
                            <option value="Coal Professionally Installed">Coal (Professionally Installed)</option>
                            <option value="Coal Non-Professionally Installed">Coal (Non-Professionally Installed)</option>
                            <option value="Electric">Electric</option>
                            <option value="Electric Portable Heater">Electric Portable Heater</option>
                            <option value="Kerosene">Kerosene</option>
                            <option value="Kerosene Portable Heater">Kerosene Portable Heater</option>
                            <option value="Liquid Propane">Liquid Propane</option>
                            <option value="Liquid Propane Portable Heater">Liquid Propane Portable Heater</option>
                            <option value="Natural Gas">Natural Gas</option>
                            <option value="Oil">Oil</option>
                            <option value="Solar Professionally Installed">Solar (Professionally Installed)</option>
                            <option value="Solar Non-Professionally Installed">Solar (Non-Professionally Installed)</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="grid-2">
                        <div><label class="label">Sewer</label>
                            <select id="sewer">
                                <option value="">Select...</option>
                                <option value="Public">Public</option>
                                <option value="Septic">Septic</option>
                            </select>
                        </div>
                        <div><label class="label">Water Source</label>
                            <select id="waterSource">
                                <option value="">Select...</option>
                                <option value="Public">Public</option>
                                <option value="Well">Well</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div><label class="label">Primary Flooring</label>
                            <select id="flooring">
                                <option value="">Select...</option>
                                <option value="Hardwood">Hardwood</option>
                                <option value="Carpet">Carpet</option>
                                <option value="Tile">Tile</option>
                                <option value="Laminate">Laminate</option>
                                <option value="Mixed">Mixed</option>
                            </select>
                        </div>
                        <div><label class="label">Number of Fireplaces</label>
                            <input type="number" id="numFireplaces" min="0" max="5" placeholder="0">
                        </div>
                    </div>
                </div>
            </details>
            </div>

            <div class="card">
                <h2>Safety & Location</h2>
                <p class="section-subtitle">Fire protection and security</p>
                
                <div class="grid-3">
                    <div><label class="label">Distance to Fire Station (Miles)</label><input type="number" id="fireStationDist" step="0.1" placeholder="2.5"></div>
                    <div>
                        <label class="label">Feet to Fire Hydrant</label>
                        <select id="fireHydrantFeet">
                            <option value="">Select...</option>
                            <option value="1-500">1-500</option>
                            <option value="501-600">501-600</option>
                            <option value="601-1000">601-1000</option>
                            <option value="1001-1100">1001-1100</option>
                            <option value="1101-1200">1101-1200</option>
                            <option value="1201-1300">1201-1300</option>
                            <option value="1301-1400">1301-1400</option>
                            <option value="1401-1500">1401-1500</option>
                            <option value="1501 and Greater">1501+</option>
                            <option value="None in Area">None in Area</option>
                        </select>
                    </div>
                    <div><label class="label">Protection Class (1-10)</label><input type="number" id="protectionClass" min="1" max="10" placeholder="5"></div>
                </div>
                
                <label class="label">Burglar Alarm</label>
                <select id="burglarAlarm">
                    <option value="">None</option>
                    <option value="Local">Local</option>
                    <option value="Central">Central Station</option>
                    <option value="Direct">Direct to Police/Fire</option>
                </select>
                
                <label class="label">Fire / Smoke Detection</label>
                <select id="fireAlarm">
                    <option value="">None</option>
                    <option value="Local">Local (Battery/Wired)</option>
                    <option value="Central">Central Station</option>
                    <option value="Direct">Direct to Fire Dept.</option>
                </select>
                
                <label class="label">Sprinkler System</label>
                <select id="sprinklers">
                    <option value="">None</option>
                    <option value="Partial">Partial</option>
                    <option value="Full">Full</option>
                </select>

                <label class="label">Smoke Detector</label>
                <select id="smokeDetector">
                    <option value="">None</option>
                    <option value="Local">Local (Battery/Wired)</option>
                    <option value="Central">Central Station</option>
                    <option value="Direct">Direct to Fire Dept.</option>
                </select>
            </div>

            <div class="card">
                <h2>Home Risk Factors</h2>
                <p class="section-subtitle">Help us understand potential risk factors</p>

                <label class="label">Swimming Pool</label>
                <select id="pool">
                    <option value="">Select...</option>
                    <option value="None">None</option>
                    <option value="Above Ground">Above Ground</option>
                    <option value="In Ground">In Ground</option>
                    <option value="In Ground with Slide">In Ground with Slide</option>
                </select>

                <label class="label">Trampoline</label>
                <select id="trampoline">
                    <option value="">Select...</option>
                    <option value="None">None</option>
                    <option value="Yes">Yes</option>
                    <option value="Yes with Safety Net">Yes with Safety Net</option>
                </select>

                <label class="label">Wood Burning Stove</label>
                <select id="woodStove">
                    <option value="">Select...</option>
                    <option value="None">None</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>

                <label class="label">Distance to Tidal Water (Miles)</label>
                <select id="tidalWaterDist">
                    <option value="">N/A</option>
                    <option value="0-.5">0 - 0.5</option>
                    <option value=".5-1">0.5 - 1</option>
                    <option value="1-2">1 - 2</option>
                    <option value="2-5">2 - 5</option>
                    <option value="more than 5">More than 5</option>
                </select>

                <label class="label">Dogs / Pets</label>
                <textarea id="dogInfo" placeholder="Breed, age, behavior history (if applicable)" rows="2"></textarea>

                <label class="label">Business on Property</label>
                <textarea id="businessOnProperty" placeholder="Describe any business operations" rows="2"></textarea>
            </div>

            <div class="card">
                <h2>Home Coverage</h2>
                <p class="section-subtitle">Coverage limits and policy details</p>

                <div class="grid-2-full">
                    <div class="full-span">
                        <label class="label">Policy Type</label>
                        <select id="homePolicyType">
                            <option value="HO3" selected>HO3 - Special Form</option>
                            <option value="HO5">HO5 - Comprehensive</option>
                            <option value="HO6">HO6 - Condo</option>
                            <option value="HO4">HO4 - Renters</option>
                            <option value="DP1">DP1 - Dwelling Fire</option>
                            <option value="DP3">DP3 - Dwelling Special</option>
                        </select>
                    </div>

                    <div class="full-span">
                        <label class="label">Dwelling Coverage (Coverage A)</label>
                        <input type="text" id="dwellingCoverage" placeholder="e.g. 600000" inputmode="numeric">
                    </div>

                    <div>
                        <label class="label">Personal Liability</label>
                        <select id="personalLiability">
                            <option value="">Select...</option>
                            <option value="25000">$25,000</option>
                            <option value="50000">$50,000</option>
                            <option value="100000">$100,000</option>
                            <option value="200000">$200,000</option>
                            <option value="300000">$300,000</option>
                            <option value="400000">$400,000</option>
                            <option value="500000">$500,000</option>
                            <option value="1000000">$1,000,000</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Medical Payments</label>
                        <select id="medicalPayments">
                            <option value="">Select...</option>
                            <option value="1000">$1,000</option>
                            <option value="2000">$2,000</option>
                            <option value="3000">$3,000</option>
                            <option value="4000">$4,000</option>
                            <option value="5000">$5,000</option>
                        </select>
                    </div>

                    <div>
                        <label class="label">All Perils Deductible</label>
                        <select id="homeDeductible">
                            <option value="">Select...</option>
                            <option value="1/2%">1/2%</option>
                            <option value="1%">1%</option>
                            <option value="100">$100</option>
                            <option value="250">$250</option>
                            <option value="500">$500</option>
                            <option value="750">$750</option>
                            <option value="1000">$1,000</option>
                            <option value="1500">$1,500</option>
                            <option value="2000">$2,000</option>
                            <option value="2500">$2,500</option>
                            <option value="3000">$3,000</option>
                            <option value="4000">$4,000</option>
                            <option value="5000">$5,000</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Wind / Hail Deductible</label>
                        <select id="windDeductible">
                            <option value="">Same as All Perils</option>
                            <option value="100">$100</option>
                            <option value="250">$250</option>
                            <option value="500">$500</option>
                            <option value="1000">$1,000</option>
                            <option value="1500">$1,500</option>
                            <option value="2000">$2,000</option>
                            <option value="2500">$2,500</option>
                            <option value="5000">$5,000</option>
                            <option value="10000">$10,000</option>
                            <option value="1%">1%</option>
                            <option value="2%">2%</option>
                            <option value="3%">3%</option>
                            <option value="4%">4%</option>
                            <option value="5%">5%</option>
                        </select>
                    </div>

                    <div class="full-span">
                        <label class="label">Mortgagee / Lienholder</label>
                        <input type="text" id="mortgagee" placeholder="Bank name and address">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Home Endorsements</h2>
                <p class="section-subtitle">Optional coverages and endorsements</p>

                <!-- ‚îÄ‚îÄ Group 1: Coverage Limit Selectors (2-column grid) ‚îÄ‚îÄ -->
                <div class="grid-2-full">
                    <div>
                        <label class="label">Increased Replacement Cost %</label>
                        <select id="increasedReplacementCost">
                            <option value="">None</option>
                            <option value="125">125%</option>
                            <option value="150">150%</option>
                            <option value="200">200%</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Ordinance or Law %</label>
                        <select id="ordinanceOrLaw">
                            <option value="">None</option>
                            <option value="10">10%</option>
                            <option value="25">25%</option>
                            <option value="50">50%</option>
                            <option value="75">75%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Water Backup</label>
                        <select id="waterBackup">
                            <option value="">None</option>
                            <option value="1000">$1,000</option>
                            <option value="2000">$2,000</option>
                            <option value="3000">$3,000</option>
                            <option value="4000">$4,000</option>
                            <option value="5000">$5,000</option>
                            <option value="6000">$6,000</option>
                            <option value="7000">$7,000</option>
                            <option value="8000">$8,000</option>
                            <option value="9000">$9,000</option>
                            <option value="10000">$10,000</option>
                            <option value="15000">$15,000</option>
                            <option value="20000">$20,000</option>
                            <option value="25000">$25,000</option>
                            <option value="50000">$50,000</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Loss Assessment</label>
                        <select id="lossAssessment">
                            <option value="">None</option>
                            <option value="5000">$5,000</option>
                            <option value="10000">$10,000</option>
                            <option value="25000">$25,000</option>
                            <option value="50000">$50,000</option>
                            <option value="75000">$75,000</option>
                            <option value="100000">$100,000</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Animal Liability</label>
                        <select id="animalLiability">
                            <option value="">None</option>
                            <option value="25000">$25,000</option>
                            <option value="50000">$50,000</option>
                            <option value="100000">$100,000</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Theft Deductible</label>
                        <select id="theftDeductible">
                            <option value="">Same as All Perils</option>
                            <option value="500">$500</option>
                            <option value="1500">$1,500</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Jewelry / Watches / Furs Limit</label>
                        <select id="jewelryLimit">
                            <option value="">Default</option>
                            <option value="2500">$2,500</option>
                            <option value="3000">$3,000</option>
                            <option value="4000">$4,000</option>
                            <option value="5000">$5,000</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Increased Credit Card Coverage</label>
                        <select id="creditCardCoverage">
                            <option value="">Default</option>
                            <option value="1000">$1,000</option>
                            <option value="2500">$2,500</option>
                            <option value="5000">$5,000</option>
                            <option value="7500">$7,500</option>
                            <option value="10000">$10,000</option>
                        </select>
                    </div>
                    <div class="full-span">
                        <label class="label">Increased Mold Damage</label>
                        <select id="moldDamage">
                            <option value="">Default</option>
                            <option value="25000">$25,000</option>
                            <option value="50000">$50,000</option>
                            <option value="75000">$75,000</option>
                            <option value="100000">$100,000</option>
                        </select>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ Group 2: Binary Toggles (3-column compact cards) ‚îÄ‚îÄ -->
                <div class="toggle-grid-3">
                    <div class="toggle-card">
                        <label class="label">Equipment Breakdown</label>
                        <input type="hidden" id="equipmentBreakdown" value="">
                        <label class="toggle-switch">
                            <input type="checkbox" data-toggle-field="equipmentBreakdown">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-card">
                        <label class="label">Service Line</label>
                        <input type="hidden" id="serviceLine" value="">
                        <label class="toggle-switch">
                            <input type="checkbox" data-toggle-field="serviceLine">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-card">
                        <label class="label">Earthquake</label>
                        <input type="hidden" id="earthquakeCoverage" value="">
                        <label class="toggle-switch">
                            <input type="checkbox" data-toggle-field="earthquakeCoverage">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ Earthquake Details (progressive disclosure) ‚îÄ‚îÄ -->
                <div id="earthquakeDetailsWrapper" class="disclosure-hidden" style="margin-top: 12px;">
                    <div class="grid-2-full">
                        <div>
                            <label class="label">Earthquake Zone</label>
                            <select id="earthquakeZone">
                                <option value="">N/A</option>
                                <option value="1">Zone 1</option>
                                <option value="2">Zone 2</option>
                                <option value="3">Zone 3</option>
                                <option value="4">Zone 4</option>
                                <option value="5">Zone 5</option>
                                <option value="6">Zone 6</option>
                                <option value="7">Zone 7</option>
                                <option value="8">Zone 8</option>
                                <option value="9">Zone 9</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Earthquake Deductible</label>
                            <select id="earthquakeDeductible">
                                <option value="">N/A</option>
                                <option value="5%">5%</option>
                                <option value="10%">10%</option>
                                <option value="15%">15%</option>
                                <option value="20%">20%</option>
                                <option value="25%">25%</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            </div> <!-- end .prop-main (left column) -->

            <!-- ‚ïê‚ïê‚ïê RIGHT COLUMN: Sticky Sidebar ‚ïê‚ïê‚ïê -->
            <div class="prop-sidebar">
                <div class="card map-preview-card">
                    <h2>Property Views</h2>
                    <p class="section-subtitle">Street &amp; satellite preview</p>
                    <div class="map-previews" style="grid-template-columns: 1fr;">
                        <div class="map-preview-item">
                            <div class="map-preview-label">Street View</div>
                            <img id="streetViewImg" class="map-preview-img" alt="Street View preview" />
                            <div class="map-preview-actions">
                                <button class="btn-utility" onclick="App.openStreetView()">üö∂ Street View</button>
                            </div>
                        </div>
                        <div class="map-preview-item">
                            <div class="map-preview-label">Satellite View</div>
                            <img id="satelliteViewImg" class="map-preview-img" alt="Satellite preview" />
                            <div class="map-preview-actions">
                                <button class="btn-utility" onclick="App.openGoogleMaps()">üó∫Ô∏è Maps</button>
                                <button class="btn-utility" onclick="App.openGoogleEarth()">üõ∞Ô∏è Earth</button>
                            </div>
                        </div>
                    </div>
                    <div id="mapPreviewHint" class="hint">Enter an address to load previews.</div>
                </div>
            </div> <!-- end .prop-sidebar -->

          </div> <!-- end .prop-layout -->
        </div>

        <!-- STEP 4: VEHICLE & DRIVER INFO -->
        <div id="step-4" class="step hidden">
            <div class="card">
                <h2>Drivers</h2>
                <p class="section-subtitle">Add all household drivers (you can add more later)</p>
                
                <div id="driversList"></div>
                
                <button class="btn btn-secondary" style="margin-top: 12px;" onclick="App.addDriver()">+ Add Driver</button>
            </div>

            <div class="card">
                <h2>Vehicles</h2>
                <p class="section-subtitle">Add all vehicles to insure</p>
                
                <div id="vehiclesList"></div>
                
                <button class="btn btn-secondary" style="margin-top: 12px;" onclick="App.addVehicle()">+ Add Vehicle</button>
            </div>

            <div class="card">
                <h2>Driving History</h2>
                <p class="section-subtitle">Accidents, violations, and discounts</p>

                <label class="label">Accidents (Last 5 Years)</label>
                <textarea id="accidents" placeholder="Date, description, claim amount" rows="2"></textarea>

                <label class="label">Violations / Tickets (Last 3 Years)</label>
                <textarea id="violations" placeholder="Date, type of violation" rows="2"></textarea>

                <label class="label">Student GPA (if applicable)</label>
                <input type="text" id="studentGPA" placeholder="3.5">
            </div>

            <div class="card">
                <h2>Auto Coverage</h2>
                <p class="section-subtitle">Current auto insurance details</p>

                <div class="grid-2">
                    <div>
                        <label class="label">Auto Policy Type</label>
                        <select id="autoPolicyType">
                            <option value="Standard">Standard</option>
                            <option value="NonOwners">Non-Owners</option>
                            <option value="BroadForm">Broad Form</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Residence Is</label>
                        <select id="residenceIs">
                            <option value="">Select...</option>
                            <option value="Home (owned)">Home (Owned)</option>
                            <option value="Condo (owned)">Condo (Owned)</option>
                            <option value="Apartment">Apartment</option>
                            <option value="Rental Home/Condo">Rental Home / Condo</option>
                            <option value="Mobile Home">Mobile Home</option>
                            <option value="Live With Parents">Live With Parents</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label class="label">Bodily Injury Limits (BI)</label>
                        <select id="liabilityLimits">
                            <option value="">Select...</option>
                            <option value="State Minimum">State Minimum</option>
                            <option value="25/50">25/50 ($25k/$50k)</option>
                            <option value="50/50">50/50 ($50k/$50k)</option>
                            <option value="50/100">50/100 ($50k/$100k)</option>
                            <option value="100/100">100/100 ($100k/$100k)</option>
                            <option value="100/300">100/300 ($100k/$300k)</option>
                            <option value="250/500">250/500 ($250k/$500k)</option>
                            <option value="300/300">300/300 ($300k/$300k)</option>
                            <option value="500/500">500/500 ($500k/$500k)</option>
                            <option value="1000/1000">1000/1000 ($1M/$1M)</option>
                            <option value="55 CSL">55 CSL</option>
                            <option value="100 CSL">100 CSL</option>
                            <option value="300 CSL">300 CSL</option>
                            <option value="500 CSL">500 CSL</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Property Damage Limit (PD)</label>
                        <select id="pdLimit">
                            <option value="">Select...</option>
                            <option value="State Minimum">State Minimum</option>
                            <option value="10000">$10,000</option>
                            <option value="15000">$15,000</option>
                            <option value="25000">$25,000</option>
                            <option value="50000">$50,000</option>
                            <option value="100000">$100,000</option>
                            <option value="250000">$250,000</option>
                            <option value="500000">$500,000</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label class="label">Uninsured Motorist (UM)</label>
                        <select id="umLimits">
                            <option value="">Select...</option>
                            <option value="No Coverage">No Coverage</option>
                            <option value="State Minimum">State Minimum</option>
                            <option value="25/50">25/50</option>
                            <option value="50/50">50/50</option>
                            <option value="50/100">50/100</option>
                            <option value="100/100">100/100</option>
                            <option value="100/300">100/300</option>
                            <option value="250/500">250/500</option>
                            <option value="300/300">300/300</option>
                            <option value="500/500">500/500</option>
                            <option value="1000/1000">1000/1000</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Underinsured Motorist (UIM)</label>
                        <select id="uimLimits">
                            <option value="">Select...</option>
                            <option value="No Coverage">No Coverage</option>
                            <option value="State Minimum">State Minimum</option>
                            <option value="25/50">25/50</option>
                            <option value="50/50">50/50</option>
                            <option value="50/100">50/100</option>
                            <option value="100/100">100/100</option>
                            <option value="100/300">100/300</option>
                            <option value="250/500">250/500</option>
                            <option value="300/300">300/300</option>
                            <option value="500/500">500/500</option>
                            <option value="1000/1000">1000/1000</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label class="label">Comprehensive Deductible</label>
                        <select id="compDeductible">
                            <option value="">Select...</option>
                            <option value="No Coverage">No Coverage</option>
                            <option value="0">$0 (Full Glass)</option>
                            <option value="50">$50</option>
                            <option value="100">$100</option>
                            <option value="200">$200</option>
                            <option value="250">$250</option>
                            <option value="500">$500</option>
                            <option value="1000">$1,000</option>
                            <option value="2000">$2,000</option>
                            <option value="2500">$2,500</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Collision Deductible</label>
                        <select id="autoDeductible">
                            <option value="">Select...</option>
                            <option value="No Coverage">No Coverage</option>
                            <option value="0">$0</option>
                            <option value="50">$50</option>
                            <option value="100">$100</option>
                            <option value="200">$200</option>
                            <option value="250">$250</option>
                            <option value="500">$500</option>
                            <option value="1000">$1,000</option>
                            <option value="2000">$2,000</option>
                            <option value="2500">$2,500</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label class="label">Medical Payments</label>
                        <select id="medPayments">
                            <option value="">Select...</option>
                            <option value="No Coverage">No Coverage</option>
                            <option value="500">$500</option>
                            <option value="1000">$1,000</option>
                            <option value="2000">$2,000</option>
                            <option value="2500">$2,500</option>
                            <option value="5000">$5,000</option>
                            <option value="10000">$10,000</option>
                            <option value="25000">$25,000</option>
                            <option value="50000">$50,000</option>
                            <option value="100000">$100,000</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">UM Property Damage</label>
                        <select id="umpdLimit">
                            <option value="">Select...</option>
                            <option value="No Coverage">No Coverage</option>
                            <option value="State Minimum">State Minimum</option>
                            <option value="10000">$10,000</option>
                            <option value="25000">$25,000</option>
                            <option value="50000">$50,000</option>
                            <option value="100000">$100,000</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label class="label">Rental Reimbursement</label>
                        <select id="rentalDeductible">
                            <option value="">Select...</option>
                            <option value="No Coverage">No Coverage</option>
                            <option value="20/600">$20/day, $600 max</option>
                            <option value="30/900">$30/day, $900 max</option>
                            <option value="40/1200">$40/day, $1200 max</option>
                            <option value="50/1500">$50/day, $1500 max</option>
                            <option value="75/2250">$75/day, $2250 max</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Towing & Labor</label>
                        <select id="towingDeductible">
                            <option value="">Select...</option>
                            <option value="No Coverage">No Coverage</option>
                            <option value="50">$50</option>
                            <option value="75">$75</option>
                            <option value="100">$100</option>
                            <option value="200">$200</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 5: INSURANCE HISTORY & ADDITIONAL INFO -->
        <div id="step-5" class="step hidden">
            <div class="card">
                <h2>Policy Details</h2>
                <p class="section-subtitle">Requested policy information</p>

                <div class="grid-2">
                    <div>
                        <label class="label">Requested Policy Term</label>
                        <select id="policyTerm">
                            <option value="">Select...</option>
                            <option value="6 Month">6 Month</option>
                            <option value="12 Month">12 Month</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Requested Effective Date</label>
                        <input type="date" id="effectiveDate">
                    </div>
                </div>
            </div>

            <!-- Home Insurance History (visible for home/both) -->
            <div class="card qtype-home-prior" id="homePriorCard">
                <h2>Home Insurance History</h2>
                <p class="section-subtitle">Your current homeowners / property coverage</p>

                <div class="grid-2">
                    <div>
                        <label class="label">Prior Home Carrier</label>
                        <select id="homePriorCarrier">
                            <option value="">Select carrier...</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Prior Home Policy Term</label>
                        <select id="homePriorPolicyTerm">
                            <option value="">Select...</option>
                            <option value="6 Month">6 Month</option>
                            <option value="12 Month">12 Month</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label class="label">Prior Liability Level</label>
                        <select id="homePriorLiability">
                            <option value="">Select...</option>
                            <option value="Greater than $300,000">Greater than $300,000</option>
                            <option value="$300,000">$300,000</option>
                            <option value="Less than $300,000">Less than $300,000</option>
                            <option value="First Time Home Buyer">First Time Home Buyer</option>
                            <option value="Lapse in Coverage (30 days or less)">Lapse in Coverage (30 days or less)</option>
                            <option value="No Prior or Lapse Greater Than 30 Days">No Prior or Lapse &gt; 30 Days</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Years with Prior Carrier</label>
                        <select id="homePriorYears">
                            <option value="">Select...</option>
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="More than 15">More than 15</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div><label class="label">Prior Home Policy Expiration</label><input type="date" id="homePriorExp"></div>
                </div>
            </div>

            <!-- Auto Insurance History (visible for auto/both) -->
            <div class="card qtype-auto-prior" id="autoPriorCard">
                <h2>Auto Insurance History</h2>
                <p class="section-subtitle">Your current auto coverage</p>

                <div class="grid-2">
                    <div>
                        <label class="label">Prior Auto Carrier</label>
                        <select id="priorCarrier">
                            <option value="">Select carrier...</option>
                        </select>
                        <label class="same-carrier-row">
                            <input type="checkbox" id="sameAsHomeCarrier" onchange="App.handleSameCarrier()">
                            <span>Same as Home Carrier</span>
                        </label>
                    </div>
                    <div>
                        <label class="label">Prior Auto Policy Term</label>
                        <select id="priorPolicyTerm">
                            <option value="">Select...</option>
                            <option value="6 Month">6 Month</option>
                            <option value="12 Month">12 Month</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label class="label">Prior Liability Limits</label>
                        <select id="priorLiabilityLimits">
                            <option value="">Select...</option>
                            <option value="State Minimum">State Minimum</option>
                            <option value="25/50">25/50</option>
                            <option value="50/50">50/50</option>
                            <option value="50/100">50/100</option>
                            <option value="100/100">100/100</option>
                            <option value="100/300">100/300</option>
                            <option value="250/500">250/500</option>
                            <option value="300/300">300/300</option>
                            <option value="500/500">500/500</option>
                            <option value="1000/1000">1000/1000</option>
                            <option value="55CSL">55 CSL</option>
                            <option value="100CSL">100 CSL</option>
                            <option value="300CSL">300 CSL</option>
                            <option value="500CSL">500 CSL</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Years with Prior Carrier</label>
                        <select id="priorYears">
                            <option value="">Select...</option>
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="More than 15">More than 15</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label class="label">Years with Continuous Coverage</label>
                        <select id="continuousCoverage">
                            <option value="">Select...</option>
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="More than 15">More than 15</option>
                        </select>
                    </div>
                    <div><label class="label">Prior Auto Policy Expiration</label><input type="date" id="priorExp"></div>
                </div>
            </div>

            <div class="card">
                <h2>Additional Information</h2>
                <p class="section-subtitle">Help us serve you better</p>

                <label class="label">Additional Insured Parties</label>
                <textarea id="additionalInsureds" placeholder="Names and relationships" rows="2"></textarea>

                <label class="label">Best Time to Contact</label>
                <select id="contactTime">
                    <option value="">Select...</option>
                    <option value="Morning">Morning</option>
                    <option value="Afternoon">Afternoon</option>
                    <option value="Evening">Evening</option>
                    <option value="Anytime">Anytime</option>
                </select>

                <label class="label">Preferred Contact Method</label>
                <select id="contactMethod">
                    <option value="">Select...</option>
                    <option value="Mobile Phone">Mobile Phone</option>
                    <option value="Email">Email</option>
                </select>

                <label class="label">How did you hear about us?</label>
                <select id="referralSource">
                    <option value="">Select...</option>
                    <option value="Google Search">Google Search</option>
                    <option value="Social Media">Social Media</option>
                    <option value="Referral">Referral from Friend/Family</option>
                    <option value="Advertisement">Advertisement</option>
                    <option value="Other">Other</option>
                </select>

                <div class="consent-row">
                    <label class="checkbox-row">
                        <input type="checkbox" id="tcpaConsent">
                        <span>I consent to receive communications via phone, text, and email regarding insurance quotes and services.</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Shared datalist for Prior Carrier fields (auto + home) -->
        <datalist id="carrierList">
            <option value="Other Standard">
            <option value="Other Non-Standard">
            <option value="No Prior Insurance">
            <option value="1st Auto">
            <option value="21st Century">
            <option value="A.Central">
            <option value="AAA">
            <option value="AARP">
            <option value="Acadia">
            <option value="Acceptance Insurance">
            <option value="Access General">
            <option value="Ace">
            <option value="Acuity">
            <option value="Adirondack Ins Exchange">
            <option value="Aegis">
            <option value="Affirmative">
            <option value="Ag Workers Mutual Auto">
            <option value="AIC">
            <option value="AIG">
            <option value="Alert Auto Insurance Company">
            <option value="Alfa Alliance">
            <option value="Alinsco">
            <option value="Allied Trust Insurance Company">
            <option value="Allied">
            <option value="Allstate">
            <option value="America First">
            <option value="American Commerce">
            <option value="American Family">
            <option value="American Freedom Insurance Company">
            <option value="American National">
            <option value="Amerisure">
            <option value="Amica">
            <option value="AmShield">
            <option value="AmWINS Star">
            <option value="Anchor General">
            <option value="Arrowhead Everest">
            <option value="Arrowhead">
            <option value="ASI Lloyds">
            <option value="ASI Select Auto Insurance Corp">
            <option value="Aspen">
            <option value="Aspire">
            <option value="AssuranceAmerica">
            <option value="Atlantic Mutual">
            <option value="Austin Mutual">
            <option value="Autoone">
            <option value="Auto-Owners">
            <option value="AutoTex">
            <option value="Badger Mutual">
            <option value="Balboa">
            <option value="Bankers">
            <option value="Beacon National">
            <option value="Bear River Mutual">
            <option value="Brethern Mutual">
            <option value="Bristol West">
            <option value="Buckeye">
            <option value="California Casualty">
            <option value="Cameron Mutual">
            <option value="Capital Insurance Group">
            <option value="Capitol Insurance Company">
            <option value="Casualty Underwriters Insurance Company">
            <option value="Celina">
            <option value="Centennial">
            <option value="Central Mutual of OH">
            <option value="Century National">
            <option value="Charter">
            <option value="Chubb">
            <option value="Cincinnati Casualty">
            <option value="Cincinnati Insurance">
            <option value="Citizens">
            <option value="Clearcover">
            <option value="CNA">
            <option value="Colonial Penn">
            <option value="Colorado Casualty">
            <option value="Columbia">
            <option value="Commerce West">
            <option value="Commonwealth">
            <option value="Concord Group Insurance">
            <option value="Connect Banner">
            <option value="Constitutional Casualty">
            <option value="Consumers">
            <option value="Cornerstone">
            <option value="Country Insurance">
            <option value="Countryway Insurance">
            <option value="Countrywide">
            <option value="Cover Insurance">
            <option value="CSE">
            <option value="Cumberland">
            <option value="Dairyland">
            <option value="Deerbrook">
            <option value="Delta Lloyds Insurance Company">
            <option value="Depositors">
            <option value="Direct General">
            <option value="Direct">
            <option value="Discovery">
            <option value="Donegal">
            <option value="Drive">
            <option value="Electric">
            <option value="Elephant Insurance">
            <option value="Embark General">
            <option value="EMC">
            <option value="Empower">
            <option value="Encompass">
            <option value="Encova Exceed">
            <option value="Enumclaw Insurance">
            <option value="Erie">
            <option value="Esurance">
            <option value="Eveready">
            <option value="Explorer">
            <option value="Farm Bureau">
            <option value="Farmers">
            <option value="Federated">
            <option value="Fidelity">
            <option value="Financial Indemnity">
            <option value="Firemans Fund">
            <option value="First Acceptance">
            <option value="First American">
            <option value="First Auto">
            <option value="First Chicago">
            <option value="First Connect">
            <option value="Fitchburg Mutual">
            <option value="Flagship Insurance">
            <option value="Foremost">
            <option value="Founders">
            <option value="Frankenmuth">
            <option value="Fred Loya">
            <option value="Fremont Insurance">
            <option value="GAINSCO Auto Insurance">
            <option value="Gateway">
            <option value="Geico">
            <option value="General Casualty">
            <option value="Germania Insurance">
            <option value="Germantown Mutual">
            <option value="GMAC">
            <option value="Goodville Mutual">
            <option value="Grange Insurance Association">
            <option value="Grange">
            <option value="GRE/Go America">
            <option value="Great American">
            <option value="Grinnell">
            <option value="Guide One">
            <option value="Hallmark Insurance Company">
            <option value="Hanover">
            <option value="Harbor">
            <option value="Harleysville">
            <option value="Hartford OMNI">
            <option value="Hartford">
            <option value="Hastings Mutual">
            <option value="Haulers Insurance Company">
            <option value="Hawkeye Security">
            <option value="HDI">
            <option value="Hochheim Prairie Insurance">
            <option value="Horace Mann">
            <option value="Houston General">
            <option value="IFA">
            <option value="Imperial Casualty">
            <option value="IMT Ins">
            <option value="Indiana Farmers">
            <option value="Indiana">
            <option value="Infinity">
            <option value="Insuremax">
            <option value="Insurequest">
            <option value="Integon">
            <option value="Integrity">
            <option value="Iowa Mutual Insurance Company">
            <option value="Kemper Specialty">
            <option value="Kemper">
            <option value="Kingsway">
            <option value="Legacy - Arizona Auto Ins. Co">
            <option value="LeMars Insurance">
            <option value="Liberty Mutual">
            <option value="Liberty Northwest">
            <option value="Madison Mutual Insurance Company">
            <option value="Maidstone Insurance">
            <option value="MAIF">
            <option value="Main Street America">
            <option value="Mapfre">
            <option value="Markel">
            <option value="Maryland Auto Insurance">
            <option value="Mendakota">
            <option value="Mendota">
            <option value="Merchants Group">
            <option value="Mercury">
            <option value="MetLife">
            <option value="Metropolitan">
            <option value="Michigan Insurance Company">
            <option value="Michigan Millers Mutual Insurance Company">
            <option value="Mid-Continent">
            <option value="Midwestern Indemnity">
            <option value="Mile Auto">
            <option value="MMG Insurance Company">
            <option value="Montgomery">
            <option value="Motor Club Insurance Company">
            <option value="Motorists Mutual">
            <option value="MSA">
            <option value="Mt. Washington">
            <option value="Mutual Benefit">
            <option value="Mutual of Enumclaw">
            <option value="National General">
            <option value="National Lloyds Insurance Company">
            <option value="Nationwide">
            <option value="New York Central Mutual">
            <option value="NJ Manufacturers">
            <option value="NJ Skylands">
            <option value="NLC Insurance Companies">
            <option value="Nodak Mutual">
            <option value="Northern Neck Insurance Company">
            <option value="Northstar">
            <option value="NYAIP">
            <option value="NYCM Standard">
            <option value="Occidental">
            <option value="Ocean Harbor">
            <option value="Ohio Casualty">
            <option value="Ohio Mutual">
            <option value="Omaha P/C">
            <option value="Omni Insurance Co">
            <option value="One Beacon">
            <option value="Oregon Mutual">
            <option value="Palisades">
            <option value="Partners Mutual Insurance">
            <option value="Patriot">
            <option value="Patrons Oxford">
            <option value="Peerless/Montgomery">
            <option value="Pekin">
            <option value="Pemco">
            <option value="Peninsula Insurance Companies">
            <option value="Penn National">
            <option value="Personal Service Insurance">
            <option value="Phoenix Indemnity">
            <option value="Pioneer State Mutual">
            <option value="Plymouth Rock">
            <option value="Preferred Mutual">
            <option value="Proformance">
            <option value="Progressive">
            <option value="Providence Mutual Fire Insurance Company">
            <option value="Prudential">
            <option value="QBE">
            <option value="Quincy Mutual">
            <option value="RAM Mutual Insurance Company">
            <option value="Republic">
            <option value="Response">
            <option value="Rockford Mutual">
            <option value="Rockingham Casualty Company">
            <option value="Royal and Sun Alliance">
            <option value="Safe Auto">
            <option value="Safeco">
            <option value="Safety Insurance Company">
            <option value="Safeway">
            <option value="Sagamore">
            <option value="SECURA">
            <option value="Selective">
            <option value="Sentry Ins">
            <option value="Sheboygan Falls Insurance">
            <option value="Shelter Insurance">
            <option value="Southern County">
            <option value="Southern Mutual">
            <option value="Southern Trust">
            <option value="St. Paul/Travelers">
            <option value="Standard Mutual">
            <option value="Star Casualty">
            <option value="State Auto">
            <option value="State Farm">
            <option value="StillWater">
            <option value="Stonegate">
            <option value="Sublimity Insurance Company">
            <option value="Sun Coast Platinum">
            <option value="Texas Ranger MGA">
            <option value="The General">
            <option value="Titan">
            <option value="Topa">
            <option value="Tower">
            <option value="Travelers">
            <option value="TWFG">
            <option value="Unigard">
            <option value="United Automobile">
            <option value="United Fire and Casualty">
            <option value="United Heritage Property and Casualty Company">
            <option value="United Home">
            <option value="Unitrin">
            <option value="Universal">
            <option value="USAA">
            <option value="Utica National">
            <option value="Victoria">
            <option value="Wadena Insurance Company">
            <option value="Wayne Mutual Insurance Company">
            <option value="West Bend">
            <option value="Western National">
            <option value="Western Reserve Group">
            <option value="Westfield">
            <option value="White Mountains">
            <option value="Wilshire">
            <option value="Wilson Mutual">
            <option value="Wind Haven">
            <option value="Windsor">
            <option value="Wisconsin Mutual">
            <option value="Wolverine Mutual Insurance Company">
            <option value="Workmens Auto Insurance Company">
            <option value="Worth Casualty Insurance Company">
            <option value="Zurich">
        </datalist>

        <!-- STEP 6: REVIEW & EXPORT -->
        <div id="step-6" class="step hidden">
            <div class="card">
                <h2>‚úì Application Complete</h2>
                <p class="section-subtitle">Export this client's data or restore a previous client</p>
            </div>

            <!-- Export Actions -->
            <div class="card export-card hero-export" id="ezlynx-export-card">
                <h3>Ready to Export?</h3>
                <p class="hero-desc">Send your intake data straight into EZLynx, download a PDF summary, or export to HawkSoft.</p>
                <button class="hero-btn" onclick="App.launchEZLynxFromExport()">‚ö° Auto-Fill EZLynx</button>
                <p class="hero-hint">Opens EZLynx and fills the new-applicant form automatically</p>
            </div>

            <!-- Prominent export buttons row -->
            <div class="export-btn-row">
                <button class="export-action-btn pdf-btn" onclick="App.exportPDF()">
                    <span class="export-action-icon">üìÑ</span>
                    <span class="export-action-label">Download PDF</span>
                </button>
                <button class="export-action-btn hawksoft-btn" onclick="App.navigateTo('hawksoft')">
                    <span class="export-action-icon">üì§</span>
                    <span class="export-action-label">HawkSoft Export</span>
                </button>
            </div>

            <!-- Client History (auto-saved) -->
            <div class="card export-card">
                <div class="ch-header">
                    <h3 style="margin:0;">üë§ Client History</h3>
                </div>
                <p class="section-subtitle" style="margin-bottom:12px;">Clients are saved automatically ‚Äî restore any previous client instantly</p>
                <div id="clientHistoryList"></div>
            </div>

            <!-- Export History -->
            <div class="card export-card">
                <details id="exportHistoryDetails">
                    <summary class="export-summary" onclick="App.loadExportHistory()">
                        <span>üìã Export History</span>
                    </summary>
                    <div id="exportHistoryList" style="margin-top:12px;font-size:13px;color:var(--text-secondary);">
                        <p>Loading...</p>
                    </div>
                </details>
            </div>
        </div>
    </main>

    <!-- Data Preview Modal Container -->
    <div id="modalContainer"></div>

    <footer>
        <button id="btnBack" class="btn btn-step-back" onclick="App.prev()">‚Üê Previous Step</button>
        <button id="btnNext" class="btn btn-primary" onclick="App.next()">Next</button>
    </footer>

    <div id="toast" class="toast">Message</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>if(window.pdfjsLib){pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';}</script>
    <script>
        // Load Google Places API dynamically with key from server or environment (optional - form works without it)
        (async function loadPlacesAPI() {
            try {
                let apiKey = null;
                
                // Try fetching from server endpoint first (Vercel production)
                try {
                    const res = await fetch('/api/places-config.js');
                    if (res.ok) {
                        const data = await res.json();
                        apiKey = data.apiKey;
                    }
                } catch (e) {
                    // Server endpoint not available, try alternative methods
                }
                
                // If no key from server, try checking window for injected key
                if (!apiKey && window.__PLACES_API_KEY__) {
                    apiKey = window.__PLACES_API_KEY__;
                }
                
                // If still no key, check if it was passed as query parameter (local dev)
                if (!apiKey && window.location.search) {
                    const params = new URLSearchParams(window.location.search);
                    apiKey = params.get('placesKey');
                }
                
                if (!apiKey) {
                    console.info('‚ÑπÔ∏è Google Places API not configured - address autocomplete disabled. For local dev, set PLACES_API_KEY env var or add ?placesKey=... to URL');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initPlaces`;
                script.async = true;
                script.defer = true;
                script.onerror = () => console.warn('‚ö†Ô∏è Places API script failed to load - address autocomplete disabled');
                document.head.appendChild(script);
                console.info('‚úì Places API loaded');
            } catch (err) {
                console.warn('‚ÑπÔ∏è Places API not available:', err.message);
            }
        })();
    </script>
    <script src="js/crypto-helper.js"></script>
    <script>
        const App = {
            data: {},
            step: 0,
            flow: [],
            storageKey: 'altech_v6',
            quotesKey: 'altech_v6_quotes',
            docIntelKey: 'altech_v6_docintel',
            scanFiles: [],
            extractedData: null,
            encryptionEnabled: true, // Toggle encryption on/off
            drivers: [], // Array of driver objects
            vehicles: [], // Array of vehicle objects
            selectedQuoteIds: new Set(),
            docIntelFiles: [],
            docIntelResults: null,
            initialDlScan: null,
            mapApiKey: null,
            mapPreviewCache: {},
            mapPreviewTimer: null,
            saveTimeout: null,
            saveToken: 0,
            
            workflows: {
                home: ['step-0', 'step-1', 'step-2', 'step-3', 'step-5', 'step-6'],
                auto: ['step-0', 'step-1', 'step-2', 'step-4', 'step-5', 'step-6'],
                both: ['step-0', 'step-1', 'step-2', 'step-3', 'step-4', 'step-5', 'step-6']
            },

            toolNames: {
                quoting: 'Personal Intake',
                coi: 'COI Generator',
                prospect: 'Prospect Investigator',
                compliance: 'CGL Compliance',
                qna: 'Policy Q&A',
                email: 'Email Composer',
                quickref: 'Quick Reference',
                accounting: 'Accounting Export',
                ezlynx: 'EZLynx Quoter',
                quotecompare: 'Quote Compare'
            },

            // Config-driven tool registry ‚Äî single source of truth for landing page,
            // navigation, breadcrumbs, and init logic. Add/remove/reorder tools here.
            toolConfig: [
                // ‚îÄ‚îÄ Quoting & Sales ‚îÄ‚îÄ
                { key: 'quoting',      icon: 'üè†', color: 'icon-blue',    title: 'Personal Lines',  name: 'Personal Intake',       containerId: 'quotingTool',      category: 'quoting' },
                { key: 'qna',          icon: 'üí¨', color: 'icon-rose',    title: 'Policy Q&A',      name: 'Policy Q&A',            containerId: 'qnaTool',          initModule: 'PolicyQA',          htmlFile: 'plugins/qna.html',         category: 'quoting' },
                { key: 'quotecompare', icon: '‚öñÔ∏è', color: 'icon-emerald', title: 'Quote Compare',   name: 'Quote Compare',          containerId: 'quoteCompareTool', initModule: 'QuoteCompare',      htmlFile: 'plugins/quotecompare.html', category: 'quoting' },
                // ‚îÄ‚îÄ Documents & Compliance ‚îÄ‚îÄ
                { key: 'coi',          icon: 'üìã', color: 'icon-teal',    title: 'COI Generator',   name: 'COI Generator',          containerId: 'coiTool',          initModule: 'COI',               htmlFile: 'plugins/coi.html',         category: 'docs' },
                { key: 'compliance',   icon: 'üõ°Ô∏è', color: 'icon-indigo',  title: 'CGL & Bonds',     name: 'CGL Compliance',         containerId: 'complianceTool',   initModule: 'ComplianceDashboard', badge: 'cglBadge', htmlFile: 'plugins/compliance.html', category: 'docs' },
                { key: 'reminders',    icon: '‚è∞', color: 'icon-orange',  title: 'Reminders',       name: 'Task Reminders',         containerId: 'remindersTool',    initModule: 'Reminders',           badge: 'remindersBadge', htmlFile: 'plugins/reminders.html', category: 'docs' },
                // ‚îÄ‚îÄ Operations ‚îÄ‚îÄ
                { key: 'prospect',     icon: 'üîç', color: 'icon-amber',   title: 'Prospect Intel',  name: 'Prospect Investigator',  containerId: 'prospectTool',     initModule: 'ProspectInvestigator', htmlFile: 'plugins/prospect.html', category: 'ops' },
                { key: 'email',        icon: '‚úâÔ∏è', color: 'icon-violet',  title: 'Email Composer',  name: 'Email Composer',         containerId: 'emailTool',        initModule: 'EmailComposer',     htmlFile: 'plugins/email.html',       category: 'ops' },
                { key: 'accounting',   icon: 'üí∞', color: 'icon-amber',   title: 'Accounting',      name: 'Accounting Export',      containerId: 'accountingTool',   initModule: 'AccountingExport',  htmlFile: 'plugins/accounting.html',  category: 'ops' },
                { key: 'hawksoft',     icon: 'üì§', color: 'icon-blue',    title: 'HawkSoft Export', name: 'HawkSoft Export',        containerId: 'hawksoftTool',     initModule: 'HawkSoftExport',    htmlFile: 'plugins/hawksoft.html',    category: 'ops' },
                { key: 'quickref',     icon: 'üìñ', color: 'icon-teal',    title: 'Quick Reference', name: 'Quick Reference',        containerId: 'quickrefTool',     initModule: 'QuickRef',          htmlFile: 'plugins/quickref.html',    category: 'ops' },
                { key: 'vindecoder',   icon: 'üöó', color: 'icon-emerald', title: 'VIN Decoder',     name: 'VIN Decoder',            containerId: 'vinDecoderTool',   initModule: 'VinDecoder',        htmlFile: 'plugins/vin-decoder.html', category: 'ops' },
                // ‚îÄ‚îÄ Hidden / internal ‚îÄ‚îÄ
                { key: 'ezlynx',       icon: 'üìä', color: 'icon-blue',    title: 'EZLynx Quoter',   name: 'EZLynx Quoter',          containerId: 'ezlynxTool',       initModule: 'EZLynxTool',        htmlFile: 'plugins/ezlynx.html',     hidden: true },
                // ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                // ‚îÇ  ADD NEW TOOLS HERE                                        ‚îÇ
                // ‚îÇ  Copy a line above and set: key, icon, color, title,    ‚îÇ
                // ‚îÇ  name, containerId, initModule, category                ‚îÇ
                // ‚îÇ  Categories: 'quoting' | 'docs' | 'ops' | 'ref'        ‚îÇ
                // ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ],

            stepTitles: {
                'step-0': 'Policy Scan',
                'step-1': 'Personal Information',
                'step-2': 'Coverage Type',
                'step-3': 'Property Details',
                'step-4': 'Vehicle & Driver Info',
                'step-5': 'Risk Factors & Additional Info',
                'step-6': 'Review & Export'
            },

            async init() {
                console.log('[App.init] Starting...');
                try {
                // Load dark mode preference
                this.loadDarkMode();

                // Detect Tauri desktop environment
                this.isDesktop = !!(window.__TAURI__ || window.__TAURI_IPC__);

                try { await this.load(); } catch(e) { console.error('[App.init] load() failed:', e); }
                try { await this.loadDocIntelResults(); } catch(e) { console.error('[App.init] loadDocIntelResults() failed:', e); }
                try { await this.loadDriversVehicles(); } catch(e) { console.error('[App.init] loadDriversVehicles() failed:', e); }
                this.handleType(); // Set initial flow ‚Äî MUST run
                console.log('[App.init] handleType done, flow:', this.flow, 'step:', this.step);
                this.updateScanCoverage();
                this.calculateResidenceTime(); // Show residence time if purchaseDate loaded
                try { await this.renderQuoteList(); } catch(e) { console.error('[App.init] renderQuoteList() failed:', e); }
                try { this.renderClientHistory(); } catch(e) { console.error('[App.init] renderClientHistory() failed:', e); }

                // Resolve Gemini API key for local scanning (shared across App + PolicyQA)
                if (!this._geminiApiKey) {
                    const savedKey = localStorage.getItem('gemini_api_key');
                    if (savedKey) {
                        this._geminiApiKey = savedKey;
                    }
                    // Key must be set via localStorage('gemini_api_key') or server env var.
                    // No longer falls back to api/config.json (security: never serve keys as static files).
                }

                // Desktop-specific branding
                if (this.isDesktop) {
                    document.body.classList.add('tauri-desktop');
                    const brand = document.querySelector('.logo > span:last-child');
                    if (brand) {
                        brand.textContent = 'PolicyPilot';
                        const badge = document.createElement('span');
                        badge.className = 'desktop-badge';
                        badge.textContent = 'Desktop';
                        brand.appendChild(badge);
                    }

                    // Show scan drop zone in Step 0
                    const scanDrop = document.getElementById('scanDropZone');
                    if (scanDrop) {
                        scanDrop.style.display = '';
                        scanDrop.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; scanDrop.classList.add('drag-over'); });
                        scanDrop.addEventListener('dragleave', () => scanDrop.classList.remove('drag-over'));
                        scanDrop.addEventListener('drop', (e) => { e.preventDefault(); scanDrop.classList.remove('drag-over'); });
                        scanDrop.addEventListener('click', () => this.openScanPicker());
                    }
                    // Tauri native drag-drop listener for Step 0 policy scan
                    if (window.__TAURI__?.event?.listen) {
                        window.__TAURI__.event.listen('tauri://drag-drop', async (event) => {
                            // Only handle if Step 0 is active (PolicyQA has its own handler)
                            const step0 = document.getElementById('step-0');
                            if (!step0 || step0.style.display === 'none' || step0.classList.contains('hidden')) return;
                            // Skip if PolicyQA tool is active
                            const qnaTool = document.getElementById('qnaTool');
                            if (qnaTool && qnaTool.style.display !== 'none') return;

                            const paths = event.payload?.paths;
                            if (!paths?.length) return;

                            const status = document.getElementById('scanStatus');
                            if (status) { status.classList.remove('hidden'); status.textContent = '‚è≥ Processing dropped file...'; }

                            for (const filePath of paths) {
                                const fileName = filePath.split('\\').pop().split('/').pop();
                                console.log('[Step0 Drop] Processing:', fileName);
                                try {
                                    const text = await window.__TAURI__.core.invoke('process_policy_file', { filePath });
                                    if (text && !text.startsWith('Error:') && !text.startsWith('Execution failed:')) {
                                        // Create a fake File object with the extracted text for processScan to handle
                                        // For images/PDFs dropped via Tauri, we use direct Gemini with the raw file
                                        const ext = fileName.split('.').pop().toLowerCase();
                                        if (['pdf'].includes(ext)) {
                                            // PDF: text was extracted by Python ‚Äî show it and auto-scan if Gemini key available
                                            if (status) status.textContent = `‚úÖ Extracted ${text.length} chars from ${fileName}. Processing with AI...`;
                                            // Use text directly ‚Äî feed to Gemini for structured extraction
                                            await this.processScanFromText(text, fileName);
                                        } else {
                                            if (status) status.textContent = `‚úÖ ${fileName} processed (${text.length} chars)`;
                                        }
                                        this.toast(`‚úÖ ${fileName} processed`);
                                    } else {
                                        if (status) status.textContent = `‚ö†Ô∏è Could not extract text from ${fileName}`;
                                    }
                                } catch (err) {
                                    console.error('[Step0 Drop] Error:', err);
                                    if (status) status.textContent = `‚ö†Ô∏è ${err.message || err}`;
                                }
                            }
                        });
                    }
                }

                // Browser (non-Tauri): also show scan drop zone on desktop browsers
                if (!this.isDesktop) {
                    const scanDrop = document.getElementById('scanDropZone');
                    if (scanDrop && window.matchMedia('(pointer: fine)').matches) {
                        scanDrop.style.display = '';
                        scanDrop.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; scanDrop.classList.add('drag-over'); });
                        scanDrop.addEventListener('dragleave', () => scanDrop.classList.remove('drag-over'));
                        scanDrop.addEventListener('drop', (e) => {
                            e.preventDefault();
                            scanDrop.classList.remove('drag-over');
                            if (e.dataTransfer?.files?.length) {
                                // Feed dropped files into the existing scan pipeline
                                const scanInput = document.getElementById('policyScanInput');
                                if (scanInput) {
                                    // DataTransfer can't be assigned to input; trigger handleScanFiles directly
                                    this.handleScanFiles({ target: { files: e.dataTransfer.files } });
                                }
                            }
                        });
                        scanDrop.addEventListener('click', () => this.openScanPicker());
                    }
                }

                const scanInput = document.getElementById('policyScanInput');
                if (scanInput) {
                    scanInput.addEventListener('change', (e) => this.handleScanFiles(e));
                }

                const initialDlInput = document.getElementById('initialDlScanInput');
                if (initialDlInput) {
                    initialDlInput.addEventListener('change', (e) => this.handleInitialDriverLicenseFile(e.target.files[0]));
                }

                const docIntelInput = document.getElementById('docIntelInput');
                if (docIntelInput) {
                    docIntelInput.addEventListener('change', (e) => this.handleDocIntelFiles(e));
                }
                
                // Auto-save listeners ‚Äî use event delegation (one listener, not 200+)
                document.body.addEventListener('input', (e) => {
                    if (e.target.matches('#quotingTool input, #quotingTool select, #quotingTool textarea')) {
                        this.clearAutoFilledIndicator(e.target);
                        this.save(e);
                    }
                });
                document.body.addEventListener('change', (e) => {
                    if (e.target.matches('#quotingTool input, #quotingTool select, #quotingTool textarea')) {
                        this.clearAutoFilledIndicator(e.target);
                        this.save(e);
                    }
                });

                // Carrier autocomplete
                this.initCarrierAutocomplete();

                // Sync "Same as Home Carrier" when home carrier changes
                const _homeCarrierInput = document.getElementById('homePriorCarrier');
                if (_homeCarrierInput) {
                    _homeCarrierInput.addEventListener('change', () => {
                        const cb = document.getElementById('sameAsHomeCarrier');
                        if (cb && cb.checked) this.handleSameCarrier();
                    });
                }

                // Restore sameAsHomeCarrier checkbox state from data
                const _sameCarrierCb = document.getElementById('sameAsHomeCarrier');
                if (_sameCarrierCb && this.data.sameAsHomeCarrier) {
                    _sameCarrierCb.checked = true;
                    this.handleSameCarrier();
                }

                // Validate years with carrier vs continuous coverage
                const _priorYearsEl = document.getElementById('priorYears');
                const _contCovEl = document.getElementById('continuousCoverage');
                if (_priorYearsEl) _priorYearsEl.addEventListener('change', () => this.validatePriorYearsCoverage());
                if (_contCovEl) _contCovEl.addEventListener('change', () => this.validatePriorYearsCoverage());
                document.body.addEventListener('blur', (e) => {
                    if (!e.target.matches('#quotingTool input, #quotingTool select, #quotingTool textarea')) return;
                    if (typeof Validation === 'undefined') return;
                    const id = e.target.id;
                    
                    // Field-specific validation
                    let result;
                    switch(id) {
                        case 'email':
                                result = Validation.email(e.target.value);
                                break;
                            case 'phone':
                                result = Validation.phone(e.target.value);
                                break;
                            case 'dob':
                                result = Validation.dob(e.target.value);
                                break;
                            case 'addrState':
                                result = Validation.stateCode(e.target.value);
                                break;
                            case 'addrZip':
                                result = Validation.zipCode(e.target.value);
                                break;
                            case 'yrBuilt':
                            case 'roofYr':
                            case 'heatYr':
                                result = Validation.year(e.target.value, 'Year');
                                break;
                            case 'firstName':
                            case 'lastName':
                                result = Validation.required(e.target.value, e.target.previousElementSibling?.textContent || 'This field');
                                break;
                        }
                        
                        if (result) {
                            if (result.valid) {
                                Validation.clearError(id);
                            } else {
                                Validation.showError(id, result.message);
                            }
                        }
                }, true); // capture phase for blur
                // Phone format
                document.getElementById('phone').addEventListener('input', this.fmtPhone);

                // Segmented control click handler
                document.body.addEventListener('click', (e) => {
                    const btn = e.target.closest('.seg-btn');
                    if (!btn) return;
                    const group = btn.closest('.seg-group');
                    if (!group) return;
                    const fieldId = group.dataset.field;
                    const hidden = document.getElementById(fieldId);
                    if (!hidden) return;
                    group.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('seg-active'));
                    btn.classList.add('seg-active');
                    hidden.value = btn.dataset.value;
                    hidden.dispatchEvent(new Event('change', { bubbles: true }));
                });

                // iOS toggle switch handler
                document.body.addEventListener('change', (e) => {
                    const toggle = e.target.closest('[data-toggle-field]');
                    if (!toggle) return;
                    const fieldId = toggle.dataset.toggleField;
                    const hidden = document.getElementById(fieldId);
                    if (!hidden) return;
                    hidden.value = toggle.checked ? 'Yes' : '';
                    hidden.dispatchEvent(new Event('change', { bubbles: true }));
                });

                // Secondary heating progressive disclosure
                const secHeatCheck = document.getElementById('hasSecondaryHeating');
                const secHeatWrap = document.getElementById('secondaryHeatingWrapper');
                if (secHeatCheck && secHeatWrap) {
                    secHeatCheck.addEventListener('change', () => {
                        secHeatWrap.classList.toggle('disclosure-hidden', !secHeatCheck.checked);
                    });
                }

                // Earthquake coverage progressive disclosure
                const eqWrap = document.getElementById('earthquakeDetailsWrapper');
                if (eqWrap) {
                    document.body.addEventListener('change', (e) => {
                        const toggle = e.target.closest('[data-toggle-field="earthquakeCoverage"]');
                        if (!toggle) return;
                        eqWrap.classList.toggle('disclosure-hidden', !toggle.checked);
                    });
                }

                // Map previews: update when address fields change
                ['addrStreet', 'addrCity', 'addrState', 'addrZip'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', () => this.scheduleMapPreviewUpdate());
                        el.addEventListener('change', () => this.scheduleMapPreviewUpdate());
                    }
                });

                // Initial preview render if address already exists
                this.updateMapPreviews();

                this.initialized = true;
                console.log('[App.init] Complete. flow:', this.flow.length, 'steps');
                } catch(initErr) {
                    console.error('[App.init] FATAL ERROR:', initErr);
                    // Ensure flow is set even if init fails
                    if (!this.flow || this.flow.length === 0) {
                        this.handleType();
                    }
                    this.initialized = true;
                }
            },

            // Centralized Gemini API key retrieval ‚Äî use this everywhere
            async _getGeminiKey() {
                if (this._geminiApiKey) return this._geminiApiKey;
                const saved = localStorage.getItem('gemini_api_key');
                if (saved) { this._geminiApiKey = saved; return saved; }
                if (typeof PolicyQA !== 'undefined' && PolicyQA._geminiApiKey) {
                    this._geminiApiKey = PolicyQA._geminiApiKey;
                    return this._geminiApiKey;
                }
                try {
                    const res = await fetch('/api/places-config');
                    if (res.ok) {
                        const data = await res.json();
                        if (data.geminiKey) { this._geminiApiKey = data.geminiKey; return data.geminiKey; }
                    }
                } catch (_) {}
                return null;
            },

            // Dark Mode Functions
            updateDarkModeIcons(isDark) {
                const moonSVG = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
                const sunSVG = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
                document.querySelectorAll('.dark-mode-icon').forEach(icon => {
                    icon.innerHTML = isDark ? sunSVG : moonSVG;
                });
            },

            loadDarkMode() {
                const darkMode = localStorage.getItem('altech_dark_mode');
                // Default to dark mode when no preference is stored
                const isDark = darkMode === null ? true : darkMode === 'true';
                if (isDark) {
                    document.body.classList.add('dark-mode');
                }
                this.updateDarkModeIcons(isDark);
            },

            toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('altech_dark_mode', isDark);
                this.updateDarkModeIcons(isDark);
                // Sync dark mode preference to cloud
                if (typeof CloudSync !== 'undefined' && CloudSync.schedulePush) {
                    CloudSync.schedulePush();
                }
            },

            initPlaces() {
                const streetInput = document.getElementById('addrStreet');
                if (!streetInput || !window.google?.maps?.places) return;

                let sessionToken = new google.maps.places.AutocompleteSessionToken();
                const autocomplete = new google.maps.places.Autocomplete(streetInput, {
                    types: ['address'],
                    componentRestrictions: { country: 'us' },
                    fields: ['address_components', 'formatted_address'],
                    sessionToken
                });

                const refreshSessionToken = () => {
                    sessionToken = new google.maps.places.AutocompleteSessionToken();
                    autocomplete.setOptions({ sessionToken });
                };

                streetInput.addEventListener('focus', () => refreshSessionToken());

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (!place || !place.address_components) {
                        this.toast('‚ö†Ô∏è Address not found. Try a different entry.');
                        return;
                    }

                    const parts = {
                        street_number: '',
                        route: '',
                        locality: '',
                        postal_town: '',
                        administrative_area_level_1: '',
                        postal_code: ''
                    };

                    place.address_components.forEach((component) => {
                        const type = component.types?.[0];
                        if (type && Object.prototype.hasOwnProperty.call(parts, type)) {
                            parts[type] = component.short_name || component.long_name || '';
                        }
                    });

                    const street = [parts.street_number, parts.route].filter(Boolean).join(' ').trim();
                    const city = parts.locality || parts.postal_town || '';
                    const state = parts.administrative_area_level_1 || '';
                    const zip = parts.postal_code || '';

                    this.setFieldValue('addrStreet', street || place.formatted_address || '', { autoFilled: true, source: 'places' });
                    this.setFieldValue('addrCity', city, { autoFilled: true, source: 'places' });
                    this.setFieldValue('addrState', state, { autoFilled: true, source: 'places' });
                    this.setFieldValue('addrZip', zip, { autoFilled: true, source: 'places' });

                    this.scheduleMapPreviewUpdate();

                    refreshSessionToken();
                });
            },

            setFieldValue(id, value, options = {}) {
                const el = document.getElementById(id);
                if (!el) return;
                el.value = value || '';
                this.data[id] = el.value;
                localStorage.setItem(this.storageKey, JSON.stringify(this.data));

                if (options.autoFilled) {
                    this.markAutoFilled(el, options.source || 'scan');
                }

                if (id === 'vin') {
                    this.decodeVin(el);
                }
            },

            markAutoFilled(el, source) {
                if (!el) return;
                el.classList.add('auto-filled');
                if (source) {
                    el.dataset.autoFilledSource = source;
                }
            },

            clearAutoFilledIndicator(el) {
                if (!el || !el.classList) return;
                if (el.classList.contains('auto-filled')) {
                    el.classList.remove('auto-filled');
                    delete el.dataset.autoFilledSource;
                }
            },

            openScanPicker() {
                const input = document.getElementById('policyScanInput');
                if (input) input.click();
            },

            exportDemoPolicyDoc() {
                const jsPDF = window.jspdf && window.jspdf.jsPDF;
                if (!jsPDF) {
                    this.toast('‚ö†Ô∏è PDF library not available.');
                    return;
                }

                const demo = {
                    firstName: 'Jordan',
                    lastName: 'Reed',
                    dob: '1988-05-12',
                    phone: '(360) 555-0199',
                    email: 'jordan.reed@example.com',
                    addrStreet: '412 Evergreen Terrace',
                    addrCity: 'Vancouver',
                    addrState: 'WA',
                    addrZip: '98686',
                    vin: '1HGCM82633A123456',
                    vehDesc: '2019 Honda Civic',
                    liabilityLimits: '100/300/100',
                    homeDeductible: '$1,000',
                    autoDeductible: '$500',
                    priorCarrier: 'State Farm',
                    priorExp: '2025-12-31'
                };

                const doc = new jsPDF({ unit: 'pt', format: 'letter' });
                const marginX = 48;
                let y = 60;

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.text('Insurance Policy Declarations (Demo)', marginX, y);
                y += 22;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
                doc.text('Use this document to demo policy scan auto-fill.', marginX, y);
                y += 18;

                const addSection = (title, lines) => {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    doc.text(title, marginX, y);
                    y += 16;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(11);
                    lines.forEach(line => {
                        const wrapped = doc.splitTextToSize(line, 520);
                        wrapped.forEach(w => {
                            doc.text(w, marginX, y);
                            y += 14;
                        });
                    });
                    y += 8;
                };

                addSection('POLICYHOLDER / INSURED', [
                    `Name: ${demo.firstName} ${demo.lastName}`,
                    `DOB: ${demo.dob}`,
                    `Phone: ${demo.phone}`,
                    `Email: ${demo.email}`
                ]);

                addSection('ADDRESS', [
                    `Street: ${demo.addrStreet}`,
                    `City: ${demo.addrCity}`,
                    `State: ${demo.addrState}`,
                    `ZIP: ${demo.addrZip}`
                ]);

                addSection('VEHICLES', [
                    `VIN: ${demo.vin}`,
                    `Vehicle: ${demo.vehDesc}`
                ]);

                addSection('COVERAGE DETAILS', [
                    `Liability Limits (BI/PD): ${demo.liabilityLimits}`,
                    `Home Deductible: ${demo.homeDeductible}`,
                    `Auto Deductible: ${demo.autoDeductible}`
                ]);

                addSection('PRIOR INSURANCE', [
                    `Previous Carrier: ${demo.priorCarrier}`,
                    `Expiration Date: ${demo.priorExp}`
                ]);

                doc.save('Altech_Demo_Policy.pdf');
                this.toast('‚¨áÔ∏è Demo policy PDF downloaded');
            },

            openInitialDriverLicensePicker() {
                const input = document.getElementById('initialDlScanInput');
                if (input) input.click();
            },

            openDocIntelPicker() {
                const input = document.getElementById('docIntelInput');
                if (input) input.click();
            },

            // ‚îÄ‚îÄ‚îÄ Shared section clear helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            _clearSection(previewId, resultsId, statusId, inputId) {
                const preview = document.getElementById(previewId);
                if (preview) preview.innerHTML = '';
                const results = document.getElementById(resultsId);
                if (results) results.innerHTML = '';
                const status = document.getElementById(statusId);
                if (status) {
                    status.classList.add('hidden');
                    status.textContent = '';
                }
                const input = document.getElementById(inputId);
                if (input) input.value = '';
            },

            clearScan() {
                this.scanFiles = [];
                this.extractedData = null;
                this._clearSection('scanPreview', 'scanResults', 'scanStatus', 'policyScanInput');
            },

            // ‚îÄ‚îÄ‚îÄ GIS Screenshot/PDF Upload ‚îÄ‚îÄ‚îÄ
            async handleGISUpload(e) {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;

                const status = document.getElementById('gisUploadStatus');
                const resultsDiv = document.getElementById('gisUploadResults');
                if (status) { status.classList.remove('hidden'); status.textContent = '‚è≥ Analyzing GIS document with AI...'; }
                if (resultsDiv) resultsDiv.innerHTML = '';

                try {
                    // Convert files to inline data for Gemini
                    const inlineData = [];
                    for (const file of files) {
                        inlineData.push(await this.fileToInlineData(file));
                    }

                    const key = await this._getGeminiKey();
                    if (!key) {
                        if (status) status.textContent = '‚ö†Ô∏è No Gemini API key available. Set GOOGLE_API_KEY on Vercel or enter key in Policy Q&A.';
                        return;
                    }

                    const gisSchema = {
                        type: 'object',
                        properties: {
                            fields: {
                                type: 'object',
                                properties: {
                                    yrBuilt: { type: 'string' }, sqFt: { type: 'string' },
                                    lotSize: { type: 'string' }, dwellingType: { type: 'string' },
                                    numStories: { type: 'string' }, bedrooms: { type: 'string' },
                                    fullBaths: { type: 'string' }, halfBaths: { type: 'string' },
                                    constructionStyle: { type: 'string' }, exteriorWalls: { type: 'string' },
                                    foundation: { type: 'string' }, roofType: { type: 'string' },
                                    roofShape: { type: 'string' }, heatingType: { type: 'string' },
                                    cooling: { type: 'string' }, garageType: { type: 'string' },
                                    garageSpaces: { type: 'string' }, numFireplaces: { type: 'string' },
                                    sewer: { type: 'string' }, waterSource: { type: 'string' },
                                    pool: { type: 'string' }, flooring: { type: 'string' },
                                    kitchenQuality: { type: 'string' },
                                    parcelNumber: { type: 'string' }, zoning: { type: 'string' },
                                    ownerName: { type: 'string' },
                                }
                            },
                            confidence: {
                                type: 'object',
                                properties: {
                                    yrBuilt: { type: 'number' }, sqFt: { type: 'number' },
                                    lotSize: { type: 'number' }, dwellingType: { type: 'number' },
                                    numStories: { type: 'number' }, bedrooms: { type: 'number' },
                                    fullBaths: { type: 'number' }, halfBaths: { type: 'number' },
                                    constructionStyle: { type: 'number' }, exteriorWalls: { type: 'number' },
                                    foundation: { type: 'number' }, roofType: { type: 'number' },
                                    roofShape: { type: 'number' }, heatingType: { type: 'number' },
                                    cooling: { type: 'number' }, garageType: { type: 'number' },
                                    garageSpaces: { type: 'number' }, numFireplaces: { type: 'number' },
                                    sewer: { type: 'number' }, waterSource: { type: 'number' },
                                    pool: { type: 'number' }, flooring: { type: 'number' },
                                    kitchenQuality: { type: 'number' },
                                    parcelNumber: { type: 'number' }, zoning: { type: 'number' },
                                    ownerName: { type: 'number' },
                                }
                            },
                            quality_issues: { type: 'array', items: { type: 'string' } }
                        },
                        required: ['fields']
                    };

                    const prompt =
                        'Analyze this county assessor / GIS page screenshot or PDF and extract ALL available property details.\n\n' +
                        'Look for:\n' +
                        '- Year built, square footage, lot size (in acres)\n' +
                        '- Dwelling type (Single Family, Condo, Townhouse, Mobile Home, etc.)\n' +
                        '- Stories, bedrooms, bathrooms (full + half)\n' +
                        '- Construction style, exterior walls material, foundation type\n' +
                        '- Roof type (Composition, Metal, Tile, etc.), roof shape\n' +
                        '- Heating type (Forced Air Gas, Electric, Heat Pump, etc.), cooling (Central AC, etc.)\n' +
                        '- Garage type (Attached, Detached, Carport, None), garage spaces\n' +
                        '- Fireplaces count, sewer type, water source\n' +
                        '- Pool (Yes/No), flooring type, kitchen quality\n' +
                        '- Parcel/Tax ID number, zoning, owner name\n\n' +
                        'Extract exact values as shown on the document. Use empty string if not found.\n' +
                        'Return structured JSON.';

                    const parts = [{ text: prompt }].concat(
                        inlineData.map(f => ({ inlineData: { mimeType: f.mimeType, data: f.data } }))
                    );

                    const res = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ role: 'user', parts }],
                                systemInstruction: { role: 'system', parts: [{ text:
                                    'You are an expert at reading county assessor and GIS property records. ' +
                                    'Extract structured property data from screenshots and PDFs of county assessor websites, tax records, and GIS maps. ' +
                                    'Return only JSON matching the schema. If data is not visible, return empty strings. ' +
                                    'Provide confidence scores (0-1) for each field.'
                                }]},
                                generationConfig: { temperature: 0.1, response_mime_type: 'application/json', response_schema: gisSchema }
                            })
                        }
                    );

                    if (!res.ok) {
                        const errData = await res.json().catch(() => ({}));
                        throw new Error(errData?.error?.message || `Gemini API error (${res.status})`);
                    }

                    const data = await res.json();
                    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error('No response from Gemini');

                    const parsed = JSON.parse(text);
                    this.renderGISExtractionReview(parsed);

                    if (status) status.textContent = '‚úÖ Property data extracted! Review below and approve.';
                } catch (err) {
                    console.error('[GIS Upload] Error:', err);
                    if (status) status.textContent = '‚ö†Ô∏è GIS extraction failed: ' + err.message;
                }

                // Reset file input
                const input = document.getElementById('gisUploadInput');
                if (input) input.value = '';
            },

            renderGISExtractionReview(result) {
                const resultsDiv = document.getElementById('gisUploadResults');
                if (!resultsDiv) return;
                resultsDiv.innerHTML = '';

                const fields = result?.fields || {};
                const confidence = result?.confidence || {};
                const issues = result?.quality_issues || [];

                if (issues.length) {
                    const warn = document.createElement('div');
                    warn.className = 'hint';
                    warn.textContent = '‚ö†Ô∏è ' + issues.join(' | ');
                    resultsDiv.appendChild(warn);
                }

                const renderField = (id, label, value) => {
                    if (!value) return; // Only show fields that have data
                    const wrapper = document.createElement('div');
                    wrapper.className = 'scan-field';

                    const labelEl = document.createElement('label');
                    labelEl.className = 'label';
                    labelEl.textContent = label;

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = value || '';
                    input.dataset.field = id;

                    const conf = typeof confidence[id] === 'number' ? confidence[id] : null;
                    if (conf !== null) {
                        const pill = document.createElement('span');
                        pill.className = 'confidence-pill ' + (conf < 0.6 ? 'confidence-low' : 'confidence-high');
                        pill.textContent = `${Math.round(conf * 100)}%`;
                        wrapper.appendChild(pill);
                    }

                    wrapper.appendChild(labelEl);
                    wrapper.appendChild(input);
                    resultsDiv.appendChild(wrapper);
                };

                const header = document.createElement('h3');
                header.textContent = 'üè† Extracted Property Data';
                header.style.cssText = 'margin: 8px 0; font-size: 15px;';
                resultsDiv.appendChild(header);

                renderField('yrBuilt', 'Year Built', fields.yrBuilt);
                renderField('sqFt', 'Square Footage', fields.sqFt);
                renderField('lotSize', 'Lot Size (acres)', fields.lotSize);
                renderField('dwellingType', 'Dwelling Type', fields.dwellingType);
                renderField('numStories', 'Stories', fields.numStories);
                renderField('bedrooms', 'Bedrooms', fields.bedrooms);
                renderField('fullBaths', 'Full Baths', fields.fullBaths);
                renderField('halfBaths', 'Half Baths', fields.halfBaths);
                renderField('constructionStyle', 'Construction', fields.constructionStyle);
                renderField('exteriorWalls', 'Exterior Walls', fields.exteriorWalls);
                renderField('foundation', 'Foundation', fields.foundation);
                renderField('roofType', 'Roof Type', fields.roofType);
                renderField('roofShape', 'Roof Shape', fields.roofShape);
                renderField('heatingType', 'Heating', fields.heatingType);
                renderField('cooling', 'Cooling', fields.cooling);
                renderField('garageType', 'Garage Type', fields.garageType);
                renderField('garageSpaces', 'Garage Spaces', fields.garageSpaces);
                renderField('numFireplaces', 'Fireplaces', fields.numFireplaces);
                renderField('sewer', 'Sewer', fields.sewer);
                renderField('waterSource', 'Water Source', fields.waterSource);
                renderField('pool', 'Pool', fields.pool);
                renderField('flooring', 'Flooring', fields.flooring);
                renderField('kitchenQuality', 'Kitchen Quality', fields.kitchenQuality);
                renderField('parcelNumber', 'Parcel / Tax ID', fields.parcelNumber);
                renderField('zoning', 'Zoning', fields.zoning);
                renderField('ownerName', 'Owner Name', fields.ownerName);

                // Action buttons
                const actionsDiv = document.createElement('div');
                actionsDiv.style.cssText = 'margin-top: 12px; display: flex; gap: 8px;';

                const approveBtn = document.createElement('button');
                approveBtn.className = 'btn btn-primary';
                approveBtn.textContent = '‚úÖ Apply to Form';
                approveBtn.onclick = () => {
                    const inputs = resultsDiv.querySelectorAll('input[data-field]');
                    let count = 0;
                    inputs.forEach(inp => {
                        if (inp.value) {
                            // Skip info-only fields
                            if (inp.dataset.field === 'parcelNumber' || inp.dataset.field === 'zoning' || inp.dataset.field === 'ownerName') return;
                            this.setFieldValue(inp.dataset.field, inp.value, { autoFilled: true, source: 'gis' });
                            count++;
                        }
                    });
                    resultsDiv.innerHTML = '';
                    const gisStatus = document.getElementById('gisUploadStatus');
                    if (gisStatus) gisStatus.textContent = `‚úÖ ${count} property field(s) applied!`;
                    this.toast(`‚úÖ ${count} property fields applied from GIS`);
                    this.checkUpdates(); // Trigger progressive disclosure (e.g., updates card for older homes)
                };

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn';
                cancelBtn.textContent = '‚ùå Cancel';
                cancelBtn.onclick = () => {
                    resultsDiv.innerHTML = '';
                    const gisStatus = document.getElementById('gisUploadStatus');
                    if (gisStatus) { gisStatus.textContent = ''; gisStatus.classList.add('hidden'); }
                };

                actionsDiv.appendChild(approveBtn);
                actionsDiv.appendChild(cancelBtn);
                resultsDiv.appendChild(actionsDiv);

                const hint = document.createElement('div');
                hint.className = 'hint';
                hint.style.marginTop = '6px';
                hint.textContent = 'üí° Edit any fields above before applying. Parcel #, zoning, and owner name are shown for reference only.';
                resultsDiv.appendChild(hint);
            },

            clearInitialDriverLicenseScan() {
                this.initialDlScan = null;
                this._clearSection('initialDlPreview', 'initialDlResults', 'initialDlStatus', 'initialDlScanInput');
            },

            clearDocIntel() {
                this.docIntelFiles = [];
                this.docIntelResults = null;
                localStorage.removeItem(this.docIntelKey);
                this._clearSection('docIntelPreview', 'docIntelResults', 'docIntelStatus', 'docIntelInput');
            },

            async handleScanFiles(e) {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                this.scanFiles = files;
                await this.renderScanPreview(files);
                await this.processScan();
            },

            async handleInitialDriverLicenseFile(file) {
                if (!file) return;
                const status = document.getElementById('initialDlStatus');
                if (status) {
                    status.classList.remove('hidden');
                    status.textContent = '‚è≥ Scanning driver license...';
                }

                const preview = document.getElementById('initialDlPreview');
                if (preview) {
                    preview.innerHTML = '';
                    const img = document.createElement('img');
                    img.className = 'scan-thumb';
                    img.src = URL.createObjectURL(file);
                    img.onload = () => URL.revokeObjectURL(img.src);
                    preview.appendChild(img);
                }

                const result = await this.processDriverLicenseImage(file);
                if (!result?.success) {
                    const errorMsg = result?.error || 'Unable to read driver license';
                    if (status) status.textContent = `‚ö†Ô∏è ${errorMsg}`;
                    console.error('[DL Scan] Failed:', result);
                    return;
                }

                this.initialDlScan = result;
                this.renderInitialDriverLicenseResults(result);

                if (status) {
                    status.textContent = `‚úÖ Scan complete (${result.confidence || 'N/A'}% confidence) - Review below`;
                }
            },

            renderInitialDriverLicenseResults(result) {
                const container = document.getElementById('initialDlResults');
                if (!container) return;
                container.innerHTML = '';

                const fields = result?.data || {};
                const confidence = result?.confidence || 0;

                const renderField = (id, label, value) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'scan-field';

                    const labelEl = document.createElement('label');
                    labelEl.className = 'label';
                    labelEl.textContent = label;

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = value || '';
                    input.dataset.field = id;

                    wrapper.appendChild(labelEl);
                    wrapper.appendChild(input);
                    container.appendChild(wrapper);
                };

                // Render editable fields
                renderField('firstName', 'First Name', fields.firstName);
                renderField('lastName', 'Last Name', fields.lastName);
                renderField('dob', 'Date of Birth', fields.dob);
                renderField('gender', 'Gender (M/F)', fields.gender);
                renderField('licenseNumber', 'License Number', fields.licenseNumber);
                renderField('licenseState', 'License State', fields.licenseState);
                renderField('addressLine1', 'Street Address', fields.addressLine1);
                renderField('city', 'City', fields.city);
                renderField('state', 'State', fields.state);
                renderField('zip', 'ZIP', fields.zip);

                // Add confidence indicator
                if (confidence) {
                    const confDiv = document.createElement('div');
                    confDiv.className = 'hint';
                    confDiv.textContent = `Overall Confidence: ${confidence}%`;
                    container.appendChild(confDiv);
                }

                // Add action buttons
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'scan-actions';
                actionsDiv.style.marginTop = '16px';

                const approveBtn = document.createElement('button');
                approveBtn.className = 'btn btn-primary';
                approveBtn.textContent = '‚úÖ Approve & Auto-Fill';
                approveBtn.onclick = () => this.applyInitialDriverLicense();

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn';
                cancelBtn.textContent = '‚ùå Cancel Scan';
                cancelBtn.onclick = () => this.clearInitialDriverLicenseScan();

                const editHint = document.createElement('div');
                editHint.className = 'hint';
                editHint.style.marginTop = '8px';
                editHint.textContent = 'üí° Edit any fields above before approving, or cancel to start over.';

                actionsDiv.appendChild(approveBtn);
                actionsDiv.appendChild(cancelBtn);
                container.appendChild(actionsDiv);
                container.appendChild(editHint);
            },

            applyInitialDriverLicense() {
                const container = document.getElementById('initialDlResults');
                if (!container) return;

                // Get values from editable inputs
                const inputs = container.querySelectorAll('input[data-field]');
                const fields = {};
                inputs.forEach(input => {
                    fields[input.dataset.field] = input.value;
                });

                let appliedCount = 0;
                const setIfEmpty = (id, value) => {
                    if (!value) return;
                    const el = document.getElementById(id);
                    if (!el || el.value) return;
                    el.value = value;
                    this.save({ target: { id, value } });
                    this.markAutoFilled(el, 'scan');
                    appliedCount++;
                };

                setIfEmpty('firstName', fields.firstName);
                setIfEmpty('lastName', fields.lastName);
                setIfEmpty('dob', fields.dob);
                setIfEmpty('gender', fields.gender);
                setIfEmpty('addrStreet', fields.addressLine1);
                setIfEmpty('addrCity', fields.city);
                setIfEmpty('addrState', fields.state);
                setIfEmpty('addrZip', fields.zip);

                if (this.drivers.length === 0) {
                    this.drivers.push({
                        id: `driver_${Date.now()}`,
                        firstName: fields.firstName || '',
                        lastName: fields.lastName || '',
                        dob: fields.dob || '',
                        gender: fields.gender || '',
                        dlNum: (fields.licenseNumber || '').toUpperCase(),
                        dlState: (fields.licenseState || fields.state || 'WA').toUpperCase(),
                        relationship: 'Self',
                        occupation: ''
                    });
                } else {
                    const primary = this.drivers[0];
                    if (primary) {
                        if (!primary.firstName) primary.firstName = fields.firstName || '';
                        if (!primary.lastName) primary.lastName = fields.lastName || '';
                        if (!primary.dob) primary.dob = fields.dob || '';
                        if (!primary.gender) primary.gender = fields.gender || '';
                        if (!primary.dlNum) primary.dlNum = (fields.licenseNumber || '').toUpperCase();
                        if (!primary.dlState) primary.dlState = (fields.licenseState || fields.state || 'WA').toUpperCase();
                    }
                }

                // Clear the review UI after applying
                container.innerHTML = '';
                const status = document.getElementById('initialDlStatus');
                if (status) {
                    status.textContent = `‚úÖ ${appliedCount} field(s) applied to form`;
                }

                this.saveDriversVehicles();
                this.updateScanCoverage();
                this.toast('‚úÖ Driver license data applied to form');
            },

            async handleDocIntelFiles(e) {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                this.docIntelFiles = files;
                await this.renderDocIntelPreview(files);
            },

            async renderScanPreview(files) {
                const preview = document.getElementById('scanPreview');
                if (!preview) return;
                preview.innerHTML = '';

                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const url = URL.createObjectURL(file);
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'scan-thumb';
                        img.onload = () => URL.revokeObjectURL(url);
                        preview.appendChild(img);
                    } else {
                        const chip = document.createElement('div');
                        chip.className = 'hint';
                        chip.textContent = `PDF: ${file.name}`;
                        preview.appendChild(chip);
                    }
                }
            },

            async renderDocIntelPreview(files) {
                const preview = document.getElementById('docIntelPreview');
                if (!preview) return;
                preview.innerHTML = '';

                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const url = URL.createObjectURL(file);
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'scan-thumb';
                        img.onload = () => URL.revokeObjectURL(url);
                        preview.appendChild(img);
                    } else {
                        const chip = document.createElement('div');
                        chip.className = 'hint';
                        chip.textContent = `PDF: ${file.name}`;
                        preview.appendChild(chip);
                    }
                }
            },

            async optimizeImage(file) {
                console.log(`[Image Optimize] Processing ${file.type || 'unknown'}: ${(file.size / 1024).toFixed(1)}KB`);
                
                const bitmap = await createImageBitmap(file, { imageOrientation: 'from-image' });
                const canvas = document.createElement('canvas');
                
                // Resize to avoid 413 payload errors (same as driver license scan)
                // Policy docs can be much larger than licenses, use 1200px max
                const MAX_WIDTH = 1200;
                const MAX_HEIGHT = 1200;
                let width = bitmap.width;
                let height = bitmap.height;
                
                if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                    const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                    width = Math.floor(width * ratio);
                    height = Math.floor(height * ratio);
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(bitmap, 0, 0, width, height);

                // Apply contrast enhancement for better OCR
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const contrast = 1.1;
                const intercept = 128 * (1 - contrast);

                for (let i = 0; i < data.length; i += 4) {
                    data[i] = data[i] * contrast + intercept;
                    data[i + 1] = data[i + 1] * contrast + intercept;
                    data[i + 2] = data[i + 2] * contrast + intercept;
                }

                ctx.putImageData(imageData, 0, 0);
                
                // Use 0.85 quality (better than driver license since docs need clarity)
                const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', 0.85));
                
                if (blob) {
                    const originalMB = (file.size / 1024 / 1024).toFixed(2);
                    const finalMB = (blob.size / 1024 / 1024).toFixed(2);
                    console.log(`[Image Optimize] ${originalMB}MB ‚Üí ${finalMB}MB`);
                    
                    // If still too large, reduce further
                    if (blob.size > 2500000) {
                        console.log('[Image Optimize] Still large, reducing to 800px...');
                        canvas.width = width * 0.67;
                        canvas.height = height * 0.67;
                        ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
                        
                        const smallerBlob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                        if (smallerBlob) {
                            console.log(`[Image Optimize] Final: ${(smallerBlob.size / 1024).toFixed(1)}KB`);
                            return smallerBlob;
                        }
                    }
                    return blob;
                }
                
                return file;
            },

            async fileToInlineData(file) {
                const reader = new FileReader();
                const blob = file.type.startsWith('image/') ? await this.optimizeImage(file) : file;

                return new Promise((resolve, reject) => {
                    reader.onload = () => {
                        const result = reader.result;
                        const base64 = result.split(',')[1];
                        
                        // Check size to avoid 413 errors (base64 is ~33% larger than file)
                        const estimatedSizeKB = (base64.length * 0.75 / 1024).toFixed(1);
                        const estimatedSizeMB = (base64.length * 0.75 / 1024 / 1024).toFixed(2);
                        
                        if (base64.length * 0.75 > 4000000) {
                            console.error(`[File Convert] Too large: ${estimatedSizeMB}MB exceeds 4MB limit`);
                            reject(new Error(`File too large (${estimatedSizeMB}MB). Please use a smaller image or crop the document.`));
                            return;
                        }
                        
                        console.log(`[File Convert] ${file.name}: ${estimatedSizeKB}KB`);
                        
                        resolve({
                            mimeType: blob.type || file.type || 'application/octet-stream',
                            data: base64
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            },

            // Process already-extracted text through Gemini for structured field extraction (desktop drag-drop)
            async processScanFromText(text, fileName) {
                const status = document.getElementById('scanStatus');
                const apiKey = await this._getGeminiKey();
                if (!apiKey) {
                    if (status) status.textContent = '‚ö†Ô∏è No Gemini API key available. Set GOOGLE_API_KEY on Vercel or enter key in Policy Q&A.';
                    return;
                }

                try {
                    const userPrompt =
                        'Below is text extracted from an insurance policy document. Extract ALL available structured information from it.\n\n' +
                        '**POLICYHOLDER/INSURED:** Prefix (Mr/Mrs/Ms/Dr), first name, last name, suffix (Jr/Sr/III), date of birth, gender (M/F), marital status, phone, email, education, occupation, industry\n' +
                        '**CO-APPLICANT/SPOUSE:** First name, last name, date of birth, gender, email, phone, relationship (if listed)\n' +
                        '**ADDRESS:** Street address, city, state (2-letter code), ZIP, county, years at address\n' +
                        '**PROPERTY:** Dwelling usage (primary/secondary/seasonal), occupancy type (owner/renter/vacant), year built, square footage, dwelling type (single family, condo, townhouse, mobile home, etc.), ' +
                        'stories, occupants, bedrooms, full baths, half baths, construction style, exterior walls (vinyl, brick, stucco, wood, etc.), foundation, ' +
                        'garage type (attached, detached, carport, none), garage spaces, kitchen/bath quality, flooring, fireplaces, lot size (acres), purchase date, ' +
                        'roof type, roof shape (gable, hip, flat, etc.), roof updated year, heating type (gas forced air, electric, oil, etc.), heating updated year, cooling type, ' +
                        'plumbing updated year, electrical updated year, sewer type, water source, ' +
                        'pool (yes/no/fenced/unfenced), trampoline (yes/no), wood stove (yes/no), dog info (breed if mentioned), business on property (yes/no)\n' +
                        '**SAFETY & PROTECTION:** Burglar alarm, fire alarm, sprinklers, smoke detector, fire station distance (miles), fire hydrant distance (feet), protection class\n' +
                        '**HOME COVERAGE:** Policy type (HO-3, HO-5, HO-4, HO-6, DP-1, DP-3), dwelling coverage amount, personal liability, medical payments, deductible, wind/hail deductible, mortgagee/lender name\n' +
                        '**VEHICLES:** VIN number(s) and vehicle description (year/make/model). If multiple vehicles, put each extra one in additionalVehicles separated by semicolons, format: "YYYY Make Model VIN: XXXXX; YYYY Make Model VIN: XXXXX"\n' +
                        '**AUTO COVERAGE:** Auto policy type, liability limits (e.g., 100/300/100), property damage limit, UM limits, UIM limits, comprehensive deductible, collision deductible, med pay (auto), rental reimbursement, towing/roadside, student GPA discount\n' +
                        '**DRIVERS:** Additional drivers beyond primary insured in additionalDrivers separated by semicolons, format: "FirstName LastName DOB: YYYY-MM-DD; FirstName LastName DOB: YYYY-MM-DD"\n' +
                        '**POLICY INFO:** Policy number, effective date, policy term (6 month/12 month/annual), prior carrier name, prior expiration date, prior policy term, prior liability limits, years with prior carrier, continuous coverage, accidents, violations. ' +
                        'If separate home/auto carriers, use homePriorCarrier/homePriorExp/homePriorPolicyTerm/homePriorYears for home.\n' +
                        '**ADDITIONAL:** Additional insureds, best contact time, referral source\n\n' +
                        'IMPORTANT NOTES:\n' +
                        '- Different carriers use different labels: "Named Insured", "Policyholder", "Insured", "Primary Insured" all mean the same thing\n' +
                        '- Ignore agent/agency information ‚Äî we only want the INSURED\'s info\n' +
                        '- Coverage labels vary: "BI/PD", "Bodily Injury/Property Damage", "Liability Limits" all refer to liability coverage\n' +
                        '- Look for the declarations page (dec page) which has the most complete information\n' +
                        '- Normalize dates to YYYY-MM-DD format when possible\n' +
                        '- Normalize currency to plain numbers (no $ or commas)\n' +
                        '- If data is unclear or missing, note it in quality_issues\n\n' +
                        '--- DOCUMENT TEXT ---\n' + text.substring(0, 30000);

                    const schema = this._getScanSchema();

                    const res = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ role: 'user', parts: [{ text: userPrompt }] }],
                                systemInstruction: { role: 'system', parts: [{ text:
                                    'You are a senior insurance underwriter and document analyst with 20+ years experience reading policies from every major US carrier ' +
                                    '(State Farm, Allstate, Progressive, GEICO, Farmers, Safeco, Liberty Mutual, Nationwide, USAA, Erie, Travelers, Hartford, Auto-Owners, ' +
                                    'American Family, Encompass, MetLife, Kemper, Mercury, Bristol West, National General, Foremost, Stillwater, and many others). ' +
                                    'You have deep expertise in reading Declarations Pages (dec pages), policy jackets, renewal notices, endorsement pages, and binders. ' +
                                    'You understand that every carrier formats their documents differently ‚Äî some use tables, some use flowing text, some use numbered sections. ' +
                                    'You know that the DECLARATIONS PAGE is the most data-rich page and typically contains: named insured, policy number, effective/expiration dates, ' +
                                    'coverages with limits, deductibles, vehicles with VINs, listed drivers, premium breakdowns, property address, and mortgagee/lienholder info. ' +
                                    'You can distinguish between AGENT/AGENCY information and INSURED/POLICYHOLDER information ‚Äî these are different people. ' +
                                    'The insured is the customer; the agent is the seller. Only extract the INSURED\'s personal info. ' +
                                    'You understand that "Named Insured", "Policyholder", "Insured", "Primary Insured", and "First Named Insured" all refer to the same person. ' +
                                    'You know coverage terminology: "BI" = Bodily Injury, "PD" = Property Damage, "UM/UIM" = Uninsured/Underinsured Motorist, ' +
                                    '"Comp" = Comprehensive, "Coll" = Collision, "Med Pay" = Medical Payments, "PIP" = Personal Injury Protection. ' +
                                    'For limits shown as "100/300/100" you know this means $100k BI per person / $300k BI per accident / $100k PD. ' +
                                    'You recognize home policy types: HO-3 (standard homeowner), HO-5 (comprehensive), HO-4 (renter), HO-6 (condo), DP-1/DP-3 (dwelling/landlord). ' +
                                    'When reading multi-page documents, you extract data from ALL pages and merge/reconcile. If there are conflicts between pages, prefer the dec page. ' +
                                    'You handle poor quality scans, rotated pages, faxed documents, and partially obscured text by inferring from context when possible. ' +
                                    'Return only JSON matching the schema. Use empty strings for any data not found. ' +
                                    'Provide confidence scores (0‚Äì1) based on how clearly you can read each value and how certain you are of the mapping. ' +
                                    'Report quality issues like blurry text, missing pages, or ambiguous data in the quality_issues array.'
                                }]},
                                generationConfig: { temperature: 0.1, response_mime_type: 'application/json', response_schema: schema }
                            })
                        }
                    );

                    if (!res.ok) throw new Error(`Gemini API error: ${res.status}`);
                    const data = await res.json();
                    const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!raw) throw new Error('No extraction result returned');

                    const result = JSON.parse(raw);
                    this.extractedData = result;
                    this.renderExtractionReview(result);
                    if (status) status.textContent = `‚úÖ ${fileName} ‚Äî extraction complete. Review below.`;
                    console.log('[ProcessScanFromText] Extraction successful');
                } catch (err) {
                    console.error('[ProcessScanFromText] Error:', err);
                    if (status) status.textContent = '‚ö†Ô∏è AI extraction failed: ' + err.message;
                }
            },

            async processScan() {
                if (!this.scanFiles.length) return;

                const status = document.getElementById('scanStatus');
                if (status) {
                    status.classList.remove('hidden');
                    status.textContent = '‚è≥ Extracting policy data...';
                }

                try {
                    const inlineData = [];
                    for (const file of this.scanFiles) {
                        inlineData.push(await this.fileToInlineData(file));
                    }

                    let result = null;

                    // Try 1: Direct Gemini API (works locally in Tauri ‚Äî no server needed)
                    const apiKey = await this._getGeminiKey();

                    if (apiKey) {
                        try {
                            console.log('[PolicyScan] Trying direct Gemini API...');
                            const schema = this._getScanSchema();

                            const userPrompt =
                                'Analyze these insurance policy document(s) and extract ALL available information:\n\n' +
                                '**POLICYHOLDER/INSURED:** Prefix (Mr/Mrs/Ms/Dr), first name, last name, suffix (Jr/Sr/III), date of birth, gender (M/F), marital status, phone, email, education, occupation, industry\n' +
                                '**CO-APPLICANT/SPOUSE:** First name, last name, date of birth, gender, email, phone, relationship (if listed)\n' +
                                '**ADDRESS:** Street address, city, state (2-letter code), ZIP, county, years at address\n' +
                                '**PROPERTY:** Dwelling usage (primary/secondary/seasonal), occupancy type (owner/renter/vacant), year built, square footage, dwelling type (single family, condo, townhouse, mobile home, etc.), ' +
                                'stories, occupants, bedrooms, full baths, half baths, construction style, exterior walls (vinyl, brick, stucco, wood, etc.), foundation, ' +
                                'garage type (attached, detached, carport, none), garage spaces, kitchen/bath quality, flooring, fireplaces, lot size (acres), purchase date, ' +
                                'roof type, roof shape (gable, hip, flat, etc.), roof updated year, heating type (gas forced air, electric, oil, etc.), heating updated year, cooling type, ' +
                                'plumbing updated year, electrical updated year, sewer type, water source, ' +
                                'pool (yes/no/fenced/unfenced), trampoline (yes/no), wood stove (yes/no), dog info (breed if mentioned), business on property (yes/no)\n' +
                                '**SAFETY & PROTECTION:** Burglar alarm, fire alarm, sprinklers, smoke detector, fire station distance (miles), fire hydrant distance (feet), protection class\n' +
                                '**HOME COVERAGE:** Policy type (HO-3, HO-5, HO-4, HO-6, DP-1, DP-3), dwelling coverage amount, personal liability, medical payments, deductible, wind/hail deductible, mortgagee/lender name\n' +
                                '**VEHICLES:** VIN number(s) and vehicle description (year/make/model). If multiple vehicles, put each extra one in additionalVehicles separated by semicolons, format: "YYYY Make Model VIN: XXXXX; YYYY Make Model VIN: XXXXX"\n' +
                                '**AUTO COVERAGE:** Auto policy type, liability limits (e.g., 100/300/100), property damage limit, UM limits, UIM limits, comprehensive deductible, collision deductible, med pay (auto), rental reimbursement, towing/roadside, student GPA discount\n' +
                                '**DRIVERS:** Additional drivers beyond primary insured in additionalDrivers separated by semicolons, format: "FirstName LastName DOB: YYYY-MM-DD; FirstName LastName DOB: YYYY-MM-DD"\n' +
                                '**POLICY INFO:** Policy number, effective date, policy term (6 month/12 month/annual), prior carrier name, prior expiration date, prior policy term, prior liability limits, years with prior carrier, continuous coverage, accidents, violations. ' +
                                'If separate home/auto carriers, use homePriorCarrier/homePriorExp/homePriorPolicyTerm/homePriorYears for home.\n' +
                                '**ADDITIONAL:** Additional insureds, best contact time, referral source\n\n' +
                                'IMPORTANT NOTES:\n' +
                                '- Different carriers use different labels: "Named Insured", "Policyholder", "Insured", "Primary Insured" all mean the same thing\n' +
                                '- Ignore agent/agency information ‚Äî we only want the INSURED\'s info\n' +
                                '- Coverage labels vary: "BI/PD", "Bodily Injury/Property Damage", "Liability Limits" all refer to liability coverage\n' +
                                '- Look for the declarations page (dec page) which has the most complete information\n' +
                                '- Multi-page policies: extract from ALL pages provided\n' +
                                '- Normalize dates to YYYY-MM-DD format when possible\n' +
                                '- Normalize currency to plain numbers (no $ or commas)\n' +
                                '- If image quality is poor or data is unclear, note it in quality_issues\n\n' +
                                'Return structured JSON with the extracted fields.';

                            const parts = [{ text: userPrompt }].concat(
                                inlineData.map(f => ({ inlineData: { mimeType: f.mimeType, data: f.data } }))
                            );

                            const geminiRes = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{ role: 'user', parts }],
                                        systemInstruction: { role: 'system', parts: [{ text:
                                            'You are a senior insurance underwriter and document analyst with 20+ years experience reading policies from every major US carrier ' +
                                            '(State Farm, Allstate, Progressive, GEICO, Farmers, Safeco, Liberty Mutual, Nationwide, USAA, Erie, Travelers, Hartford, Auto-Owners, ' +
                                            'American Family, Encompass, MetLife, Kemper, Mercury, Bristol West, National General, Foremost, Stillwater, and many others). ' +
                                            'You have deep expertise in reading Declarations Pages (dec pages), policy jackets, renewal notices, endorsement pages, and binders. ' +
                                            'You understand that every carrier formats their documents differently ‚Äî some use tables, some use flowing text, some use numbered sections. ' +
                                            'You know that the DECLARATIONS PAGE is the most data-rich page and typically contains: named insured, policy number, effective/expiration dates, ' +
                                            'coverages with limits, deductibles, vehicles with VINs, listed drivers, premium breakdowns, property address, and mortgagee/lienholder info. ' +
                                            'You can distinguish between AGENT/AGENCY information and INSURED/POLICYHOLDER information ‚Äî these are different people. ' +
                                            'The insured is the customer; the agent is the seller. Only extract the INSURED\'s personal info. ' +
                                            'You understand that "Named Insured", "Policyholder", "Insured", "Primary Insured", and "First Named Insured" all refer to the same person. ' +
                                            'You know coverage terminology: "BI" = Bodily Injury, "PD" = Property Damage, "UM/UIM" = Uninsured/Underinsured Motorist, ' +
                                            '"Comp" = Comprehensive, "Coll" = Collision, "Med Pay" = Medical Payments, "PIP" = Personal Injury Protection. ' +
                                            'For limits shown as "100/300/100" you know this means $100k BI per person / $300k BI per accident / $100k PD. ' +
                                            'You recognize home policy types: HO-3 (standard homeowner), HO-5 (comprehensive), HO-4 (renter), HO-6 (condo), DP-1/DP-3 (dwelling/landlord). ' +
                                            'When reading multi-page documents, you extract data from ALL pages and merge/reconcile. If there are conflicts between pages, prefer the dec page. ' +
                                            'You handle poor quality scans, rotated pages, faxed documents, and partially obscured text by inferring from context when possible. ' +
                                            'Return only JSON matching the schema. Use empty strings for any data not found. ' +
                                            'Provide confidence scores (0‚Äì1) based on how clearly you can read each value and how certain you are of the mapping. ' +
                                            'Report quality issues like blurry text, missing pages, or ambiguous data in the quality_issues array.'
                                        }]},
                                        generationConfig: {
                                            temperature: 0.1,
                                            response_mime_type: 'application/json',
                                            response_schema: schema
                                        }
                                    })
                                }
                            );

                            if (geminiRes.ok) {
                                const geminiData = await geminiRes.json();
                                const raw = geminiData?.candidates?.[0]?.content?.parts?.[0]?.text;
                                if (raw) {
                                    result = JSON.parse(raw);
                                    console.log('[PolicyScan] Direct Gemini extraction successful');
                                }
                            } else {
                                console.warn('[PolicyScan] Gemini API returned', geminiRes.status);
                            }
                        } catch (e) {
                            console.warn('[PolicyScan] Direct Gemini failed:', e);
                        }
                    }

                    // Try 2: Vercel server endpoint (fallback when deployed)
                    if (!result) {
                        console.log('[PolicyScan] Falling back to /api/policy-scan.js...');
                        const response = await fetch('/api/policy-scan.js', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files: inlineData })
                        });
                        if (!response.ok) {
                            const err = await response.json().catch(() => ({}));
                            throw new Error(err?.error || 'Unable to extract policy data');
                        }
                        result = await response.json();
                    }

                    this.extractedData = result;
                    this.renderExtractionReview(result);

                    if (status) {
                        status.textContent = '‚úÖ Extraction complete. Review below.';
                    }
                } catch (err) {
                    if (status) status.textContent = '‚ö†Ô∏è ' + err.message;
                }
            },

            async analyzeDocuments() {
                const files = this.docIntelFiles.length ? this.docIntelFiles : this.scanFiles;
                if (!files.length) {
                    this.toast('‚ö†Ô∏è Upload documents first.');
                    return;
                }

                const status = document.getElementById('docIntelStatus');
                if (status) {
                    status.classList.remove('hidden');
                    status.textContent = '‚è≥ Analyzing documents...';
                }

                try {
                    const inlineData = [];
                    for (const file of files) {
                        inlineData.push(await this.fileToInlineData(file));
                    }

                    const response = await fetch('/api/document-intel.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files: inlineData })
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err?.error || 'Unable to analyze documents');
                    }

                    const result = await response.json();
                    this.docIntelResults = result;
                    await this.saveDocIntelResults(result);
                    this.renderDocIntelResults(result);

                    if (status) {
                        status.textContent = '‚úÖ Document analysis complete.';
                    }
                } catch (err) {
                    if (status) status.textContent = '‚ö†Ô∏è ' + err.message;
                }
            },

            renderDocIntelResults(result) {
                const container = document.getElementById('docIntelResults');
                if (!container) return;
                container.innerHTML = '';

                if (!result) return;

                const warnings = this.getDocIntelWarnings(result);
                if (warnings.length) {
                    const warn = document.createElement('div');
                    warn.className = 'hint';
                    warn.textContent = '‚ö†Ô∏è ' + warnings.join(' | ');
                    container.appendChild(warn);
                }

                const summary = document.createElement('div');
                summary.className = 'hint';
                summary.textContent = result.summary || 'Document analysis complete.';
                container.appendChild(summary);

                const fields = result.fields || {};
                const fieldsCard = document.createElement('div');
                fieldsCard.className = 'scan-field';

                const fieldsTitle = document.createElement('label');
                fieldsTitle.className = 'label';
                fieldsTitle.textContent = 'Review Extracted Fields';
                fieldsCard.appendChild(fieldsTitle);

                const fieldList = document.createElement('div');
                fieldList.className = 'grid-2';

                const renderInput = (labelText, key, placeholder = '') => {
                    const wrap = document.createElement('div');
                    const label = document.createElement('label');
                    label.className = 'label';
                    label.textContent = labelText;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = fields[key] || '';
                    input.placeholder = placeholder;
                    input.oninput = (e) => this.updateDocIntelField(key, e.target.value);
                    wrap.appendChild(label);
                    wrap.appendChild(input);
                    fieldList.appendChild(wrap);
                };

                renderInput('Owner Name', 'ownerName', 'John Doe');
                renderInput('Policy Number', 'policyNumber', 'ABC123');
                renderInput('Effective Date', 'effectiveDate', 'YYYY-MM-DD');
                renderInput('Expiration Date', 'expirationDate', 'YYYY-MM-DD');
                renderInput('Year Built', 'yearBuilt', '1999');
                renderInput('Assessed Value', 'assessedValue', '450000');
                renderInput('Mortgagee', 'mortgagee', 'Lender Name');
                renderInput('Address Line 1', 'addressLine1', '123 Main St');
                renderInput('City', 'city', 'Seattle');
                renderInput('State', 'state', 'WA');
                renderInput('Zip', 'zip', '98101');

                fieldsCard.appendChild(fieldList);
                container.appendChild(fieldsCard);

                const docs = result.documents || [];
                docs.forEach(doc => {
                    const card = document.createElement('div');
                    card.className = 'scan-field';

                    const title = document.createElement('label');
                    title.className = 'label';
                    title.textContent = doc.title || doc.type || 'Document';

                    const detail = document.createElement('div');
                    detail.className = 'hint';
                    detail.textContent = doc.details || doc.notes || 'No details extracted.';

                    card.appendChild(title);
                    card.appendChild(detail);
                    container.appendChild(card);
                });
            },

            async updateDocIntelField(key, value) {
                if (!this.docIntelResults) return;
                if (!this.docIntelResults.fields) this.docIntelResults.fields = {};
                this.docIntelResults.fields[key] = value;
                await this.saveDocIntelResults(this.docIntelResults);
            },

            getDocIntelWarnings(result) {
                const warnings = [];
                const fields = result?.fields || {};
                if (fields.yearBuilt && this.data.yrBuilt) {
                    const diff = Math.abs(parseInt(fields.yearBuilt, 10) - parseInt(this.data.yrBuilt, 10));
                    if (!Number.isNaN(diff) && diff >= 2) {
                        warnings.push(`Year built mismatch (${fields.yearBuilt} vs ${this.data.yrBuilt})`);
                    }
                }
                if (!fields.ownerName && (fields.deedBook || fields.apn)) {
                    warnings.push('Owner name missing from document extraction');
                }
                if (fields.assessedValue && !this.data.propertyValue) {
                    warnings.push('Assessed value found ‚Äî consider setting property value');
                }
                return warnings;
            },

            applyDocIntelToForm() {
                if (!this.docIntelResults) {
                    this.toast('‚ö†Ô∏è Run document analysis first.');
                    return;
                }
                const fields = this.docIntelResults.fields || {};

                const setIfEmpty = (id, value) => {
                    if (!value) return;
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (!el.value) {
                        el.value = value;
                        this.data[id] = value;
                        this.markAutoFilled(el, 'scan');
                    }
                };

                setIfEmpty('yrBuilt', fields.yearBuilt);
                setIfEmpty('addrStreet', fields.addressLine1);
                setIfEmpty('addrCity', fields.city);
                setIfEmpty('addrState', fields.state);
                setIfEmpty('addrZip', fields.zip);
                setIfEmpty('mortgagee', fields.mortgagee);
                setIfEmpty('purchaseDate', fields.purchaseDate);

                if (fields.assessedValue && !this.data.propertyValue) {
                    this.data.propertyValue = fields.assessedValue;
                }

                this.data.docIntel = {
                    source: fields.source || 'Document Intelligence',
                    yearBuilt: fields.yearBuilt || '',
                    assessedValue: fields.assessedValue || '',
                    ownerName: fields.ownerName || '',
                    policyNumber: fields.policyNumber || '',
                    effectiveDate: fields.effectiveDate || '',
                    expirationDate: fields.expirationDate || '',
                    mortgagee: fields.mortgagee || ''
                };

                this.save({ target: { id: 'docIntel', value: JSON.stringify(this.data.docIntel) } });
                this.updateScanCoverage();
                this.toast('‚úÖ Document data applied');
            },

            async saveDocIntelResults(result) {
                if (!result) return;
                if (this.encryptionEnabled) {
                    const encrypted = await CryptoHelper.encrypt(result);
                    localStorage.setItem(this.docIntelKey, encrypted);
                } else {
                    localStorage.setItem(this.docIntelKey, JSON.stringify(result));
                }
            },

            async loadDocIntelResults() {
                const stored = localStorage.getItem(this.docIntelKey);
                if (!stored) return;

                if (this.encryptionEnabled) {
                    const decrypted = await CryptoHelper.decrypt(stored);
                    if (decrypted) this.docIntelResults = decrypted;
                } else {
                    try {
                        this.docIntelResults = JSON.parse(stored);
                    } catch (e) {
                        console.warn('[loadDocIntelResults] Corrupt JSON:', e);
                    }
                }

                if (this.docIntelResults) {
                    this.renderDocIntelResults(this.docIntelResults);
                    this.updateScanCoverage();
                }
            },

            updateScanCoverage() {
                const el = document.getElementById('scanCoverage');
                if (!el) return;

                const fields = [
                    'firstName','lastName','dob','addrStreet','addrCity','addrState','addrZip',
                    'email','phone','yrBuilt','sqFt','roofType','mortgagee'
                ];

                const filled = fields.filter(k => (this.data?.[k] || '').toString().trim().length > 0).length;
                const total = fields.length;
                const percent = Math.round((filled / total) * 100);

                el.textContent = `Scan coverage: ${filled}/${total} fields applied (${percent}%)`;
            },

            renderExtractionReview(result) {
                const results = document.getElementById('scanResults');
                if (!results) return;
                results.innerHTML = '';

                const fields = result?.fields || {};
                const confidence = result?.confidence || {};
                const issues = result?.quality_issues || [];

                if (issues.length) {
                    const warn = document.createElement('div');
                    warn.className = 'hint';
                    warn.textContent = '‚ö†Ô∏è ' + issues.join(' | ');
                    results.appendChild(warn);
                }

                const renderField = (id, label, value) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'scan-field';

                    const labelEl = document.createElement('label');
                    labelEl.className = 'label';
                    labelEl.textContent = label;

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = value || '';
                    input.dataset.field = id;

                    const conf = typeof confidence[id] === 'number' ? confidence[id] : null;
                    if (conf !== null) {
                        const pill = document.createElement('span');
                        pill.className = 'confidence-pill ' + (conf < 0.6 ? 'confidence-low' : 'confidence-high');
                        pill.textContent = `${Math.round(conf * 100)}% confidence`;
                        wrapper.appendChild(pill);
                    }

                    wrapper.appendChild(labelEl);
                    wrapper.appendChild(input);
                    results.appendChild(wrapper);
                };

                renderField('prefix', 'Prefix', fields.prefix);
                renderField('firstName', 'First Name', fields.firstName);
                renderField('lastName', 'Last Name', fields.lastName);
                renderField('suffix', 'Suffix', fields.suffix);
                renderField('dob', 'Date of Birth', fields.dob);
                renderField('gender', 'Gender', fields.gender);
                renderField('maritalStatus', 'Marital Status', fields.maritalStatus);
                renderField('phone', 'Phone', fields.phone);
                renderField('email', 'Email', fields.email);
                renderField('education', 'Education', fields.education);
                renderField('occupation', 'Occupation', fields.occupation);
                renderField('industry', 'Industry', fields.industry);

                // Co-Applicant (only render if data found)
                if (fields.coFirstName || fields.coLastName) {
                    const coHeader = document.createElement('h3');
                    coHeader.textContent = 'üë• Co-Applicant / Spouse';
                    coHeader.style.cssText = 'margin: 12px 0 6px; font-size: 14px; color: var(--text-secondary);';
                    results.appendChild(coHeader);
                    renderField('coFirstName', 'Co-Applicant First Name', fields.coFirstName);
                    renderField('coLastName', 'Co-Applicant Last Name', fields.coLastName);
                    renderField('coDob', 'Co-Applicant DOB', fields.coDob);
                    renderField('coGender', 'Co-Applicant Gender', fields.coGender);
                    renderField('coEmail', 'Co-Applicant Email', fields.coEmail);
                    renderField('coPhone', 'Co-Applicant Phone', fields.coPhone);
                    renderField('coRelationship', 'Relationship', fields.coRelationship);
                }

                // Address
                const addrHeader = document.createElement('h3');
                addrHeader.textContent = 'üìç Address';
                addrHeader.style.cssText = 'margin: 12px 0 6px; font-size: 14px; color: var(--text-secondary);';
                results.appendChild(addrHeader);
                renderField('addrStreet', 'Street Address', fields.addrStreet);
                renderField('addrCity', 'City', fields.addrCity);
                renderField('addrState', 'State', fields.addrState);
                renderField('addrZip', 'ZIP', fields.addrZip);
                renderField('county', 'County', fields.county);
                renderField('yearsAtAddress', 'Years at Address', fields.yearsAtAddress);

                // Property (only if data found)
                if (fields.yrBuilt || fields.sqFt || fields.dwellingType || fields.dwellingUsage || fields.occupancyType || fields.roofType || fields.exteriorWalls || fields.heatingType || fields.garageType || fields.lotSize || fields.pool || fields.trampoline || fields.dogInfo || fields.bedrooms || fields.fullBaths) {
                    const propHeader = document.createElement('h3');
                    propHeader.textContent = 'üè† Property';
                    propHeader.style.cssText = 'margin: 12px 0 6px; font-size: 14px; color: var(--text-secondary);';
                    results.appendChild(propHeader);
                    renderField('dwellingUsage', 'Dwelling Use', fields.dwellingUsage);
                    renderField('occupancyType', 'Occupancy Type', fields.occupancyType);
                    renderField('yrBuilt', 'Year Built', fields.yrBuilt);
                    renderField('sqFt', 'Square Footage', fields.sqFt);
                    renderField('dwellingType', 'Dwelling Type', fields.dwellingType);
                    renderField('numStories', 'Stories', fields.numStories);
                    renderField('numOccupants', 'Occupants', fields.numOccupants);
                    renderField('bedrooms', 'Bedrooms', fields.bedrooms);
                    renderField('fullBaths', 'Full Baths', fields.fullBaths);
                    renderField('halfBaths', 'Half Baths', fields.halfBaths);
                    renderField('constructionStyle', 'Construction', fields.constructionStyle);
                    renderField('exteriorWalls', 'Exterior Walls', fields.exteriorWalls);
                    renderField('foundation', 'Foundation', fields.foundation);
                    renderField('garageType', 'Garage Type', fields.garageType);
                    renderField('garageSpaces', 'Garage Spaces', fields.garageSpaces);
                    renderField('kitchenQuality', 'Kitchen/Bath Quality', fields.kitchenQuality);
                    renderField('flooring', 'Flooring', fields.flooring);
                    renderField('numFireplaces', 'Fireplaces', fields.numFireplaces);
                    renderField('lotSize', 'Lot Size (acres)', fields.lotSize);
                    renderField('purchaseDate', 'Purchase Date', fields.purchaseDate);
                    renderField('roofType', 'Roof Type', fields.roofType);
                    renderField('roofShape', 'Roof Shape', fields.roofShape);
                    renderField('roofYr', 'Roof Updated', fields.roofYr);
                    renderField('heatingType', 'Heating Type', fields.heatingType);
                    renderField('heatYr', 'Heating Updated', fields.heatYr);
                    renderField('cooling', 'Cooling', fields.cooling);
                    renderField('plumbYr', 'Plumbing Updated', fields.plumbYr);
                    renderField('elecYr', 'Electrical Updated', fields.elecYr);
                    renderField('sewer', 'Sewer', fields.sewer);
                    renderField('waterSource', 'Water Source', fields.waterSource);
                    renderField('pool', 'Pool', fields.pool);
                    renderField('trampoline', 'Trampoline', fields.trampoline);
                    renderField('woodStove', 'Wood Stove', fields.woodStove);
                    renderField('dogInfo', 'Dog Info', fields.dogInfo);
                    renderField('businessOnProperty', 'Business on Property', fields.businessOnProperty);
                }

                // Safety & Protection (only if data found)
                if (fields.burglarAlarm || fields.fireAlarm || fields.sprinklers || fields.smokeDetector || fields.fireStationDist || fields.fireHydrantFeet || fields.protectionClass) {
                    const safetyHeader = document.createElement('h3');
                    safetyHeader.textContent = 'üõ°Ô∏è Safety & Protection';
                    safetyHeader.style.cssText = 'margin: 12px 0 6px; font-size: 14px; color: var(--text-secondary);';
                    results.appendChild(safetyHeader);
                    renderField('burglarAlarm', 'Burglar Alarm', fields.burglarAlarm);
                    renderField('fireAlarm', 'Fire Alarm', fields.fireAlarm);
                    renderField('sprinklers', 'Sprinklers', fields.sprinklers);
                    renderField('smokeDetector', 'Smoke Detector', fields.smokeDetector);
                    renderField('fireStationDist', 'Fire Station (mi)', fields.fireStationDist);
                    renderField('fireHydrantFeet', 'Fire Hydrant (ft)', fields.fireHydrantFeet);
                    renderField('protectionClass', 'Protection Class', fields.protectionClass);
                }

                // Home Coverage (only if data found)
                if (fields.homePolicyType || fields.dwellingCoverage || fields.personalLiability || fields.medicalPayments || fields.homeDeductible) {
                    const homeHeader = document.createElement('h3');
                    homeHeader.textContent = 'üè° Home Coverage';
                    homeHeader.style.cssText = 'margin: 12px 0 6px; font-size: 14px; color: var(--text-secondary);';
                    results.appendChild(homeHeader);
                    renderField('homePolicyType', 'Policy Type', fields.homePolicyType);
                    renderField('dwellingCoverage', 'Dwelling Coverage', fields.dwellingCoverage);
                    renderField('personalLiability', 'Personal Liability', fields.personalLiability);
                    renderField('medicalPayments', 'Medical Payments', fields.medicalPayments);
                    renderField('homeDeductible', 'Home Deductible', fields.homeDeductible);
                    renderField('windDeductible', 'Wind/Hail Deductible', fields.windDeductible);
                    renderField('mortgagee', 'Mortgagee / Lender', fields.mortgagee);
                }

                // Vehicles
                const vehHeader = document.createElement('h3');
                vehHeader.textContent = 'üöó Vehicles';
                vehHeader.style.cssText = 'margin: 12px 0 6px; font-size: 14px; color: var(--text-secondary);';
                results.appendChild(vehHeader);
                renderField('vin', 'VIN', fields.vin);
                renderField('vehDesc', 'Vehicle Description', fields.vehDesc);
                if (fields.additionalVehicles) renderField('additionalVehicles', 'Additional Vehicles', fields.additionalVehicles);

                // Auto Coverage (only if data found)
                if (fields.liabilityLimits || fields.pdLimit || fields.autoDeductible || fields.compDeductible) {
                    const autoHeader = document.createElement('h3');
                    autoHeader.textContent = 'üöô Auto Coverage';
                    autoHeader.style.cssText = 'margin: 12px 0 6px; font-size: 14px; color: var(--text-secondary);';
                    results.appendChild(autoHeader);
                    renderField('autoPolicyType', 'Auto Policy Type', fields.autoPolicyType);
                    renderField('liabilityLimits', 'Liability Limits', fields.liabilityLimits);
                    renderField('pdLimit', 'Property Damage Limit', fields.pdLimit);
                    renderField('umLimits', 'UM Limits', fields.umLimits);
                    renderField('uimLimits', 'UIM Limits', fields.uimLimits);
                    renderField('compDeductible', 'Comprehensive Ded.', fields.compDeductible);
                    renderField('autoDeductible', 'Collision Ded.', fields.autoDeductible);
                    renderField('medPayments', 'Med Pay (Auto)', fields.medPayments);
                    renderField('rentalDeductible', 'Rental Reimburse.', fields.rentalDeductible);
                    renderField('towingDeductible', 'Towing/Roadside', fields.towingDeductible);
                    renderField('studentGPA', 'Student GPA', fields.studentGPA);
                }

                // Drivers (additional)
                if (fields.additionalDrivers) renderField('additionalDrivers', 'Additional Drivers', fields.additionalDrivers);

                // Policy & Prior Insurance
                const polHeader = document.createElement('h3');
                polHeader.textContent = 'üìã Policy & Prior Insurance';
                polHeader.style.cssText = 'margin: 12px 0 6px; font-size: 14px; color: var(--text-secondary);';
                results.appendChild(polHeader);
                renderField('policyNumber', 'Policy Number', fields.policyNumber);
                renderField('effectiveDate', 'Effective Date', fields.effectiveDate);
                renderField('policyTerm', 'Policy Term', fields.policyTerm);
                renderField('priorCarrier', 'Prior Carrier', fields.priorCarrier);
                renderField('priorExp', 'Prior Expiration', fields.priorExp);
                renderField('priorPolicyTerm', 'Prior Policy Term', fields.priorPolicyTerm);
                renderField('priorLiabilityLimits', 'Prior Liability Limits', fields.priorLiabilityLimits);
                renderField('priorYears', 'Years w/ Prior', fields.priorYears);
                renderField('continuousCoverage', 'Continuous Coverage', fields.continuousCoverage);
                renderField('accidents', 'Accidents', fields.accidents);
                renderField('violations', 'Violations', fields.violations);
                if (fields.homePriorCarrier) renderField('homePriorCarrier', 'Home Prior Carrier', fields.homePriorCarrier);
                if (fields.homePriorExp) renderField('homePriorExp', 'Home Prior Exp.', fields.homePriorExp);
                if (fields.homePriorPolicyTerm) renderField('homePriorPolicyTerm', 'Home Prior Term', fields.homePriorPolicyTerm);
                if (fields.homePriorYears) renderField('homePriorYears', 'Home Yrs w/ Prior', fields.homePriorYears);

                // Additional Info
                if (fields.additionalInsureds || fields.contactTime || fields.referralSource) {
                    const addlHeader = document.createElement('h3');
                    addlHeader.textContent = 'üìù Additional Information';
                    addlHeader.style.cssText = 'margin: 12px 0 6px; font-size: 14px; color: var(--text-secondary);';
                    results.appendChild(addlHeader);
                    if (fields.additionalInsureds) renderField('additionalInsureds', 'Additional Insureds', fields.additionalInsureds);
                    if (fields.contactTime) renderField('contactTime', 'Best Contact Time', fields.contactTime);
                    if (fields.referralSource) renderField('referralSource', 'Referral Source', fields.referralSource);
                }

                // Add action buttons
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'scan-actions';
                actionsDiv.style.marginTop = '16px';

                const approveBtn = document.createElement('button');
                approveBtn.className = 'btn btn-primary';
                approveBtn.textContent = '‚úÖ Approve & Auto-Fill';
                approveBtn.onclick = () => this.applyExtractedData();

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn';
                cancelBtn.textContent = '‚ùå Cancel Scan';
                cancelBtn.onclick = () => this.clearScan();

                const editHint = document.createElement('div');
                editHint.className = 'hint';
                editHint.style.marginTop = '8px';
                editHint.textContent = 'üí° Edit any fields above before approving, or cancel to start over.';

                actionsDiv.appendChild(approveBtn);
                actionsDiv.appendChild(cancelBtn);
                results.appendChild(actionsDiv);
                results.appendChild(editHint);
            },

            applyExtractedData() {
                const results = document.getElementById('scanResults');
                if (!results) return;
                const inputs = results.querySelectorAll('input[data-field]');
                let appliedCount = 0;
                let hasCoApplicant = false;
                let additionalVehiclesText = '';
                let additionalDriversText = '';
                inputs.forEach((input) => {
                    if (input.value) {
                        const field = input.dataset.field;
                        // Track co-applicant presence
                        if (field === 'coFirstName' || field === 'coLastName') hasCoApplicant = true;
                        // Capture additional vehicles/drivers text for parsing below
                        if (field === 'additionalVehicles') { additionalVehiclesText = input.value; return; }
                        if (field === 'additionalDrivers') { additionalDriversText = input.value; return; }
                        this.setFieldValue(field, input.value, { autoFilled: true, source: 'scan' });
                        appliedCount++;
                    }
                });
                
                // Auto-enable co-applicant section if co-applicant data found
                if (hasCoApplicant) {
                    this.data.hasCoApplicant = 'yes';
                    const coRadio = document.querySelector('input[name="hasCoApplicant"][value="yes"]');
                    if (coRadio) { coRadio.checked = true; coRadio.dispatchEvent(new Event('change', { bubbles: true })); }
                    this.restoreCoApplicantUI();
                }
                
                // Clear the review UI after applying
                results.innerHTML = '';
                const status = document.getElementById('scanStatus');
                if (status) {
                    status.textContent = `‚úÖ ${appliedCount} field(s) applied to form`;
                }
                
                // --- Sync scanned vehicle data into vehicles array ---
                // Helper: parse "YYYY Make Model" text into vehicle object
                const parseVehicleDesc = (desc) => {
                    const m = (desc || '').match(/(\d{4})\s+(\S+)\s+(.*)/);
                    return m ? { year: m[1], make: m[2], model: m[3].trim() } : {};
                };

                // Helper: extract VIN from a text chunk (17 alphanumeric, no I/O/Q)
                const extractVIN = (text) => {
                    const m = (text || '').match(/\b([A-HJ-NPR-Z0-9]{17})\b/i);
                    return m ? m[1].toUpperCase() : '';
                };

                // Build primary vehicle from vin/vehDesc fields
                if (this.data.vin || this.data.vehDesc) {
                    const p = parseVehicleDesc(this.data.vehDesc);
                    const primaryVeh = {
                        id: `vehicle_${Date.now()}`,
                        vin: this.data.vin || '',
                        year: p.year || '', make: p.make || '', model: p.model || '',
                        use: 'Commute', miles: '12000', primaryDriver: ''
                    };
                    if (!this.vehicles || this.vehicles.length === 0) {
                        this.vehicles = [primaryVeh];
                    } else {
                        const v = this.vehicles[0];
                        if (this.data.vin) v.vin = this.data.vin;
                        if (p.year) { v.year = p.year; v.make = p.make; v.model = p.model; }
                    }
                }

                // Parse additionalVehicles text into extra entries
                if (additionalVehiclesText) {
                    // Split on semicolons, commas between entries, newlines, or "Vehicle N:" patterns
                    const chunks = additionalVehiclesText.split(/[;\n]|,\s*(?=\d{4}\s)|(?:Vehicle\s*\d+\s*:\s*)/i).filter(s => s.trim());
                    chunks.forEach((chunk, i) => {
                        const vin = extractVIN(chunk);
                        const descClean = chunk.replace(/VIN\s*[:=]?\s*[A-HJ-NPR-Z0-9]{17}/i, '').trim();
                        const p = parseVehicleDesc(descClean);
                        // Avoid duplicating a vehicle already in the list
                        const isDupe = vin && this.vehicles.some(v => v.vin === vin);
                        if (!isDupe && (vin || p.year)) {
                            if (!this.vehicles) this.vehicles = [];
                            this.vehicles.push({
                                id: `vehicle_${Date.now() + i + 1}`,
                                vin: vin, year: p.year || '', make: p.make || '', model: p.model || '',
                                use: 'Commute', miles: '12000', primaryDriver: ''
                            });
                        }
                    });
                }

                if (this.vehicles && this.vehicles.length > 0) {
                    this.saveDriversVehicles();
                    this.renderVehicles();
                }

                // --- Sync scanned driver data into drivers array ---
                if (this.data.firstName || this.data.lastName) {
                    if (!this.drivers || this.drivers.length === 0) {
                        this.drivers = [{
                            id: `driver_${Date.now()}`,
                            firstName: this.data.firstName || '',
                            lastName: this.data.lastName || '',
                            dob: this.data.dob || '',
                            dlNum: '',
                            dlState: this.data.addrState || 'WA',
                            relationship: 'Self'
                        }];
                    }
                }

                // Parse additionalDrivers text into extra entries
                if (additionalDriversText) {
                    const chunks = additionalDriversText.split(/[;\n]|(?:Driver\s*\d+\s*:\s*)/i).filter(s => s.trim());
                    chunks.forEach((chunk, i) => {
                        // Try to parse "FirstName LastName (DOB: ...)" or "FirstName LastName, DOB ..."
                        const nameMatch = chunk.match(/^([A-Za-z'-]+)\s+([A-Za-z'-]+)/);
                        if (nameMatch) {
                            const dobMatch = chunk.match(/\b(\d{4}-\d{2}-\d{2}|\d{2}\/\d{2}\/\d{4})\b/);
                            if (!this.drivers) this.drivers = [];
                            // Avoid duplicating by name
                            const isDupe = this.drivers.some(d =>
                                d.firstName.toLowerCase() === nameMatch[1].toLowerCase() &&
                                d.lastName.toLowerCase() === nameMatch[2].toLowerCase()
                            );
                            if (!isDupe) {
                                this.drivers.push({
                                    id: `driver_${Date.now() + i + 1}`,
                                    firstName: nameMatch[1],
                                    lastName: nameMatch[2],
                                    dob: dobMatch ? dobMatch[1] : '',
                                    dlNum: '',
                                    dlState: this.data.addrState || 'WA',
                                    relationship: 'Other'
                                });
                            }
                        }
                    });
                }

                if (this.drivers && this.drivers.length > 0) {
                    this.saveDriversVehicles();
                    this.renderDrivers();
                }

                this.updateScanCoverage();
                const totalVeh = this.vehicles ? this.vehicles.length : 0;
                const totalDrv = this.drivers ? this.drivers.length : 0;
                this.toast(`‚úÖ ${appliedCount} fields + ${totalVeh} vehicle(s) + ${totalDrv} driver(s) applied`);
            },

            handleType() {
                const t = document.querySelector('input[name="qType"]:checked')?.value || 'both';
                const prevFlow = this.flow || [];
                this.flow = this.workflows[t];
                
                // Clear data for steps excluded from the new workflow
                // (prevents stale home data leaking into auto-only quotes, etc.)
                const allSteps = this.workflows.both; // superset of all steps
                const excludedSteps = allSteps.filter(s => !this.flow.includes(s));
                excludedSteps.forEach(stepId => {
                    const stepEl = document.getElementById(stepId);
                    if (!stepEl) return;
                    stepEl.querySelectorAll('input, select, textarea').forEach(el => {
                        if (!el.id || el.type === 'radio' || el.type === 'hidden' || el.type === 'file') return;
                        if (el.type === 'checkbox') {
                            el.checked = false;
                            delete this.data[el.id];
                        } else {
                            el.value = '';
                            delete this.data[el.id];
                        }
                    });
                    // Clear drivers/vehicles arrays when step-4 (auto) is excluded
                    if (stepId === 'step-4') {
                        this.drivers = [];
                        this.vehicles = [];
                        delete this.data.drivers;
                        delete this.data.vehicles;
                        const driverList = document.getElementById('driverCardList');
                        const vehicleList = document.getElementById('vehicleCardList');
                        if (driverList) driverList.innerHTML = '';
                        if (vehicleList) vehicleList.innerHTML = '';
                    }
                });

                // Move to next step automatically after selection
                if (this.step === 2) {
                    this.step++;
                }
                
                // Reset step if out of bounds
                if (this.step >= this.flow.length) this.step = 0;
                this.updateUI();
                this.save({ target: document.querySelector('input[name="qType"]:checked') });
            },

            updateUI() {
                if (!this.flow || this.flow.length === 0) {
                    console.warn('[App.updateUI] flow empty, calling handleType()');
                    this.handleType();
                    return; // handleType calls updateUI, avoid recursion
                }
                document.querySelectorAll('.step').forEach(e => e.classList.add('hidden'));
                const curId = this.flow[this.step];
                if (!curId) {
                    console.error('[App.updateUI] No step at index', this.step);
                    this.step = 0;
                    return this.updateUI();
                }
                const curEl = document.getElementById(curId);
                if (!curEl) {
                    console.error('[App.updateUI] Element not found:', curId);
                    return;
                }
                curEl.classList.remove('hidden');

                // Show/hide insurance history cards based on qType
                const qType = document.querySelector('input[name="qType"]:checked')?.value || 'both';
                const showHome = qType === 'home' || qType === 'both';
                const showAuto = qType === 'auto' || qType === 'both';
                const homeCard = document.getElementById('homePriorCard');
                const autoCard = document.getElementById('autoPriorCard');
                if (homeCard) homeCard.style.display = showHome ? '' : 'none';
                if (autoCard) autoCard.style.display = showAuto ? '' : 'none';
                
                // Render drivers/vehicles when landing on step 4
                if (curId === 'step-4') {
                    this.renderDrivers();
                    this.renderVehicles();
                    
                    // Auto-add primary applicant as first driver if empty
                    if (this.drivers.length === 0 && this.data.firstName) {
                        this.drivers.push({
                            id: `driver_${Date.now()}`,
                            firstName: this.data.firstName || '',
                            lastName: this.data.lastName || '',
                            dob: this.data.dob || '',
                            dlNum: '',
                            dlState: 'WA',
                            relationship: 'Self'
                        });
                        this.renderDrivers();
                    }
                }
                
                // Render client history on Quick Start page
                if (curId === 'step-0') {
                    this.renderStep0ClientHistory();
                }

                // Auto-select current data when landing on export page
                if (curId === 'step-6') {
                    this.autoSaveClient();
                    this.renderClientHistory();
                }
                
                // Update step title
                const stepTitle = document.getElementById('stepTitle');
                const totalSteps = this.flow.length;
                const currentStep = this.step + 1;
                const stepName = this.stepTitles[curId] || 'Step';
                stepTitle.textContent = `Step ${currentStep} of ${totalSteps}: ${stepName}`;
                this.updateBreadcrumb();
                
                // Progress
                const pct = ((this.step + 1) / this.flow.length) * 100;
                document.getElementById('progressBar').style.width = pct + '%';
                
                // Buttons
                const back = document.getElementById('btnBack');
                const next = document.getElementById('btnNext');
                back.disabled = this.step === 0;
                next.textContent = this.step === this.flow.length - 1 ? 'Finish' : 'Next';
                
                document.getElementById('mainContainer').scrollTo(0,0);
            },

            next() {
                try {
                    // Auto-init flow if somehow empty
                    if (!this.flow || this.flow.length === 0) {
                        console.warn('[App.next] flow was empty, calling handleType()');
                        this.handleType();
                    }

                    // Validate current step before proceeding
                    const curStepId = this.flow[this.step];
                    if (!curStepId) {
                        console.error('[App.next] No step at index', this.step, 'flow:', this.flow);
                        return;
                    }
                    const stepNumber = parseInt(curStepId.split('-')[1]);
                    
                    if (typeof Validation !== 'undefined') {
                        const errors = Validation.validateStep(stepNumber);
                        
                        // Clear all previous errors
                        document.querySelectorAll('.validation-error').forEach(e => e.remove());
                        document.querySelectorAll('input, select, textarea').forEach(el => {
                            el.style.borderColor = '';
                            el.style.background = '';
                        });
                        
                        // Show new errors
                        if (errors.length > 0) {
                            errors.forEach(err => {
                                if (err.field) {
                                    Validation.showError(err.field, err.message);
                                }
                            });
                            
                            // Scroll to first error
                            const firstError = document.querySelector('.validation-error');
                            if (firstError) {
                                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                            
                            this.toast('‚ö†Ô∏è Please fix validation errors before continuing');
                            return; // Don't proceed
                        }
                    }
                    
                    if (this.step < this.flow.length - 1) {
                        this.step++;
                        this.updateUI();
                    }
                } catch(e) {
                    console.error('[App.next] Error:', e);
                }
            },
            prev() {
                try {
                    if (!this.flow || this.flow.length === 0) {
                        console.warn('[App.prev] flow was empty, calling handleType()');
                        this.handleType();
                    }
                    if (this.step > 0) {
                        this.step--;
                        this.updateUI();
                    }
                } catch(e) {
                    console.error('[App.prev] Error:', e);
                }
            },

            async save(e) {
                if (e && e.target) {
                    const k = e.target.id || e.target.name;
                    this.data[k] = e.target.type === 'checkbox' ? e.target.checked : e.target.value;

                    if (k === 'firstName' || k === 'lastName') {
                        this.data.firstNamePhonetic = '';
                        this.data.lastNamePhonetic = '';
                        this.updateNamePronunciationUI();
                    }
                }

                if (this.saveTimeout) {
                    clearTimeout(this.saveTimeout);
                }

                this.saveToken += 1;
                const token = this.saveToken;

                this.saveTimeout = setTimeout(async () => {
                    if (token !== this.saveToken) return;

                    const dataToSave = JSON.parse(JSON.stringify(this.data || {}));

                    if (this.encryptionEnabled) {
                        const encrypted = await CryptoHelper.encrypt(dataToSave);
                        safeSave(this.storageKey, encrypted);
                    } else {
                        safeSave(this.storageKey, JSON.stringify(dataToSave));
                    }

                    const ind = document.getElementById('saveIndicator');
                    if (ind) {
                        ind.style.opacity = 1;
                        setTimeout(() => { ind.style.opacity = 0; }, 1500);
                    }
                }, 500);
            },

            async load() {
                const s = localStorage.getItem(this.storageKey);
                if (!s) return;
                
                // Try decrypting first
                if (this.encryptionEnabled) {
                    const decrypted = await CryptoHelper.decrypt(s);
                    if (decrypted) {
                        this.applyData(decrypted);
                    } else {
                        console.warn('[App.load] Decryption returned null ‚Äî stored data may be corrupt or key changed');
                        this.toast('‚ö†Ô∏è Could not decrypt saved data. It may need to be re-entered.');
                    }
                } else {
                    try {
                        this.applyData(JSON.parse(s));
                    } catch (e) {
                        console.error('[App.load] Corrupt JSON in localStorage:', e);
                        this.toast('‚ö†Ô∏è Saved data was corrupted. Starting fresh.');
                    }
                }
            },

            applyData(data) {
                this.data = data || {};
                Object.keys(this.data).forEach(k => {
                    const el = document.getElementById(k);
                    if(el) {
                        if(el.type === 'checkbox') {
                            el.checked = this.data[k];
                        } else {
                            el.value = this.data[k];
                        }
                    }
                    if(k === 'qType') {
                        const r = document.querySelector(`input[name="qType"][value="${this.data[k]}"]`);
                        if(r) r.checked = true;
                    }
                });
                this.checkUpdates();
                this.handleType();
                this.updateNamePronunciationUI();
                this.restoreCoApplicantUI();
                this.syncSegmentedControls();
                // Restore drivers/vehicles arrays and render cards
                this.loadDriversVehicles();
            },

            syncSegmentedControls() {
                document.querySelectorAll('.seg-group[data-field]').forEach(group => {
                    const fieldId = group.dataset.field;
                    const val = this.data[fieldId] || '';
                    group.querySelectorAll('.seg-btn').forEach(btn => {
                        btn.classList.toggle('seg-active', btn.dataset.value === val);
                    });
                });
                // Sync iOS toggle switches
                document.querySelectorAll('[data-toggle-field]').forEach(toggle => {
                    const fieldId = toggle.dataset.toggleField;
                    const val = this.data[fieldId] || '';
                    toggle.checked = (val === 'Yes');
                });
                // Restore progressive disclosure state
                const secHeatVal = this.data.secondaryHeating || '';
                const secHeatCheck = document.getElementById('hasSecondaryHeating');
                const secHeatWrap = document.getElementById('secondaryHeatingWrapper');
                if (secHeatCheck && secHeatWrap) {
                    const hasValue = secHeatVal !== '';
                    secHeatCheck.checked = hasValue;
                    secHeatWrap.classList.toggle('disclosure-hidden', !hasValue);
                }
                // Restore earthquake disclosure state
                const eqVal = this.data.earthquakeCoverage || '';
                const eqWrap = document.getElementById('earthquakeDetailsWrapper');
                if (eqWrap) {
                    eqWrap.classList.toggle('disclosure-hidden', eqVal !== 'Yes');
                }
            },

            // === CARRIER AUTOCOMPLETE ===
            _carrierListCache: null,

            getCarrierList() {
                if (this._carrierListCache) return this._carrierListCache;
                const dl = document.getElementById('carrierList');
                if (!dl) return [];
                this._carrierListCache = Array.from(dl.options).map(o => o.value).filter(Boolean);
                return this._carrierListCache;
            },

            initCarrierAutocomplete() {
                const carriers = this.getCarrierList();
                const optionsHTML = '<option value="">Select carrier...</option>' +
                    carriers.map(c => {
                        const esc = c.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
                        return `<option value="${esc}">${esc}</option>`;
                    }).join('');
                ['homePriorCarrier', 'priorCarrier'].forEach(id => {
                    const el = document.getElementById(id);
                    if (!el || el.tagName !== 'SELECT') return;
                    el.innerHTML = optionsHTML;
                    // Restore saved value
                    if (this.data[id]) el.value = this.data[id];
                });
            },

            handleSameCarrier() {
                const cb = document.getElementById('sameAsHomeCarrier');
                const autoInput = document.getElementById('priorCarrier');
                const homeInput = document.getElementById('homePriorCarrier');
                if (!cb || !autoInput || !homeInput) return;
                if (cb.checked) {
                    autoInput.value = homeInput.value || '';
                    autoInput.disabled = true;
                    autoInput.style.opacity = '0.6';
                    autoInput.dispatchEvent(new Event('change', { bubbles: true }));
                } else {
                    autoInput.disabled = false;
                    autoInput.style.opacity = '';
                }
                this.data.sameAsHomeCarrier = cb.checked;
            },

            validatePriorYearsCoverage() {
                const yearsEl = document.getElementById('priorYears');
                const covEl = document.getElementById('continuousCoverage');
                if (!yearsEl || !covEl) return;
                const yrsVal = yearsEl.value;
                const covVal = covEl.value;
                if (!yrsVal || !covVal) return;
                const yrs = yrsVal === 'More than 15' ? 16 : parseInt(yrsVal, 10);
                const cov = covVal === 'More than 15' ? 16 : parseInt(covVal, 10);
                if (isNaN(yrs) || isNaN(cov)) return;
                if (yrs >= 5 && cov < yrs) {
                    // Auto-correct: continuous coverage should be at least as high as years with carrier
                    const targetVal = yrs > 15 ? 'More than 15' : String(yrs);
                    const opt = covEl.querySelector(`option[value="${targetVal}"]`);
                    if (opt) {
                        covEl.value = targetVal;
                        covEl.dispatchEvent(new Event('change', { bubbles: true }));
                        this.toast(`\u2139\ufe0f Continuous coverage updated to match ${yrsVal} years with carrier`);
                    }
                }
            },

            // === PROGRESSIVE DISCLOSURE ===
            checkUpdates() {
                const yrBuilt = document.getElementById('yrBuilt').value;
                const updatesCard = document.getElementById('updatesCard');
                
                if(yrBuilt && parseInt(yrBuilt) < 2000) {
                    updatesCard.classList.remove('hidden');
                } else {
                    updatesCard.classList.add('hidden');
                }
            },

            // === FEATURES ===
            async decodeVin(el) {
                const v = (el.value || '').toUpperCase().trim();
                const resultEl = document.getElementById('vinResult');
                const vinRegex = /^[A-HJ-NPR-Z0-9]{17}$/;

                if (!v) {
                    if (resultEl) resultEl.innerText = '';
                    return;
                }

                if (!vinRegex.test(v)) {
                    if (resultEl) resultEl.innerText = 'Invalid VIN format (17 chars, no I/O/Q).';
                    return;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                try {
                    if (resultEl) resultEl.innerText = 'Decoding VIN...';
                    const r = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${v}?format=json`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    if (!r.ok) {
                        throw new Error(`VIN decode failed: ${r.status}`);
                    }

                    const d = await r.json();
                    const r1 = d && d.Results && d.Results[0];
                    if (!r1) {
                        throw new Error('No vehicle data found for VIN');
                    }

                    const desc = `${r1.ModelYear || ''} ${r1.Make || ''} ${r1.Model || ''}`.trim();
                    const descEl = document.getElementById('vehDesc');
                    if (descEl) descEl.value = desc;
                    if (resultEl) resultEl.innerText = desc ? `OK ${desc}` : 'VIN decoded.';
                    this.data.vehDesc = desc;
                } catch (e) {
                    clearTimeout(timeoutId);
                    if (resultEl) {
                        resultEl.innerText = e && e.name === 'AbortError'
                            ? 'VIN decode timed out. Enter details manually.'
                            : 'VIN decode failed. Enter details manually.';
                    }
                }
            },

            fmtPhone(e) {
                let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            },

            // === MAP PREVIEWS (Street View + Satellite) ===
            async ensureMapApiKey() {
                if (this.mapApiKey) return this.mapApiKey;
                try {
                    // Try fetching from Vercel serverless function first
                    let res = await fetch('/api/places-config.js');
                    if (res.ok) {
                        const { apiKey } = await res.json();
                        if (apiKey) {
                            this.mapApiKey = apiKey;
                            return this.mapApiKey;
                        }
                    }
                } catch (e) {}
                
                try {
                    // Fallback: fetch from JSON config file (for local dev)
                    const res = await fetch('/api/config.json');
                    if (res.ok) {
                        const { apiKey } = await res.json();
                        if (apiKey) {
                            this.mapApiKey = apiKey;
                            return this.mapApiKey;
                        }
                    }
                } catch (e) {}
                
                return null;
            },

            getFullAddress(data = this.data) {
                const parts = [data.addrStreet, data.addrCity, data.addrState, data.addrZip].filter(Boolean);
                return parts.join(', ').trim();
            },

            getMapUrls(address) {
                if (!address || !this.mapApiKey) return null;
                const encoded = encodeURIComponent(address);
                const streetViewUrl = `https://maps.googleapis.com/maps/api/streetview?size=640x360&location=${encoded}&fov=80&pitch=0&key=${this.mapApiKey}`;
                const satelliteUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${encoded}&zoom=19&size=640x360&maptype=satellite&key=${this.mapApiKey}`;
                return { streetViewUrl, satelliteUrl };
            },

            async updateMapPreviews() {
                const hint = document.getElementById('mapPreviewHint');
                const streetImg = document.getElementById('streetViewImg');
                const satImg = document.getElementById('satelliteViewImg');
                if (!streetImg || !satImg) return;

                streetImg.onclick = () => this.openStreetView();
                satImg.onclick = () => this.openGoogleMaps();

                const address = this.getFullAddress();
                if (!address) {
                    if (hint) hint.textContent = 'Enter an address to load previews.';
                    streetImg.removeAttribute('src');
                    satImg.removeAttribute('src');
                    return;
                }

                const apiKey = await this.ensureMapApiKey();
                if (!apiKey) {
                    if (hint) hint.textContent = 'Map previews unavailable (API key not configured).';
                    return;
                }

                const cached = this.mapPreviewCache[address];
                if (cached) {
                    streetImg.src = cached.streetViewUrl;
                    satImg.src = cached.satelliteUrl;
                    if (hint) hint.textContent = ' '; 
                    return;
                }

                const urls = this.getMapUrls(address);
                if (!urls) return;

                this.mapPreviewCache[address] = urls;
                streetImg.src = urls.streetViewUrl;
                satImg.src = urls.satelliteUrl;
                if (hint) hint.textContent = ' ';
            },

            scheduleMapPreviewUpdate() {
                clearTimeout(this.mapPreviewTimer);
                this.mapPreviewTimer = setTimeout(() => this.updateMapPreviews(), 450);
            },

            openGoogleMaps() {
                const address = this.getFullAddress();
                if (!address) return;
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`, '_blank');
            },

            openGoogleEarth() {
                const address = this.getFullAddress();
                if (!address) return;
                window.open(`https://earth.google.com/web/search/${encodeURIComponent(address)}`, '_blank');
            },

            async openStreetView() {
                const address = this.getFullAddress();
                if (!address) return;

                try {
                    const apiKey = await this.ensureMapApiKey();
                    if (apiKey) {
                        const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`;
                        const res = await fetch(geocodeUrl);
                        if (res.ok) {
                            const data = await res.json();
                            const loc = data?.results?.[0]?.geometry?.location;
                            if (loc && typeof loc.lat === 'number' && typeof loc.lng === 'number') {
                                window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${loc.lat},${loc.lng}`, '_blank');
                                return;
                            }
                        }
                    }
                } catch (e) {}

                window.open(`https://www.google.com/maps/@?api=1&map_action=pano&query=${encodeURIComponent(address)}`, '_blank');
            },

            async fetchImageDataUrl(url) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) return null;
                    const buffer = await res.arrayBuffer();
                    const bytes = new Uint8Array(buffer);
                    const base64 = btoa(String.fromCharCode(...bytes));
                    const contentType = res.headers.get('content-type') || 'image/jpeg';
                    const format = contentType.includes('png') ? 'PNG' : 'JPEG';
                    return { dataUrl: `data:${contentType};base64,${base64}`, format };
                } catch (e) {
                    return null;
                }
            },

            async getMapImages(address) {
                const apiKey = await this.ensureMapApiKey();
                if (!apiKey || !address) return null;
                const urls = this.getMapUrls(address);
                if (!urls) return null;

                const cacheKey = `${address}::data`;
                if (this.mapPreviewCache[cacheKey]) return this.mapPreviewCache[cacheKey];

                const [street, sat] = await Promise.all([
                    this.fetchImageDataUrl(urls.streetViewUrl),
                    this.fetchImageDataUrl(urls.satelliteUrl)
                ]);

                const result = {
                    streetView: street,
                    satellite: sat
                };
                this.mapPreviewCache[cacheKey] = result;
                return result;
            },

            // === MULTIPLE DRIVERS/VEHICLES ===
            addDriver() {
                const id = `driver_${Date.now()}`;
                const driver = {
                    id,
                    firstName: '',
                    lastName: '',
                    dob: '',
                    dlNum: '',
                    dlState: 'WA',
                    relationship: 'Self'
                };
                this.drivers.push(driver);
                this.renderDrivers();
                this.saveDriversVehicles();
            },

            removeDriver(id) {
                this.drivers = this.drivers.filter(d => d.id !== id);
                this.renderDrivers();
                this.saveDriversVehicles();
            },

            updateDriver(id, field, value) {
                const driver = this.drivers.find(d => d.id === id);
                if (driver) {
                    // Normalize license # and state to uppercase
                    if (field === 'dlNum' || field === 'dlState') value = (value || '').toUpperCase();
                    driver[field] = value;
                    this.saveDriversVehicles();
                }
            },

            openDriverLicensePicker(driverId) {
                const input = document.getElementById(`dlScan_${driverId}`);
                if (input) input.click();
            },

            async handleDriverLicenseFile(driverId, file) {
                if (!file) return;
                const previewUrl = URL.createObjectURL(file);
                const result = await this.processDriverLicenseImage(file);
                if (!result?.success) {
                    URL.revokeObjectURL(previewUrl);
                    const errorMsg = result?.error || 'Unable to read driver license';
                    this.toast(`‚ö†Ô∏è ${errorMsg}`);
                    console.error('[DL Scan] Failed:', result);
                    return;
                }

                const driver = this.drivers.find(d => d.id === driverId);
                if (!driver) return;

                driver.dlScanPreview = previewUrl;
                driver.dlScanConfidence = result.confidence || '';

                const data = result.data || {};

                if (!driver.firstName && data.firstName) driver.firstName = data.firstName;
                if (!driver.lastName && data.lastName) driver.lastName = data.lastName;
                if (!driver.dob && data.dob) driver.dob = data.dob;
                if (!driver.dlNum && data.licenseNumber) driver.dlNum = (data.licenseNumber || '').toUpperCase();
                if (!driver.dlState && data.licenseState) driver.dlState = (data.licenseState || '').toUpperCase();

                const setFieldIfEmpty = (id, value) => {
                    if (!value) return;
                    const el = document.getElementById(id);
                    if (!el || el.value) return;
                    el.value = value;
                    this.save({ target: { id, value } });
                };

                setFieldIfEmpty('addrStreet', data.addressLine1);
                setFieldIfEmpty('addrCity', data.city);
                setFieldIfEmpty('addrState', data.state);
                setFieldIfEmpty('addrZip', data.zip);

                this.saveDriversVehicles();
                this.renderDrivers();
                this.toast('‚úÖ License data captured');
            },

            async processDriverLicenseImage(imageFile) {
                if (!imageFile) return null;

                // Always resize and compress images for Vercel 4.5MB limit
                const convertedFile = await this.convertImageToJPEG(imageFile);

                const reader = new FileReader();
                return new Promise((resolve) => {
                    reader.onload = async (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        const mimeType = convertedFile.type || 'image/jpeg';
                        
                        // Check base64 size (33% larger than raw file)
                        const base64SizeKB = (base64Data.length * 0.75 / 1024).toFixed(1);
                        const base64SizeMB = (base64Data.length * 0.75 / 1024 / 1024).toFixed(2);
                        console.log(`[DL Scan] Base64 size: ${base64SizeKB}KB (${base64SizeMB}MB)`);
                        
                        // Reject if payload would exceed 4MB (safer than 4.5MB limit)
                        if (base64Data.length * 0.75 > 4000000) {
                            console.error(`[DL Scan] Base64 too large: ${base64SizeMB}MB exceeds 4MB limit`);
                            return resolve({
                                success: false,
                                error: 'Image still too large after compression. Try cropping closer or use a different camera. (Error 413)',
                                errorCode: 413
                            });
                        }

                        console.log(`[DL Scan] Uploading image: ${convertedFile.type}, size: ${(convertedFile.size / 1024).toFixed(1)}KB`);

                        try {
                            const response = await fetch('/api/vision-processor.js', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'scanDriverLicense',
                                    base64Data,
                                    mimeType
                                })
                            });

                            console.log(`[DL Scan] Response status: ${response.status} ${response.statusText}`);

                            if (!response.ok) {
                                console.error(`[DL Scan] HTTP error: ${response.status}`);
                                const errorText = await response.text();
                                console.error('[DL Scan] Error response:', errorText);
                                
                                // Handle payload too large error specifically
                                if (response.status === 413) {
                                    return resolve({ 
                                        success: false, 
                                        error: 'Image too large. Please try again with a smaller photo or crop closer to the license. (Error 413)',
                                        errorCode: 413
                                    });
                                }
                                
                                return resolve({ 
                                    success: false, 
                                    error: `Network error (${response.status}): ${response.statusText}`,
                                    errorCode: response.status
                                });
                            }

                            const result = await response.json();
                            console.log('[DL Scan] API result:', result);
                            
                            if (!result.success) {
                                console.error('[DL Scan] API Error:', result.error, 'Code:', result.errorCode);
                            } else {
                                console.log('[DL Scan] Success! Confidence:', result.confidence);
                            }
                            
                            resolve(result);
                        } catch (error) {
                            console.error('[DL Scan] Exception:', error);
                            resolve({ 
                                success: false, 
                                error: `Client error: ${error.message} (Error 999)`,
                                errorCode: 999
                            });
                        }
                    };
                    reader.readAsDataURL(convertedFile);
                });
            },

            async convertImageToJPEG(file) {
                // Always resize and compress all images to stay under Vercel's 4.5MB limit
                // Modern phones take 5-10MB+ photos that exceed the limit
                console.log(`[Image Convert] Processing ${file.type || 'unknown'}: ${(file.size / 1024).toFixed(1)}KB`);

                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            // Create canvas and draw image
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Aggressive compression for Vercel 4.5MB payload limit
                            // 800px is plenty for driver license OCR
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 800;
                            let width = img.width;
                            let height = img.height;

                            if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                                const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                                width = width * ratio;
                                height = height * ratio;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);

                            // Try quality 0.65 first (very aggressive compression)
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    const sizeKB = (blob.size / 1024).toFixed(1);
                                    const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
                                    const originalMB = (file.size / 1024 / 1024).toFixed(2);
                                    console.log(`[Image Convert] ${originalMB}MB ‚Üí ${sizeMB}MB (${sizeKB}KB)`);
                                    
                                    // If still too large, try even smaller
                                    if (blob.size > 2500000) { // 2.5MB raw ‚Üí ~3.3MB base64
                                        console.log('[Image Convert] Still large, reducing to 600px...');
                                        canvas.width = width * 0.75;
                                        canvas.height = height * 0.75;
                                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                        
                                        canvas.toBlob((smallerBlob) => {
                                            if (smallerBlob) {
                                                console.log(`[Image Convert] Final: ${(smallerBlob.size / 1024).toFixed(1)}KB`);
                                                const convertedFile = new File([smallerBlob], 'converted.jpg', { type: 'image/jpeg' });
                                                resolve(convertedFile);
                                            } else {
                                                const convertedFile = new File([blob], 'converted.jpg', { type: 'image/jpeg' });
                                                resolve(convertedFile);
                                            }
                                        }, 'image/jpeg', 0.6);
                                    } else {
                                        const convertedFile = new File([blob], 'converted.jpg', { type: 'image/jpeg' });
                                        resolve(convertedFile);
                                    }
                                } else {
                                    console.warn('[Image Convert] Failed, using original');
                                    resolve(file);
                                }
                            }, 'image/jpeg', 0.65);
                        };
                        img.onerror = () => {
                            console.warn('[Image Convert] Image load failed, using original');
                            resolve(file);
                        };
                        img.src = e.target.result;
                    };
                    reader.onerror = () => {
                        console.warn('[Image Convert] File read failed, using original');
                        resolve(file);
                    };
                    reader.readAsDataURL(file);
                });
            },

            renderDrivers() {
                const container = document.getElementById('driversList');
                if (!container) return;
                
                if (this.drivers.length === 0) {
                    container.innerHTML = '<div class="hint">No drivers added yet. Click "+ Add Driver" below to get started.</div>';
                    return;
                }
                
                container.innerHTML = this.drivers.map((driver, index) => {
                    const isPrimary = index === 0;
                    const relationshipLabel = driver.relationship
                        ? (driver.relationship === 'Self' && isPrimary ? '‚Ä¢ Self' : (driver.relationship !== 'Self' ? `‚Ä¢ ${driver.relationship}` : ''))
                        : '';

                    return `
                    <div class="driver-vehicle-card">
                        <div class="driver-vehicle-header">
                            <h3>Driver ${index + 1} ${relationshipLabel}</h3>
                            <button class="remove-btn" onclick="App.removeDriver('${driver.id}')" title="Remove driver">√ó</button>
                        </div>
                        
                        <div class="grid-2">
                            <div>
                                <label class="label">First Name</label>
                                <input type="text" value="${this._escapeAttr(driver.firstName || '')}" 
                                    onchange="App.updateDriver('${driver.id}', 'firstName', this.value)" 
                                    placeholder="First name">
                            </div>
                            <div>
                                <label class="label">Last Name</label>
                                <input type="text" value="${this._escapeAttr(driver.lastName || '')}" 
                                    onchange="App.updateDriver('${driver.id}', 'lastName', this.value)" 
                                    placeholder="Last name">
                            </div>
                        </div>
                        
                        <div class="grid-2">
                            <div>
                                <label class="label">Date of Birth</label>
                                <input type="date" value="${driver.dob || ''}" 
                                    onchange="App.updateDriver('${driver.id}', 'dob', this.value)">
                            </div>
                            <div>
                                <label class="label">Relationship</label>
                                <select onchange="App.updateDriver('${driver.id}', 'relationship', this.value)">
                                    ${isPrimary ? `<option value="Self" ${driver.relationship === 'Self' ? 'selected' : ''}>Self (Primary)</option>` : ''}
                                    <option value="Spouse" ${driver.relationship === 'Spouse' ? 'selected' : ''}>Spouse / Partner</option>
                                    <option value="Child" ${driver.relationship === 'Child' ? 'selected' : ''}>Child</option>
                                    <option value="Parent" ${driver.relationship === 'Parent' ? 'selected' : ''}>Parent</option>
                                    <option value="Other" ${driver.relationship === 'Other' ? 'selected' : ''}>Other Household Member</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="label">Gender</label>
                                <select onchange="App.updateDriver('${driver.id}', 'gender', this.value)">
                                    <option value="">Select...</option>
                                    <option value="M" ${driver.gender === 'M' ? 'selected' : ''}>Male</option>
                                    <option value="F" ${driver.gender === 'F' ? 'selected' : ''}>Female</option>
                                    <option value="X" ${driver.gender === 'X' ? 'selected' : ''}>Not Specified</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Marital Status</label>
                                <select onchange="App.updateDriver('${driver.id}', 'maritalStatus', this.value)">
                                    <option value="" ${!driver.maritalStatus ? 'selected' : ''}>Select...</option>
                                    <option value="Single" ${driver.maritalStatus === 'Single' ? 'selected' : ''}>Single</option>
                                    <option value="Married" ${driver.maritalStatus === 'Married' ? 'selected' : ''}>Married</option>
                                    <option value="Domestic Partner" ${driver.maritalStatus === 'Domestic Partner' ? 'selected' : ''}>Domestic Partner</option>
                                    <option value="Widowed" ${driver.maritalStatus === 'Widowed' ? 'selected' : ''}>Widowed</option>
                                    <option value="Separated" ${driver.maritalStatus === 'Separated' ? 'selected' : ''}>Separated</option>
                                    <option value="Divorced" ${driver.maritalStatus === 'Divorced' ? 'selected' : ''}>Divorced</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="label">Occupation Industry</label>
                                <select onchange="App.updateDriver('${driver.id}', 'occupation', this.value)">
                                    <option value="" ${!driver.occupation ? 'selected' : ''}>Select...</option>
                                    <option value="Homemaker/House person" ${driver.occupation === 'Homemaker/House person' ? 'selected' : ''}>Homemaker / House Person</option>
                                    <option value="Retired" ${driver.occupation === 'Retired' ? 'selected' : ''}>Retired</option>
                                    <option value="Disabled" ${driver.occupation === 'Disabled' ? 'selected' : ''}>Disabled</option>
                                    <option value="Unemployed" ${driver.occupation === 'Unemployed' ? 'selected' : ''}>Unemployed</option>
                                    <option value="Student" ${driver.occupation === 'Student' ? 'selected' : ''}>Student</option>
                                    <option value="Agriculture/Forestry/Fishing" ${driver.occupation === 'Agriculture/Forestry/Fishing' ? 'selected' : ''}>Agriculture / Forestry / Fishing</option>
                                    <option value="Art/Design/Media" ${driver.occupation === 'Art/Design/Media' ? 'selected' : ''}>Art / Design / Media</option>
                                    <option value="Banking/Finance/Real Estate" ${driver.occupation === 'Banking/Finance/Real Estate' ? 'selected' : ''}>Banking / Finance / Real Estate</option>
                                    <option value="Business/Sales/Office" ${driver.occupation === 'Business/Sales/Office' ? 'selected' : ''}>Business / Sales / Office</option>
                                    <option value="Construction/Energy Trades" ${driver.occupation === 'Construction/Energy Trades' ? 'selected' : ''}>Construction / Energy Trades</option>
                                    <option value="Education/Library" ${driver.occupation === 'Education/Library' ? 'selected' : ''}>Education / Library</option>
                                    <option value="Engineer/Architect/Science/Math" ${driver.occupation === 'Engineer/Architect/Science/Math' ? 'selected' : ''}>Engineer / Architect / Science / Math</option>
                                    <option value="Government/Military" ${driver.occupation === 'Government/Military' ? 'selected' : ''}>Government / Military</option>
                                    <option value="Information Technology" ${driver.occupation === 'Information Technology' ? 'selected' : ''}>Information Technology</option>
                                    <option value="Insurance" ${driver.occupation === 'Insurance' ? 'selected' : ''}>Insurance</option>
                                    <option value="Legal/Law Enforcement/Security" ${driver.occupation === 'Legal/Law Enforcement/Security' ? 'selected' : ''}>Legal / Law Enforcement / Security</option>
                                    <option value="Maintenance/Repair/Housekeeping" ${driver.occupation === 'Maintenance/Repair/Housekeeping' ? 'selected' : ''}>Maintenance / Repair / Housekeeping</option>
                                    <option value="Manufacturing/Production" ${driver.occupation === 'Manufacturing/Production' ? 'selected' : ''}>Manufacturing / Production</option>
                                    <option value="Medical/Social Services/Religion" ${driver.occupation === 'Medical/Social Services/Religion' ? 'selected' : ''}>Medical / Social Services / Religion</option>
                                    <option value="Personal Care/Service" ${driver.occupation === 'Personal Care/Service' ? 'selected' : ''}>Personal Care / Service</option>
                                    <option value="Restaurant/Hotel Services" ${driver.occupation === 'Restaurant/Hotel Services' ? 'selected' : ''}>Restaurant / Hotel Services</option>
                                    <option value="Sports/Recreation" ${driver.occupation === 'Sports/Recreation' ? 'selected' : ''}>Sports / Recreation</option>
                                    <option value="Travel/Transportation/Warehousing" ${driver.occupation === 'Travel/Transportation/Warehousing' ? 'selected' : ''}>Travel / Transportation / Warehousing</option>
                                    <option value="Other" ${driver.occupation === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Education</label>
                                <select onchange="App.updateDriver('${driver.id}', 'education', this.value)">
                                    <option value="" ${!driver.education ? 'selected' : ''}>Select...</option>
                                    <option value="No High School" ${driver.education === 'No High School' ? 'selected' : ''}>No High School Diploma</option>
                                    <option value="High School" ${driver.education === 'High School' ? 'selected' : ''}>High School Diploma</option>
                                    <option value="Some College" ${driver.education === 'Some College' ? 'selected' : ''}>Some College</option>
                                    <option value="Associates" ${driver.education === 'Associates' ? 'selected' : ''}>Associate's Degree</option>
                                    <option value="Bachelors" ${driver.education === 'Bachelors' ? 'selected' : ''}>Bachelor's Degree</option>
                                    <option value="Masters" ${driver.education === 'Masters' ? 'selected' : ''}>Master's Degree</option>
                                    <option value="Doctorate" ${driver.education === 'Doctorate' ? 'selected' : ''}>Doctorate</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="label">DL Status</label>
                                <select onchange="App.updateDriver('${driver.id}', 'dlStatus', this.value)">
                                    <option value="" ${!driver.dlStatus ? 'selected' : ''}>Select...</option>
                                    <option value="Valid" ${driver.dlStatus === 'Valid' ? 'selected' : ''}>Valid</option>
                                    <option value="Permit" ${driver.dlStatus === 'Permit' ? 'selected' : ''}>Permit</option>
                                    <option value="Expired" ${driver.dlStatus === 'Expired' ? 'selected' : ''}>Expired</option>
                                    <option value="Suspended" ${driver.dlStatus === 'Suspended' ? 'selected' : ''}>Suspended</option>
                                    <option value="Cancelled" ${driver.dlStatus === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                    <option value="Not Licensed" ${driver.dlStatus === 'Not Licensed' ? 'selected' : ''}>Not Licensed</option>
                                    <option value="Permanently Revoked" ${driver.dlStatus === 'Permanently Revoked' ? 'selected' : ''}>Permanently Revoked</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Age Licensed</label>
                                <select onchange="App.updateDriver('${driver.id}', 'ageLicensed', this.value)">
                                    <option value="" ${!driver.ageLicensed ? 'selected' : ''}>Select...</option>
                                    <option value="16" ${driver.ageLicensed === '16' ? 'selected' : ''}>16</option>
                                    <option value="17" ${driver.ageLicensed === '17' ? 'selected' : ''}>17</option>
                                    <option value="18" ${driver.ageLicensed === '18' ? 'selected' : ''}>18</option>
                                    <option value="19" ${driver.ageLicensed === '19' ? 'selected' : ''}>19</option>
                                    <option value="20" ${driver.ageLicensed === '20' ? 'selected' : ''}>20</option>
                                    <option value="21+" ${driver.ageLicensed === '21+' ? 'selected' : ''}>21+</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="label">SR-22 Required</label>
                                <select onchange="App.updateDriver('${driver.id}', 'sr22', this.value)">
                                    <option value="No" ${driver.sr22 !== 'Yes' ? 'selected' : ''}>No</option>
                                    <option value="Yes" ${driver.sr22 === 'Yes' ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">FR-44 Required</label>
                                <select onchange="App.updateDriver('${driver.id}', 'fr44', this.value)">
                                    <option value="No" ${driver.fr44 !== 'Yes' ? 'selected' : ''}>No</option>
                                    <option value="Yes" ${driver.fr44 === 'Yes' ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="label">Good Driver</label>
                                <select onchange="App.updateDriver('${driver.id}', 'goodDriver', this.value)">
                                    <option value="" ${!driver.goodDriver ? 'selected' : ''}>Select...</option>
                                    <option value="Yes" ${driver.goodDriver === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${driver.goodDriver === 'No' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Mature Driver</label>
                                <select onchange="App.updateDriver('${driver.id}', 'matureDriver', this.value)">
                                    <option value="" ${!driver.matureDriver ? 'selected' : ''}>Select...</option>
                                    <option value="Yes" ${driver.matureDriver === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${driver.matureDriver === 'No' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="label">License Sus/Rev (Last 5 yrs)</label>
                                <select onchange="App.updateDriver('${driver.id}', 'licenseSusRev', this.value)">
                                    <option value="No" ${driver.licenseSusRev !== 'Yes' ? 'selected' : ''}>No</option>
                                    <option value="Yes" ${driver.licenseSusRev === 'Yes' ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Driver Education</label>
                                <select onchange="App.updateDriver('${driver.id}', 'driverEducation', this.value)">
                                    <option value="No" ${driver.driverEducation !== 'Yes' ? 'selected' : ''}>No</option>
                                    <option value="Yes" ${driver.driverEducation === 'Yes' ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                        </div>

                        <label class="label">Driver's License</label>
                        <div class="export-row" style="margin-bottom:10px; align-items:center;">
                            <button class="btn btn-tertiary" onclick="App.openDriverLicensePicker('${driver.id}')">üì∏ Scan Driver's License</button>
                            <input id="dlScan_${driver.id}" type="file" accept="image/*" class="hidden" onchange="App.handleDriverLicenseFile('${driver.id}', this.files[0])" />
                            ${driver.dlScanPreview ? `<img src="${driver.dlScanPreview}" alt="DL preview" style="width:48px;height:32px;object-fit:cover;border-radius:6px;border:1px solid var(--border);" />` : ''}
                            ${driver.dlScanConfidence ? `<span class="hint" style="margin:0; padding:6px 10px;">${driver.dlScanConfidence}% confidence</span>` : ''}
                        </div>
                        <div class="grid-2">
                            <input type="text" value="${this._escapeAttr(driver.dlNum || '')}" 
                                onchange="App.updateDriver('${driver.id}', 'dlNum', this.value)" 
                                style="text-transform:uppercase;font-family:monospace" 
                                placeholder="License #">
                            <input type="text" value="${this._escapeAttr(driver.dlState || 'WA')}" 
                                onchange="App.updateDriver('${driver.id}', 'dlState', this.value)" 
                                placeholder="State" maxlength="2" style="text-transform:uppercase">
                        </div>
                    </div>
                `;
                }).join('');
            },

            addVehicle() {
                const id = `vehicle_${Date.now()}`;
                const vehicle = {
                    id,
                    vin: '',
                    year: '',
                    make: '',
                    model: '',
                    use: 'Commute',
                    miles: '12000',
                    primaryDriver: ''
                };
                this.vehicles.push(vehicle);
                this.renderVehicles();
                this.saveDriversVehicles();
            },

            removeVehicle(id) {
                this.vehicles = this.vehicles.filter(v => v.id !== id);
                this.renderVehicles();
                this.saveDriversVehicles();
            },

            updateVehicle(id, field, value) {
                const vehicle = this.vehicles.find(v => v.id === id);
                if (vehicle) {
                    vehicle[field] = value;
                    clearTimeout(this._vehicleSaveTimer);
                    this._vehicleSaveTimer = setTimeout(() => this.saveDriversVehicles(), 300);
                }
            },

            async decodeVehicleVin(id, vin) {
                const vehicle = this.vehicles.find(v => v.id === id);
                if (!vehicle) return;

                const vinUpper = (vin || '').toUpperCase().trim();
                vehicle.vin = vinUpper;

                const vinRegex = /^[A-HJ-NPR-Z0-9]{17}$/;
                if (!vinUpper) {
                    this.renderVehicles();
                    return;
                }

                if (!vinRegex.test(vinUpper)) {
                    if (typeof this.toast === 'function') {
                        this.toast('Invalid VIN format (17 chars, no I/O/Q).');
                    }
                    this.renderVehicles();
                    return;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                try {
                    const r = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vinUpper}?format=json`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    if (!r.ok) {
                        throw new Error(`VIN decode failed: ${r.status}`);
                    }

                    const d = await r.json();
                    const r1 = d && d.Results && d.Results[0];
                    if (!r1) {
                        throw new Error('No vehicle data found for VIN');
                    }

                    vehicle.year = r1.ModelYear || '';
                    vehicle.make = r1.Make || '';
                    vehicle.model = r1.Model || '';

                    this.renderVehicles();
                    this.saveDriversVehicles();
                } catch (e) {
                    clearTimeout(timeoutId);
                    if (typeof this.toast === 'function') {
                        this.toast(e && e.name === 'AbortError'
                            ? 'VIN decode timed out. Enter details manually.'
                            : 'VIN decode failed. Enter details manually.');
                    }
                    console.error('VIN decode error:', e);
                }
            },

            renderVehicles() {
                const container = document.getElementById('vehiclesList');
                if (!container) return;
                
                if (this.vehicles.length === 0) {
                    container.innerHTML = '<div class="hint">No vehicles added yet. Click "+ Add Vehicle" below to get started.</div>';
                    return;
                }
                
                const driverOptions = this.drivers.map(d => 
                    `<option value="${d.id}">${this._escapeAttr(d.firstName)} ${this._escapeAttr(d.lastName)}</option>`
                ).join('');
                
                container.innerHTML = this.vehicles.map((vehicle, index) => `
                    <div class="driver-vehicle-card">
                        <div class="driver-vehicle-header">
                            <h3>Vehicle ${index + 1} ${vehicle.year && vehicle.make ? `‚Äî ${this._escapeAttr(vehicle.year)} ${this._escapeAttr(vehicle.make)}` : ''}</h3>
                            <button class="remove-btn" onclick="App.removeVehicle('${vehicle.id}')" title="Remove vehicle">√ó</button>
                        </div>
                        
                        <label class="label">VIN (optional) - Auto-fills year/make/model</label>
                        <input type="text" maxlength="17" value="${this._escapeAttr(vehicle.vin || '')}" 
                            onchange="App.decodeVehicleVin('${vehicle.id}', this.value)" 
                            style="text-transform:uppercase;font-family:monospace" 
                            placeholder="1HG...">
                        <div class="hint" style="margin-top:6px;">No VIN? Leave blank and fill Year/Make/Model below.</div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div>
                                <label class="label">Year</label>
                                <input type="text" inputmode="numeric" maxlength="4" value="${this._escapeAttr(vehicle.year || '')}" 
                                    oninput="App.updateVehicle('${vehicle.id}', 'year', this.value)"
                                    onchange="App.updateVehicle('${vehicle.id}', 'year', this.value)" 
                                    placeholder="2020" style="min-width:0;">
                            </div>
                            <div>
                                <label class="label">Make</label>
                                <input type="text" value="${this._escapeAttr(vehicle.make || '')}" 
                                    oninput="App.updateVehicle('${vehicle.id}', 'make', this.value)"
                                    onchange="App.updateVehicle('${vehicle.id}', 'make', this.value)" 
                                    placeholder="Honda">
                            </div>
                            <div>
                                <label class="label">Model</label>
                                <input type="text" value="${this._escapeAttr(vehicle.model || '')}" 
                                    oninput="App.updateVehicle('${vehicle.id}', 'model', this.value)"
                                    onchange="App.updateVehicle('${vehicle.id}', 'model', this.value)" 
                                    placeholder="Civic">
                            </div>
                        </div>
                        
                        <div class="grid-2">
                            <div>
                                <label class="label">Primary Use</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'use', this.value)">
                                    <option value="Pleasure" ${vehicle.use === 'Pleasure' ? 'selected' : ''}>Pleasure</option>
                                    <option value="Commute" ${vehicle.use === 'Commute' ? 'selected' : ''}>To/From Work</option>
                                    <option value="To/From School" ${vehicle.use === 'To/From School' ? 'selected' : ''}>To/From School</option>
                                    <option value="Business" ${vehicle.use === 'Business' ? 'selected' : ''}>Business</option>
                                    <option value="Farming" ${vehicle.use === 'Farming' ? 'selected' : ''}>Farming</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Annual Mileage</label>
                                <input type="number" value="${vehicle.miles || '12000'}" 
                                    onchange="App.updateVehicle('${vehicle.id}', 'miles', this.value)" 
                                    placeholder="12000">
                            </div>
                        </div>
                        
                        <div class="grid-2">
                            <div>
                                <label class="label">Ownership Type</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'ownershipType', this.value)">
                                    <option value="" ${!vehicle.ownershipType ? 'selected' : ''}>Select...</option>
                                    <option value="Owned" ${vehicle.ownershipType === 'Owned' ? 'selected' : ''}>Owned</option>
                                    <option value="Leased" ${vehicle.ownershipType === 'Leased' ? 'selected' : ''}>Leased</option>
                                    <option value="Lien" ${vehicle.ownershipType === 'Lien' ? 'selected' : ''}>Lien</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Performance</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'performance', this.value)">
                                    <option value="" ${!vehicle.performance ? 'selected' : ''}>Select...</option>
                                    <option value="Standard" ${vehicle.performance === 'Standard' ? 'selected' : ''}>Standard</option>
                                    <option value="Sports" ${vehicle.performance === 'Sports' ? 'selected' : ''}>Sports</option>
                                    <option value="Intermediate" ${vehicle.performance === 'Intermediate' ? 'selected' : ''}>Intermediate</option>
                                    <option value="High Performance" ${vehicle.performance === 'High Performance' ? 'selected' : ''}>High Performance</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="label">Anti-Theft</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'antiTheft', this.value)">
                                    <option value="" ${!vehicle.antiTheft ? 'selected' : ''}>None</option>
                                    <option value="Active" ${vehicle.antiTheft === 'Active' ? 'selected' : ''}>Active</option>
                                    <option value="Alarm Only" ${vehicle.antiTheft === 'Alarm Only' ? 'selected' : ''}>Alarm Only</option>
                                    <option value="Passive" ${vehicle.antiTheft === 'Passive' ? 'selected' : ''}>Passive</option>
                                    <option value="Vehicle Recovery System" ${vehicle.antiTheft === 'Vehicle Recovery System' ? 'selected' : ''}>Vehicle Recovery System</option>
                                    <option value="Both Active and Passive" ${vehicle.antiTheft === 'Both Active and Passive' ? 'selected' : ''}>Both Active and Passive</option>
                                    <option value="VIN# Etching" ${vehicle.antiTheft === 'VIN# Etching' ? 'selected' : ''}>VIN# Etching</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Passive Restraints</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'passiveRestraints', this.value)">
                                    <option value="" ${!vehicle.passiveRestraints ? 'selected' : ''}>Select...</option>
                                    <option value="Automatic Seatbelts" ${vehicle.passiveRestraints === 'Automatic Seatbelts' ? 'selected' : ''}>Automatic Seatbelts</option>
                                    <option value="Airbag (Drvr Side)" ${vehicle.passiveRestraints === 'Airbag (Drvr Side)' ? 'selected' : ''}>Airbag (Driver Side)</option>
                                    <option value="Auto Stbelts/Drvr Airbag" ${vehicle.passiveRestraints === 'Auto Stbelts/Drvr Airbag' ? 'selected' : ''}>Auto Seatbelts / Driver Airbag</option>
                                    <option value="Airbag Both Sides" ${vehicle.passiveRestraints === 'Airbag Both Sides' ? 'selected' : ''}>Airbag Both Sides</option>
                                    <option value="Auto Stbelts/Airbag Both" ${vehicle.passiveRestraints === 'Auto Stbelts/Airbag Both' ? 'selected' : ''}>Auto Seatbelts / Airbag Both</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="label">Anti-Lock Brakes</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'antiLockBrakes', this.value)">
                                    <option value="" ${!vehicle.antiLockBrakes ? 'selected' : ''}>Select...</option>
                                    <option value="Yes" ${vehicle.antiLockBrakes === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${vehicle.antiLockBrakes === 'No' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Daytime Running Lights</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'daytimeRunningLights', this.value)">
                                    <option value="" ${!vehicle.daytimeRunningLights ? 'selected' : ''}>Select...</option>
                                    <option value="Yes" ${vehicle.daytimeRunningLights === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${vehicle.daytimeRunningLights === 'No' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="label">Was the Car New?</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'carNew', this.value)">
                                    <option value="" ${!vehicle.carNew ? 'selected' : ''}>Select...</option>
                                    <option value="Yes" ${vehicle.carNew === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${vehicle.carNew === 'No' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Telematics</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'telematics', this.value)">
                                    <option value="" ${!vehicle.telematics ? 'selected' : ''}>Select...</option>
                                    <option value="Yes" ${vehicle.telematics === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${vehicle.telematics === 'No' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <label class="label">Car Pool</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'carPool', this.value)">
                                    <option value="" ${!vehicle.carPool ? 'selected' : ''}>Select...</option>
                                    <option value="Yes" ${vehicle.carPool === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${vehicle.carPool === 'No' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Rideshare (TNC)</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'tnc', this.value)">
                                    <option value="" ${!vehicle.tnc ? 'selected' : ''}>Select...</option>
                                    <option value="Yes" ${vehicle.tnc === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${vehicle.tnc === 'No' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                        </div>
                        
                        <label class="label">Primary Driver</label>
                        <select onchange="App.updateVehicle('${vehicle.id}', 'primaryDriver', this.value)">
                            <option value="">Select driver...</option>
                            ${driverOptions}
                        </select>
                    </div>
                `).join('');
            },

            async saveDriversVehicles() {
                this.data.drivers = this.drivers;
                this.data.vehicles = this.vehicles;
                
                // Encrypt and save
                if (this.encryptionEnabled) {
                    const encrypted = await CryptoHelper.encrypt(this.data);
                    safeSave(this.storageKey, encrypted);
                } else {
                    safeSave(this.storageKey, JSON.stringify(this.data));
                }
            },

            async loadDriversVehicles() {
                if (this.data.drivers && Array.isArray(this.data.drivers)) {
                    this.drivers = this.data.drivers;
                } else {
                    // Migrate old single driver/vehicle to new format
                    if (this.data.dlNum || this.data.vin) {
                        this.drivers = [{
                            id: `driver_${Date.now()}`,
                            firstName: this.data.firstName || '',
                            lastName: this.data.lastName || '',
                            dob: this.data.dob || '',
                            dlNum: this.data.dlNum || '',
                            dlState: this.data.dlState || 'WA',
                            relationship: 'Self'
                        }];
                    }
                }

                // Cleanup any stale object URLs in stored drivers
                if (Array.isArray(this.drivers)) {
                    this.drivers.forEach(d => {
                        if (d.dlScanPreview && d.dlScanPreview.startsWith('blob:')) {
                            d.dlScanPreview = '';
                        }
                    });
                }
                
                if (this.data.vehicles && Array.isArray(this.data.vehicles)) {
                    this.vehicles = this.data.vehicles;
                } else {
                    // Migrate old single vehicle
                    if (this.data.vin || this.data.vehDesc) {
                        const parts = (this.data.vehDesc || '').match(/(\d{4})\s+(.+?)\s+(.+)/);
                        this.vehicles = [{
                            id: `vehicle_${Date.now()}`,
                            vin: this.data.vin || '',
                            year: parts ? parts[1] : '',
                            make: parts ? parts[2] : '',
                            model: parts ? parts[3] : '',
                            use: this.data.use || 'Commute',
                            miles: this.data.miles || '12000',
                            primaryDriver: ''
                        }];
                    }
                }
                
                this.renderDrivers();
                this.renderVehicles();
            },

            openZillow() {
                const a = `${this.data.addrStreet || ''} ${this.data.addrCity || ''} ${this.data.addrState || ''} ${this.data.addrZip || ''}`.trim();
                if (!a) { alert('Please enter an address first.'); return; }
                // Google search for Zillow listing ‚Äî clicking through from Google bypasses Zillow's CAPTCHA
                window.open(`https://www.google.com/search?q=${encodeURIComponent(a + ' zillow')}`, '_blank');
            },

            // ‚îÄ‚îÄ Import Property Data from Chrome Extension ‚îÄ‚îÄ
            // Reads clipboard JSON from extension's "Copy for Altech" button
            async importPropertyFromExtension() {
                let text = '';
                try {
                    text = await navigator.clipboard.readText();
                } catch (e) {
                    // Clipboard API failed ‚Äî show prompt
                    text = prompt('Paste the property data from the extension (Ctrl+V):');
                }

                if (!text || !text.trim()) {
                    this.toast('‚ö†Ô∏è Clipboard is empty. In the extension, click "üìã Copy for Altech" first.');
                    return;
                }

                let parsed;
                try {
                    parsed = JSON.parse(text);
                } catch (e) {
                    this.toast('‚ö†Ô∏è Clipboard doesn\'t contain valid property data JSON.');
                    return;
                }

                // Validate it's from our extension
                if (!parsed._altech_property || !parsed.data) {
                    this.toast('‚ö†Ô∏è Not property data. Use the extension\'s "üìã Copy for Altech" button.');
                    return;
                }

                const data = parsed.data;
                let filled = 0;

                // Map scraped field keys to Altech form IDs
                const fieldMap = {
                    yrBuilt: 'yrBuilt',
                    sqFt: 'sqFt',
                    lotSize: 'lotSize',
                    bedrooms: 'bedrooms',
                    fullBaths: 'fullBaths',
                    halfBaths: 'halfBaths',
                    numStories: 'numStories',
                    numOccupants: 'numOccupants',
                    constructionStyle: 'constructionStyle',
                    exteriorWalls: 'exteriorWalls',
                    foundation: 'foundation',
                    garageType: 'garageType',
                    garageSpaces: 'garageSpaces',
                    roofType: 'roofType',
                    roofShape: 'roofShape',
                    roofYr: 'roofYr',
                    heatingType: 'heatingType',
                    heatYr: 'heatYr',
                    cooling: 'cooling',
                    plumbYr: 'plumbYr',
                    elecYr: 'elecYr',
                    flooring: 'flooring',
                    numFireplaces: 'numFireplaces',
                    pool: 'pool',
                    woodStove: 'woodStove',
                    sewer: 'sewer',
                    waterSource: 'waterSource',
                    dwellingType: 'dwellingType',
                    dwellingUsage: 'dwellingUsage',
                    occupancyType: 'occupancyType',
                    kitchenQuality: 'kitchenQuality',
                    purchaseDate: 'purchaseDate',
                    assessedValue: 'propertyValue',
                    ownerName: 'ownerName',
                    parcelId: 'parcelId',
                };

                for (const [srcKey, formId] of Object.entries(fieldMap)) {
                    const value = data[srcKey];
                    if (!value) continue;

                    const el = document.getElementById(formId);
                    if (!el) continue;

                    // Only fill if field is currently empty (don't overwrite user edits)
                    if (el.value && el.value.trim()) continue;

                    // For <select> elements, try to match the value to an option
                    if (el.tagName === 'SELECT') {
                        const options = Array.from(el.options);
                        const exact = options.find(o => o.value.toLowerCase() === String(value).toLowerCase());
                        const partial = options.find(o =>
                            o.value.toLowerCase().includes(String(value).toLowerCase()) ||
                            String(value).toLowerCase().includes(o.value.toLowerCase())
                        );
                        const match = exact || partial;
                        if (match) {
                            el.value = match.value;
                            this.data[formId] = match.value;
                            this.markAutoFilled?.(el, 'extension');
                            filled++;
                        }
                    } else {
                        el.value = String(value);
                        this.data[formId] = String(value);
                        this.markAutoFilled?.(el, 'extension');
                        filled++;
                    }
                }

                // Save all changes
                this.save({ target: { id: '_bulk', value: '' } });

                const source = parsed._source || 'unknown';
                const addr = parsed.address || '';
                this.toast(`‚úÖ Imported ${filled} property fields from ${source}${addr ? ` (${addr})` : ''}`);
            },

            openPropertyRecords() {
                const address = this.data.addrStreet || '';
                const city = this.data.addrCity || '';
                const state = (this.data.addrState || '').toUpperCase();
                const zip = this.data.addrZip || '';
                const fullAddr = `${address} ${city} ${state} ${zip}`.trim();
                if (!address || !city || !state) {
                    alert('Please enter a complete address (street, city, and state) first.');
                    return;
                }
                // Copy address to clipboard so user can paste into assessor search
                navigator.clipboard.writeText(fullAddr).then(() => {
                    this.toast('üìã Address copied ‚Äî paste into the assessor search');
                }).catch(() => {});

                const cityLower = city.toLowerCase().trim();

                // County GIS direct links by state ‚Üí city
                const gisUrls = {
                    'WA': {
                        'vancouver': 'https://gis.clark.wa.gov/gishome/property/', 'camas': 'https://gis.clark.wa.gov/gishome/property/', 'battle ground': 'https://gis.clark.wa.gov/gishome/property/', 'ridgefield': 'https://gis.clark.wa.gov/gishome/property/', 'la center': 'https://gis.clark.wa.gov/gishome/property/', 'washougal': 'https://gis.clark.wa.gov/gishome/property/',
                        'seattle': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx', 'bellevue': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx', 'redmond': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx', 'kent': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx', 'renton': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx', 'federal way': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx', 'kirkland': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx', 'auburn': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx', 'sammamish': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx', 'bothell': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                        'tacoma': 'https://atip.piercecountywa.gov/app/parcel-search', 'lakewood': 'https://atip.piercecountywa.gov/app/parcel-search', 'puyallup': 'https://atip.piercecountywa.gov/app/parcel-search', 'bonney lake': 'https://atip.piercecountywa.gov/app/parcel-search', 'university place': 'https://atip.piercecountywa.gov/app/parcel-search',
                        'everett': 'https://www.snoco.org/proptax/default.aspx', 'marysville': 'https://www.snoco.org/proptax/default.aspx', 'lynnwood': 'https://www.snoco.org/proptax/default.aspx', 'edmonds': 'https://www.snoco.org/proptax/default.aspx', 'mountlake terrace': 'https://www.snoco.org/proptax/default.aspx',
                        'spokane': 'https://mapgis.spokanecounty.org/SCGIS2/Parcel/', 'spokane valley': 'https://mapgis.spokanecounty.org/SCGIS2/Parcel/',
                        'bremerton': 'https://psearch.kitsap.gov/psearch/', 'silverdale': 'https://psearch.kitsap.gov/psearch/', 'poulsbo': 'https://psearch.kitsap.gov/psearch/',
                        'olympia': 'https://taxlot.co.thurston.wa.us/', 'lacey': 'https://taxlot.co.thurston.wa.us/', 'tumwater': 'https://taxlot.co.thurston.wa.us/',
                        'bellingham': 'https://www.whatcomcounty.us/1476/Online-Property-Search',
                        'yakima': 'https://www.co.yakima.wa.us/497/Property-Information-Public-Inquiry',
                        'longview': 'https://cowlitzassessor.us/', 'kelso': 'https://cowlitzassessor.us/',
                    },
                    'OR': {
                        'portland': 'https://www.portlandmaps.com/', 'gresham': 'https://www.portlandmaps.com/', 'troutdale': 'https://www.portlandmaps.com/', 'wood village': 'https://www.portlandmaps.com/', 'fairview': 'https://www.portlandmaps.com/',
                        'beaverton': 'https://www.washingtoncountyor.gov/at/property-information', 'hillsboro': 'https://www.washingtoncountyor.gov/at/property-information', 'tigard': 'https://www.washingtoncountyor.gov/at/property-information', 'tualatin': 'https://www.washingtoncountyor.gov/at/property-information', 'lake oswego': 'https://www.washingtoncountyor.gov/at/property-information', 'west linn': 'https://www.washingtoncountyor.gov/at/property-information', 'sherwood': 'https://www.washingtoncountyor.gov/at/property-information', 'forest grove': 'https://www.washingtoncountyor.gov/at/property-information', 'cornelius': 'https://www.washingtoncountyor.gov/at/property-information',
                        'oregon city': 'https://ascendweb.clackamas.us/', 'milwaukie': 'https://ascendweb.clackamas.us/', 'happy valley': 'https://ascendweb.clackamas.us/', 'wilsonville': 'https://ascendweb.clackamas.us/', 'canby': 'https://ascendweb.clackamas.us/', 'sandy': 'https://ascendweb.clackamas.us/', 'estacada': 'https://ascendweb.clackamas.us/',
                        'eugene': 'https://apps.lanecounty.org/PropertyAccountInformation/', 'springfield': 'https://apps.lanecounty.org/PropertyAccountInformation/', 'cottage grove': 'https://apps.lanecounty.org/PropertyAccountInformation/', 'creswell': 'https://apps.lanecounty.org/PropertyAccountInformation/', 'veneta': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                        'salem': 'https://mcasr.co.marion.or.us/', 'keizer': 'https://mcasr.co.marion.or.us/', 'woodburn': 'https://mcasr.co.marion.or.us/', 'silverton': 'https://mcasr.co.marion.or.us/',
                        'bend': 'https://dial.deschutes.org/', 'redmond': 'https://dial.deschutes.org/', 'sisters': 'https://dial.deschutes.org/', 'la pine': 'https://dial.deschutes.org/',
                        'medford': 'http://pdo.jacksoncountyor.gov/pdo', 'ashland': 'http://pdo.jacksoncountyor.gov/pdo', 'central point': 'http://pdo.jacksoncountyor.gov/pdo', 'phoenix': 'http://pdo.jacksoncountyor.gov/pdo', 'talent': 'http://pdo.jacksoncountyor.gov/pdo',
                        'albany': 'https://www.linncountyassessor.com/', 'lebanon': 'https://www.linncountyassessor.com/', 'sweet home': 'https://www.linncountyassessor.com/',
                        'roseburg': 'https://apps.co.douglas.or.us/onlineservices/PropertyViewer/', 'sutherlin': 'https://apps.co.douglas.or.us/onlineservices/PropertyViewer/', 'winston': 'https://apps.co.douglas.or.us/onlineservices/PropertyViewer/',
                    },
                    'AZ': {
                        'phoenix': 'https://mcassessor.maricopa.gov/', 'mesa': 'https://mcassessor.maricopa.gov/', 'chandler': 'https://mcassessor.maricopa.gov/', 'scottsdale': 'https://mcassessor.maricopa.gov/', 'glendale': 'https://mcassessor.maricopa.gov/', 'tempe': 'https://mcassessor.maricopa.gov/', 'peoria': 'https://mcassessor.maricopa.gov/', 'surprise': 'https://mcassessor.maricopa.gov/', 'gilbert': 'https://mcassessor.maricopa.gov/', 'avondale': 'https://mcassessor.maricopa.gov/', 'goodyear': 'https://mcassessor.maricopa.gov/', 'buckeye': 'https://mcassessor.maricopa.gov/', 'el mirage': 'https://mcassessor.maricopa.gov/', 'queen creek': 'https://mcassessor.maricopa.gov/', 'cave creek': 'https://mcassessor.maricopa.gov/', 'fountain hills': 'https://mcassessor.maricopa.gov/', 'paradise valley': 'https://mcassessor.maricopa.gov/',
                        'tucson': 'https://www.asr.pima.gov/assessor/', 'oro valley': 'https://www.asr.pima.gov/assessor/', 'marana': 'https://www.asr.pima.gov/assessor/', 'sahuarita': 'https://www.asr.pima.gov/assessor/',
                        'casa grande': 'https://gis.pinalcountyaz.gov/parcelviewer/', 'apache junction': 'https://gis.pinalcountyaz.gov/parcelviewer/', 'coolidge': 'https://gis.pinalcountyaz.gov/parcelviewer/', 'eloy': 'https://gis.pinalcountyaz.gov/parcelviewer/', 'florence': 'https://gis.pinalcountyaz.gov/parcelviewer/', 'maricopa': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                        'prescott': 'https://gis.yavapaiaz.gov/v4/', 'prescott valley': 'https://gis.yavapaiaz.gov/v4/', 'chino valley': 'https://gis.yavapaiaz.gov/v4/', 'cottonwood': 'https://gis.yavapaiaz.gov/v4/', 'sedona': 'https://gis.yavapaiaz.gov/v4/',
                        'flagstaff': 'https://www.coconino.az.gov/119/Assessor', 'williams': 'https://www.coconino.az.gov/119/Assessor',
                        'lake havasu city': 'https://www.mohave.gov/departments/assessor/assessor-search/', 'kingman': 'https://www.mohave.gov/departments/assessor/assessor-search/', 'bullhead city': 'https://www.mohave.gov/departments/assessor/assessor-search/',
                        'yuma': 'https://www.yumacountyaz.gov/government/assessor', 'san luis': 'https://www.yumacountyaz.gov/government/assessor', 'somerton': 'https://www.yumacountyaz.gov/government/assessor',
                    }
                };

                // Try direct county GIS link
                const stateUrls = gisUrls[state];
                if (stateUrls && stateUrls[cityLower]) {
                    const county = this.getCountyFromCity(city, state);
                    this.toast(`üìã Address copied ‚Äî opening ${county ? county + ' County' : city} assessor`);
                    window.open(stateUrls[cityLower], '_blank');
                    return;
                }

                // Fallback: open state assessor directory so user can find their county
                const stateDirectories = {
                    'WA': 'https://www.dor.wa.gov/find-taxes-rates/property-tax/county-assessors',
                    'OR': 'https://www.oregon.gov/dor/forms/pages/county-assessor.aspx',
                    'AZ': 'https://azdor.gov/property-appraisal/county-assessors-information',
                };
                if (stateDirectories[state]) {
                    const county = this.getCountyFromCity(city, state);
                    this.toast(`üìã Address copied ‚Äî find ${county ? county + ' County' : 'your county'} on the directory`);
                    window.open(stateDirectories[state], '_blank');
                } else {
                    // Unknown state ‚Äî Google for their county assessor
                    this.toast('üìã Address copied ‚Äî searching for county assessor');
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(city)}+${encodeURIComponent(state)}+county+assessor+property+search`, '_blank');
                }
            },

            copyAddress() {
                const address = this.data.addrStreet || '';
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const zip = this.data.addrZip || '';
                const fullAddr = `${address} ${city} ${state} ${zip}`.trim();
                if (!fullAddr) { this.toast('‚ö†Ô∏è Enter an address first'); return; }
                navigator.clipboard.writeText(fullAddr).then(() => {
                    this.toast('üìã Address copied to clipboard');
                }).catch(() => {
                    // Fallback
                    const ta = document.createElement('textarea');
                    ta.value = fullAddr;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    ta.remove();
                    this.toast('üìã Address copied to clipboard');
                });
            },

            openPropertyResearch() {
                const address = this.data.addrStreet || '';
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const zip = this.data.addrZip || '';
                
                if (!address || !city || !state) {
                    alert('Please enter a complete address (street, city, and state) first.');
                    return;
                }
                
                // Open research tools in new tabs/windows
                const addr = `${address} ${city} ${state} ${zip}`.trim();
                const zillowUrl = `https://www.google.com/search?q=site:zillow.com+${encodeURIComponent(addr)}&btnI`;
                window.open(zillowUrl, 'zillow');
                
                // Also trigger GIS if available
                setTimeout(() => this.openGIS(), 500);
            },

            async smartAutoFill() {
                const address = this.data.addrStreet || '';
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const zip = this.data.addrZip || '';

                if (!address || !city || !state) {
                    alert('Please enter a complete address (street, city, and state) first.');
                    return;
                }

                const btn = document.getElementById('smartFillBtn');
                const originalText = btn.innerHTML;
                const county = this.getCountyFromCity(city, state);

                // Auto-fill county if we can resolve it and it's not already set
                if (county) {
                    const countyEl = document.getElementById('county');
                    if (countyEl && !countyEl.value) {
                        countyEl.value = county;
                        this.data.county = county;
                        localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                        console.log('[SmartScan] Auto-filled county:', county);
                    }
                }

                try {
                    btn.disabled = true;
                    btn.innerHTML = 'üîÑ Gathering property data from all sources...';

                    // Fire ALL enrichment sources in parallel
                    const [arcgisResult, zillowResult, fireStationResult] = await Promise.allSettled([
                        this.fetchArcgisAndRag(address, city, state, county),
                        this.fetchZillowData(address, city, state, zip),
                        this.fetchFireStationData(address, city, state, zip)
                    ]);

                    let arcgisData = arcgisResult.status === 'fulfilled' ? arcgisResult.value : null;
                    let zillowData = zillowResult.status === 'fulfilled' ? zillowResult.value : null;
                    const fireData = fireStationResult.status === 'fulfilled' ? fireStationResult.value : null;

                    console.log('[SmartFill] Results:', {
                        arcgis: arcgisData ? arcgisData.source : 'none',
                        zillow: zillowData ? zillowData.source : 'none',
                        fire: fireData ? 'ok' : 'none'
                    });

                    // If no property details (only fire data), try direct Gemini property search
                    if (!arcgisData && !zillowData) {
                        btn.innerHTML = 'üîÑ Searching property records via AI...';
                        try {
                            const geminiProperty = await this.fetchPropertyViaGemini(address, city, state, zip);
                            if (geminiProperty) {
                                zillowData = geminiProperty; // Slot into zillow position for unified popup
                                console.log('[SmartFill] Gemini direct property search found data');
                            }
                        } catch (e) {
                            console.warn('[SmartFill] Gemini direct search failed:', e.message);
                        }
                    }

                    // If we have any structured data, show unified popup
                    if (arcgisData || zillowData || fireData) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        this.showUnifiedDataPopup(arcgisData, zillowData, fireData, address, city, state);
                        return;
                    }

                    // FALLBACK: No structured data ‚Äî try satellite imagery
                    btn.innerHTML = 'üîÑ Analyzing satellite imagery...';

                    const hazardResponse = await fetch('/api/property-intelligence?mode=satellite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, city, state, zip })
                    });

                    if (!hazardResponse.ok) {
                        throw new Error('Failed to analyze property');
                    }

                    const result = await hazardResponse.json();

                    if (!result.success) {
                        throw new Error(result.error || 'Analysis failed');
                    }

                    btn.innerHTML = originalText;
                    btn.disabled = false;

                    const fullAddress = `${address}, ${city}, ${state} ${zip || ''}`.trim();
                    this.showHazardDetectionPopup(result.data, result.satelliteImage, fullAddress, result.streetViewImage);

                } catch (error) {
                    console.error('Smart auto-fill error:', error);
                    btn.innerHTML = '‚ùå Failed';
                    alert('Failed to retrieve property data.\n\nTry:\n- Manually entering details\n- Using Zillow or GIS lookup\n- Checking County property records');

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 3000);
                }
            },

            // Helper: ArcGIS + RAG pipeline (internal sequential dependency)
            async fetchArcgisAndRag(address, city, state, county) {
                try {
                    const arcgisResponse = await fetch('/api/property-intelligence?mode=arcgis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, city, state, county })
                    });
                    if (!arcgisResponse.ok) return null;
                    const arcgisData = await arcgisResponse.json();
                    if (!arcgisData.success || !arcgisData.parcelData) {
                        console.warn('[ArcGIS] No parcel data:', arcgisData.error || 'Unknown error');
                        return null;
                    }

                    // Try RAG interpretation
                    const ragResponse = await fetch('/api/rag-interpreter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rawParcelData: arcgisData.parcelData, county })
                    });
                    if (ragResponse.ok) {
                        const ragData = await ragResponse.json();
                        if (ragData.success && ragData.parcelData) {
                            return { data: ragData.parcelData, source: 'arcgis-rag', confidence: 0.99 };
                        }
                    }
                    // RAG failed, return raw ArcGIS data
                    const result = { data: arcgisData.parcelData, source: 'arcgis-raw', confidence: 0.95 };
                    // If Clark County enrichment happened, note it
                    if (arcgisData.enrichedBy === 'clark-factsheet') {
                        result.source = 'arcgis+clark-factsheet';
                        result.factSheetFields = arcgisData.factSheetFields;
                        console.log(`[ArcGIS] Clark County enriched with: ${arcgisData.factSheetFields?.join(', ')}`);
                    }
                    return result;
                } catch (e) {
                    console.warn('[ArcGIS+RAG] Error:', e.message);
                    return null;
                }
            },

            // Helper: Zillow/Gemini property data
            async fetchZillowData(address, city, state, zip) {
                try {
                    const resp = await fetch('/api/property-intelligence?mode=zillow', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, city, state, zip })
                    });
                    if (!resp.ok) return null;
                    const result = await resp.json();
                    if (!result.success || !result.data) {
                        console.warn('[Zillow] No data:', result.error);
                        return null;
                    }
                    return { data: result.data, source: result.source, zillowUrl: result.zillowUrl };
                } catch (e) {
                    console.warn('[Zillow] Error:', e.message);
                    return null;
                }
            },

            // Helper: Fire station distance
            async fetchFireStationData(address, city, state, zip) {
                try {
                    const resp = await fetch('/api/property-intelligence?mode=firestation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, city, state, zip })
                    });
                    if (!resp.ok) return null;
                    const result = await resp.json();
                    if (!result.success) {
                        console.warn('[FireStation] No data:', result.error);
                        return null;
                    }
                    return {
                        fireStationDist: result.fireStationDist,
                        fireStationName: result.fireStationName,
                        protectionClass: result.protectionClass,
                        stationReliability: result.stationReliability || 'responding',
                        reviewNote: result.reviewNote || null
                    };
                } catch (e) {
                    console.warn('[FireStation] Error:', e.message);
                    return null;
                }
            },

            // Direct Gemini property lookup fallback (no server needed)
            async fetchPropertyViaGemini(address, city, state, zip) {
                const key = await this._getGeminiKey();
                if (!key) return null;

                const fullAddress = `${address}, ${city}, ${state}${zip ? ' ' + zip : ''}`.trim();
                console.log('[GeminiProperty] Searching for:', fullAddress);

                const prompt = `Find detailed property/home facts for this specific address: ${fullAddress}

Search real estate listings, public records, and property databases for this exact property. I need EVERY available construction and feature detail for insurance underwriting.

Return ONLY valid JSON (no markdown, no code fences) with this exact structure:
{
  "heating": "heating system type (e.g. Forced Air, Baseboard, Heat Pump, Boiler, Radiant, Electric)",
  "cooling": "cooling system type (e.g. Central Air, Window Units, None)",
  "roofType": "roof material (e.g. Composition, Asphalt Shingle, Metal, Tile, Wood Shake, Slate)",
  "roofYearUpdated": year_number_or_null,
  "foundation": "foundation type (e.g. Crawl Space, Slab, Basement, Pier, Daylight Basement)",
  "basementFinishPct": percentage_number_or_null,
  "construction": "construction type (e.g. Wood Frame, Masonry, Brick, Stucco, Log)",
  "exterior": "exterior wall material (e.g. Vinyl Siding, Wood Siding, Brick, Stucco, Fiber Cement, Hardie, Stone)",
  "garageType": "Attached or Detached or Built-in or Carport or None",
  "garageSpaces": number_or_null,
  "bedrooms": number_or_null,
  "bathrooms": number_or_null,
  "yearBuilt": number_or_null,
  "stories": number_or_null,
  "livingArea": square_feet_number_or_null,
  "flooring": "primary flooring (e.g. Hardwood, Carpet, Tile, Laminate, Mixed)",
  "fireplaces": number_or_null,
  "sewer": "Public or Septic or null",
  "waterSource": "Public or Well or null",
  "pool": "Yes or No or null",
  "woodStove": "Yes or No or null",
  "notes": "source of data and confidence level"
}

IMPORTANT: Use null for any field you cannot find. Only include data for THIS SPECIFIC address.`;

                try {
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 30000);

                    const res = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,
                        {
                            signal: controller.signal,
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                tools: [{ google_search: {} }],
                                generationConfig: { temperature: 0.1, maxOutputTokens: 4096 }
                            })
                        }
                    );
                    clearTimeout(timeout);

                    if (!res.ok) {
                        console.warn('[GeminiProperty] API error:', res.status);
                        return null;
                    }

                    const result = await res.json();
                    const allParts = result?.candidates?.[0]?.content?.parts || [];
                    const text = allParts.map(p => p.text || '').filter(Boolean).join('');

                    if (!text) return null;

                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) return null;

                    const raw = JSON.parse(jsonMatch[0]);
                    const nonNullKeys = Object.keys(raw).filter(k => raw[k] != null && k !== 'notes');
                    if (nonNullKeys.length < 2) return null;

                    console.log(`[GeminiProperty] Found ${nonNullKeys.length} fields: ${nonNullKeys.join(', ')}`);

                    // Map to the format showUnifiedDataPopup expects (same as Zillow data shape)
                    const data = {};
                    if (raw.heating) data.heatingType = raw.heating;
                    if (raw.cooling) data.cooling = raw.cooling;
                    if (raw.roofType) data.roofType = raw.roofType;
                    if (raw.foundation) data.foundation = raw.foundation;
                    if (raw.construction) data.constructionStyle = raw.construction;
                    if (raw.exterior) data.exteriorWalls = raw.exterior;
                    if (raw.garageSpaces != null) data.garageSpaces = raw.garageSpaces;
                    if (raw.garageType) data.garageType = raw.garageType;
                    if (raw.bedrooms != null) data.bedrooms = raw.bedrooms;
                    if (raw.bathrooms != null) data.fullBaths = raw.bathrooms;
                    if (raw.yearBuilt != null) { data.yearBuilt = raw.yearBuilt; data.yrBuilt = raw.yearBuilt; }
                    if (raw.stories != null) { data.stories = raw.stories; }
                    if (raw.livingArea != null) { data.totalSqft = raw.livingArea; }
                    if (raw.fireplaces != null) data.numFireplaces = raw.fireplaces;
                    if (raw.roofYearUpdated != null) data.roofYr = raw.roofYearUpdated;
                    if (raw.basementFinishPct != null) data.basementFinishPct = raw.basementFinishPct;
                    if (raw.flooring) data.flooring = raw.flooring;
                    if (raw.sewer) data.sewer = raw.sewer;
                    if (raw.waterSource) data.waterSource = raw.waterSource;
                    if (raw.pool) data.pool = raw.pool;
                    if (raw.woodStove) data.woodStove = raw.woodStove;

                    return { data, source: 'gemini-direct' };
                } catch (err) {
                    console.warn('[GeminiProperty] Error:', err.message);
                    return null;
                }
            },

            getGISUrlForCounty(city, state) {
                // Returns the GIS URL for browser fallback (from existing openGIS() method)
                // This allows Phase 2 to access the same county websites
                const countyMappings = {
                    'WA': {
                        'Vancouver': 'https://gis.clark.wa.gov/gishome/property/',
                        'Seattle': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                        'Tacoma': 'https://atip.piercecountywa.gov/app/parcel-search',
                        'Spokane': 'https://mapgis.spokanecounty.org/SCGIS2/Parcel/'
                    },
                    'OR': {
                        'Portland': 'https://ggis.multco.us/',
                        'Salem': 'https://www.marionco.us/assessor/',
                        'Eugene': 'https://www.lanecountygov.org/'
                    },
                    'AZ': {
                        'Phoenix': 'https://gis.maricopa.gov/',
                        'Tucson': 'https://www.pimacountyassessor.com/'
                    }
                };
                
                const stateMap = countyMappings[state];
                return stateMap ? stateMap[city] || '' : '';
            },

            showParcelDataPopup(parcelData, address, city, state, confidence = 1.0, dataSource = 'unknown') {
                // Display official county parcel data in confirmation popup
                // confidence: 1.0 = ArcGIS API, 0.99 = RAG interpreted, 0.85 = browser scraping
                // dataSource: 'phase1-arcgis', 'phase2-browser', or 'phase3-rag'
                
                const modal = document.createElement('div');
                modal.id = 'parcelDataModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                // Determine title and styling based on confidence/data source
                let titleText = '‚úì Official County Parcel Data Found';
                let titleColor = '#28a745';
                let warningText = null;
                
                if (confidence === 0.99) {
                    titleText = '‚úì Property Data Verified & Standardized';
                    titleColor = '#28a745';
                    warningText = 'Data has been verified and standardized for accuracy (99% confidence).';
                } else if (confidence === 0.95) {
                    titleText = '‚úì Official County Parcel Data Found';
                    titleColor = '#28a745';
                } else if (confidence < 0.95) {
                    titleText = '‚úì Extracted County Data (Browser)';
                    titleColor = '#ffc107';
                    warningText = '‚ö† Data extracted from county website (' + Math.round(confidence * 100) + '% confidence). Please review before submitting.';
                }
                
                const title = document.createElement('h2');
                title.textContent = titleText;
                title.style.cssText = `margin: 0 0 16px 0; color: ${titleColor};`;
                
                const addressLine = document.createElement('p');
                addressLine.style.cssText = 'color: #666; margin: 8px 0; font-size: 14px;';
                addressLine.textContent = `${address}, ${city}, ${state} ‚Ä¢ Parcel: ${parcelData.parcelId}`;
                
                content.appendChild(title);
                content.appendChild(addressLine);
                
                // Add appropriate warning/confirmation banner
                if (warningText) {
                    const banner = document.createElement('p');
                    const bannerBgColor = confidence === 0.99 ? '#d4edda' : '#fff3cd';
                    const bannerBorderColor = confidence === 0.99 ? '#28a745' : '#ffc107';
                    const bannerTextColor = confidence === 0.99 ? '#155724' : '#856404';
                    banner.style.cssText = `background: ${bannerBgColor}; border-left: 4px solid ${bannerBorderColor}; padding: 8px 12px; margin: 12px 0; font-size: 12px; color: ${bannerTextColor}; border-radius: 3px;`;
                    banner.textContent = warningText;
                    content.appendChild(banner);
                }
                
                const grid = document.createElement('div');
                grid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0;';
                
                const fields = [
                    { label: 'Year Built', value: parcelData.yearBuilt || 'N/A' },
                    { label: 'Stories', value: parcelData.stories > 0 ? parcelData.stories : 'N/A' },
                    { label: 'Total Sq Ft', value: parcelData.totalSqft > 0 ? parcelData.totalSqft.toLocaleString() : 'N/A' },
                    { label: 'Lot Size', value: parcelData.lotSizeAcres > 0 ? `${parcelData.lotSizeAcres.toFixed(2)} acres` : 'N/A' },
                    { label: 'Bedrooms', value: parcelData.bedrooms > 0 ? parcelData.bedrooms : 'N/A' },
                    { label: 'Bathrooms', value: parcelData.bathrooms > 0 ? parcelData.bathrooms : 'N/A' },
                    { label: 'Garage Spaces', value: parcelData.garageSpaces > 0 ? parcelData.garageSpaces : (parcelData.garageSqft > 0 ? `${Math.round(parcelData.garageSqft / 180)} (est.)` : 'N/A') },
                    { label: 'Foundation', value: parcelData.foundationType || 'N/A' },
                    { label: 'Roof Type', value: parcelData.roofType || 'N/A' },
                    { label: 'Heating Type', value: parcelData.heatingType || 'N/A' },
                    { label: 'Construction', value: parcelData.constructionStyle || 'N/A' },
                    { label: 'Land Use', value: parcelData.landUse || 'N/A' }
                ];
                
                fields.forEach(field => {
                    const box = document.createElement('div');
                    box.style.cssText = 'background: #f5f5f5; padding: 12px; border-radius: 6px;';
                    
                    const label = document.createElement('div');
                    label.style.cssText = 'font-size: 12px; color: #999; text-transform: uppercase; margin-bottom: 4px;';
                    label.textContent = field.label;
                    
                    const value = document.createElement('div');
                    value.style.cssText = 'font-size: 16px; font-weight: 600; color: #333;';
                    value.textContent = field.value;
                    
                    box.appendChild(label);
                    box.appendChild(value);
                    grid.appendChild(box);
                });
                
                const buttonBox = document.createElement('div');
                buttonBox.style.cssText = 'display: flex; gap: 12px; margin-top: 20px;';
                
                const useBtn = document.createElement('button');
                useBtn.textContent = '‚úì Use This Data';
                useBtn.style.cssText = `
                    flex: 1;
                    padding: 12px;
                    background: #28a745;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                `;
                useBtn.onclick = () => {
                    this.applyParcelData(parcelData);
                    this.closeParcelModal();
                    // Fire enrichments in background (non-blocking)
                    this.enrichWithZillow(address, city, state);
                    this.enrichFireStation(address, city, state);
                };
                
                const skipBtn = document.createElement('button');
                skipBtn.textContent = '‚úó Skip';
                skipBtn.style.cssText = `
                    flex: 1;
                    padding: 12px;
                    background: #6c757d;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                `;
                skipBtn.onclick = () => this.closeParcelModal();
                
                buttonBox.appendChild(useBtn);
                buttonBox.appendChild(skipBtn);
                
                content.appendChild(title);
                content.appendChild(addressLine);
                content.appendChild(grid);
                content.appendChild(buttonBox);
                modal.appendChild(content);
                
                modal.onclick = (e) => {
                    if (e.target === modal) this.closeParcelModal();
                };
                
                document.body.appendChild(modal);
            },

            closeParcelModal() {
                const modal = document.getElementById('parcelDataModal');
                if (modal) {
                    modal.style.opacity = '0';
                    modal.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => modal.remove(), 300);
                }
            },

            showUnifiedDataPopup(arcgisData, zillowData, fireData, address, city, state) {
                // Merge data from all sources: ArcGIS (primary) ‚Üí Zillow (fill gaps) ‚Üí FireStation
                const merged = {};
                const sources = [];

                if (arcgisData && arcgisData.data) {
                    Object.assign(merged, arcgisData.data);
                    sources.push('County Records');
                }

                if (zillowData && zillowData.data) {
                    const zd = zillowData.data;
                    sources.push('Property Listings');
                    // Only fill gaps ‚Äî don't overwrite ArcGIS data
                    if (!merged.heatingType && zd.heatingType) merged.heatingType = zd.heatingType;
                    if (!merged.cooling && zd.cooling) merged.cooling = zd.cooling;
                    if (!merged.roofType && zd.roofType) merged.roofType = zd.roofType;
                    if (!merged.foundationType && zd.foundation) merged.foundationType = zd.foundation;
                    if (!merged.constructionStyle && zd.constructionStyle) merged.constructionStyle = zd.constructionStyle;
                    if (!merged.exteriorWalls && zd.exteriorWalls) merged.exteriorWalls = zd.exteriorWalls;
                    if ((!merged.yearBuilt || merged.yearBuilt === 0) && zd.yearBuilt) merged.yearBuilt = zd.yearBuilt;
                    if ((!merged.stories || merged.stories === 0) && zd.stories) merged.stories = zd.stories;
                    if ((!merged.totalSqft || merged.totalSqft === 0) && zd.totalSqft) merged.totalSqft = zd.totalSqft;
                    if ((!merged.bedrooms || merged.bedrooms === 0) && zd.bedrooms) merged.bedrooms = zd.bedrooms;
                    if ((!merged.bathrooms || merged.bathrooms === 0) && zd.fullBaths) merged.bathrooms = zd.fullBaths;
                    if ((!merged.garageSpaces || merged.garageSpaces === 0) && zd.garageSpaces) merged.garageSpaces = zd.garageSpaces;
                    if (zd.fireplace) merged.fireplace = zd.fireplace;
                    if (!merged.garageType && zd.garageType) merged.garageType = zd.garageType;
                    if (!merged.flooring && zd.flooring) merged.flooring = zd.flooring;
                    if (!merged.numFireplaces && zd.numFireplaces) merged.numFireplaces = zd.numFireplaces;
                    if (!merged.sewer && zd.sewer) merged.sewer = zd.sewer;
                    if (!merged.waterSource && zd.waterSource) merged.waterSource = zd.waterSource;
                    if (!merged.pool && zd.pool) merged.pool = zd.pool;
                    if (!merged.woodStove && zd.woodStove) merged.woodStove = zd.woodStove;
                    if (!merged.roofYr && zd.roofYr) merged.roofYr = zd.roofYr;
                    if (!merged.basementFinishPct && zd.basementFinishPct) merged.basementFinishPct = zd.basementFinishPct;
                }

                if (fireData) {
                    sources.push('Fire Protection');
                    merged.fireStationDist = fireData.fireStationDist;
                    merged.fireStationName = fireData.fireStationName;
                    merged.protectionClass = fireData.protectionClass;
                }

                // Build modal
                const modal = document.createElement('div');
                modal.id = 'parcelDataModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex; align-items: center; justify-content: center;
                    z-index: 10000;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white; border-radius: 12px; padding: 24px;
                    max-width: 520px; max-height: 85vh; overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;

                // Title
                const title = document.createElement('h2');
                title.textContent = `Property Data Found`;
                title.style.cssText = 'margin: 0 0 8px 0; color: #28a745;';
                content.appendChild(title);

                // Source badges
                const badgeRow = document.createElement('div');
                badgeRow.style.cssText = 'display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;';
                const badgeColors = { 'County Records': '#0066cc', 'Property Listings': '#6f42c1', 'Fire Protection': '#dc3545' };
                const badgeIcons = { 'County Records': 'üèõ', 'Property Listings': 'üè†', 'Fire Protection': 'üöí' };
                sources.forEach(src => {
                    const badge = document.createElement('span');
                    badge.style.cssText = `
                        display: inline-flex; align-items: center; gap: 4px;
                        padding: 3px 10px; border-radius: 12px;
                        font-size: 11px; font-weight: 600; color: white;
                        background: ${badgeColors[src] || '#666'};
                    `;
                    badge.textContent = `${badgeIcons[src] || ''} ${src}`;
                    badgeRow.appendChild(badge);
                });
                content.appendChild(badgeRow);

                // Address line
                const addressLine = document.createElement('p');
                addressLine.style.cssText = 'color: #666; margin: 4px 0 12px 0; font-size: 13px;';
                addressLine.textContent = `${address}, ${city}, ${state}${merged.parcelId ? ' ¬∑ Parcel: ' + merged.parcelId : ''}`;
                content.appendChild(addressLine);

                // Data grid
                const grid = document.createElement('div');
                grid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0;';

                const fields = [
                    { label: 'Year Built', value: merged.yearBuilt && merged.yearBuilt > 0 ? merged.yearBuilt : null },
                    { label: 'Stories', value: merged.stories && merged.stories > 0 ? merged.stories : null },
                    { label: 'Total Sq Ft', value: merged.totalSqft && merged.totalSqft > 0 ? merged.totalSqft.toLocaleString() : null },
                    { label: 'Lot Size', value: merged.lotSizeAcres && merged.lotSizeAcres > 0 ? `${merged.lotSizeAcres.toFixed(2)} acres` : null },
                    { label: 'Bedrooms', value: merged.bedrooms && merged.bedrooms > 0 ? merged.bedrooms : null },
                    { label: 'Bathrooms', value: merged.bathrooms && merged.bathrooms > 0 ? merged.bathrooms : null },
                    { label: 'Garage Type', value: merged.garageType || null },
                    { label: 'Garage Spaces', value: merged.garageSpaces && merged.garageSpaces > 0 ? merged.garageSpaces : (merged.garageSqft && merged.garageSqft > 0 ? `${Math.round(merged.garageSqft / 180)} (est.)` : null) },
                    { label: 'Foundation', value: merged.foundationType && merged.foundationType !== 'Unknown' ? merged.foundationType : null },
                    { label: 'Roof Type', value: merged.roofType && merged.roofType !== 'Unknown' ? merged.roofType : null },
                    { label: 'Roof Year', value: merged.roofYr || null },
                    { label: 'Heating', value: merged.heatingType && merged.heatingType !== 'Unknown' ? merged.heatingType : null },
                    { label: 'Cooling', value: merged.cooling || null },
                    { label: 'Construction', value: merged.constructionStyle && merged.constructionStyle !== 'Unknown' ? merged.constructionStyle : null },
                    { label: 'Exterior', value: merged.exteriorWalls || null },
                    { label: 'Flooring', value: merged.flooring || null },
                    { label: 'Fireplaces', value: merged.numFireplaces && merged.numFireplaces > 0 ? merged.numFireplaces : (merged.fireplace === 'Yes' ? 'Yes' : null) },
                    { label: 'Sewer', value: merged.sewer || null },
                    { label: 'Water', value: merged.waterSource || null },
                    { label: 'Pool', value: merged.pool && merged.pool !== 'None' ? merged.pool : null },
                    { label: 'Wood Stove', value: merged.woodStove && merged.woodStove !== 'None' ? merged.woodStove : null },
                    { label: 'Land Use', value: merged.landUse || null },
                ];

                // Add fire station fields if available
                if (fireData) {
                    const reliabilityBadge = fireData.stationReliability === 'volunteer' ? ' üü°' :
                                             fireData.stationReliability === 'review' ? ' ‚ö†Ô∏è' : '';
                    fields.push({ label: 'Fire Station', value: `${fireData.fireStationDist} mi ‚Äî ${fireData.fireStationName || 'Nearest'}${reliabilityBadge}` });
                    fields.push({ label: 'Protection Class', value: fireData.protectionClass });
                    if (fireData.reviewNote) {
                        fields.push({ label: 'Station Note', value: fireData.reviewNote });
                    }
                }

                // Only show fields that have data
                const fieldsWithData = fields.filter(f => f.value != null && f.value !== '' && f.value !== 'N/A');

                fieldsWithData.forEach(field => {
                    const box = document.createElement('div');
                    box.style.cssText = 'background: #f5f5f5; padding: 10px; border-radius: 6px;';

                    const label = document.createElement('div');
                    label.style.cssText = 'font-size: 11px; color: #999; text-transform: uppercase; margin-bottom: 3px;';
                    label.textContent = field.label;

                    const value = document.createElement('div');
                    value.style.cssText = 'font-size: 15px; font-weight: 600; color: #333;';
                    value.textContent = field.value;

                    box.appendChild(label);
                    box.appendChild(value);
                    grid.appendChild(box);
                });

                content.appendChild(grid);

                // Buttons
                const buttonBox = document.createElement('div');
                buttonBox.style.cssText = 'display: flex; gap: 12px; margin-top: 16px;';

                const useBtn = document.createElement('button');
                useBtn.textContent = `‚úì Use This Data (${fieldsWithData.length} fields)`;
                useBtn.style.cssText = `
                    flex: 1; padding: 12px; background: #28a745; color: white;
                    border: none; border-radius: 6px; font-weight: 600;
                    cursor: pointer; font-size: 14px;
                `;
                useBtn.onclick = () => {
                    this.applyParcelData(merged);
                    if (zillowData && zillowData.data) {
                        this.applyZillowSelects(zillowData.data);
                    }
                    if (fireData) {
                        this.applyFireStationData(fireData);
                    }
                    // Smart Defaults ‚Äî set standard HO3 assumptions unless data says otherwise
                    if (!this.data.dwellingUsage) {
                        this.data.dwellingUsage = 'Primary';
                        const el = document.getElementById('dwellingUsage');
                        if (el) {
                            el.value = 'Primary';
                            this.markAutoFilled(el, 'smart');
                        }
                    }
                    if (!this.data.occupancyType) {
                        this.data.occupancyType = 'Owner Occupied';
                        const el = document.getElementById('occupancyType');
                        if (el) {
                            el.value = 'Owner Occupied';
                            this.markAutoFilled(el, 'smart');
                        }
                    }
                    this.closeParcelModal();
                    this.save();
                    const count = fieldsWithData.length;
                    this.toast(`Applied ${count} field${count !== 1 ? 's' : ''} from ${sources.join(' + ')}`);
                };

                const skipBtn = document.createElement('button');
                skipBtn.textContent = '‚úó Skip';
                skipBtn.style.cssText = `
                    flex: 0 0 auto; padding: 12px 20px; background: #6c757d; color: white;
                    border: none; border-radius: 6px; font-weight: 600;
                    cursor: pointer; font-size: 14px;
                `;
                skipBtn.onclick = () => this.closeParcelModal();

                buttonBox.appendChild(useBtn);
                buttonBox.appendChild(skipBtn);
                content.appendChild(buttonBox);

                modal.appendChild(content);
                modal.onclick = (e) => {
                    if (e.target === modal) this.closeParcelModal();
                };
                document.body.appendChild(modal);
            },

            // Apply Zillow select-field values (dropdown fields that need option matching)
            applyZillowSelects(zd) {
                const selectFields = ['heatingType', 'cooling', 'roofType', 'foundation', 'constructionStyle', 'exteriorWalls', 'garageType', 'sewer', 'waterSource', 'flooring', 'pool', 'woodStove'];
                for (const fid of selectFields) {
                    if (!zd[fid]) continue;
                    const el = document.getElementById(fid);
                    if (!el) continue;
                    const opts = Array.from(el.options).map(o => o.value);
                    if (opts.includes(zd[fid])) {
                        el.value = zd[fid];
                        this.data[fid] = zd[fid];
                        this.markAutoFilled(el, 'zillow');
                    }
                }
                // Text/number fields from Zillow
                const textFields = {
                    yrBuilt: zd.yrBuilt,
                    bedrooms: zd.bedrooms,
                    fullBaths: zd.fullBaths,
                    garageSpaces: zd.garageSpaces,
                    numStories: zd.stories,
                    sqFt: zd.totalSqft,
                    numFireplaces: zd.numFireplaces,
                    roofYr: zd.roofYr
                };
                for (const [fid, val] of Object.entries(textFields)) {
                    if (val == null) continue;
                    const el = document.getElementById(fid);
                    if (!el) continue;
                    // Only fill if currently empty
                    if (el.value && el.value !== '0' && el.value !== '') continue;
                    el.value = val;
                    this.data[fid] = String(val);
                    this.markAutoFilled(el, 'zillow');
                }
            },

            // Apply fire station distance and protection class
            applyFireStationData(fireData) {
                if (fireData.fireStationDist != null) {
                    const el = document.getElementById('fireStationDist');
                    if (el) {
                        el.value = fireData.fireStationDist;
                        this.data.fireStationDist = String(fireData.fireStationDist);
                        this.markAutoFilled(el, 'fire');
                    }
                }
                if (fireData.protectionClass != null) {
                    const el = document.getElementById('protectionClass');
                    if (el) {
                        el.value = fireData.protectionClass;
                        this.data.protectionClass = String(fireData.protectionClass);
                        this.markAutoFilled(el, 'fire');
                    }
                }
            },

            applyParcelData(parcelData) {
                // Auto-fill form fields from official county parcel data
                let fieldsApplied = 0;

                // Basic property info
                if (parcelData.yearBuilt && parcelData.yearBuilt > 0) {
                    const field = document.getElementById('yrBuilt');
                    if (field) {
                        field.value = parcelData.yearBuilt;
                        this.data.yrBuilt = parcelData.yearBuilt;
                        this.markAutoFilled(field, 'parcel');
                        fieldsApplied++;
                    }
                }

                if (parcelData.stories && parcelData.stories > 0) {
                    const field = document.getElementById('numStories');
                    if (field) {
                        field.value = parcelData.stories;
                        this.data.numStories = parcelData.stories;
                        this.markAutoFilled(field, 'parcel');
                        fieldsApplied++;
                    }
                }

                if (parcelData.totalSqft && parcelData.totalSqft > 0) {
                    const field = document.getElementById('sqFt');
                    if (field) {
                        field.value = parcelData.totalSqft;
                        this.data.sqFt = parcelData.totalSqft;
                        this.markAutoFilled(field, 'parcel');
                        fieldsApplied++;
                    }
                }

                if (parcelData.lotSizeAcres && parcelData.lotSizeAcres > 0) {
                    const field = document.getElementById('lotSize');
                    if (field) {
                        field.value = parcelData.lotSizeAcres.toFixed(2);
                        this.data.lotSize = parcelData.lotSizeAcres.toFixed(2);
                        this.markAutoFilled(field, 'parcel');
                        fieldsApplied++;
                    }
                }

                // Garage info
                if (parcelData.garageSpaces && parcelData.garageSpaces > 0) {
                    const field = document.getElementById('garageSpaces');
                    if (field) {
                        field.value = parcelData.garageSpaces;
                        this.data.garageSpaces = parcelData.garageSpaces;
                        this.markAutoFilled(field, 'parcel');
                        fieldsApplied++;
                    }
                } else if (parcelData.garageSqft && parcelData.garageSqft > 0) {
                    // Estimate garage spaces (1 space ‚âà 180 sq ft)
                    const garageSpaces = Math.round(parcelData.garageSqft / 180);
                    const field = document.getElementById('garageSpaces');
                    if (field) {
                        field.value = garageSpaces;
                        this.data.garageSpaces = garageSpaces;
                        this.markAutoFilled(field, 'parcel');
                        fieldsApplied++;
                    }
                }

                // NEW: Bedrooms
                if (parcelData.bedrooms && parcelData.bedrooms > 0) {
                    const field = document.getElementById('bedrooms');
                    if (field) {
                        field.value = parcelData.bedrooms;
                        this.data.bedrooms = parcelData.bedrooms;
                        this.markAutoFilled(field, 'parcel');
                        fieldsApplied++;
                    }
                }

                // NEW: Bathrooms
                if (parcelData.bathrooms && parcelData.bathrooms > 0) {
                    const field = document.getElementById('fullBaths');
                    if (field) {
                        // Split into full and half baths (e.g., 2.5 ‚Üí 2 full, 1 half)
                        const fullBaths = Math.floor(parcelData.bathrooms);
                        const halfBaths = (parcelData.bathrooms % 1) >= 0.5 ? 1 : 0;
                        field.value = fullBaths;
                        this.data.fullBaths = fullBaths;
                        this.markAutoFilled(field, 'parcel');
                        fieldsApplied++;

                        const halfField = document.getElementById('halfBaths');
                        if (halfField && halfBaths > 0) {
                            halfField.value = halfBaths;
                            this.data.halfBaths = halfBaths;
                            this.markAutoFilled(halfField, 'parcel');
                        }
                    }
                }

                // NEW: Foundation Type
                if (parcelData.foundationType && parcelData.foundationType !== 'Unknown') {
                    const field = document.getElementById('foundation');
                    if (field) {
                        // Try to match to existing select options
                        const options = Array.from(field.options).map(opt => opt.value);
                        if (options.includes(parcelData.foundationType)) {
                            field.value = parcelData.foundationType;
                            this.data.foundation = parcelData.foundationType;
                            this.markAutoFilled(field, 'parcel');
                            fieldsApplied++;
                        }
                    }
                }

                // NEW: Roof Type
                if (parcelData.roofType && parcelData.roofType !== 'Unknown') {
                    const field = document.getElementById('roofType');
                    if (field) {
                        const options = Array.from(field.options).map(opt => opt.value);
                        if (options.includes(parcelData.roofType)) {
                            field.value = parcelData.roofType;
                            this.data.roofType = parcelData.roofType;
                            this.markAutoFilled(field, 'parcel');
                            fieldsApplied++;
                        }
                    }
                }

                // NEW: Heating Type
                if (parcelData.heatingType && parcelData.heatingType !== 'Unknown') {
                    const field = document.getElementById('heatingType');
                    if (field) {
                        const options = Array.from(field.options).map(opt => opt.value);
                        if (options.includes(parcelData.heatingType)) {
                            field.value = parcelData.heatingType;
                            this.data.heatingType = parcelData.heatingType;
                            this.markAutoFilled(field, 'parcel');
                            fieldsApplied++;
                        }
                    }
                }

                // NEW: Construction Style
                if (parcelData.constructionStyle && parcelData.constructionStyle !== 'Unknown') {
                    const field = document.getElementById('constructionStyle');
                    if (field) {
                        const options = Array.from(field.options).map(opt => opt.value);
                        if (options.includes(parcelData.constructionStyle)) {
                            field.value = parcelData.constructionStyle;
                            this.data.constructionStyle = parcelData.constructionStyle;
                            this.markAutoFilled(field, 'parcel');
                            fieldsApplied++;
                        }
                    }
                }

                // Save changes
                this.save();

                // Show success toast with count
                this.toast(`‚úÖ Auto-filled ${fieldsApplied} field${fieldsApplied !== 1 ? 's' : ''} from county data`);
            },

            async enrichWithZillow(address, city, state) {
                const zip = this.data.addrZip || '';
                console.log(`[Zillow] Enrichment starting: ${address}, ${city}, ${state} ${zip}`);
                try {
                    const resp = await fetch('/api/property-intelligence?mode=zillow', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, city, state, zip })
                    });
                    if (!resp.ok) {
                        console.warn(`[Zillow] API returned HTTP ${resp.status}`);
                        return;
                    }
                    const result = await resp.json();
                    console.log('[Zillow] API response:', JSON.stringify(result).substring(0, 500));
                    if (!result.success || !result.data) {
                        console.warn('[Zillow] No data:', result.error, result.diagnostics);
                        // Show Zillow link if we got the zpid from autocomplete
                        if (result.zillowUrl) {
                            this.toast(`Zillow blocks server access. <a href="${result.zillowUrl}" target="_blank" style="color:var(--primary);text-decoration:underline;">View on Zillow</a> to check details manually.`, 8000, true);
                        }
                        return;
                    }

                    const zd = result.data;
                    const applied = [];

                    const labels = {
                        heatingType: 'Heating', cooling: 'Cooling', roofType: 'Roof',
                        foundation: 'Foundation', constructionStyle: 'Construction',
                        exteriorWalls: 'Exterior', garageSpaces: 'Garage',
                        bedrooms: 'Bedrooms', fullBaths: 'Bathrooms',
                        yrBuilt: 'Year Built', numStories: 'Stories', sqFt: 'Sq Ft'
                    };

                    const selectFields = ['heatingType', 'cooling', 'roofType', 'foundation', 'constructionStyle', 'exteriorWalls'];
                    for (const fid of selectFields) {
                        if (!zd[fid]) { console.log(`[Zillow] Select ${fid}: no data`); continue; }
                        const el = document.getElementById(fid);
                        if (!el) { console.log(`[Zillow] Select ${fid}: no element`); continue; }
                        const opts = Array.from(el.options).map(o => o.value);
                        if (opts.includes(zd[fid])) {
                            el.value = zd[fid];
                            this.data[fid] = zd[fid];
                            this.markAutoFilled(el, 'zillow');
                            applied.push(labels[fid] || fid);
                        } else {
                            console.log(`[Zillow] Select ${fid}: value "${zd[fid]}" not in options:`, opts);
                        }
                    }

                    // Map API field names to form field IDs
                    const textFields = {
                        yrBuilt: zd.yrBuilt,
                        bedrooms: zd.bedrooms,
                        fullBaths: zd.fullBaths,
                        garageSpaces: zd.garageSpaces,
                        numStories: zd.stories,
                        sqFt: zd.totalSqft
                    };
                    for (const [fid, val] of Object.entries(textFields)) {
                        if (val == null) continue;
                        const el = document.getElementById(fid);
                        if (!el) continue;
                        el.value = val;
                        this.data[fid] = String(val);
                        this.markAutoFilled(el, 'zillow');
                        applied.push(labels[fid] || fid);
                    }

                    if (applied.length > 0) {
                        this.save();
                        this.toast(`üè† Property data found (${result.source}): ${applied.join(', ')}`, 6000);
                        console.log(`[Zillow] Enriched ${applied.length} fields via ${result.source}:`, applied);
                    } else {
                        console.log('[Zillow] Data received but no fields matched form options:', zd);
                    }
                } catch (e) {
                    console.warn('[Zillow] Enrichment failed (non-fatal):', e.message);
                }
            },

            calculateResidenceTime() {
                const dateStr = this.data.purchaseDate;
                const display = document.getElementById('residenceTimeDisplay');
                if (!display) return;
                if (!dateStr) { display.textContent = ''; return; }
                const purchase = new Date(dateStr);
                const now = new Date();
                const diffMs = now - purchase;
                if (diffMs < 0) { display.textContent = '(future date)'; return; }
                const years = Math.floor(diffMs / (365.25 * 24 * 60 * 60 * 1000));
                const months = Math.floor((diffMs / (30.44 * 24 * 60 * 60 * 1000)) % 12);
                if (years > 0) {
                    display.textContent = `(~${years} yr${years !== 1 ? 's' : ''}, ${months} mo at residence)`;
                } else {
                    display.textContent = `(${months} month${months !== 1 ? 's' : ''} at residence)`;
                }
                this.data.yearsAtResidence = years;
            },

            async enrichFireStation(address, city, state) {
                const zip = this.data.addrZip || '';
                console.log(`[FireStation] Enrichment starting: ${address}, ${city}, ${state} ${zip}`);
                try {
                    const resp = await fetch('/api/property-intelligence?mode=firestation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, city, state, zip })
                    });
                    if (!resp.ok) {
                        console.warn(`[FireStation] API returned HTTP ${resp.status}`);
                        return;
                    }
                    const result = await resp.json();
                    console.log('[FireStation] API response:', JSON.stringify(result).substring(0, 500));
                    if (!result.success) {
                        console.warn('[FireStation] No data:', result.error);
                        return;
                    }

                    const applied = [];

                    if (result.fireStationDist != null) {
                        const el = document.getElementById('fireStationDist');
                        if (el) {
                            el.value = result.fireStationDist;
                            this.data.fireStationDist = String(result.fireStationDist);
                            this.markAutoFilled(el, 'fire');
                            applied.push(`${result.fireStationDist} mi to ${result.fireStationName || 'fire station'}`);
                        }
                    }

                    if (result.protectionClass != null) {
                        const el = document.getElementById('protectionClass');
                        if (el) {
                            el.value = result.protectionClass;
                            this.data.protectionClass = String(result.protectionClass);
                            this.markAutoFilled(el, 'fire');
                            applied.push(`Protection Class ${result.protectionClass}`);
                        }
                    }

                    if (applied.length > 0) {
                        this.save();
                        this.toast(`üöí ${applied.join(' ¬∑ ')}`, 5000);
                        console.log(`[FireStation] Applied: ${applied.join(', ')}`);
                    }
                } catch (e) {
                    console.warn('[FireStation] Enrichment failed (non-fatal):', e.message);
                }
            },

            showHazardDetectionPopup(detections, satelliteImage, address, streetViewImage) {
                // Normalize new Gemini Vision response format (roof_material, has_pool, etc.)
                // to the internal field names used by the popup and apply logic
                const d = detections || {};
                const hazards = {
                    pool: d.has_pool === true || d.pool === 'yes',
                    poolFenced: d.pool_fenced === true || null,
                    trampoline: d.has_trampoline === true || d.trampoline === 'yes',
                    deck: d.deck_or_patio === true || d.deck === 'yes',
                    roofType: d.roof_material && d.roof_material !== 'unknown' ? d.roof_material : (d.roofType && d.roofType !== 'unknown' ? d.roofType : null),
                    roofShape: d.roof_shape && d.roof_shape !== 'unknown' ? d.roof_shape : (d.roofShape && d.roofShape !== 'unknown' ? d.roofShape : null),
                    roofConditionScore: d.roof_condition_score || null,
                    numStories: d.stories || (d.numStories && d.numStories !== 'unknown' ? d.numStories : null),
                    garageSpaces: d.garage_doors || (d.garageSpaces && d.garageSpaces !== 'unknown' ? d.garageSpaces : null),
                    visibleHazards: d.visible_hazards || [],
                    treeOverhang: d.tree_overhang_roof,
                    brushClearance: d.brush_clearance_adequate,
                    notes: d.notes || '',
                };
                
                // Count detected hazards
                const hazardCount = [hazards.pool, hazards.trampoline, hazards.deck].filter(Boolean).length;
                
                // Create elegant popup
                const modalHTML = `
                    <div class="modal-overlay" id="hazardDetectionModal">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h2>üõ°Ô∏è Property Analysis Complete</h2>
                                <p style="font-size: 13px; color: var(--text-secondary); margin: 8px 0 0 0;">
                                    ${address}
                                </p>
                            </div>
                            
                            <div class="modal-body">
                                ${satelliteImage || streetViewImage ? `
                                    <div style="margin-bottom: 20px; display: flex; gap: 8px;">
                                        ${satelliteImage ? `
                                            <div style="flex: 1;">
                                                <p style="font-size: 11px; font-weight: 600; margin: 0 0 6px 0;">Satellite</p>
                                                <img
                                                    src="data:image/png;base64,${satelliteImage}"
                                                    style="width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--border); cursor: pointer;"
                                                    onclick="App.viewSatelliteFullscreen(this.src)"
                                                    title="Click to view fullscreen"
                                                >
                                            </div>
                                        ` : ''}
                                        ${streetViewImage ? `
                                            <div style="flex: 1;">
                                                <p style="font-size: 11px; font-weight: 600; margin: 0 0 6px 0;">Street View</p>
                                                <img
                                                    src="data:image/jpeg;base64,${streetViewImage}"
                                                    style="width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--border); cursor: pointer;"
                                                    onclick="App.viewSatelliteFullscreen(this.src)"
                                                    title="Click to view fullscreen"
                                                >
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                                    <p style="font-size: 12px; font-weight: 600; margin: 0 0 12px 0; color: var(--text);">Hazards Detected ${hazardCount > 0 ? `(${hazardCount})` : ''}</p>
                                    
                                    <div style="display: grid; gap: 8px;">
                                        <label class="checkbox-row is-prominent">
                                            <input type="checkbox" id="hazard_pool" ${hazards.pool ? 'checked' : ''}>
                                            <span>üèä Pool ${hazards.pool ? '‚úì Detected' : '(Not detected)'}${hazards.pool && hazards.poolFenced === true ? ' (fenced)' : hazards.pool && hazards.poolFenced === false ? ' ‚ö†Ô∏è no visible fence' : ''}</span>
                                        </label>
                                        <label class="checkbox-row is-prominent">
                                            <input type="checkbox" id="hazard_trampoline" ${hazards.trampoline ? 'checked' : ''}>
                                            <span>üé™ Trampoline ${hazards.trampoline ? '‚úì Detected' : '(Not detected)'}</span>
                                        </label>
                                        <label class="checkbox-row is-prominent">
                                            <input type="checkbox" id="hazard_deck" ${hazards.deck ? 'checked' : ''}>
                                            <span>üõãÔ∏è Deck/Patio ${hazards.deck ? '‚úì Detected' : '(Not detected)'}</span>
                                        </label>
                                        ${hazards.treeOverhang === true ? `
                                            <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: #fff3cd; border-radius: 6px;">
                                                <span>üå≤</span>
                                                <span style="font-size: 13px; color: #856404;">Tree branches overhanging roof</span>
                                            </div>
                                        ` : ''}
                                        ${hazards.visibleHazards && hazards.visibleHazards.length > 0 ? `
                                            <div style="padding: 8px; background: #f8d7da; border-radius: 6px;">
                                                <p style="font-size: 11px; font-weight: 600; margin: 0 0 4px 0; color: #721c24;">‚ö†Ô∏è Visible Hazards</p>
                                                <ul style="margin: 0; padding: 0 0 0 16px; font-size: 12px; color: #721c24;">
                                                    ${hazards.visibleHazards.map(h => `<li>${h}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
                                    <p style="font-size: 12px; font-weight: 600; margin: 0 0 12px 0; color: var(--text);">Property Details</p>
                                    
                                    <div style="display: grid; gap: 8px;">
                                        ${hazards.numStories ? `
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="font-size: 14px;">üìä Stories:</span>
                                                <span style="font-size: 14px; font-weight: 600;">${hazards.numStories}</span>
                                            </div>
                                        ` : ''}
                                        ${hazards.roofType ? `
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="font-size: 14px;">üè† Roof Material:</span>
                                                <span style="font-size: 14px; font-weight: 600;">${String(hazards.roofType).replace(/_/g, ' ')}</span>
                                            </div>
                                        ` : ''}
                                        ${hazards.roofShape ? `
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="font-size: 14px;">üèóÔ∏è Roof Shape:</span>
                                                <span style="font-size: 14px; font-weight: 600;">${hazards.roofShape}</span>
                                            </div>
                                        ` : ''}
                                        ${hazards.roofConditionScore ? `
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="font-size: 14px;">üîç Roof Condition:</span>
                                                <span style="font-size: 14px; font-weight: 600; color: ${hazards.roofConditionScore >= 7 ? '#28a745' : hazards.roofConditionScore >= 4 ? '#ffc107' : '#dc3545'};">${hazards.roofConditionScore}/10 ${hazards.roofConditionScore >= 7 ? '(Good)' : hazards.roofConditionScore >= 4 ? '(Fair)' : '(Poor)'}</span>
                                            </div>
                                        ` : ''}
                                        ${hazards.garageSpaces ? `
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="font-size: 14px;">üöó Garage Doors:</span>
                                                <span style="font-size: 14px; font-weight: 600;">${hazards.garageSpaces}</span>
                                            </div>
                                        ` : ''}
                                        ${hazards.notes ? `
                                            <div style="margin-top: 8px; padding: 8px; background: var(--bg); border-radius: 6px;">
                                                <p style="font-size: 11px; font-weight: 600; margin: 0 0 4px 0; color: var(--text-secondary);">üìù Underwriter Notes</p>
                                                <p style="font-size: 12px; margin: 0; color: var(--text);">${hazards.notes}</p>
                                            </div>
                                        ` : ''}
                                        ${!hazards.numStories && !hazards.roofType && !hazards.roofShape && !hazards.garageSpaces ? `
                                            <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">No additional details detected in satellite image.</p>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-footer">
                                <button class="btn-secondary" onclick="App.closeHazardModal()">Cancel</button>
                                <button class="btn-primary" onclick="App.applyHazardDetections()">‚úÖ Apply to Form</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existing = document.getElementById('hazardDetectionModal');
                if (existing) existing.remove();
                
                // Add to page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Show modal
                setTimeout(() => {
                    document.getElementById('hazardDetectionModal').classList.add('active');
                }, 10);
                
                // Store for later use
                this.detectedHazards = hazards;
            },

            closeHazardModal() {
                const modal = document.getElementById('hazardDetectionModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            },

            applyHazardDetections() {
                // Get user-confirmed hazards from checkboxes
                const pool = document.getElementById('hazard_pool')?.checked || false;
                const trampoline = document.getElementById('hazard_trampoline')?.checked || false;
                const deck = document.getElementById('hazard_deck')?.checked || false;
                const applied = [];

                // Apply hazards to form
                if (pool) {
                    this.data.pool = 'In Ground';
                    const poolEl = document.getElementById('pool');
                    if (poolEl) {
                        poolEl.value = 'In Ground';
                        this.markAutoFilled(poolEl, 'hazard');
                    }
                    applied.push('Pool');
                }

                if (trampoline) {
                    this.data.trampoline = 'Yes';
                    const trampolineEl = document.getElementById('trampoline');
                    if (trampolineEl) {
                        trampolineEl.value = 'Yes';
                        this.markAutoFilled(trampolineEl, 'hazard');
                    }
                    applied.push('Trampoline');
                }

                if (deck) {
                    applied.push('Deck/Patio (noted)');
                }

                // Apply property details from detectedHazards
                const h = this.detectedHazards || {};

                if (h.roofShape) {
                    const capitalize = s => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
                    const val = capitalize(h.roofShape);
                    const el = document.getElementById('roofShape');
                    if (el) {
                        const options = Array.from(el.options).map(o => o.value);
                        if (options.includes(val)) {
                            el.value = val;
                            this.data.roofShape = val;
                            this.markAutoFilled(el, 'hazard');
                            applied.push('Roof Shape: ' + val);
                        }
                    }
                }

                if (h.roofType) {
                    const roofMap = {
                        'asphalt': 'Asphalt/Composite Shingle',
                        'composition_shingle': 'Asphalt/Composite Shingle',
                        'architectural_shingle': 'Asphalt/Composite Shingle',
                        'metal': 'Metal',
                        'tile': 'Clay Tile',
                        'clay_tile': 'Clay Tile',
                        'concrete_tile': 'Concrete Tile',
                        'flat': 'Tar & Gravel',
                        'flat_membrane': 'Tar & Gravel',
                        'wood_shake': 'Wood Shake/Shingle',
                        'slate': 'Slate',
                    };
                    const mapped = roofMap[h.roofType.toLowerCase()] || roofMap[h.roofType.toLowerCase().replace(/_/g, ' ')] || null;
                    if (mapped) {
                        const el = document.getElementById('roofType');
                        if (el) {
                            const options = Array.from(el.options).map(o => o.value);
                            if (options.includes(mapped)) {
                                el.value = mapped;
                                this.data.roofType = mapped;
                                this.markAutoFilled(el, 'hazard');
                                applied.push('Roof Type: ' + mapped);
                            }
                        }
                    }
                }

                if (h.numStories) {
                    const val = parseInt(String(h.numStories).replace('+', ''));
                    if (val > 0 && val <= 5) {
                        const el = document.getElementById('numStories');
                        if (el) {
                            el.value = val;
                            this.data.numStories = val;
                            this.markAutoFilled(el, 'hazard');
                            applied.push('Stories: ' + val);
                        }
                    }
                }

                // Save to localStorage
                this.save({ target: { id: 'pool', value: this.data.pool || '' } });

                // Show confirmation
                this.toast(applied.length > 0 ? `Applied: ${applied.join(', ')}` : 'No detections applied', 4000);

                // Close modal
                this.closeHazardModal();
            },

            // Phase 4: Vision Processing Methods
            
            async processVisionImage(imageFile) {
                /**
                 * Process a property image (roof, foundation, exterior, etc.)
                 * Sends base64-encoded image to vision-processor.js
                 */
                if (!imageFile) return null;
                
                const reader = new FileReader();
                return new Promise((resolve) => {
                    reader.onload = async (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        
                        try {
                            const response = await fetch('/api/vision-processor.js', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'processImage',
                                    base64Data: base64Data,
                                    mimeType: imageFile.type || 'image/jpeg',
                                    imageType: 'property',
                                    county: this.getCountyFromCity(this.data.addrCity, this.data.addrState)
                                })
                            });
                            
                            const result = await response.json();
                            resolve(result);
                        } catch (error) {
                            console.error('Vision image processing error:', error);
                            resolve({ success: false, error: error.message });
                        }
                    };
                    reader.readAsDataURL(imageFile);
                });
            },

            async processVisionPDF(pdfFile, documentType = 'tax_summary') {
                /**
                 * Process a property document PDF (tax summary, assessment, etc.)
                 * Sends base64-encoded PDF to vision-processor.js
                 */
                if (!pdfFile) return null;
                
                const reader = new FileReader();
                return new Promise((resolve) => {
                    reader.onload = async (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        
                        try {
                            const response = await fetch('/api/vision-processor.js', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'processPDF',
                                    base64Data: base64Data,
                                    documentType: documentType,
                                    county: this.getCountyFromCity(this.data.addrCity, this.data.addrState)
                                })
                            });
                            
                            const result = await response.json();
                            resolve(result);
                        } catch (error) {
                            console.error('Vision PDF processing error:', error);
                            resolve({ success: false, error: error.message });
                        }
                    };
                    reader.readAsDataURL(pdfFile);
                });
            },

            async analyzeAerialImage(lat, lng) {
                /**
                 * Analyze satellite/aerial image for hazard assessment
                 * Uses Google Satellite imagery for flood, wildfire, wind hazards
                 */
                if (!lat || !lng) return null;
                
                try {
                    // Get satellite image first (using existing Google Maps API)
                    const mapsKey = this._geminiApiKey || localStorage.getItem('gemini_api_key') || '';
                    const imageUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=18&size=640x640&maptype=satellite&key=${mapsKey}`;
                    
                    // Fetch image and convert to base64
                    const imageResponse = await fetch(imageUrl);
                    const blob = await imageResponse.blob();
                    const reader = new FileReader();
                    
                    return new Promise((resolve) => {
                        reader.onload = async (e) => {
                            const base64Data = e.target.result.split(',')[1];
                            
                            try {
                                const response = await fetch('/api/vision-processor.js', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        action: 'analyzeAerial',
                                        base64Data: base64Data,
                                        lat: lat,
                                        lng: lng,
                                        county: this.getCountyFromCity(this.data.addrCity, this.data.addrState)
                                    })
                                });
                                
                                const result = await response.json();
                                resolve(result);
                            } catch (error) {
                                console.error('Aerial analysis error:', error);
                                resolve({ success: false, error: error.message, hazards: [] });
                            }
                        };
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error('Aerial image retrieval error:', error);
                    return { success: false, error: error.message, hazards: [] };
                }
            },

            async consolidateVisionData(visionResults) {
                /**
                 * Consolidate results from multiple vision processing calls
                 * Returns standardized property data
                 */
                if (!visionResults) return null;
                
                try {
                    const response = await fetch('/api/vision-processor.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'consolidate',
                            visionResults: visionResults
                        })
                    });
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('Vision data consolidation error:', error);
                    return null;
                }
            },

            showVisionResultsPopup(visionData, imageType) {
                /**
                 * Display vision processing results in popup
                 * Allows user to confirm and apply extracted data
                 */
                if (!visionData || !visionData.success) {
                    alert('‚ùå Vision processing failed. Please try again.');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.id = 'visionResultsModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                const title = document.createElement('h2');
                title.textContent = `üëÅÔ∏è Vision Analysis Results (${imageType})`;
                title.style.cssText = 'margin: 0 0 16px 0; color: #007AFF;';
                
                const dataDiv = document.createElement('div');
                dataDiv.style.cssText = 'background: #f5f5f5; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                
                let dataHTML = '<p style="margin: 0; font-size: 14px;">';
                const rawData = visionData.rawData || {};
                
                for (const [key, value] of Object.entries(rawData)) {
                    if (value && value !== 'N/A' && value !== '') {
                        dataHTML += `<strong>${key}:</strong> ${value}<br>`;
                    }
                }
                
                dataHTML += '</p>';
                dataDiv.innerHTML = dataHTML;
                
                const confirmDiv = document.createElement('div');
                confirmDiv.style.cssText = 'display: flex; gap: 8px; margin-top: 16px;';
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.style.cssText = `
                    flex: 1;
                    padding: 12px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    background: white;
                    color: #333;
                    cursor: pointer;
                    font-weight: 500;
                `;
                cancelBtn.onclick = () => modal.remove();
                
                const applyBtn = document.createElement('button');
                applyBtn.textContent = '‚úÖ Apply Data';
                applyBtn.style.cssText = `
                    flex: 1;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #007AFF;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                `;
                applyBtn.onclick = () => {
                    this.applyVisionData(rawData);
                    modal.remove();
                };
                
                confirmDiv.appendChild(cancelBtn);
                confirmDiv.appendChild(applyBtn);
                
                content.appendChild(title);
                content.appendChild(dataDiv);
                content.appendChild(confirmDiv);
                modal.appendChild(content);
                document.body.appendChild(modal);
            },

            applyVisionData(data) {
                /**
                 * Apply vision-extracted data to form fields
                 */
                const fieldMappings = {
                    'year_built': 'yearBuilt',
                    'yearBuilt': 'yearBuilt',
                    'roof_type': 'roofType',
                    'roofType': 'roofType',
                    'stories': 'numStories',
                    'garage_spaces': 'numGarages',
                    'garageSpaces': 'numGarages',
                    'lot_size': 'lotSize',
                    'lotSize': 'lotSize',
                    'total_sqft': 'totalSqft',
                    'totalSqft': 'totalSqft'
                };
                
                for (const [visionKey, formKey] of Object.entries(fieldMappings)) {
                    if (data[visionKey]) {
                        const formElement = document.getElementById(formKey);
                        if (formElement) {
                            formElement.value = data[visionKey];
                            this.data[formKey] = data[visionKey];
                            this.markAutoFilled(formElement, 'vision');
                            this.save({ target: { id: formKey, value: data[visionKey] } });
                        }
                    }
                }
                
                alert(`‚úÖ Applied vision data to form`);
            },

            // Phase 5: Historical Data & Comparative Analysis Methods

            async analyzePropertyHistory() {
                /**
                 * Analyze property value history and market trends
                 * Called from Step 6 or property research section
                 */
                const address = this.data.addrStreet || '';
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const yearBuilt = this.data.yearBuilt || null;
                const county = this.getCountyFromCity(city, state);
                
                if (!address || !city || !state) {
                    alert('Please enter a complete address first.');
                    return;
                }
                
                try {
                    // Show loading state
                    const btn = document.getElementById('analyzeHistoryBtn');
                    const originalText = btn ? btn.innerHTML : 'Analyzing...';
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = 'üìä Analyzing property history...';
                    }
                    
                    // Call Phase 5: Value history analysis
                    const response = await fetch('/api/historical-analyzer.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'analyzeValues',
                            address: address,
                            city: city,
                            state: state,
                            county: county,
                            yearBuilt: yearBuilt ? parseInt(yearBuilt) : null
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showHistoryAnalysisPopup(result.data, address, city, state);
                    } else {
                        alert(`‚ùå History analysis failed: ${result.error || 'Unknown error'}`);
                    }
                    
                    // Reset button
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('Property history analysis error:', error);
                    alert('‚ùå Failed to analyze property history.');
                    const btn = document.getElementById('analyzeHistoryBtn');
                    if (btn) btn.disabled = false;
                }
            },

            async analyzeInsuranceTrends() {
                /**
                 * Analyze historical insurance rates and trends
                 */
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const county = this.getCountyFromCity(city, state);
                
                if (!county || !state) {
                    alert('Please enter a complete address first.');
                    return;
                }
                
                try {
                    const btn = document.getElementById('analyzeInsuranceBtn');
                    const originalText = btn ? btn.innerHTML : 'Analyzing...';
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = 'üìà Analyzing insurance trends...';
                    }
                    
                    const response = await fetch('/api/historical-analyzer.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'analyzeInsurance',
                            city: city,
                            state: state,
                            county: county,
                            riskLevel: 'all'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showInsuranceAnalysisPopup(result.data, county, state);
                    } else {
                        alert(`‚ùå Insurance analysis failed: ${result.error || 'Unknown error'}`);
                    }
                    
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('Insurance analysis error:', error);
                    alert('‚ùå Failed to analyze insurance trends.');
                    const btn = document.getElementById('analyzeInsuranceBtn');
                    if (btn) btn.disabled = false;
                }
            },

            async compareToMarket() {
                /**
                 * Compare property to market baseline and comparables
                 */
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const county = this.getCountyFromCity(city, state);
                const yearBuilt = this.data.yearBuilt || null;
                // Estimate property value if not provided
                const propertyValue = parseInt(this.data.propertyValue) || 500000;
                const sqft = parseInt(this.data.totalSqft) || null;
                
                if (!city || !state) {
                    alert('Please enter a complete address first.');
                    return;
                }
                
                try {
                    const btn = document.getElementById('compareMarketBtn');
                    const originalText = btn ? btn.innerHTML : 'Comparing...';
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = 'üîç Comparing to market...';
                    }
                    
                    const response = await fetch('/api/historical-analyzer.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'compareMarket',
                            city: city,
                            state: state,
                            county: county,
                            propertyValue: propertyValue,
                            yearBuilt: yearBuilt ? parseInt(yearBuilt) : null,
                            sqft: sqft
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showMarketComparisonPopup(result.data, city, state);
                    } else {
                        alert(`‚ùå Market comparison failed: ${result.error || 'Unknown error'}`);
                    }
                    
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('Market comparison error:', error);
                    alert('‚ùå Failed to compare to market.');
                    const btn = document.getElementById('compareMarketBtn');
                    if (btn) btn.disabled = false;
                }
            },

            async generatePropertyTimeline() {
                /**
                 * Generate comprehensive property timeline report
                 */
                const address = this.data.addrStreet || '';
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const county = this.getCountyFromCity(city, state);
                const yearBuilt = this.data.yearBuilt || null;
                const propertyValue = parseInt(this.data.propertyValue) || 500000;
                const sqft = parseInt(this.data.totalSqft) || null;
                
                if (!address || !city || !state) {
                    alert('Please enter a complete address first.');
                    return;
                }
                
                try {
                    const btn = document.getElementById('timelineBtn');
                    const originalText = btn ? btn.innerHTML : 'Generating...';
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = 'üìÖ Generating timeline...';
                    }
                    
                    const response = await fetch('/api/historical-analyzer.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'generateTimeline',
                            address: address,
                            city: city,
                            state: state,
                            county: county,
                            yearBuilt: yearBuilt ? parseInt(yearBuilt) : null,
                            propertyValue: propertyValue,
                            sqft: sqft
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showTimelinePopup(result.data, address, city, state);
                    } else {
                        alert(`‚ùå Timeline generation failed: ${result.error || 'Unknown error'}`);
                    }
                    
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('Timeline generation error:', error);
                    alert('‚ùå Failed to generate timeline.');
                    const btn = document.getElementById('timelineBtn');
                    if (btn) btn.disabled = false;
                }
            },

            showHistoryAnalysisPopup(data, address, city, state) {
                /**
                 * Display property value history analysis
                 */
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 600px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                const title = document.createElement('h2');
                title.textContent = 'üìä Property Value History';
                title.style.cssText = 'margin: 0 0 16px 0; color: #28a745;';
                
                const addressLine = document.createElement('p');
                addressLine.style.cssText = 'color: #666; margin: 0 0 24px 0; font-size: 14px;';
                addressLine.textContent = `${address}, ${city}, ${state}`;
                
                const historyDiv = document.createElement('div');
                historyDiv.style.cssText = 'margin-bottom: 24px;';
                
                if (data.valueHistory) {
                    let historyHTML = '<p style="font-weight: 600; margin-bottom: 12px;">Estimated Values Over Time:</p>';
                    historyHTML += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                    historyHTML += '<tr style="background: #f5f5f5;"><th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Time Period</th><th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Est. Value</th></tr>';
                    
                    if (data.valueHistory.tenYearsAgo) {
                        historyHTML += `<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">10 years ago</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #eee;">$${data.valueHistory.tenYearsAgo.estimatedValue?.toLocaleString()}</td></tr>`;
                    }
                    if (data.valueHistory.fiveYearsAgo) {
                        historyHTML += `<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">5 years ago</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #eee;">$${data.valueHistory.fiveYearsAgo.estimatedValue?.toLocaleString()}</td></tr>`;
                    }
                    if (data.valueHistory.current) {
                        historyHTML += `<tr><td style="padding: 8px; font-weight: 600; background: #fff3cd;">Current</td><td style="text-align: right; padding: 8px; font-weight: 600; background: #fff3cd;">$${data.valueHistory.current.estimatedValue?.toLocaleString()}</td></tr>`;
                    }
                    
                    historyHTML += '</table>';
                    historyDiv.innerHTML = historyHTML;
                }
                
                if (data.appreciationRate) {
                    const rateDiv = document.createElement('div');
                    rateDiv.style.cssText = 'background: #e8f5e9; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    rateDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Appreciation Rate</p>
                        <p style="margin: 0; font-size: 14px;">Annual Average: <strong>${(data.appreciationRate.annualAverage * 100).toFixed(1)}%</strong></p>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;">${data.appreciationRate.comparison}</p>
                    `;
                    content.appendChild(rateDiv);
                }
                
                if (data.currentTrend) {
                    const trendDiv = document.createElement('div');
                    trendDiv.style.cssText = 'background: #e3f2fd; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    trendDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Current Market Trend</p>
                        <p style="margin: 0; font-size: 14px;">${data.currentTrend}</p>
                    `;
                    content.appendChild(trendDiv);
                }
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úì Close';
                closeBtn.style.cssText = `
                    width: 100%;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #007AFF;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 14px;
                `;
                closeBtn.onclick = () => modal.remove();
                
                content.appendChild(addressLine);
                content.appendChild(historyDiv);
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
            },

            showInsuranceAnalysisPopup(data, county, state) {
                /**
                 * Display insurance analysis and trends
                 */
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 600px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                const title = document.createElement('h2');
                title.textContent = 'üìà Insurance Trends Analysis';
                title.style.cssText = 'margin: 0 0 8px 0; color: #ff9800;';
                
                const subtitle = document.createElement('p');
                subtitle.textContent = `${county} County, ${state}`;
                subtitle.style.cssText = 'margin: 0 0 24px 0; color: #666; font-size: 14px;';
                
                if (data.homeownersInsurance) {
                    const insuranceDiv = document.createElement('div');
                    insuranceDiv.style.cssText = 'background: #fff3e0; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    insuranceDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Homeowners Insurance Trend</p>
                        <p style="margin: 0; font-size: 14px;"><strong>${data.homeownersInsurance.trend}</strong></p>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;">Causes: ${data.homeownersInsurance.causes?.join(', ') || 'Multiple factors'}</p>
                    `;
                    content.appendChild(insuranceDiv);
                }
                
                if (data.ratePrediction) {
                    const predictionDiv = document.createElement('div');
                    predictionDiv.style.cssText = 'background: #f3e5f5; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    predictionDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Rate Prediction (Next 3 Years)</p>
                        <p style="margin: 0; font-size: 14px;"><strong>${data.ratePrediction.nextThreeYears}</strong></p>
                        <p style="margin: 8px 0 0 0; font-size: 13px; font-weight: 600;">Mitigation:</p>
                        <ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 13px;">
                            ${data.ratePrediction.mitigation?.map(m => `<li>${m}</li>`).join('') || '<li>Consult with insurance agent</li>'}
                        </ul>
                    `;
                    content.appendChild(predictionDiv);
                }
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úì Close';
                closeBtn.style.cssText = `
                    width: 100%;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #007AFF;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 14px;
                    margin-top: 16px;
                `;
                closeBtn.onclick = () => modal.remove();
                
                content.appendChild(title);
                content.appendChild(subtitle);
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
            },

            showMarketComparisonPopup(data, city, state) {
                /**
                 * Display market comparison and positioning
                 */
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 600px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                const title = document.createElement('h2');
                title.textContent = 'üîç Market Comparison';
                title.style.cssText = 'margin: 0 0 8px 0; color: #1976d2;';
                
                const subtitle = document.createElement('p');
                subtitle.textContent = `${city}, ${state}`;
                subtitle.style.cssText = 'margin: 0 0 24px 0; color: #666; font-size: 14px;';
                
                if (data.valuationAssessment) {
                    const assessmentDiv = document.createElement('div');
                    assessmentDiv.style.cssText = 'background: #e8f5e9; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    assessmentDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Valuation Assessment</p>
                        <p style="margin: 0; font-size: 14px;"><strong>Price/SqFt: $${data.valuationAssessment.pricePerSqft}</strong> (Market Avg: $${data.valuationAssessment.marketAverage})</p>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;">${data.valuationAssessment.assessment}</p>
                    `;
                    content.appendChild(assessmentDiv);
                }
                
                if (data.neighborhoodPositioning) {
                    const positionDiv = document.createElement('div');
                    positionDiv.style.cssText = 'background: #e3f2fd; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    positionDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Neighborhood Positioning</p>
                        <p style="margin: 0; font-size: 14px;"><strong>Similar Properties:</strong> $${data.neighborhoodPositioning.similar?.range || 'N/A'}</p>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;"><strong>Trend:</strong> ${data.neighborhoodPositioning.trend}</p>
                    `;
                    content.appendChild(positionDiv);
                }
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úì Close';
                closeBtn.style.cssText = `
                    width: 100%;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #007AFF;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 14px;
                    margin-top: 16px;
                `;
                closeBtn.onclick = () => modal.remove();
                
                content.appendChild(title);
                content.appendChild(subtitle);
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
            },

            showTimelinePopup(data, address, city, state) {
                /**
                 * Display property timeline report
                 */
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 700px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                const title = document.createElement('h2');
                title.textContent = 'üìÖ Property Timeline Report';
                title.style.cssText = 'margin: 0 0 16px 0; color: #9c27b0;';
                
                const addressLine = document.createElement('p');
                addressLine.style.cssText = 'color: #666; margin: 0 0 24px 0; font-size: 14px;';
                addressLine.textContent = `${address}, ${city}, ${state}`;
                
                if (data.timeline && Array.isArray(data.timeline)) {
                    let timelineHTML = '';
                    data.timeline.forEach((item, idx) => {
                        timelineHTML += `
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                                <p style="margin: 0 0 4px 0; font-weight: 600; color: #333;">üïê ${item.year}</p>
                                <p style="margin: 0 0 8px 0; font-size: 14px; font-weight: 500;">${item.event}</p>
                                <p style="margin: 0 0 4px 0; font-size: 13px; color: #666;">${item.context}</p>
                                <p style="margin: 0; font-size: 13px; color: #1976d2;"><strong>Relevance:</strong> ${item.relevance}</p>
                            </div>
                        `;
                    });
                    content.innerHTML += timelineHTML;
                }
                
                if (data.valueProjection) {
                    const projectionDiv = document.createElement('div');
                    projectionDiv.style.cssText = 'background: #f5f5f5; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    projectionDiv.innerHTML = `
                        <p style="margin: 0 0 12px 0; font-weight: 600;">Value Projections</p>
                        <table style="width: 100%; font-size: 13px;">
                            <tr><td>Current:</td><td style="text-align: right;"><strong>$${data.valueProjection.current?.toLocaleString()}</strong></td></tr>
                            <tr><td>5 Years:</td><td style="text-align: right;">$${data.valueProjection.fiveYears?.toLocaleString()}</td></tr>
                            <tr><td>10 Years:</td><td style="text-align: right;">$${data.valueProjection.tenYears?.toLocaleString()}</td></tr>
                        </table>
                    `;
                    content.appendChild(projectionDiv);
                }
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úì Close';
                closeBtn.style.cssText = `
                    width: 100%;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #007AFF;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 14px;
                    margin-top: 16px;
                `;
                closeBtn.onclick = () => modal.remove();
                
                content.appendChild(title);
                content.appendChild(addressLine);
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
            },

            showDataPreview(data, sources, conflicts = {}, satelliteImage = null, address = '') {
                // Create modal HTML
                const modalHTML = `
                    <div class="modal-overlay" id="dataPreviewModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>üìã Review Extracted Data</h2>
                                <p style="font-size: 13px; color: var(--text-secondary); margin: 8px 0 0 0;">
                                    Review and edit before applying to form
                                </p>
                            </div>
                            <div class="modal-body" id="dataPreviewBody">
                                ${satelliteImage ? this.renderSatelliteSection(satelliteImage, address) : ''}
                                ${this.renderDataItems(data, conflicts)}
                            </div>
                            <div class="modal-footer">
                                <button class="btn-secondary" onclick="App.closeDataPreview()">Cancel</button>
                                <button class="btn-primary" onclick="App.applyPreviewData()">‚úÖ Apply Selected Data</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existing = document.getElementById('dataPreviewModal');
                if (existing) existing.remove();
                
                // Add to page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Show modal
                setTimeout(() => {
                    document.getElementById('dataPreviewModal').classList.add('active');
                }, 10);
                
                // Store data for later use
                this.previewData = data;
                this.previewConflicts = conflicts;
                this.previewAddress = address;
            },

            renderSatelliteSection(satelliteImage, address) {
                const googleMapsUrl = `https://maps.google.com/maps?q=${encodeURIComponent(address)}`;
                const googleEarthUrl = `https://earth.google.com/web/search/${encodeURIComponent(address)}`;
                
                return `
                    <div class="satellite-section">
                        <p style="font-size: 12px; font-weight: 600; margin: 0 0 8px 0; color: var(--text);">üõ∞Ô∏è Satellite View</p>
                        <img 
                            src="data:image/png;base64,${satelliteImage}" 
                            class="satellite-thumbnail" 
                            onclick="App.viewSatelliteFullscreen(this.src)"
                            title="Click to view fullscreen"
                        >
                        <p class="satellite-label">Tap to view fullscreen</p>
                        <div class="satellite-links">
                            <a href="${googleMapsUrl}" target="_blank">üìç Google Maps</a>
                            <a href="${googleEarthUrl}" target="_blank">üåç Google Earth</a>
                        </div>
                    </div>
                `;
            },

            viewSatelliteFullscreen(imageSrc) {
                const modal = `
                    <div class="modal-overlay" id="fullscreenImageModal" style="display: flex;">
                        <div style="position: relative; max-width: 90%; max-height: 90%; display: flex; align-items: center; justify-content: center;">
                            <img src="${imageSrc}" style="max-width: 100%; max-height: 100%; border-radius: 8px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                            <button onclick="document.getElementById('fullscreenImageModal').remove()" 
                                    style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">
                                ‚úï
                            </button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
                document.getElementById('fullscreenImageModal').classList.add('active');
            },

            renderDataItems(data, conflicts) {
                const fieldLabels = {
                    yrBuilt: 'Year Built',
                    sqFt: 'Square Footage',
                    numStories: 'Number of Stories',
                    fullBaths: 'Full Bathrooms',
                    dwellingType: 'Dwelling Type',
                    dwellingUsage: 'Dwelling Usage',
                    constructionStyle: 'Construction Style',
                    exteriorWalls: 'Exterior Walls',
                    roofType: 'Roof Type',
                    roofYr: 'Roof Year',
                    roofShape: 'Roof Shape',
                    heatingType: 'Heating Type',
                    foundation: 'Foundation Type',
                    pool: 'Pool',
                    trampoline: 'Trampoline',
                    fireplace: 'Fireplace',
                    garageSpaces: 'Garage Spaces',
                    lotSize: 'Lot Size'
                };
                
                let html = '';
                
                for (const [key, label] of Object.entries(fieldLabels)) {
                    const value = data[key];
                    const conflict = conflicts?.[key];
                    
                    if (!value && !conflict) continue;
                    
                    const hasConflict = conflict && conflict.length > 1;
                    
                    html += `
                        <div class="data-item ${hasConflict ? 'conflict' : ''}">
                            <div class="data-item-header">
                                <span class="data-item-label">${label}</span>
                                ${hasConflict ? '<span class="conflict-badge">‚ö†Ô∏è Conflict</span>' : ''}
                            </div>
                            <div class="data-value-group">
                    `;
                    
                    if (hasConflict) {
                        // Show all conflicting values with radio buttons
                        conflict.forEach((option, idx) => {
                            const checked = idx === 0 ? 'checked' : '';
                            html += `
                                <div class="data-value-option">
                                    <input type="radio" name="field_${key}" value="${option.value}" id="${key}_${idx}" ${checked}>
                                    <label for="${key}_${idx}">${option.value}</label>
                                    <span class="source-tag">${option.source}</span>
                                </div>
                            `;
                        });
                        // Add manual edit option
                        html += `
                            <div class="data-value-option">
                                <input type="radio" name="field_${key}" value="custom" id="${key}_custom">
                                <input type="text" id="${key}_custom_value" placeholder="Enter custom value" 
                                       onclick="document.getElementById('${key}_custom').checked = true">
                            </div>
                        `;
                    } else {
                        // Single value - show as editable input
                        const source = data[key + '_source'] || 'Smart';
                        html += `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="text" class="data-value" id="field_${key}" value="${value}">
                                <span class="data-source">${source}</span>
                            </div>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                return html || '<p style="text-align: center; color: var(--text-secondary);">No data extracted</p>';
            },

            closeDataPreview() {
                const modal = document.getElementById('dataPreviewModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            },

            applyPreviewData() {
                const fieldsUpdated = [];
                
                // Get all data items
                const dataItems = document.querySelectorAll('.data-item');
                
                dataItems.forEach(item => {
                    const label = item.querySelector('.data-item-label').textContent;
                    const isConflict = item.classList.contains('conflict');
                    
                    if (isConflict) {
                        // Get selected radio button value
                        const radios = item.querySelectorAll('input[type="radio"]');
                        const selected = Array.from(radios).find(r => r.checked);
                        
                        if (selected) {
                            const fieldKey = selected.name.replace('field_', '');
                            let value;
                            
                            if (selected.value === 'custom') {
                                value = document.getElementById(fieldKey + '_custom_value').value;
                            } else {
                                value = selected.value;
                            }
                            
                            if (value) {
                                this.setFieldValue(fieldKey, value);
                                fieldsUpdated.push(label);
                            }
                        }
                    } else {
                        // Get input value directly
                        const input = item.querySelector('.data-value');
                        if (input && input.value) {
                            const fieldKey = input.id.replace('field_', '');
                            this.setFieldValue(fieldKey, input.value);
                            fieldsUpdated.push(label);
                        }
                    }
                });
                
                this.closeDataPreview();
                
                if (fieldsUpdated.length > 0) {
                    alert(`‚úÖ Applied ${fieldsUpdated.length} fields!\n\n${fieldsUpdated.join('\n')}`);
                    this.updateScanCoverage();
                }
            },

            getCountyFromCity(city, state) {
                // Map city to county for display and reference
                // Normalize city to lowercase for lookup
                const cityLower = (city || '').toLowerCase().trim();

                const cityToCounty = {
                    'WA': {
                        'vancouver': 'Clark', 'camas': 'Clark', 'battle ground': 'Clark', 'ridgefield': 'Clark', 'la center': 'Clark', 'washougal': 'Clark',
                        'seattle': 'King', 'bellevue': 'King', 'redmond': 'King', 'kent': 'King', 'renton': 'King', 'federal way': 'King', 'kirkland': 'King', 'auburn': 'King', 'sammamish': 'King', 'bothell': 'King',
                        'tacoma': 'Pierce', 'lakewood': 'Pierce', 'puyallup': 'Pierce', 'bonney lake': 'Pierce', 'university place': 'Pierce',
                        'everett': 'Snohomish', 'marysville': 'Snohomish', 'lynnwood': 'Snohomish', 'edmonds': 'Snohomish', 'mountlake terrace': 'Snohomish',
                        'spokane': 'Spokane', 'spokane valley': 'Spokane',
                        'bremerton': 'Kitsap', 'silverdale': 'Kitsap', 'poulsbo': 'Kitsap',
                        'olympia': 'Thurston', 'lacey': 'Thurston', 'tumwater': 'Thurston',
                        'bellingham': 'Whatcom',
                        'yakima': 'Yakima',
                        'longview': 'Cowlitz', 'kelso': 'Cowlitz',
                    },
                    'OR': {
                        'portland': 'Multnomah', 'gresham': 'Multnomah', 'troutdale': 'Multnomah', 'wood village': 'Multnomah', 'fairview': 'Multnomah',
                        'beaverton': 'Washington', 'hillsboro': 'Washington', 'tigard': 'Washington', 'tualatin': 'Washington', 'lake oswego': 'Washington', 'west linn': 'Washington', 'sherwood': 'Washington', 'forest grove': 'Washington', 'cornelius': 'Washington',
                        'oregon city': 'Clackamas', 'milwaukie': 'Clackamas', 'happy valley': 'Clackamas', 'wilsonville': 'Clackamas', 'canby': 'Clackamas', 'sandy': 'Clackamas', 'estacada': 'Clackamas',
                        'eugene': 'Lane', 'springfield': 'Lane', 'cottage grove': 'Lane', 'creswell': 'Lane', 'veneta': 'Lane',
                        'salem': 'Marion', 'keizer': 'Marion', 'woodburn': 'Marion', 'silverton': 'Marion',
                        'bend': 'Deschutes', 'redmond': 'Deschutes', 'sisters': 'Deschutes', 'la pine': 'Deschutes',
                        'medford': 'Jackson', 'ashland': 'Jackson', 'central point': 'Jackson', 'phoenix': 'Jackson', 'talent': 'Jackson',
                        'albany': 'Linn', 'lebanon': 'Linn', 'sweet home': 'Linn',
                        'roseburg': 'Douglas', 'sutherlin': 'Douglas', 'winston': 'Douglas',
                    },
                    'AZ': {
                        'phoenix': 'Maricopa', 'mesa': 'Maricopa', 'chandler': 'Maricopa', 'scottsdale': 'Maricopa', 'glendale': 'Maricopa', 'tempe': 'Maricopa', 'peoria': 'Maricopa', 'surprise': 'Maricopa', 'gilbert': 'Maricopa', 'avondale': 'Maricopa', 'goodyear': 'Maricopa', 'buckeye': 'Maricopa', 'el mirage': 'Maricopa', 'queen creek': 'Maricopa', 'cave creek': 'Maricopa', 'fountain hills': 'Maricopa', 'paradise valley': 'Maricopa',
                        'tucson': 'Pima', 'oro valley': 'Pima', 'marana': 'Pima', 'sahuarita': 'Pima',
                        'casa grande': 'Pinal', 'apache junction': 'Pinal', 'coolidge': 'Pinal', 'eloy': 'Pinal', 'florence': 'Pinal', 'maricopa': 'Pinal',
                        'prescott': 'Yavapai', 'prescott valley': 'Yavapai', 'chino valley': 'Yavapai', 'cottonwood': 'Yavapai', 'sedona': 'Yavapai',
                        'flagstaff': 'Coconino', 'williams': 'Coconino',
                        'lake havasu city': 'Mohave', 'kingman': 'Mohave', 'bullhead city': 'Mohave',
                        'yuma': 'Yuma', 'san luis': 'Yuma', 'somerton': 'Yuma',
                    }
                };

                if (cityToCounty[state] && cityToCounty[state][cityLower]) {
                    return cityToCounty[state][cityLower];
                }
                return null;
            },

            openGIS() {
                const address = this.data.addrStreet || '';
                const city = (this.data.addrCity || '').toLowerCase();
                const state = (this.data.addrState || '').toUpperCase();
                const zip = this.data.addrZip || '';
                
                if (!address || !city || !state) {
                    alert('Please enter a complete address (street, city, and state) first.');
                    return;
                }
                
                // Washington State County GIS mapping
                const waCountyGIS = {
                    // Clark County - Property Information Center
                    'vancouver': 'https://gis.clark.wa.gov/gishome/property/',
                    'camas': 'https://gis.clark.wa.gov/gishome/property/',
                    'battle ground': 'https://gis.clark.wa.gov/gishome/property/',
                    'ridgefield': 'https://gis.clark.wa.gov/gishome/property/',
                    'la center': 'https://gis.clark.wa.gov/gishome/property/',
                    'washougal': 'https://gis.clark.wa.gov/gishome/property/',
                    
                    // King County
                    'seattle': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'bellevue': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'redmond': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'kent': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'renton': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'federal way': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'kirkland': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'auburn': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'sammamish': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'bothell': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    
                    // Pierce County
                    'tacoma': 'https://atip.piercecountywa.gov/app/parcel-search',
                    'lakewood': 'https://atip.piercecountywa.gov/app/parcel-search',
                    'puyallup': 'https://atip.piercecountywa.gov/app/parcel-search',
                    'bonney lake': 'https://atip.piercecountywa.gov/app/parcel-search',
                    'university place': 'https://atip.piercecountywa.gov/app/parcel-search',
                    
                    // Snohomish County
                    'everett': 'https://www.snoco.org/proptax/default.aspx',
                    'marysville': 'https://www.snoco.org/proptax/default.aspx',
                    'lynnwood': 'https://www.snoco.org/proptax/default.aspx',
                    'edmonds': 'https://www.snoco.org/proptax/default.aspx',
                    'mountlake terrace': 'https://www.snoco.org/proptax/default.aspx',
                    
                    // Spokane County
                    'spokane': 'https://mapgis.spokanecounty.org/SCGIS2/Parcel/',
                    'spokane valley': 'https://mapgis.spokanecounty.org/SCGIS2/Parcel/',
                    
                    // Kitsap County
                    'bremerton': 'https://psearch.kitsap.gov/psearch/',
                    'silverdale': 'https://psearch.kitsap.gov/psearch/',
                    'poulsbo': 'https://psearch.kitsap.gov/psearch/',
                    
                    // Thurston County
                    'olympia': 'https://taxlot.co.thurston.wa.us/',
                    'lacey': 'https://taxlot.co.thurston.wa.us/',
                    'tumwater': 'https://taxlot.co.thurston.wa.us/',
                    
                    // Whatcom County
                    'bellingham': 'https://www.whatcomcounty.us/1476/Online-Property-Search',
                    
                    // Yakima County
                    'yakima': 'https://www.co.yakima.wa.us/497/Property-Information-Public-Inquiry',
                    
                    // Cowlitz County
                    'longview': 'https://cowlitzassessor.us/',
                    'kelso': 'https://cowlitzassessor.us/',
                };
                
                // Oregon County GIS mapping
                const orCountyGIS = {
                    // Multnomah County
                    'portland': 'https://www.portlandmaps.com/',
                    'gresham': 'https://www.portlandmaps.com/',
                    'troutdale': 'https://www.portlandmaps.com/',
                    'wood village': 'https://www.portlandmaps.com/',
                    'fairview': 'https://www.portlandmaps.com/',
                    
                    // Washington County
                    'beaverton': 'https://www.washingtoncountyor.gov/at/property-information',
                    'hillsboro': 'https://www.washingtoncountyor.gov/at/property-information',
                    'tigard': 'https://www.washingtoncountyor.gov/at/property-information',
                    'tualatin': 'https://www.washingtoncountyor.gov/at/property-information',
                    'lake oswego': 'https://www.washingtoncountyor.gov/at/property-information',
                    'west linn': 'https://www.washingtoncountyor.gov/at/property-information',
                    'sherwood': 'https://www.washingtoncountyor.gov/at/property-information',
                    'forest grove': 'https://www.washingtoncountyor.gov/at/property-information',
                    'cornelius': 'https://www.washingtoncountyor.gov/at/property-information',
                    
                    // Clackamas County
                    'oregon city': 'https://ascendweb.clackamas.us/',
                    'milwaukie': 'https://ascendweb.clackamas.us/',
                    'happy valley': 'https://ascendweb.clackamas.us/',
                    'wilsonville': 'https://ascendweb.clackamas.us/',
                    'canby': 'https://ascendweb.clackamas.us/',
                    'sandy': 'https://ascendweb.clackamas.us/',
                    'estacada': 'https://ascendweb.clackamas.us/',
                    
                    // Lane County
                    'eugene': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                    'springfield': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                    'cottage grove': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                    'creswell': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                    'veneta': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                    
                    // Marion County
                    'salem': 'https://mcasr.co.marion.or.us/',
                    'keizer': 'https://mcasr.co.marion.or.us/',
                    'woodburn': 'https://mcasr.co.marion.or.us/',
                    'silverton': 'https://mcasr.co.marion.or.us/',
                    
                    // Deschutes County
                    'bend': 'https://dial.deschutes.org/',
                    'redmond': 'https://dial.deschutes.org/',
                    'sisters': 'https://dial.deschutes.org/',
                    'la pine': 'https://dial.deschutes.org/',
                    
                    // Jackson County
                    'medford': 'http://pdo.jacksoncountyor.gov/pdo',
                    'ashland': 'http://pdo.jacksoncountyor.gov/pdo',
                    'central point': 'http://pdo.jacksoncountyor.gov/pdo',
                    'phoenix': 'http://pdo.jacksoncountyor.gov/pdo',
                    'talent': 'http://pdo.jacksoncountyor.gov/pdo',
                    
                    // Linn County
                    'albany': 'https://www.linncountyassessor.com/',
                    'lebanon': 'https://www.linncountyassessor.com/',
                    'sweet home': 'https://www.linncountyassessor.com/',
                    
                    // Douglas County
                    'roseburg': 'https://apps.co.douglas.or.us/onlineservices/PropertyViewer/',
                    'sutherlin': 'https://apps.co.douglas.or.us/onlineservices/PropertyViewer/',
                    'winston': 'https://apps.co.douglas.or.us/onlineservices/PropertyViewer/',
                };
                
                // Arizona County GIS mapping
                const azCountyGIS = {
                    // Maricopa County
                    'phoenix': 'https://mcassessor.maricopa.gov/',
                    'mesa': 'https://mcassessor.maricopa.gov/',
                    'chandler': 'https://mcassessor.maricopa.gov/',
                    'scottsdale': 'https://mcassessor.maricopa.gov/',
                    'glendale': 'https://mcassessor.maricopa.gov/',
                    'tempe': 'https://mcassessor.maricopa.gov/',
                    'peoria': 'https://mcassessor.maricopa.gov/',
                    'surprise': 'https://mcassessor.maricopa.gov/',
                    'gilbert': 'https://mcassessor.maricopa.gov/',
                    'avondale': 'https://mcassessor.maricopa.gov/',
                    'goodyear': 'https://mcassessor.maricopa.gov/',
                    'buckeye': 'https://mcassessor.maricopa.gov/',
                    'el mirage': 'https://mcassessor.maricopa.gov/',
                    'queen creek': 'https://mcassessor.maricopa.gov/',
                    'cave creek': 'https://mcassessor.maricopa.gov/',
                    'fountain hills': 'https://mcassessor.maricopa.gov/',
                    'paradise valley': 'https://mcassessor.maricopa.gov/',
                    
                    // Pima County
                    'tucson': 'https://www.asr.pima.gov/assessor/',
                    'oro valley': 'https://www.asr.pima.gov/assessor/',
                    'marana': 'https://www.asr.pima.gov/assessor/',
                    'sahuarita': 'https://www.asr.pima.gov/assessor/',
                    
                    // Pinal County
                    'casa grande': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    'apache junction': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    'coolidge': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    'eloy': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    'florence': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    'maricopa': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    
                    // Yavapai County
                    'prescott': 'https://gis.yavapaiaz.gov/v4/',
                    'prescott valley': 'https://gis.yavapaiaz.gov/v4/',
                    'chino valley': 'https://gis.yavapaiaz.gov/v4/',
                    'cottonwood': 'https://gis.yavapaiaz.gov/v4/',
                    'sedona': 'https://gis.yavapaiaz.gov/v4/',
                    
                    // Coconino County
                    'flagstaff': 'https://www.coconino.az.gov/119/Assessor',
                    'williams': 'https://www.coconino.az.gov/119/Assessor',
                    
                    // Mohave County
                    'lake havasu city': 'https://www.mohave.gov/departments/assessor/assessor-search/',
                    'kingman': 'https://www.mohave.gov/departments/assessor/assessor-search/',
                    'bullhead city': 'https://www.mohave.gov/departments/assessor/assessor-search/',
                    
                    // Yuma County
                    'yuma': 'https://www.yumacountyaz.gov/government/assessor',
                    'san luis': 'https://www.yumacountyaz.gov/government/assessor',
                    'somerton': 'https://www.yumacountyaz.gov/government/assessor',
                };

                // Normalize city to lowercase for lookup (user might type "Portland" but key is "portland")
                const cityLower = (city || '').toLowerCase().trim();

                // Check if we have a direct GIS link for this city
                if (state === 'WA' && waCountyGIS[cityLower]) {
                    window.open(waCountyGIS[cityLower], '_blank');
                    return;
                }

                if (state === 'OR' && orCountyGIS[cityLower]) {
                    // Portland Maps doesn't support URL-based search, just open homepage
                    // User can enter address in the search box at top of page
                    window.open(orCountyGIS[cityLower], '_blank');
                    return;
                }

                if (state === 'AZ' && azCountyGIS[cityLower]) {
                    window.open(azCountyGIS[cityLower], '_blank');
                    return;
                }
                
                // Detect county and show it to user
                const county = this.getCountyFromCity(city, state);
                
                // Fallback: Try to open general county assessor search
                const searchAddress = encodeURIComponent(`${address} ${city} ${state} ${zip}`);
                let message = '';
                
                if (county) {
                    message = `üìç County Detected: ${county} County, ${state}\n\nOpening county assessor search...`;
                    console.log(`County detected: ${county} County, ${state}`);
                } else {
                    message = `üìç City/County: ${city}, ${state}\n\nOpening general assessor search...`;
                }
                
                // Show notification
                const toast = document.createElement('div');
                toast.textContent = message.split('\n')[0];
                toast.style.cssText = 'position:fixed;top:80px;right:20px;background:#007AFF;color:white;padding:12px 20px;border-radius:8px;font-size:14px;z-index:9999;';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
                
                if (state === 'WA') {
                    window.open(`https://www.dor.wa.gov/find-taxes-rates/property-tax/county-assessors`, '_blank');
                } else if (state === 'OR') {
                    window.open(`https://www.oregon.gov/dor/forms/pages/county-assessor.aspx`, '_blank');
                } else if (state === 'AZ') {
                    window.open(`https://azdor.gov/property-appraisal/county-assessors-information`, '_blank');
                } else {
                    // Generic Google search for county GIS
                    window.open(`https://www.google.com/search?q=${city}+${state}+county+gis+assessor+property+search`, '_blank');
                }
            },

            // === NOTES & EXPORT ===
            getNamePronunciation(data) {
                const first = (data.firstNamePhonetic || '').trim();
                const last = (data.lastNamePhonetic || '').trim();

                if (!first && !last) return '';
                if (first && last) return `First: ${first} | Last: ${last}`;
                if (first) return `First: ${first}`;
                return `Last: ${last}`;
            },

            updateNamePronunciationUI() {
                const firstEl = document.getElementById('firstNamePhonetic');
                const lastEl = document.getElementById('lastNamePhonetic');
                if (firstEl) firstEl.value = (this.data.firstNamePhonetic || '').trim();
                if (lastEl) lastEl.value = (this.data.lastNamePhonetic || '').trim();
                // Update button style to show pronunciation exists
                const btnFirst = document.getElementById('pronBtnFirst');
                const btnLast = document.getElementById('pronBtnLast');
                if (btnFirst) btnFirst.classList.toggle('has-value', !!(this.data.firstNamePhonetic || '').trim());
                if (btnLast) btnLast.classList.toggle('has-value', !!(this.data.lastNamePhonetic || '').trim());
            },

            togglePronunciation(which) {
                const popup = document.getElementById(which === 'first' ? 'pronPopupFirst' : 'pronPopupLast');
                if (!popup) return;
                popup.classList.toggle('active');
                // Close the other popup
                const other = document.getElementById(which === 'first' ? 'pronPopupLast' : 'pronPopupFirst');
                if (other) other.classList.remove('active');
            },

            toggleCoApplicant() {
                const cb = document.getElementById('hasCoApplicant');
                const section = document.getElementById('coApplicantSection');
                if (!cb || !section) return;
                const show = cb.checked;
                section.classList.toggle('visible', show);
                this.data.hasCoApplicant = show ? 'yes' : '';
                this.save({});
            },

            restoreCoApplicantUI() {
                const cb = document.getElementById('hasCoApplicant');
                const section = document.getElementById('coApplicantSection');
                if (!cb || !section) return;
                const show = this.data.hasCoApplicant === 'yes';
                cb.checked = show;
                section.classList.toggle('visible', show);
            },

            async generateNamePronunciation() {
                const firstName = (this.data.firstName || '').trim();
                const lastName = (this.data.lastName || '').trim();
                if (!firstName && !lastName) {
                    this.toast('‚ö†Ô∏è Enter a first or last name first.');
                    return;
                }

                const btns = document.querySelectorAll('.popup-btn-gen');
                btns.forEach(b => { b.disabled = true; b.textContent = '...'; });

                try {
                    // Try 1: Server API (works on Vercel / local server)
                    let payload = null;
                    try {
                        const res = await fetch('/api/name-phonetics', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ firstName, lastName })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            if (!data.error) payload = data;
                        }
                    } catch (_) { /* server unavailable ‚Äì fall through */ }

                    // Try 2: Direct Gemini API (works in Tauri / offline / no server)
                    if (!payload) {
                        const key = await this._getGeminiKey();

                        if (key) {
                            const prompt =
                                'Generate phonetic pronunciations for the provided name(s).\n' +
                                'Rules:\n' +
                                '- Return plain ASCII with syllable breaks using hyphens.\n' +
                                '- Use uppercase for the stressed syllable.\n' +
                                '- If unsure, provide a best-effort guess.\n' +
                                'Return ONLY JSON: {"firstNamePhonetic":"","lastNamePhonetic":""}\n' +
                                `First Name: ${firstName}\nLast Name: ${lastName}`;

                            const geminiRes = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{ role: 'user', parts: [{ text: prompt }] }],
                                        generationConfig: {
                                            temperature: 0.2,
                                            maxOutputTokens: 256,
                                            response_mime_type: 'application/json',
                                            response_schema: {
                                                type: 'object',
                                                properties: {
                                                    firstNamePhonetic: { type: 'string' },
                                                    lastNamePhonetic: { type: 'string' }
                                                },
                                                required: ['firstNamePhonetic', 'lastNamePhonetic']
                                            }
                                        }
                                    })
                                }
                            );

                            if (geminiRes.ok) {
                                const geminiData = await geminiRes.json();
                                const text = geminiData?.candidates?.[0]?.content?.parts?.[0]?.text;
                                if (text) payload = JSON.parse(text);
                            }
                        }
                    }

                    if (!payload) throw new Error('No API available');

                    this.data.firstNamePhonetic = payload.firstNamePhonetic || '';
                    this.data.lastNamePhonetic = payload.lastNamePhonetic || '';
                    this.updateNamePronunciationUI();
                    this.save();
                    this.toast('‚úì Pronunciation added');
                    // Close popups after generating
                    document.querySelectorAll('.pronunciation-popup').forEach(p => p.classList.remove('active'));
                } catch (err) {
                    console.error('[Pronunciation] Failed:', err);
                    this.toast('‚ö†Ô∏è Unable to generate pronunciation right now');
                } finally {
                    btns.forEach(b => { b.disabled = false; b.textContent = 'Generate'; });
                }
            },

            formatDateDisplay(value) {
                if (!value) return '';
                const d = new Date(value);
                if (Number.isNaN(d.getTime())) return value;
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const yyyy = String(d.getFullYear());
                return `${mm}-${dd}-${yyyy}`;
            },

            resolveDriverName(driverId, driversArr) {
                if (!driverId) return '';
                const drivers = driversArr || this.drivers || [];
                const driver = drivers.find(d => d.id === driverId);
                return driver ? [driver.firstName, driver.lastName].filter(Boolean).join(' ') : '';
            },

            getNotesForData(data) {
                const fmt = (v) => this.formatDateDisplay(v);
                const drivers = (data.drivers && data.drivers.length) ? data.drivers : (this.drivers || []);
                const vehicles = (data.vehicles && data.vehicles.length) ? data.vehicles : (this.vehicles || []);
                const qType = data.qType || 'both';
                const includeHome = qType === 'home' || qType === 'both';
                const includeAuto = qType === 'auto' || qType === 'both';

                let notes = `
=== CLIENT PROFILE ===
Name: ${data.firstName || ''} ${data.lastName || ''}
Email: ${data.email || ''}
Phone: ${data.phone || ''}
DOB: ${fmt(data.dob)}
Marital Status: ${data.maritalStatus || ''}
Education: ${data.education || ''}
Occupation: ${data.industry || ''}`;

                // Co-Applicant
                if (data.hasCoApplicant === 'yes' && (data.coFirstName || data.coLastName)) {
                    notes += `

=== CO-APPLICANT ===
Name: ${data.coFirstName || ''} ${data.coLastName || ''}
DOB: ${fmt(data.coDob)}
Gender: ${data.coGender || ''}
Email: ${data.coEmail || ''}
Phone: ${data.coPhone || ''}
Relationship: ${data.coRelationship || ''}`;
                }

                // Property (home + both)
                if (includeHome) {
                    notes += `

=== DWELLING SPECIFICATIONS ===
Address: ${data.addrStreet || ''}, ${data.addrCity || ''}, ${data.addrState || ''} ${data.addrZip || ''}
Dwelling Type: ${data.dwellingType || ''} (${data.dwellingUsage || ''})
Year Built: ${data.yrBuilt || ''} | Square Feet: ${data.sqFt || ''}
Stories: ${data.numStories || ''} | Bathrooms: ${data.fullBaths || ''}
Construction: ${data.constructionStyle || ''} | Walls: ${data.exteriorWalls || ''}
Foundation: ${data.foundation || ''}
Roof: ${data.roofType || ''} (${data.roofShape || ''}) - Updated: ${data.roofYr || ''}
Heating: ${data.heatingType || ''} (Updated: ${data.heatYr || ''})
Cooling: ${data.cooling || ''}
Plumbing Updated: ${data.plumbYr || ''}
Electrical Updated: ${data.elecYr || ''}
Fire Station: ${data.fireStationDist || ''} miles | Hydrant: ${data.fireHydrantFeet || ''} feet
Protection Class: ${data.protectionClass || ''}
Burglar Alarm: ${data.burglarAlarm || ''}
Fire Alarm: ${data.fireAlarm || ''}
Sprinklers: ${data.sprinklers || ''}`;
                }

                // Drivers & Vehicles (auto + both)
                if (includeAuto) {
                    notes += `

=== DRIVERS & VEHICLES ===
${drivers.map((d, i) => `Driver ${i + 1}: ${[d.firstName, d.lastName].filter(Boolean).join(' ')} | Relationship: ${d.relationship || ''} | Occupation: ${d.occupation || ''} | DOB: ${fmt(d.dob)} | DL: ${(d.dlNum || '').toUpperCase()} (${(d.dlState || '').toUpperCase()})`).join('\n')}
${vehicles.map((v, i) => { const desc = [v.year, v.make, v.model].filter(Boolean).join(' '); return `Vehicle ${i + 1}: ${desc || 'Unknown'} | VIN: ${v.vin || ''} | Use: ${v.use || ''} | Miles: ${v.miles || ''} | Primary Driver: ${this.resolveDriverName(v.primaryDriver, drivers)}`; }).join('\n')}
Vehicle (Legacy): ${data.vehDesc || ''}
VIN (Legacy): ${data.vin || ''}
Driver's License: ${(data.dlNum || '').toUpperCase()} (${(data.dlState || '').toUpperCase()})
Usage: ${data.use || ''} | Annual Miles: ${data.miles || ''}
Commute Distance: ${data.commuteDist || ''} miles
Ride Sharing: ${data.rideSharing || 'No'}
Telematics: ${data.telematics || ''}`;
                }

                notes += `

=== POLICY HISTORY & RISK ===
${includeAuto ? `Current Liability: ${data.liabilityLimits || ''}\n` : ''}Deductibles: ${includeHome ? `Home ${data.homeDeductible || ''}` : ''}${includeHome && includeAuto ? ' / ' : ''}${includeAuto ? `Auto ${data.autoDeductible || ''}` : ''}
${includeHome ? `Home Prior Carrier: ${data.homePriorCarrier || data.priorCarrier || ''} (${data.homePriorYears || data.priorYears || ''} years)\nHome Prior Expiration: ${fmt(data.homePriorExp || data.priorExp)}\n` : ''}${includeAuto ? `Auto Prior Carrier: ${data.priorCarrier || ''} (${data.priorYears || ''} years)\nAuto Prior Expiration: ${fmt(data.priorExp)}\n` : ''}Effective Date: ${fmt(data.effectiveDate)}
${includeAuto ? `Accidents: ${data.accidents || 'None'}\nViolations: ${data.violations || 'None'}\nStudent GPA: ${data.studentGPA || 'N/A'}\n` : ''}${includeHome ? `Pool: ${data.pool || 'No'}\nTrampoline: ${data.trampoline || 'No'}\nWood Stove: ${data.woodStove && data.woodStove !== 'None' ? data.woodStove : 'None'}\nDog: ${data.dogInfo || 'None'}\nBusiness on Property: ${data.businessOnProperty || 'No'}` : ''}

=== ADDITIONAL INFORMATION ===
${includeHome ? `Mortgagee: ${data.mortgagee || ''}\n` : ''}Additional Insureds: ${data.additionalInsureds || 'None'}
${includeHome ? `Purchase Date: ${fmt(data.purchaseDate)}\nKitchen/Bath Quality: ${data.kitchenQuality || ''}\n` : ''}Best Contact Time: ${data.contactTime || ''}
Referral Source: ${data.referralSource || ''}
TCPA Consent: ${data.tcpaConsent ? 'Yes' : 'No'}`;

                return notes.trim();
            },

            getNotes() {
                return this.getNotesForData(this.data);
            },

            copyNotes() {
                navigator.clipboard.writeText(this.getNotes());
                this.toast('üìã Copied to Clipboard!');
            },

            async exportPDF() {
                const result = await this.buildPDF(this.data);
                this.downloadBlob(result.blob, result.filename);
                this.logExport('PDF', result.filename);
                this.toast('‚úì PDF downloaded successfully');
            },

            exportText() {
                const result = this.buildText(this.data);
                this.downloadFile(result.content, result.filename, result.mime);
                this.logExport('Text', result.filename);
                this.toast('üìù Text summary downloaded');
            },

            async buildPDF(data) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageW = doc.internal.pageSize.getWidth();
                const pageH = doc.internal.pageSize.getHeight();
                const margin = 14;
                const contentW = pageW - margin * 2;
                let pageNum = 1;

                // Helper: get value from data, falling back to the current DOM
                // element value. This ensures fields with HTML default values
                // (e.g. numStories="1", bedrooms="3") appear even if the user
                // never manually changed them.
                const v = (key) => {
                    if (data[key] !== undefined && data[key] !== null && String(data[key]).trim() !== '') {
                        return String(data[key]);
                    }
                    const el = document.getElementById(key);
                    if (el) {
                        const val = el.type === 'checkbox' ? (el.checked ? 'Yes' : '') : (el.value || '');
                        return val.trim();
                    }
                    return '';
                };

                // ‚îÄ‚îÄ‚îÄ Color palette ‚îÄ‚îÄ‚îÄ
                const C = {
                    brand:    [0, 102, 204],     // Professional blue
                    brandLt:  [230, 241, 252],   // Light blue tint
                    dark:     [33, 37, 41],       // Near-black text
                    mid:      [108, 117, 125],    // Secondary text
                    light:    [206, 212, 218],    // Borders
                    stripe:   [245, 247, 250],    // Alternating rows
                    white:    [255, 255, 255],
                    accent:   [40, 167, 69],      // Green accent
                    warn:     [220, 53, 69],      // Red accent
                };

                const formatDate = (value) => {
                    if (!value) return '';
                    const d = new Date(value);
                    if (Number.isNaN(d.getTime())) return value;
                    return `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}/${d.getFullYear()}`;
                };
                const formatCurrency = (v) => {
                    if (!v) return '';
                    const num = parseFloat(String(v).replace(/[$,\s]/g, ''));
                    if (isNaN(num)) return v;
                    return '$' + num.toLocaleString('en-US');
                };
                const formatDateTime = (value) => {
                    const d = value instanceof Date ? value : new Date(value);
                    if (Number.isNaN(d.getTime())) return '';
                    let hours = d.getHours();
                    const minutes = String(d.getMinutes()).padStart(2, '0');
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12 || 12;
                    return `${formatDate(d)} ${hours}:${minutes} ${ampm}`;
                };

                // ‚îÄ‚îÄ‚îÄ Layout helpers ‚îÄ‚îÄ‚îÄ
                let y = 0;

                const checkPage = (needed = 20) => {
                    if (y + needed > pageH - 20) {
                        doc.addPage();
                        pageNum++;
                        y = 20;
                        return true;
                    }
                    return false;
                };

                const drawFooter = () => {
                    const total = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= total; i++) {
                        doc.setPage(i);
                        doc.setFontSize(7);
                        doc.setTextColor(...C.mid);
                        doc.text(`Page ${i} of ${total}`, pageW / 2, pageH - 8, { align: 'center' });
                        doc.setDrawColor(...C.light);
                        doc.setLineWidth(0.3);
                        doc.line(margin, pageH - 14, pageW - margin, pageH - 14);
                        doc.text('Generated by Altech Insurance Tools', margin, pageH - 8);
                        doc.text(formatDateTime(new Date()), pageW - margin, pageH - 8, { align: 'right' });
                    }
                };

                const sectionHeader = (title) => {
                    checkPage(16);
                    doc.setFillColor(...C.brand);
                    doc.roundedRect(margin, y, contentW, 7.5, 1.5, 1.5, 'F');
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(...C.white);
                    doc.text(title.toUpperCase(), margin + 4, y + 5.3);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(...C.dark);
                    y += 10;
                };

                // Key-value rows in a two-column table style
                const kvTable = (fields, cols = 2) => {
                    const filtered = fields.filter(([, v]) => v && String(v).trim());
                    if (!filtered.length) return;
                    const colW = contentW / cols;
                    const rowH = 6;
                    let rowIdx = 0;
                    let col = 0;
                    const startY = y;

                    filtered.forEach(([label, value], i) => {
                        if (col === 0) checkPage(rowH + 2);
                        const cellX = margin + col * colW;
                        const cellY = y;

                        // Alternating stripe (per visual row, not per item)
                        if (col === 0 && rowIdx % 2 === 0) {
                            doc.setFillColor(...C.stripe);
                            doc.rect(margin, cellY - 1, contentW, rowH, 'F');
                        }

                        // Label
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(...C.mid);
                        doc.text(label, cellX + 2, cellY + 3.5);

                        // Value
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(...C.dark);
                        const valX = cellX + colW * 0.45;
                        const maxValW = colW * 0.52;
                        const valLines = doc.splitTextToSize(String(value), maxValW);
                        doc.text(valLines[0] || '', valX, cellY + 3.5);

                        col++;
                        if (col >= cols) {
                            col = 0;
                            y += rowH;
                            rowIdx++;
                        }
                    });
                    if (col > 0) { y += rowH; }

                    // Bottom border line
                    doc.setDrawColor(...C.light);
                    doc.setLineWidth(0.2);
                    doc.line(margin, y, margin + contentW, y);
                    y += 5;
                };

                // Single-column table for longer content (drivers/vehicles)
                const detailTable = (fields) => {
                    const filtered = fields.filter(([, v]) => v && String(v).trim());
                    if (!filtered.length) return;
                    const rowH = 5.5;
                    const labelW = 50;

                    filtered.forEach(([label, value], i) => {
                        checkPage(rowH + 2);
                        const isHeader = !label.startsWith('  ');

                        if (isHeader) {
                            // Driver/Vehicle heading row
                            if (i > 0) y += 2;
                            doc.setFillColor(...C.brandLt);
                            doc.rect(margin, y - 1, contentW, rowH + 1, 'F');
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'bold');
                            doc.setTextColor(...C.brand);
                            doc.text(label, margin + 3, y + 3);
                            doc.text(String(value), margin + labelW, y + 3);
                            doc.setFont(undefined, 'normal');
                            doc.setTextColor(...C.dark);
                        } else {
                            // Detail sub-row
                            if (i % 2 === 0) {
                                doc.setFillColor(...C.stripe);
                                doc.rect(margin, y - 1, contentW, rowH, 'F');
                            }
                            doc.setFontSize(8);
                            doc.setFont(undefined, 'normal');
                            doc.setTextColor(...C.mid);
                            doc.text(label.trim(), margin + 8, y + 3);
                            doc.setTextColor(...C.dark);
                            doc.text(String(value), margin + labelW, y + 3);
                        }
                        y += rowH;
                    });
                    doc.setDrawColor(...C.light);
                    doc.setLineWidth(0.2);
                    doc.line(margin, y, margin + contentW, y);
                    y += 5;
                };

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                //  PAGE 1: HEADER
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const address = this.getFullAddress(data);
                const [mapImages, logoImg] = await Promise.all([
                    this.getMapImages(address),
                    this.fetchImageDataUrl('Resources/altech-logo.png')
                ]);
                const prefix = v('prefix');
                const suffix = v('suffix');
                const nameParts = [prefix, data.firstName || '', data.lastName || '', suffix].filter(Boolean);
                const clientName = nameParts.join(' ') || 'Client';

                // Top accent bar
                doc.setFillColor(...C.brand);
                doc.rect(0, 0, pageW, 3, 'F');
                y = 10;

                // Logo + title header row
                const logoSize = 18;
                let headerTextX = margin;
                if (logoImg?.dataUrl) {
                    doc.addImage(logoImg.dataUrl, logoImg.format, margin, y - 2, logoSize, logoSize);
                    headerTextX = margin + logoSize + 4;
                }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(...C.dark);
                doc.text('Altech Insurance', headerTextX, y + 4);
                doc.setFontSize(7.5);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(...C.mid);
                doc.text('Insurance Application Summary', headerTextX, y + 9.5);

                // Document ref & date (right-aligned)
                const docRef = `APP-${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}${String(new Date().getDate()).padStart(2,'0')}-${String(Math.floor(Math.random()*9000)+1000)}`;
                doc.setFontSize(7);
                doc.setTextColor(...C.mid);
                doc.text(docRef, pageW - margin, y + 4, { align: 'right' });
                doc.text(formatDateTime(new Date()), pageW - margin, y + 9, { align: 'right' });
                doc.setTextColor(...C.dark);

                y += Math.max(logoSize, 12) + 4;

                // Thin rule under header
                doc.setDrawColor(...C.brand);
                doc.setLineWidth(0.5);
                doc.line(margin, y, pageW - margin, y);
                y += 5;

                // Street View banner (clean ‚Äî no overlay text)
                if (mapImages?.streetView?.dataUrl) {
                    const bannerH = 46;
                    doc.addImage(mapImages.streetView.dataUrl, mapImages.streetView.format, margin, y, contentW, bannerH);
                    doc.setDrawColor(...C.light);
                    doc.setLineWidth(0.3);
                    doc.rect(margin, y, contentW, bannerH, 'S');
                    y += bannerH + 2;
                }

                // Client info strip
                doc.setFillColor(...C.brandLt);
                doc.rect(margin, y, contentW, 13, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(...C.brand);
                doc.text(clientName, margin + 3, y + 5.5);
                doc.setFontSize(7.5);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(...C.mid);
                doc.text(address || '', margin + 3, y + 10.5);
                doc.setTextColor(...C.dark);
                y += 16;

                // Satellite thumbnail
                if (mapImages?.satellite?.dataUrl) {
                    const satX = pageW - margin - 30;
                    doc.addImage(mapImages.satellite.dataUrl, mapImages.satellite.format, satX, y, 30, 24);
                    doc.setDrawColor(...C.light);
                    doc.setLineWidth(0.3);
                    doc.rect(satX, y, 30, 24, 'S');
                    doc.setFontSize(5.5);
                    doc.setTextColor(...C.brand);
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address || '')}`;
                    doc.textWithLink('View on Maps', satX + 15, y + 27, { url: mapUrl, align: 'center' });
                    doc.setTextColor(...C.dark);
                }

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                //  DATA SECTIONS
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const quoteType = (data.qType || '').toLowerCase();
                const showHome = quoteType === 'home' || quoteType === 'both' || !quoteType;
                const showAuto = quoteType === 'auto' || quoteType === 'both' || !quoteType;
                const drivers = (data.drivers && data.drivers.length) ? data.drivers : (this.drivers || []);
                const vehicles = (data.vehicles && data.vehicles.length) ? data.vehicles : (this.vehicles || []);

                // ‚îÄ‚îÄ Applicant ‚îÄ‚îÄ
                sectionHeader('Applicant');
                kvTable([
                    ['Full Name', clientName],
                    ['Date of Birth', formatDate(v('dob'))],
                    ['Gender', v('gender') === 'M' ? 'Male' : v('gender') === 'F' ? 'Female' : v('gender')],
                    ['Marital Status', v('maritalStatus')],
                    ['Phone', v('phone')],
                    ['Email', v('email')],
                    ['Education', v('education')],
                    ['Industry', v('industry')],
                    ['Occupation', v('occupation')],
                    ['Quote Type', quoteType === 'home' ? 'Home Only' : quoteType === 'auto' ? 'Auto Only' : quoteType === 'both' ? 'Home & Auto' : quoteType],
                    ['Pronunciation', this.getNamePronunciation(data)],
                ]);

                // ‚îÄ‚îÄ Co-Applicant (if provided) ‚îÄ‚îÄ
                if (data.hasCoApplicant === 'yes' && (data.coFirstName || data.coLastName)) {
                    sectionHeader('Co-Applicant / Spouse');
                    kvTable([
                        ['Full Name', `${data.coFirstName || ''} ${data.coLastName || ''}`.trim()],
                        ['Date of Birth', formatDate(v('coDob'))],
                        ['Gender', v('coGender') === 'M' ? 'Male' : v('coGender') === 'F' ? 'Female' : v('coGender')],
                        ['Email', v('coEmail')],
                        ['Phone', v('coPhone')],
                        ['Relationship', v('coRelationship')],
                    ]);
                }

                // ‚îÄ‚îÄ Property Address ‚îÄ‚îÄ
                sectionHeader('Property Address');
                kvTable([
                    ['Street Address', v('addrStreet')],
                    ['City', v('addrCity')],
                    ['State', v('addrState')],
                    ['ZIP Code', v('addrZip')],
                    ['County', this.getCountyFromCity(data.addrCity, data.addrState) || ''],
                    ['Years at Address', v('yearsAtAddress')],
                ]);

                if (showHome) {
                    // ‚îÄ‚îÄ Property Details ‚îÄ‚îÄ
                    sectionHeader('Property Details');
                    kvTable([
                        ['Year Built', v('yrBuilt')],
                        ['Square Footage', v('sqFt') ? Number(v('sqFt')).toLocaleString() + ' sq ft' : ''],
                        ['Lot Size', v('lotSize') ? v('lotSize') + ' acres' : ''],
                        ['Dwelling Type', v('dwellingType')],
                        ['Dwelling Use', v('dwellingUsage')],
                        ['Occupancy', v('occupancyType')],
                        ['Stories', v('numStories')],
                        ['Occupants', v('numOccupants')],
                        ['Bedrooms', v('bedrooms')],
                        ['Full Baths', v('fullBaths')],
                        ['Half Baths', v('halfBaths')],
                        ['Construction', v('constructionStyle')],
                        ['Exterior Walls', v('exteriorWalls')],
                        ['Foundation', v('foundation')],
                        ['Garage Type', v('garageType')],
                        ['Garage Spaces', v('garageSpaces')],
                        ['Kitchen/Bath Quality', v('kitchenQuality')],
                        ['Flooring', v('flooring')],
                        ['Fireplaces', v('numFireplaces')],
                        ['Purchase Date', formatDate(v('purchaseDate'))],
                    ]);

                    // ‚îÄ‚îÄ Building Systems ‚îÄ‚îÄ
                    sectionHeader('Building Systems');
                    kvTable([
                        ['Roof Type', v('roofType')],
                        ['Roof Shape', v('roofShape')],
                        ['Roof Updated', v('roofYr')],
                        ['Heating Type', v('heatingType')],
                        ['Heating Updated', v('heatYr')],
                        ['Cooling', v('cooling')],
                        ['Plumbing Updated', v('plumbYr')],
                        ['Electrical Updated', v('elecYr')],
                        ['Sewer', v('sewer')],
                        ['Water Source', v('waterSource')],
                    ]);

                    // ‚îÄ‚îÄ Risk & Protection ‚îÄ‚îÄ
                    sectionHeader('Risk & Protection');
                    kvTable([
                        ['Burglar Alarm', v('burglarAlarm')],
                        ['Fire Alarm', v('fireAlarm')],
                        ['Smoke Detector', v('smokeDetector')],
                        ['Sprinklers', v('sprinklers')],
                        ['Swimming Pool', v('pool') || 'No'],
                        ['Trampoline', v('trampoline') || 'No'],
                        ['Wood Stove', v('woodStove') && v('woodStove') !== 'None' ? v('woodStove') : 'None'],
                        ['Secondary Heating', v('secondaryHeating')],
                        ['Dog on Premises', data.dogInfo || 'None'],
                        ['Business on Property', data.businessOnProperty || 'No'],
                        ['Fire Station (mi)', v('fireStationDist')],
                        ['Fire Hydrant (ft)', v('fireHydrantFeet')],
                        ['Tidal Water (ft)', v('tidalWaterDist')],
                        ['Protection Class', v('protectionClass')],
                    ]);

                    // ‚îÄ‚îÄ Home Coverage ‚îÄ‚îÄ
                    sectionHeader('Home Coverage');
                    kvTable([
                        ['Policy Type', v('homePolicyType')],
                        ['Dwelling Coverage', formatCurrency(v('dwellingCoverage'))],
                        ['Personal Liability', formatCurrency(v('personalLiability'))],
                        ['Medical Payments', formatCurrency(v('medicalPayments'))],
                        ['Deductible', formatCurrency(v('homeDeductible'))],
                        ['Wind/Hail Ded.', formatCurrency(v('windDeductible'))],
                        ['Mortgagee', v('mortgagee')],
                        ['Increased Repl. Cost', v('increasedReplacementCost')],
                        ['Ordinance or Law', v('ordinanceOrLaw')],
                        ['Water Backup', v('waterBackup')],
                        ['Loss Assessment', formatCurrency(v('lossAssessment'))],
                        ['Equipment Breakdown', v('equipmentBreakdown')],
                        ['Service Line', v('serviceLine')],
                        ['Animal Liability', formatCurrency(v('animalLiability'))],
                        ['Earthquake Coverage', v('earthquakeCoverage')],
                    ]);
                }

                if (showAuto) {
                    // ‚îÄ‚îÄ Drivers ‚îÄ‚îÄ
                    if (drivers.length) {
                        sectionHeader('Drivers');
                        const driverRows = drivers.map((d, i) => {
                            const name = [d.firstName, d.lastName].filter(Boolean).join(' ');
                            return [
                                [`Driver ${i + 1}`, name || 'Unknown'],
                                ['  Date of Birth', formatDate(d.dob || '')],
                                ['  Gender', d.gender === 'M' ? 'Male' : d.gender === 'F' ? 'Female' : (d.gender || '')],
                                ['  Marital Status', d.maritalStatus || ''],
                                ['  Relationship', d.relationship || ''],
                                ['  Education', d.education || ''],
                                ['  Occupation', d.occupation || ''],
                                ['  License #', (d.dlNum || '').toUpperCase()],
                                ['  License State', (d.dlState || '').toUpperCase()],
                            ];
                        }).flat();
                        detailTable(driverRows);
                    }

                    // ‚îÄ‚îÄ Vehicles ‚îÄ‚îÄ
                    if (vehicles.length) {
                        sectionHeader('Vehicles');
                        const vehicleRows = vehicles.map((v, i) => {
                            const vehDesc = [v.year, v.make, v.model].filter(Boolean).join(' ');
                            const driverDisplay = this.resolveDriverName(v.primaryDriver, drivers);
                            return [
                                [`Vehicle ${i + 1}`, vehDesc || 'Unknown'],
                                ['  VIN', v.vin || ''],
                                ['  Usage', v.use || ''],
                                ['  Annual Miles', v.miles ? Number(v.miles).toLocaleString() : ''],
                                ['  Primary Driver', driverDisplay],
                            ];
                        }).flat();
                        detailTable(vehicleRows);
                    }

                    // Legacy single-vehicle (if no multi-vehicle data)
                    if (!vehicles.length && (data.vehDesc || data.vin)) {
                        sectionHeader('Vehicle');
                        kvTable([
                            ['Vehicle', data.vehDesc || ''],
                            ['VIN', data.vin || ''],
                            ['Usage', data.use || ''],
                            ['Annual Miles', data.miles || ''],
                        ]);
                    }

                    // ‚îÄ‚îÄ Auto Coverage ‚îÄ‚îÄ
                    sectionHeader('Auto Coverage');
                    kvTable([
                        ['Auto Policy Type', v('autoPolicyType')],
                        ['Residence Is', v('residenceIs')],
                        ['Liability Limits', v('liabilityLimits')],
                        ['Property Damage', v('pdLimit')],
                        ['Med Pay (Auto)', formatCurrency(v('medPayments'))],
                        ['UM Limits', v('umLimits')],
                        ['UIM Limits', v('uimLimits')],
                        ['UMPD Limit', v('umpdLimit')],
                        ['Comprehensive Ded.', formatCurrency(v('compDeductible'))],
                        ['Collision Ded.', formatCurrency(v('autoDeductible'))],
                        ['Rental Reimburse.', v('rentalDeductible')],
                        ['Towing/Roadside', v('towingDeductible')],
                        ['Student GPA', v('studentGPA')],
                    ]);
                }

                // ‚îÄ‚îÄ Policy & Prior Insurance ‚îÄ‚îÄ
                sectionHeader('Policy & Prior Insurance');
                const pdfPriorRows = [
                    ['Policy Term', v('policyTerm')],
                    ['Effective Date', formatDate(v('effectiveDate'))],
                ];
                if (showHome) {
                    const hCarrier = v('homePriorCarrier') || v('priorCarrier');
                    pdfPriorRows.push(
                        ['Home Prior Carrier', hCarrier],
                        ['Home Prior Term', v('homePriorPolicyTerm') || v('priorPolicyTerm')],
                        ['Home Yrs w/ Prior', v('homePriorYears') || v('priorYears')],
                        ['Home Prior Exp.', formatDate(v('homePriorExp') || v('priorExp'))]
                    );
                }
                if (showAuto) {
                    pdfPriorRows.push(
                        ['Auto Prior Carrier', v('priorCarrier')],
                        ['Auto Prior Term', v('priorPolicyTerm')],
                        ['Auto Yrs w/ Prior', v('priorYears')],
                        ['Auto Prior Exp.', formatDate(v('priorExp'))]
                    );
                }
                pdfPriorRows.push(
                    ['Continuous Coverage', v('continuousCoverage')],
                    ['Accidents', v('accidents')],
                    ['Violations', v('violations')]
                );
                kvTable(pdfPriorRows);

                // ‚îÄ‚îÄ Additional Information ‚îÄ‚îÄ
                sectionHeader('Additional Information');
                kvTable([
                    ['Additional Insureds', v('additionalInsureds')],
                    ['Best Contact Time', v('contactTime')],
                    ['Contact Method', v('contactMethod')],
                    ['Referral Source', v('referralSource')],
                    ['TCPA Consent', data.tcpaConsent ? 'Yes' : 'No'],
                ], 2);

                // ‚îÄ‚îÄ‚îÄ Footer on every page ‚îÄ‚îÄ‚îÄ
                drawFooter();

                const fileName = `Insurance_Application_${data.lastName || 'Client'}_${new Date().toISOString().split('T')[0]}.pdf`;
                return { blob: doc.output('blob'), filename: fileName };
            },

            buildText(data) {
                const content = this.getNotesForData(data);
                const fileName = `Insurance_Application_${data.lastName || 'Client'}_${new Date().toISOString().split('T')[0]}.txt`;
                return { content, filename: fileName, mime: 'text/plain;charset=utf-8' };
            },

            exportCSV() {
                const result = this.buildCSV(this.data);
                this.downloadFile(result.content, result.filename, result.mime);
                this.logExport('CSV', result.filename);
                this.toast('üì• CSV Generated!');
            },

            buildCSV(data) {
                const h = this.getCSVHeaders();
                const flatNotes = this.getNotesForData(data).replace(/\n/g, ' | ');
                const driversSummary = (data.drivers || []).map((d, i) => {
                    const name = [d.firstName, d.lastName].filter(Boolean).join(' ');
                    return `Driver ${i + 1}: ${name || 'Unknown'} (${d.occupation || 'N/A'})`;
                }).join(' | ');
                const row = [
                    data.firstName, data.lastName, data.addrStreet, data.addrCity, data.addrState, data.addrZip,
                    data.phone, data.email, data.dob, flatNotes, data.qType, driversSummary
                ].map(v => `"${v||''}"`).join(',');

                const csv = h.join(',') + "\n" + row;
                return { content: csv, filename: `Lead_${data.lastName || 'Export'}.csv`, mime: 'text/csv' };
            },

            getCSVHeaders() {
                return ["First Name","Last Name","Address Line 1","City","State Code","Zip Code","Mobile Phone","Email","Date of Birth","Notes","Quote Type","Drivers/Occupations"];
            },

            downloadCSVTemplate() {
                const headers = this.getCSVHeaders();
                const sample = [
                    'Jane','Doe','123 Main St','Seattle','WA','98101','2065551212','jane@example.com','1985-05-12','Follow up','home','Driver 1: Jane Doe (Engineer)'
                ].map(v => `"${v}"`).join(',');
                const content = `${headers.join(',')}\n${sample}`;
                this.downloadFile(content, 'Altech_Batch_Template.csv', 'text/csv');
                this.toast('üìÑ CSV template downloaded');
            },

            openBatchImport() {
                const input = document.getElementById('batchCsvInput');
                if (!input) return;
                input.value = '';
                input.click();
            },

            async handleBatchImport(file) {
                if (!file) return;
                const text = await file.text();
                const parsed = this.parseCSV(text);
                if (!parsed || !parsed.rows.length) {
                    this.toast('‚ö†Ô∏è CSV has no rows.');
                    return;
                }

                const quotes = await this.getQuotes();
                const errors = [];
                let created = 0;

                parsed.rows.forEach((row, index) => {
                    const data = this.mapCsvRowToData(parsed.headers, row);
                    if (!data.addrStreet || !data.addrCity || !data.addrState) {
                        errors.push(`Row ${index + 2}: Missing address fields`);
                        return;
                    }

                    const id = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
                    const title = this.getQuoteTitle(data);
                    quotes.unshift({
                        id,
                        title,
                        data,
                        updatedAt: new Date().toISOString(),
                        starred: false,
                        isDuplicate: false
                    });
                    created += 1;
                });

                await this.saveQuotes(quotes);
                await this.renderQuoteList();

                if (created) {
                    this.toast(`‚úÖ Imported ${created} draft${created > 1 ? 's' : ''}`);
                }
                if (errors.length) {
                    console.warn('Batch import warnings:', errors);
                    this.toast('‚ö†Ô∏è Some rows were skipped.');
                }
            },

            parseCSV(text) {
                if (!text) return { headers: [], rows: [] };
                const rows = [];
                let cur = '';
                let row = [];
                let inQuotes = false;

                for (let i = 0; i < text.length; i++) {
                    const ch = text[i];
                    const next = text[i + 1];

                    if (ch === '"') {
                        if (inQuotes && next === '"') {
                            cur += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                        continue;
                    }

                    if (ch === ',' && !inQuotes) {
                        row.push(cur);
                        cur = '';
                        continue;
                    }

                    if ((ch === '\n' || ch === '\r') && !inQuotes) {
                        if (ch === '\r' && next === '\n') i++;
                        row.push(cur);
                        cur = '';
                        if (row.some(cell => cell.trim().length)) {
                            rows.push(row);
                        }
                        row = [];
                        continue;
                    }

                    cur += ch;
                }

                if (cur.length || row.length) {
                    row.push(cur);
                    if (row.some(cell => cell.trim().length)) {
                        rows.push(row);
                    }
                }

                const headers = (rows.shift() || []).map(h => h.trim());
                return { headers, rows };
            },

            mapCsvRowToData(headers, row) {
                const data = {};
                headers.forEach((header, i) => {
                    const key = header.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const value = (row[i] || '').trim();

                    const map = {
                        firstname: 'firstName',
                        lastname: 'lastName',
                        addressline1: 'addrStreet',
                        city: 'addrCity',
                        statecode: 'addrState',
                        zipcode: 'addrZip',
                        mobilephone: 'phone',
                        email: 'email',
                        dateofbirth: 'dob',
                        notes: 'importNotes',
                        quotetype: 'qType'
                    };

                    const field = map[key];
                    if (field) data[field] = value;
                });

                if (data.addrState) data.addrState = data.addrState.toUpperCase();
                if (data.qType) {
                    const qt = data.qType.toLowerCase();
                    if (['home','auto','both'].includes(qt)) data.qType = qt;
                }
                return data;
            },

            exportCMSMTF() {
                const result = this.buildCMSMTF(this.data);
                this.downloadFile(result.content, result.filename, result.mime);
                this.logExport('CMSMTF', result.filename);
                this.toast('üì• HawkSoft File Generated!');
            },

            buildCMSMTF(data) {
                const qType = data.qType || 'both';
                const includeHome = qType === 'home' || qType === 'both';
                const includeAuto = qType === 'auto' || qType === 'both';
                
                const fields = [
                    // ‚îÄ‚îÄ Core Contact ‚îÄ‚îÄ
                    { tag: 'NAM', value: `${data.firstName || ''} ${data.lastName || ''}`.trim() },
                    { tag: 'ADD', value: data.addrStreet },
                    { tag: 'CTY', value: data.addrCity },
                    { tag: 'STA', value: data.addrState },
                    { tag: 'ZIP', value: data.addrZip },
                    { tag: 'PHN', value: data.phone ? data.phone.replace(/\D/g, '') : '' },
                    { tag: 'EML', value: data.email },
                    { tag: 'DOB', value: this.formatDateDisplay(data.dob) },
                    { tag: 'MARITAL_STATUS', value: data.maritalStatus },
                    { tag: 'EDUCATION', value: data.education },
                    { tag: 'INDUSTRY', value: data.industry },
                ];

                // ‚îÄ‚îÄ Co-Applicant ‚îÄ‚îÄ
                if (data.hasCoApplicant === 'yes' && (data.coFirstName || data.coLastName)) {
                    fields.push(
                        { tag: 'CO_NAM', value: `${data.coFirstName || ''} ${data.coLastName || ''}`.trim() },
                        { tag: 'CO_DOB', value: this.formatDateDisplay(data.coDob) },
                        { tag: 'CO_GENDER', value: data.coGender },
                        { tag: 'CO_EML', value: data.coEmail },
                        { tag: 'CO_PHN', value: data.coPhone ? data.coPhone.replace(/\D/g, '') : '' },
                        { tag: 'CO_REL', value: data.coRelationship }
                    );
                }

                // ‚îÄ‚îÄ Home/Property (only when quoting home) ‚îÄ‚îÄ
                if (includeHome) {
                    fields.push(
                        { tag: 'L1', value: data.roofYr },
                        { tag: 'L2', value: data.roofType },
                        { tag: 'L3', value: data.heatingType },
                        { tag: 'L4', value: data.heatYr },
                        { tag: 'L5', value: data.plumbYr },
                        { tag: 'L6', value: data.elecYr },
                        { tag: 'L7', value: data.pool },
                        { tag: 'L8', value: data.dogInfo },
                        { tag: 'L9', value: data.kitchenQuality },
                        { tag: 'L10', value: data.burglarAlarm },
                        { tag: 'DWELLING_TYPE', value: data.dwellingType },
                        { tag: 'DWELLING_USAGE', value: data.dwellingUsage },
                        { tag: 'YEAR_BUILT', value: data.yrBuilt },
                        { tag: 'SQ_FT', value: data.sqFt },
                        { tag: 'STORIES', value: data.numStories },
                        { tag: 'BATHROOMS', value: data.fullBaths },
                        { tag: 'CONSTRUCTION', value: data.constructionStyle },
                        { tag: 'EXTERIOR_WALLS', value: data.exteriorWalls },
                        { tag: 'FOUNDATION', value: data.foundation },
                        { tag: 'ROOF_SHAPE', value: data.roofShape },
                        { tag: 'COOLING', value: data.cooling },
                        { tag: 'FIRE_ALARM', value: data.fireAlarm },
                        { tag: 'SPRINKLERS', value: data.sprinklers },
                        { tag: 'PROTECTION_CLASS', value: data.protectionClass },
                        { tag: 'R2', value: data.trampoline },
                        { tag: 'R3', value: data.woodStove },
                        { tag: 'R4', value: data.businessOnProperty },
                        { tag: 'R5', value: this.formatDateDisplay(data.purchaseDate) },
                        { tag: 'R6', value: data.mortgagee }
                    );
                }

                // ‚îÄ‚îÄ Auto/Vehicle (only when quoting auto) ‚îÄ‚îÄ
                if (includeAuto) {
                    fields.push(
                        { tag: 'C1', value: data.liabilityLimits },
                        { tag: 'C4', value: data.accidents },
                        { tag: 'C5', value: data.violations },
                        { tag: 'C6', value: data.miles },
                        { tag: 'C7', value: data.commuteDist },
                        { tag: 'C8', value: data.rideSharing },
                        { tag: 'C9', value: data.telematics },
                        { tag: 'C10', value: data.studentGPA },
                        { tag: 'VIN', value: data.vin },
                        { tag: 'VEH', value: data.vehDesc },
                        { tag: 'DL_NUM', value: (data.dlNum || '').toUpperCase() },
                        { tag: 'DL_STATE', value: data.dlState },
                        { tag: 'VEHICLE_USE', value: data.use }
                    );
                }

                // ‚îÄ‚îÄ Prior Insurance (split by line of business) ‚îÄ‚îÄ
                if (includeAuto) {
                    fields.push(
                        { tag: 'C2', value: data.priorCarrier },
                        { tag: 'C3', value: data.priorYears }
                    );
                }
                if (includeHome) {
                    fields.push(
                        { tag: 'L_PRIOR_CARRIER', value: data.homePriorCarrier || data.priorCarrier },
                        { tag: 'L_PRIOR_YEARS', value: data.homePriorYears || data.priorYears }
                    );
                }

                // ‚îÄ‚îÄ Shared fields ‚îÄ‚îÄ
                fields.push(
                    { tag: 'R1', value: includeHome && includeAuto
                        ? `Home: ${data.homeDeductible || ''} / Auto: ${data.autoDeductible || ''}`
                        : includeHome ? data.homeDeductible : data.autoDeductible },
                    { tag: 'R7', value: data.additionalInsureds },
                    { tag: 'R8', value: data.contactTime },
                    { tag: 'R9', value: data.referralSource },
                    { tag: 'R10', value: data.tcpaConsent ? 'Yes - Consented' : 'No' }
                );

                const content = fields
                    .filter(f => f.value && f.value.toString().trim() !== '')
                    .map(f => `[${f.tag}]${f.value}`)
                    .join('\n');

                return { content, filename: `Lead_${data.lastName || 'Export'}.cmsmtf`, mime: 'text/plain;charset=utf-8' };
            },

            exportXML() {
                const result = this.buildXML(this.data);
                if (!result.ok) {
                    this.toast(result.error);
                    return;
                }
                this.downloadFile(result.content, result.filename, result.mime);
                this.logExport('XML', result.filename);
                this.toast('üì• EZLynx Auto XML File Generated!');
            },

            updateExportButtons() {
                const qType = (document.querySelector('input[name="qType"]:checked') || {}).value || 'both';
                const autoBtn = document.getElementById('ezlynx-auto-btn');
                const homeBtn = document.getElementById('ezlynx-home-btn');
                const bothBtn = document.getElementById('ezlynx-both-btn');
                if (!autoBtn || !homeBtn || !bothBtn) return;

                if (qType === 'home') {
                    autoBtn.style.display = 'none';
                    homeBtn.style.display = 'block';
                    bothBtn.style.display = 'none';
                } else if (qType === 'auto') {
                    autoBtn.style.display = 'block';
                    homeBtn.style.display = 'none';
                    bothBtn.style.display = 'none';
                } else {
                    // 'both'
                    autoBtn.style.display = 'block';
                    homeBtn.style.display = 'block';
                    bothBtn.style.display = 'block';
                }
            },

            launchEZLynxFromExport() {
                // Navigate to EZLynx Quoter tool, auto-load intake data, and launch filler
                this.openTool('ezlynx');
                // Give tool time to render, then load data and launch
                setTimeout(() => {
                    if (typeof EZLynxTool !== 'undefined') {
                        EZLynxTool.loadFromIntake();
                        // Small delay so user can see the loaded data before launching
                        setTimeout(() => {
                            EZLynxTool.launch();
                        }, 500);
                    }
                }, 300);
            },

            async exportBothXML() {
                const autoResult = this.buildXML(this.data);
                const homeResult = this.buildHomeXML(this.data);
                if (!autoResult.ok) {
                    this.toast(autoResult.error);
                    return;
                }
                if (!homeResult.ok) {
                    this.toast(homeResult.error);
                    return;
                }
                // Use JSZip to bundle both files
                if (typeof JSZip === 'undefined') {
                    // Fallback: download individually
                    this.downloadFile(autoResult.content, autoResult.filename, autoResult.mime);
                    setTimeout(() => {
                        this.downloadFile(homeResult.content, homeResult.filename, homeResult.mime);
                    }, 500);
                    this.toast('üì¶ Both XML files downloaded!');
                    return;
                }
                const zip = new JSZip();
                zip.file(autoResult.filename, autoResult.content);
                zip.file(homeResult.filename, homeResult.content);
                const lastName = this.data.lastName || 'Lead';
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${lastName}_EZLynx_Bundle.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.logExport('BothXML', `${lastName}_EZLynx_Bundle.zip`);
                this.toast('üì¶ Auto + Home XML Bundle Downloaded!');
            },

            // ‚îÄ‚îÄ‚îÄ Shared XML Export Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Used by both buildXML (auto) and buildHomeXML (home)

            _escapeXML(str) {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&apos;');
            },

            // Escape for safe HTML attribute/text content insertion
            _escapeAttr(str) {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            },

            // Shared Gemini scan schema (used by processScan + processScanFromText)
            _getScanSchema() {
                const fieldProps = {
                    // Applicant
                    prefix: { type: 'string' }, firstName: { type: 'string' }, lastName: { type: 'string' }, suffix: { type: 'string' },
                    dob: { type: 'string' }, gender: { type: 'string' }, maritalStatus: { type: 'string' },
                    phone: { type: 'string' }, email: { type: 'string' },
                    education: { type: 'string' }, occupation: { type: 'string' }, industry: { type: 'string' },
                    // Co-Applicant
                    coFirstName: { type: 'string' }, coLastName: { type: 'string' },
                    coDob: { type: 'string' }, coGender: { type: 'string' }, coEmail: { type: 'string' }, coPhone: { type: 'string' }, coRelationship: { type: 'string' },
                    // Address
                    addrStreet: { type: 'string' }, addrCity: { type: 'string' },
                    addrState: { type: 'string' }, addrZip: { type: 'string' },
                    yearsAtAddress: { type: 'string' }, county: { type: 'string' },
                    // Property
                    dwellingUsage: { type: 'string' }, occupancyType: { type: 'string' },
                    yrBuilt: { type: 'string' }, sqFt: { type: 'string' }, dwellingType: { type: 'string' },
                    roofType: { type: 'string' }, roofShape: { type: 'string' }, roofYr: { type: 'string' },
                    constructionStyle: { type: 'string' },
                    numStories: { type: 'string' }, foundation: { type: 'string' },
                    exteriorWalls: { type: 'string' }, heatingType: { type: 'string' },
                    cooling: { type: 'string' }, heatYr: { type: 'string' },
                    plumbYr: { type: 'string' }, elecYr: { type: 'string' },
                    sewer: { type: 'string' }, waterSource: { type: 'string' },
                    garageType: { type: 'string' }, garageSpaces: { type: 'string' }, lotSize: { type: 'string' },
                    numOccupants: { type: 'string' }, bedrooms: { type: 'string' },
                    fullBaths: { type: 'string' }, halfBaths: { type: 'string' },
                    kitchenQuality: { type: 'string' }, flooring: { type: 'string' },
                    numFireplaces: { type: 'string' }, purchaseDate: { type: 'string' },
                    pool: { type: 'string' }, trampoline: { type: 'string' }, dogInfo: { type: 'string' },
                    businessOnProperty: { type: 'string' }, woodStove: { type: 'string' },
                    // Safety & Protection
                    burglarAlarm: { type: 'string' }, fireAlarm: { type: 'string' },
                    sprinklers: { type: 'string' }, smokeDetector: { type: 'string' },
                    fireStationDist: { type: 'string' }, fireHydrantFeet: { type: 'string' }, protectionClass: { type: 'string' },
                    // Home Coverage
                    homePolicyType: { type: 'string' }, dwellingCoverage: { type: 'string' },
                    personalLiability: { type: 'string' }, medicalPayments: { type: 'string' },
                    homeDeductible: { type: 'string' }, windDeductible: { type: 'string' }, mortgagee: { type: 'string' },
                    // Auto / Vehicles
                    vin: { type: 'string' }, vehDesc: { type: 'string' },
                    autoPolicyType: { type: 'string' },
                    liabilityLimits: { type: 'string' }, pdLimit: { type: 'string' },
                    umLimits: { type: 'string' }, uimLimits: { type: 'string' },
                    compDeductible: { type: 'string' }, autoDeductible: { type: 'string' },
                    medPayments: { type: 'string' },
                    rentalDeductible: { type: 'string' }, towingDeductible: { type: 'string' },
                    studentGPA: { type: 'string' },
                    // Policy / Prior
                    policyNumber: { type: 'string' },
                    effectiveDate: { type: 'string' }, policyTerm: { type: 'string' },
                    priorCarrier: { type: 'string' }, priorExp: { type: 'string' },
                    priorPolicyTerm: { type: 'string' }, priorLiabilityLimits: { type: 'string' },
                    priorYears: { type: 'string' }, continuousCoverage: { type: 'string' },
                    homePriorCarrier: { type: 'string' }, homePriorExp: { type: 'string' },
                    homePriorPolicyTerm: { type: 'string' }, homePriorYears: { type: 'string' },
                    accidents: { type: 'string' }, violations: { type: 'string' },
                    // Additional
                    additionalInsureds: { type: 'string' },
                    contactTime: { type: 'string' }, referralSource: { type: 'string' },
                    additionalVehicles: { type: 'string' }, additionalDrivers: { type: 'string' },
                };
                const confProps = {};
                Object.keys(fieldProps).forEach(k => { confProps[k] = { type: 'number' }; });
                return {
                    type: 'object',
                    properties: {
                        fields: { type: 'object', properties: fieldProps },
                        confidence: { type: 'object', properties: confProps },
                        quality_issues: { type: 'array', items: { type: 'string' } }
                    },
                    required: ['fields']
                };
            },

            _mapGender(g) {
                if (g === 'M') return 'Male';
                if (g === 'F') return 'Female';
                return g || '';
            },

            _mapMaritalStatus(m) {
                const valid = ['Single','Married','Divorced','Widowed','Separated','Domestic Partner'];
                if (!m) return '';
                const match = valid.find(v => v.toLowerCase() === m.toLowerCase());
                return match || m;
            },

            _normalizeDate(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                if (Number.isNaN(d.getTime())) return '';
                const year = d.getUTCFullYear();
                if (year < 1900 || year > 2100) return '';
                return d.toISOString().split('T')[0];
            },

            _splitZip(zip) {
                const raw = (zip || '').toString().trim();
                if (!raw) return { zip5: '', zip4: '' };
                const digits = raw.replace(/[^0-9]/g, '');
                if (digits.length >= 9) {
                    return { zip5: digits.slice(0, 5), zip4: digits.slice(5, 9) };
                }
                return { zip5: digits.slice(0, 5), zip4: '' };
            },

            buildXML(data) {
                const escapeXML = this._escapeXML;
                const mapGender = this._mapGender;
                const mapMaritalStatus = this._mapMaritalStatus;
                const normalizeDate = this._normalizeDate;
                const splitZip = this._splitZip;

                const parseLimits = (value) => {
                    if (!value) return { bi: '', pd: '' };
                    const cleaned = String(value).replace(/\s+/g, '');
                    const parts = cleaned.split('/').filter(Boolean);
                    if (parts.length >= 2) {
                        return { bi: `${parts[0]}/${parts[1]}`, pd: parts[2] || '' };
                    }
                    return { bi: cleaned, pd: '' };
                };

                // Use arrays if available, otherwise fall back to flat fields
                const drivers = (data.drivers && data.drivers.length > 0) ? data.drivers : null;
                const vehicles = (data.vehicles && data.vehicles.length > 0) ? data.vehicles : null;

                // Get primary applicant info (use first driver if array exists, otherwise use flat fields)
                const primaryDriver = drivers ? drivers[0] : data;
                const firstName = primaryDriver.firstName || data.firstName || '';
                const lastName = primaryDriver.lastName || data.lastName || '';
                const dob = normalizeDate(primaryDriver.dob || data.dob);

                // Validation
                if (!firstName || !lastName) {
                    return { ok: false, error: '‚ö†Ô∏è First and last name are required for EZLynx XML.' };
                }
                const state = (data.addrState || '').trim().toUpperCase();
                if (!state || !/^[A-Z]{2}$/.test(state)) {
                    return { ok: false, error: '‚ö†Ô∏è A valid 2-letter state is required for EZLynx XML.' };
                }
                if (!dob) {
                    return { ok: false, error: '‚ö†Ô∏è A valid DOB is required for EZLynx XML.' };
                }

                // VIN is optional for EZLynx XML export, but each vehicle needs VIN or year/make/model
                const isAutoPolicy = data.qType === 'auto' || data.qType === 'both';
                if (isAutoPolicy) {
                    if (vehicles && vehicles.length) {
                        const invalidVehicles = vehicles.filter(v => {
                            const hasVin = v.vin && v.vin.trim().length > 0;
                            const hasDetails = (v.year && v.make && v.model);
                            return !hasVin && !hasDetails;
                        });
                        if (invalidVehicles.length) {
                            return { ok: false, error: '‚ö†Ô∏è Each vehicle needs a VIN or Year/Make/Model for EZLynx XML.' };
                        }
                    } else {
                        const hasVin = data.vin && data.vin.trim().length > 0;
                        const hasDesc = data.vehDesc && data.vehDesc.trim().length > 0;
                        if (!hasVin && !hasDesc) {
                            return { ok: false, error: '‚ö†Ô∏è Add at least one vehicle (VIN or Year/Make/Model) for EZLynx XML.' };
                        }
                        if (!hasVin && hasDesc) {
                            const match = data.vehDesc.match(/(\d{4})\s+([A-Z]+)\s+(.+)/i);
                            if (!match) {
                                return { ok: false, error: '‚ö†Ô∏è Vehicle description should be "YEAR MAKE MODEL" if no VIN is provided.' };
                            }
                        }
                    }
                }

                const phone = data.phone ? data.phone.replace(/\D/g, '') : '';
                const streetRaw = (data.addrStreet || '').trim();
                const streetMatch = streetRaw.match(/^(\d+)\s+(.*)$/);
                const streetNumber = streetMatch?.[1] || '';
                const streetName = streetMatch?.[2] || streetRaw;
                const { zip5, zip4 } = splitZip(data.addrZip);
                const gender = mapGender(data.gender);
                const marital = mapMaritalStatus(data.maritalStatus);

                let xml = '<?xml version="1.0" encoding="utf-8"?>\n';
                xml += '<EZAUTO xmlns="http://www.ezlynx.com/XMLSchema/Auto/V200">\n';

                // Applicant section (primary contact info)
                xml += '  <Applicant>\n';
                xml += '    <ApplicantType>Applicant</ApplicantType>\n';
                xml += '    <PersonalInfo>\n';
                xml += '      <Name>\n';
                xml += `        <FirstName>${escapeXML(firstName)}</FirstName>\n`;
                xml += '        <MiddleName></MiddleName>\n';
                xml += `        <LastName>${escapeXML(lastName)}</LastName>\n`;
                xml += '      </Name>\n';
                xml += `      <DOB>${dob}</DOB>\n`;
                if (gender) {
                    xml += `      <Gender>${escapeXML(gender)}</Gender>\n`;
                }
                if (marital) {
                    xml += `      <MaritalStatus>${escapeXML(marital)}</MaritalStatus>\n`;
                }
                xml += '      <Relation>Insured</Relation>\n';
                xml += '    </PersonalInfo>\n';
                xml += '    <Address>\n';
                xml += '      <AddressCode>StreetAddress</AddressCode>\n';
                xml += '      <Addr1>\n';
                xml += `        <StreetName>${escapeXML(streetName)}</StreetName>\n`;
                xml += `        <StreetNumber>${escapeXML(streetNumber)}</StreetNumber>\n`;
                xml += '      </Addr1>\n';
                xml += `      <City>${escapeXML(data.addrCity)}</City>\n`;
                xml += `      <StateCode>${escapeXML(state)}</StateCode>\n`;
                const county = this.getCountyFromCity(data.addrCity, state);
                if (county) {
                    xml += `      <County>${escapeXML(county)}</County>\n`;
                }
                xml += `      <Zip5>${escapeXML(zip5)}</Zip5>\n`;
                if (zip4) {
                    xml += `      <Zip4>${escapeXML(zip4)}</Zip4>\n`;
                }
                if (phone) {
                    xml += '      <Phone id="1">\n';
                    xml += '        <PhoneType>Mobile</PhoneType>\n';
                    xml += `        <PhoneNumber>${escapeXML(phone)}</PhoneNumber>\n`;
                    xml += '        <Extension></Extension>\n';
                    xml += '      </Phone>\n';
                }
                if (data.email) {
                    xml += `      <Email>${escapeXML(data.email)}</Email>\n`;
                }
                xml += '    </Address>\n';
                xml += '  </Applicant>\n';

                // Co-Applicant section (if provided)
                if (data.hasCoApplicant === 'yes' && (data.coFirstName || data.coLastName)) {
                    const coDob = normalizeDate(data.coDob);
                    const coGender = mapGender(data.coGender);
                    xml += '  <Applicant>\n';
                    xml += '    <ApplicantType>CoApplicant</ApplicantType>\n';
                    xml += '    <PersonalInfo>\n';
                    xml += '      <Name>\n';
                    xml += `        <FirstName>${escapeXML(data.coFirstName || '')}</FirstName>\n`;
                    xml += '        <MiddleName></MiddleName>\n';
                    xml += `        <LastName>${escapeXML(data.coLastName || '')}</LastName>\n`;
                    xml += '      </Name>\n';
                    if (coDob) xml += `      <DOB>${coDob}</DOB>\n`;
                    if (coGender) xml += `      <Gender>${escapeXML(coGender)}</Gender>\n`;
                    if (marital) xml += `      <MaritalStatus>${escapeXML(marital)}</MaritalStatus>\n`;
                    xml += `      <Relation>${escapeXML(data.coRelationship === 'Domestic Partner' ? 'Domestic Partner' : 'Spouse')}</Relation>\n`;
                    xml += '    </PersonalInfo>\n';
                    xml += '    <Address>\n';
                    xml += '      <AddressCode>StreetAddress</AddressCode>\n';
                    xml += '      <Addr1>\n';
                    xml += `        <StreetName>${escapeXML(streetName)}</StreetName>\n`;
                    xml += `        <StreetNumber>${escapeXML(streetNumber)}</StreetNumber>\n`;
                    xml += '      </Addr1>\n';
                    xml += `      <City>${escapeXML(data.addrCity)}</City>\n`;
                    xml += `      <StateCode>${escapeXML(state)}</StateCode>\n`;
                    if (county) xml += `      <County>${escapeXML(county)}</County>\n`;
                    xml += `      <Zip5>${escapeXML(zip5)}</Zip5>\n`;
                    if (zip4) xml += `      <Zip4>${escapeXML(zip4)}</Zip4>\n`;
                    const coPhone = data.coPhone ? data.coPhone.replace(/\D/g, '') : '';
                    if (coPhone) {
                        xml += '      <Phone id="1">\n';
                        xml += '        <PhoneType>Mobile</PhoneType>\n';
                        xml += `        <PhoneNumber>${escapeXML(coPhone)}</PhoneNumber>\n`;
                        xml += '        <Extension></Extension>\n';
                        xml += '      </Phone>\n';
                    }
                    if (data.coEmail) xml += `      <Email>${escapeXML(data.coEmail)}</Email>\n`;
                    xml += '    </Address>\n';
                    xml += '  </Applicant>\n';
                }

                // PriorPolicyInfo ‚Äî only emit child date/text elements when they have values
                const priorExp = normalizeDate(data.priorExp);
                xml += '  <PriorPolicyInfo>\n';
                if (data.priorCarrier) {
                    xml += `    <PriorCarrier>${escapeXML(data.priorCarrier)}</PriorCarrier>\n`;
                }
                if (data.priorPolicyTerm) {
                    xml += `    <PriorPolicyTerm>${escapeXML(data.priorPolicyTerm)}</PriorPolicyTerm>\n`;
                }
                if (priorExp) {
                    xml += `    <Expiration>${priorExp}</Expiration>\n`;
                }
                if (data.priorYears) {
                    xml += '    <YearsWithPriorCarrier>\n';
                    xml += `      <Years>${escapeXML(data.priorYears)}</Years>\n`;
                    xml += '    </YearsWithPriorCarrier>\n';
                }
                xml += '  </PriorPolicyInfo>\n';

                // PolicyInfo ‚Äî only emit when values present
                const effectiveDate = normalizeDate(data.effectiveDate);
                xml += '  <PolicyInfo>\n';
                if (data.policyTerm) {
                    xml += `    <PolicyTerm>${escapeXML(data.policyTerm)}</PolicyTerm>\n`;
                }
                if (effectiveDate) {
                    xml += `    <Effective>${effectiveDate}</Effective>\n`;
                }
                xml += '  </PolicyInfo>\n';

                // ResidenceInfo section (garage location = mailing address by default)
                xml += '  <ResidenceInfo>\n';
                xml += '    <GarageLocation>\n';
                xml += '      <Address>\n';
                xml += '        <AddressCode>StreetAddress</AddressCode>\n';
                xml += '        <Addr1>\n';
                xml += `          <StreetName>${escapeXML(streetName)}</StreetName>\n`;
                xml += `          <StreetNumber>${escapeXML(streetNumber)}</StreetNumber>\n`;
                xml += '        </Addr1>\n';
                xml += `        <City>${escapeXML(data.addrCity)}</City>\n`;
                xml += `        <StateCode>${escapeXML(state)}</StateCode>\n`;
                if (county) {
                    xml += `        <County>${escapeXML(county)}</County>\n`;
                }
                xml += `        <Zip5>${escapeXML(zip5)}</Zip5>\n`;
                if (zip4) {
                    xml += `        <Zip4>${escapeXML(zip4)}</Zip4>\n`;
                }
                xml += '      </Address>\n';
                xml += '    </GarageLocation>\n';
                xml += '  </ResidenceInfo>\n';

                // Drivers section - iterate over drivers array or use flat fields
                xml += '  <Drivers>\n';
                if (drivers) {
                    // Use drivers array
                    drivers.forEach((driver, index) => {
                        const driverDob = normalizeDate(driver.dob);
                        const driverId = index + 1;
                        const isFirstDriver = index === 0;
                        const driverGender = mapGender(driver.gender || data.gender);
                        const driverMarital = mapMaritalStatus(driver.maritalStatus || data.maritalStatus);

                        xml += `    <Driver id="${driverId}">\n`;
                        const driverFirst = driver.firstName || (isFirstDriver ? (data.firstName || '') : '');
                        const driverLast = driver.lastName || (isFirstDriver ? (data.lastName || '') : '');
                        xml += '      <Name>\n';
                        xml += `        <FirstName>${escapeXML(driverFirst)}</FirstName>\n`;
                        xml += `        <LastName>${escapeXML(driverLast)}</LastName>\n`;
                        xml += '      </Name>\n';
                        if (driverGender) {
                            xml += `      <Gender>${escapeXML(driverGender)}</Gender>\n`;
                        }
                        if (driverDob) {
                            xml += `      <DOB>${driverDob}</DOB>\n`;
                        }
                        if (driver.dlNum) {
                            xml += `      <DLNumber>${escapeXML((driver.dlNum || '').toUpperCase())}</DLNumber>\n`;
                        }
                        xml += `      <DLState>${escapeXML((driver.dlState || state).toUpperCase())}</DLState>\n`;
                        if (driverMarital) {
                            xml += `      <MaritalStatus>${escapeXML(driverMarital)}</MaritalStatus>\n`;
                        }
                        if (isFirstDriver) {
                            xml += '      <Relation>Insured</Relation>\n';
                        }
                        xml += '      <GoodStudent>No</GoodStudent>\n';
                        xml += '      <MATDriver>No</MATDriver>\n';
                        xml += '      <Rated>Rated</Rated>\n';
                        xml += '    </Driver>\n';
                    });
                } else {
                    // Fallback to flat fields for backward compatibility
                    xml += '    <Driver id="1">\n';
                    xml += '      <Name>\n';
                    xml += `        <FirstName>${escapeXML(data.firstName)}</FirstName>\n`;
                    xml += `        <LastName>${escapeXML(data.lastName)}</LastName>\n`;
                    xml += '      </Name>\n';
                    if (gender) {
                        xml += `      <Gender>${escapeXML(gender)}</Gender>\n`;
                    }
                    xml += `      <DOB>${dob}</DOB>\n`;
                    if (data.dlNum) {
                        xml += `      <DLNumber>${escapeXML((data.dlNum || '').toUpperCase())}</DLNumber>\n`;
                    }
                    xml += `      <DLState>${escapeXML((data.dlState || state).toUpperCase())}</DLState>\n`;
                    if (marital) {
                        xml += `      <MaritalStatus>${escapeXML(marital)}</MaritalStatus>\n`;
                    }
                    xml += '      <Relation>Insured</Relation>\n';
                    xml += '      <GoodStudent>No</GoodStudent>\n';
                    xml += '      <MATDriver>No</MATDriver>\n';
                    xml += '      <Rated>Rated</Rated>\n';
                    xml += '    </Driver>\n';
                }
                xml += '  </Drivers>\n';

                // Vehicles section ‚Äî only emit if there are vehicles
                const hasVehicles = vehicles ? vehicles.length > 0 : !!(data.vin || data.vehDesc);
                if (hasVehicles) {
                    xml += '  <Vehicles>\n';
                    if (vehicles) {
                        vehicles.forEach((vehicle, index) => {
                            const vehicleId = index + 1;
                            const hasVin = vehicle.vin && vehicle.vin.trim().length > 0;
                            xml += `    <Vehicle id="${vehicleId}">\n`;
                            xml += `      <UseVinLookup>${hasVin ? 'Yes' : 'No'}</UseVinLookup>\n`;
                            xml += `      <Year>${escapeXML(vehicle.year || '')}</Year>\n`;
                            xml += `      <Vin>${escapeXML(vehicle.vin || '')}</Vin>\n`;
                            xml += `      <Make>${escapeXML(vehicle.make || '')}</Make>\n`;
                            xml += `      <Model>${escapeXML(vehicle.model || '')}</Model>\n`;
                            xml += '      <Anti-Theft>None</Anti-Theft>\n';
                            xml += '      <PassiveRestraints>None</PassiveRestraints>\n';
                            xml += '    </Vehicle>\n';
                        });
                    } else if (data.vin || data.vehDesc) {
                        const parseVehicle = (desc) => {
                            const match = desc?.match(/(\d{4})\s+([A-Z]+)\s+(.+)/i);
                            return {
                                year: match?.[1] || '',
                                make: match?.[2] || '',
                                model: match?.[3]?.trim() || ''
                            };
                        };
                        const { year, make, model } = parseVehicle(data.vehDesc);
                        const hasVin = data.vin && data.vin.trim().length > 0;
                        xml += '    <Vehicle id="1">\n';
                        xml += `      <UseVinLookup>${hasVin ? 'Yes' : 'No'}</UseVinLookup>\n`;
                        xml += `      <Year>${escapeXML(year)}</Year>\n`;
                        xml += `      <Vin>${escapeXML(data.vin || '')}</Vin>\n`;
                        xml += `      <Make>${escapeXML(make)}</Make>\n`;
                        xml += `      <Model>${escapeXML(model)}</Model>\n`;
                        xml += '      <Anti-Theft>None</Anti-Theft>\n';
                        xml += '      <PassiveRestraints>None</PassiveRestraints>\n';
                        xml += '    </Vehicle>\n';
                    }
                    xml += '  </Vehicles>\n';

                    // VehiclesUse section
                    xml += '  <VehiclesUse>\n';
                    if (vehicles) {
                        vehicles.forEach((vehicle, index) => {
                            const vehicleId = index + 1;
                            const miles = vehicle.miles || '12000';
                            xml += `    <VehicleUse id="${vehicleId}">\n`;
                            xml += `      <AnnualMiles>${escapeXML(miles)}</AnnualMiles>\n`;
                            xml += '    </VehicleUse>\n';
                        });
                    } else if (data.vin || data.vehDesc) {
                        xml += '    <VehicleUse id="1">\n';
                        xml += `      <AnnualMiles>${escapeXML(data.miles || '12000')}</AnnualMiles>\n`;
                        xml += '    </VehicleUse>\n';
                    }
                    xml += '  </VehiclesUse>\n';

                    // Coverages section
                    const vehCount = vehicles ? vehicles.length : 1;
                    const liab = parseLimits(data.liabilityLimits);
                    const um = parseLimits(data.umLimits);
                    const uim = parseLimits(data.uimLimits);
                    const pdValue = data.pdLimit || liab.pd || '100000';
                    xml += '  <Coverages>\n';
                    xml += '    <GeneralCoverage>\n';
                    xml += `      <BI>${escapeXML(liab.bi || data.liabilityLimits || '100/300')}</BI>\n`;
                    xml += `      <PD>${escapeXML(pdValue)}</PD>\n`;
                    xml += `      <UM>${escapeXML(um.bi || data.umLimits || '100/300')}</UM>\n`;
                    xml += `      <UIM>${escapeXML(uim.bi || data.uimLimits || '100/300')}</UIM>\n`;
                    xml += `      <Multicar>${vehCount > 1 ? 'Yes' : 'No'}</Multicar>\n`;
                    xml += '    </GeneralCoverage>\n';

                    // VehicleCoverage per vehicle
                    for (let i = 1; i <= vehCount; i++) {
                        xml += `    <VehicleCoverage id="${i}">\n`;
                        xml += `      <OtherCollisionDeductible>${escapeXML(data.compDeductible || 'No Coverage')}</OtherCollisionDeductible>\n`;
                        xml += `      <CollisionDeductible>${escapeXML(data.autoDeductible || 'No Coverage')}</CollisionDeductible>\n`;
                        xml += `      <TowingDeductible>${escapeXML(data.towingDeductible || 'No Coverage')}</TowingDeductible>\n`;
                        xml += `      <RentalDeductible>${escapeXML(data.rentalDeductible || 'No Coverage')}</RentalDeductible>\n`;
                        xml += '    </VehicleCoverage>\n';
                    }

                    // StateSpecificCoverage
                    if (state === 'WA') {
                        xml += '    <StateSpecificCoverage>\n';
                        xml += '      <WA-Coverages>\n';
                        xml += `        <WA-UMPD>${escapeXML(data.umPd || data.pdLimit || liab.pd || '25000')}</WA-UMPD>\n`;
                        xml += '        <WA-PIP>10000</WA-PIP>\n';
                        xml += '      </WA-Coverages>\n';
                        xml += '    </StateSpecificCoverage>\n';
                    }

                    xml += '  </Coverages>\n';

                    // VehicleAssignments section
                    xml += '  <VehicleAssignments>\n';
                    const driverCount = drivers ? drivers.length : 1;
                    for (let i = 1; i <= vehCount; i++) {
                        xml += `    <VehicleAssignment id="${i}">\n`;
                        let assignedDriver = ((i - 1) % driverCount) + 1;
                        if (vehicles && vehicles[i-1]?.primaryDriver && drivers) {
                            const driverIdx = drivers.findIndex(d => d.id === vehicles[i-1].primaryDriver);
                            if (driverIdx >= 0) assignedDriver = driverIdx + 1;
                        }
                        xml += `      <DriverAssignment>${assignedDriver}</DriverAssignment>\n`;
                        xml += '    </VehicleAssignment>\n';
                    }
                    xml += '  </VehicleAssignments>\n';
                }

                xml += '</EZAUTO>\n';

                return {
                    ok: true,
                    content: xml,
                    filename: `${lastName || 'Lead'}_EZLynx.xml`,
                    mime: 'application/xml;charset=utf-8'
                };
            },

            exportHomeXML() {
                const result = this.buildHomeXML(this.data);
                if (!result.ok) {
                    this.toast(result.error);
                    return;
                }
                this.downloadFile(result.content, result.filename, result.mime);
                this.logExport('HomeXML', result.filename);
                this.toast('üè† EZLynx Home XML File Generated!');
            },

            buildHomeXML(data) {
                // ‚îÄ‚îÄ‚îÄ Shared helpers (from App._xxx methods) ‚îÄ‚îÄ‚îÄ
                const escapeXML = this._escapeXML;
                const mapMaritalStatus = this._mapMaritalStatus;
                const mapGender = this._mapGender;
                const normalizeDate = this._normalizeDate;
                const splitZip = this._splitZip;
                const cleanNum = (v) => (v || '').toString().replace(/[$,\s]/g, '').trim();

                // ‚îÄ‚îÄ‚îÄ Mapping helpers (EZLynx exact values from reference sample) ‚îÄ‚îÄ‚îÄ
                const mapConstruction = (style) => {
                    if (!style) return '';
                    const map = { 'Frame': 'Frame', 'Vinyl Siding': 'Siding, Vinyl', 'Masonry Veneer': 'Masonry Veneer', 'Masonry': 'Masonry', 'Stucco': 'Stucco', 'Log': 'Log', 'Adobe': 'Adobe', 'Brick': 'Brick' };
                    return map[style] || style;
                };
                const mapDwelling = (dt) => {
                    if (!dt) return 'One Family';
                    const map = { 'Single Family': 'One Family', 'Condo': 'Condo', 'Townhome': 'Townhouse', 'Duplex': 'Two Family', 'Triplex': 'Three Family', 'Fourplex': 'Four Family' };
                    return map[dt] || dt;
                };
                const mapStructure = (dt) => {
                    if (!dt) return '';
                    const map = { 'Single Family': 'Ranch', 'Condo': 'Condo', 'Townhome': 'Townhouse', 'Colonial': 'Colonial', 'Ranch': 'Ranch', 'Split Level': 'Split Level', 'Cape Cod': 'Cape Cod', 'Victorian': 'Victorian' };
                    return map[dt] || dt;
                };
                const mapRoof = (rt) => {
                    if (!rt) return '';
                    const map = { 'Asphalt/Composite Shingle': 'COMPOSITION', 'Architectural Shingle': 'ARCHITECTURAL SHINGLE', 'Metal': 'METAL', 'Clay Tile': 'CLAY TILE', 'Concrete Tile': 'CONCRETE TILE', 'Wood Shake': 'WOOD SHAKE', 'Slate': 'SLATE', 'Tar & Gravel': 'TAR AND GRAVEL' };
                    return map[rt] || rt.toUpperCase();
                };
                const mapFoundation = (f) => {
                    if (!f) return '';
                    const map = { 'Slab': 'Slab', 'Crawlspace': 'Crawlspace', 'Basement (Finished)': 'Basement - Finished', 'Basement (Unfinished)': 'Basement - Unfinished', 'Pier/Pile': 'Pier' };
                    return map[f] || f;
                };
                const mapHeating = (h) => {
                    if (!h) return '';
                    const map = { 'Forced Air - Gas': 'Gas', 'Forced Air - Electric': 'Electric', 'Heat Pump': 'Heat Pump', 'Boiler (Steam/Water)': 'Hot Water/Steam', 'Electric Baseboard': 'Electric', 'Oil/Kerosene': 'Oil' };
                    return map[h] || h;
                };
                const mapDwellingUse = (u) => {
                    if (!u) return 'Primary';
                    const map = { 'Primary': 'Primary', 'Secondary': 'Secondary', 'Seasonal': 'Seasonal', 'Rental': 'Tenant Occupied', 'Vacant': 'Vacant' };
                    return map[u] || u;
                };
                const mapOccupancy = (o) => {
                    if (!o) return 'Owner Occupied';
                    const map = { 'Owner': 'Owner Occupied', 'Tenant': 'Tenant', 'Vacant': 'Vacant' };
                    return map[o] || o;
                };
                // Map form industry values to valid EZLynx/ACORD Industry names.
                // Employment statuses (Retired, Disabled, etc.) are NOT industries
                // and crash .NET enum deserialization ‚Äî omit them.
                const mapIndustry = (val) => {
                    if (!val) return '';
                    const notIndustry = ['Retired','Disabled','Unemployed','Student','Homemaker/House person'];
                    if (notIndustry.includes(val)) return '';
                    const map = {
                        'Agriculture/Forestry/Fishing': 'Agriculture/Forestry/Fishing',
                        'Art/Design/Media': 'Art/Design/Media',
                        'Banking/Finance/Real Estate': 'Banking/Finance/Real Estate',
                        'Business/Sales/Office': 'Business/Sales/Office',
                        'Construction/Energy Trades': 'Construction/Energy Trades',
                        'Education/Library': 'Education/Library',
                        'Engineer/Architect/Science/Math': 'Engineer/Architect/Science/Math',
                        'Government/Military': 'Government/Military',
                        'Information Technology': 'Information Technology',
                        'Insurance': 'Insurance',
                        'Legal/Law Enforcement/Security': 'Legal/Law Enforcement/Security',
                        'Maintenance/Repair/Housekeeping': 'Maintenance/Repair/Housekeeping',
                        'Manufacturing/Production': 'Manufacturing/Production',
                        'Medical/Social Services/Religion': 'Medical/Social Services/Religion',
                        'Personal Care/Service': 'Personal Care/Service',
                        'Restaurant/Hotel Services': 'Restaurant/Hotel Services',
                        'Sports/Recreation': 'Sports/Recreation',
                        'Travel/Transportation/Warehousing': 'Travel/Transportation/Warehousing',
                        'Other': 'Other'
                    };
                    return map[val] || '';
                };
                // Determine update status from year
                const updateStatus = (yr, builtYr) => {
                    if (!yr) return 'NOT UPDATED';
                    const y = parseInt(yr, 10);
                    const b = parseInt(builtYr, 10) || 0;
                    if (y >= b + 5) return 'PARTIAL UPDATE';
                    return 'NOT UPDATED';
                };

                // ‚îÄ‚îÄ‚îÄ Primary applicant resolution ‚îÄ‚îÄ‚îÄ
                const drivers = (data.drivers && data.drivers.length > 0) ? data.drivers : null;
                const primaryDriver = drivers ? drivers[0] : data;
                const firstName = primaryDriver.firstName || data.firstName || '';
                const lastName = primaryDriver.lastName || data.lastName || '';
                const dob = normalizeDate(primaryDriver.dob || data.dob);

                // ‚îÄ‚îÄ‚îÄ Validation ‚îÄ‚îÄ‚îÄ
                if (!firstName || !lastName) {
                    return { ok: false, error: '‚ö†Ô∏è First and last name are required for EZLynx Home XML.' };
                }
                const state = (data.addrState || '').trim().toUpperCase();
                if (!state || !/^[A-Z]{2}$/.test(state)) {
                    return { ok: false, error: '‚ö†Ô∏è A valid 2-letter state is required for EZLynx Home XML.' };
                }
                if (!dob) {
                    return { ok: false, error: '‚ö†Ô∏è A valid DOB is required for EZLynx Home XML.' };
                }

                // ‚îÄ‚îÄ‚îÄ Shared address/contact fields ‚îÄ‚îÄ‚îÄ
                const phone = data.phone ? data.phone.replace(/\D/g, '') : '';
                const streetRaw = (data.addrStreet || '').trim();
                const streetMatch = streetRaw.match(/^(\d+)\s+(.*)$/);
                const streetNumber = streetMatch?.[1] || '';
                const streetName = streetMatch?.[2] || streetRaw;
                const { zip5, zip4 } = splitZip(data.addrZip);
                const gender = mapGender(primaryDriver.gender || data.gender);
                const marital = mapMaritalStatus(primaryDriver.maritalStatus || data.maritalStatus);
                const county = this.getCountyFromCity(data.addrCity, state);

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // START XML ‚Äî Pretty-printed EZHOME V200 format
                // Structural twin of John_Smith_Home.xml reference
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const I = '  ';   // 2-space indent (matches reference file)
                const I2 = I+I, I3 = I2+I, I4 = I3+I;
                const L = '\n';   // newline between elements

                let xml = '<?xml version="1.0" encoding="utf-8"?>' + L;
                xml += '<EZHOME xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.ezlynx.com/XMLSchema/Home/V200">' + L;

                // ‚îÄ‚îÄ Applicant ‚îÄ‚îÄ
                xml += I + '<Applicant>' + L;
                xml += I2 + '<ApplicantType>Applicant</ApplicantType>' + L;
                xml += I2 + '<PersonalInfo>' + L;
                xml += I3 + '<Name>' + L;
                xml += I4 + `<FirstName>${escapeXML(firstName)}</FirstName>` + L;
                xml += I4 + '<MiddleName />' + L;
                xml += I4 + `<LastName>${escapeXML(lastName)}</LastName>` + L;
                xml += I3 + '</Name>' + L;
                xml += I3 + `<DOB>${dob}</DOB>` + L;
                if (gender) xml += I3 + `<Gender>${escapeXML(gender)}</Gender>` + L;
                if (marital) xml += I3 + `<MaritalStatus>${escapeXML(marital)}</MaritalStatus>` + L;
                xml += I3 + '<Relation>Insured</Relation>' + L;
                const industry = mapIndustry(data.industry);
                if (industry) xml += I3 + `<Industry>${escapeXML(industry)}</Industry>` + L;
                if (data.occupation) xml += I3 + `<Occupation>${escapeXML(data.occupation)}</Occupation>` + L;
                xml += I2 + '</PersonalInfo>' + L;
                xml += I2 + '<Address>' + L;
                xml += I3 + '<AddressCode>StreetAddress</AddressCode>' + L;
                xml += I3 + '<Addr1>' + L;
                xml += I4 + `<StreetName>${escapeXML(streetName)}</StreetName>` + L;
                xml += I4 + `<StreetNumber>${escapeXML(streetNumber)}</StreetNumber>` + L;
                xml += I4 + '<UnitNumber />' + L;
                xml += I3 + '</Addr1>' + L;
                xml += I3 + '<Addr2 />' + L;
                xml += I3 + `<City>${escapeXML(data.addrCity || '')}</City>` + L;
                xml += I3 + `<StateCode>${escapeXML(state)}</StateCode>` + L;
                if (county) xml += I3 + `<County>${escapeXML(county)}</County>` + L;
                xml += I3 + `<Zip5>${escapeXML(zip5)}</Zip5>` + L;
                if (zip4) xml += I3 + `<Zip4>${escapeXML(zip4)}</Zip4>` + L;
                if (phone) {
                    xml += I3 + '<Phone>' + L;
                    xml += I4 + '<PhoneType>Mobile</PhoneType>' + L;
                    xml += I4 + `<PhoneNumber>${escapeXML(phone)}</PhoneNumber>` + L;
                    xml += I3 + '</Phone>' + L;
                }
                if (data.email) xml += I3 + `<Email>${escapeXML(data.email)}</Email>` + L;
                xml += I3 + '<BridgeEmailToCarriers>No</BridgeEmailToCarriers>' + L;
                xml += I3 + '<PreferredContactMethod>Phone (Mobile)</PreferredContactMethod>' + L;
                if (data.yearsAtAddress) xml += I3 + `<YearsAtAddress>${escapeXML(data.yearsAtAddress)}</YearsAtAddress>` + L;
                xml += I3 + '<Validation>Valid</Validation>' + L;
                xml += I2 + '</Address>' + L;
                xml += I + '</Applicant>' + L;

                // ‚îÄ‚îÄ Co-Applicant (if provided) ‚îÄ‚îÄ
                if (data.hasCoApplicant === 'yes' && (data.coFirstName || data.coLastName)) {
                    const coDob = normalizeDate(data.coDob);
                    const coGender = mapGender(data.coGender);
                    xml += I + '<Applicant>' + L;
                    xml += I2 + '<ApplicantType>CoApplicant</ApplicantType>' + L;
                    xml += I2 + '<PersonalInfo>' + L;
                    xml += I3 + '<Name>' + L;
                    xml += I4 + `<FirstName>${escapeXML(data.coFirstName || '')}</FirstName>` + L;
                    xml += I4 + '<MiddleName />' + L;
                    xml += I4 + `<LastName>${escapeXML(data.coLastName || '')}</LastName>` + L;
                    xml += I3 + '</Name>' + L;
                    if (coDob) xml += I3 + `<DOB>${coDob}</DOB>` + L;
                    if (coGender) xml += I3 + `<Gender>${escapeXML(coGender)}</Gender>` + L;
                    if (marital) xml += I3 + `<MaritalStatus>${escapeXML(marital)}</MaritalStatus>` + L;
                    xml += I3 + `<Relation>${escapeXML(data.coRelationship === 'Domestic Partner' ? 'Domestic Partner' : 'Spouse')}</Relation>` + L;
                    xml += I2 + '</PersonalInfo>' + L;
                    xml += I2 + '<Address>' + L;
                    xml += I3 + '<AddressCode>StreetAddress</AddressCode>' + L;
                    xml += I3 + '<Addr1>' + L;
                    xml += I4 + `<StreetName>${escapeXML(streetName)}</StreetName>` + L;
                    xml += I4 + `<StreetNumber>${escapeXML(streetNumber)}</StreetNumber>` + L;
                    xml += I4 + '<UnitNumber />' + L;
                    xml += I3 + '</Addr1>' + L;
                    xml += I3 + '<Addr2 />' + L;
                    xml += I3 + `<City>${escapeXML(data.addrCity || '')}</City>` + L;
                    xml += I3 + `<StateCode>${escapeXML(state)}</StateCode>` + L;
                    if (county) xml += I3 + `<County>${escapeXML(county)}</County>` + L;
                    xml += I3 + `<Zip5>${escapeXML(zip5)}</Zip5>` + L;
                    if (zip4) xml += I3 + `<Zip4>${escapeXML(zip4)}</Zip4>` + L;
                    const coPhone = data.coPhone ? data.coPhone.replace(/\D/g, '') : '';
                    if (coPhone) {
                        xml += I3 + '<Phone>' + L;
                        xml += I4 + '<PhoneType>Mobile</PhoneType>' + L;
                        xml += I4 + `<PhoneNumber>${escapeXML(coPhone)}</PhoneNumber>` + L;
                        xml += I3 + '</Phone>' + L;
                    }
                    if (data.coEmail) xml += I3 + `<Email>${escapeXML(data.coEmail)}</Email>` + L;
                    xml += I3 + '<Validation>Valid</Validation>' + L;
                    xml += I2 + '</Address>' + L;
                    xml += I + '</Applicant>' + L;
                }

                // ‚îÄ‚îÄ PriorPolicyInfo (home-specific fields) ‚îÄ‚îÄ
                const homePriorCarrier = data.homePriorCarrier || data.priorCarrier || '';
                const homePriorYears = data.homePriorYears || data.priorYears || '';
                const homePriorExpDate = normalizeDate(data.homePriorExp || data.priorExp);
                xml += I + '<PriorPolicyInfo>' + L;
                if (homePriorCarrier) xml += I2 + `<PriorCarrier>${escapeXML(homePriorCarrier)}</PriorCarrier>` + L;
                if (homePriorExpDate) xml += I2 + `<Expiration>${homePriorExpDate}</Expiration>` + L;
                if (homePriorYears) {
                    const yearsInt = parseInt(String(homePriorYears).replace(/[^0-9]/g, ''), 10) || 0;
                    xml += I2 + '<YearsWithPriorCarrier>' + L;
                    xml += I3 + `<Years>${yearsInt}</Years>` + L;
                    xml += I3 + '<Months>0</Months>' + L;
                    xml += I2 + '</YearsWithPriorCarrier>' + L;
                    xml += I2 + '<YearsWithContinuousCoverage>' + L;
                    xml += I3 + `<Years>${yearsInt}</Years>` + L;
                    xml += I3 + '<Months>0</Months>' + L;
                    xml += I2 + '</YearsWithContinuousCoverage>' + L;
                }
                xml += I + '</PriorPolicyInfo>' + L;

                // ‚îÄ‚îÄ PolicyInfo ‚îÄ‚îÄ
                const effectiveDate = normalizeDate(data.effectiveDate) || new Date().toISOString().split('T')[0];
                const policyType = data.homePolicyType || 'HO3';
                xml += I + '<PolicyInfo>' + L;
                xml += I2 + `<PolicyTerm>${escapeXML(data.policyTerm || '12 Month')}</PolicyTerm>` + L;
                xml += I2 + `<PolicyType>${escapeXML(policyType)}</PolicyType>` + L;
                xml += I2 + '<Package>No</Package>' + L;
                xml += I2 + `<Effective>${effectiveDate}</Effective>` + L;
                xml += I2 + '<CreditCheckAuth>Yes</CreditCheckAuth>' + L;
                xml += I + '</PolicyInfo>' + L;

                // ‚îÄ‚îÄ RatingInfo (strict positional sequence from John_Smith reference) ‚îÄ‚îÄ
                const yrBuilt = data.yrBuilt || '';
                xml += I + '<RatingInfo>' + L;
                xml += I2 + '<PropertyInsCancelledLapsed>No</PropertyInsCancelledLapsed>' + L;
                if (yrBuilt) xml += I2 + `<YearBuilt>${escapeXML(yrBuilt)}</YearBuilt>` + L;
                xml += I2 + `<Dwelling>${escapeXML(mapDwelling(data.dwellingType))}</Dwelling>` + L;
                xml += I2 + `<NumberOfOccupants>${escapeXML(data.numOccupants || '1')}</NumberOfOccupants>` + L;
                xml += I2 + `<DwellingUse>${escapeXML(mapDwellingUse(data.dwellingUsage))}</DwellingUse>` + L;
                xml += I2 + `<DwellingOccupancy>${escapeXML(mapOccupancy(data.occupancyType))}</DwellingOccupancy>` + L;

                // Fire protection ‚Äî all tags always present for positional deserializer
                if (data.fireHydrantFeet) xml += I2 + `<DistanceToFireHydrant>${escapeXML(data.fireHydrantFeet)}</DistanceToFireHydrant>` + L;
                xml += I2 + '<WithinCityLimits>No</WithinCityLimits>' + L;
                if (data.fireStationDist) {
                    // Round to integer ‚Äî V200 schema expects int for DistanceToFireStation
                    const fireDist = Math.round(parseFloat(data.fireStationDist)) || data.fireStationDist;
                    xml += I2 + `<DistanceToFireStation>${escapeXML(String(fireDist))}</DistanceToFireStation>` + L;
                }
                // Omit DistanceToFireStation entirely when no data ‚Äî self-closing
                // <DistanceToFireStation /> crashes .NET int deserialization
                xml += I2 + '<WithinFireDistrict>No</WithinFireDistrict>' + L;
                if (data.protectionClass) xml += I2 + `<ProtectionClass>${escapeXML(data.protectionClass)}</ProtectionClass>` + L;

                // Structure ‚Äî always present
                xml += I2 + `<NumberOfStories>${escapeXML(data.numStories || '1')}</NumberOfStories>` + L;
                if (data.fullBaths) xml += I2 + `<NumberOfFullBaths>${escapeXML(data.fullBaths)}</NumberOfFullBaths>` + L;
                if (data.halfBaths && data.halfBaths !== '0') xml += I2 + `<NumberOfHalfBaths>${escapeXML(data.halfBaths)}</NumberOfHalfBaths>` + L;

                const construction = mapConstruction(data.constructionStyle || data.exteriorWalls);
                if (construction) xml += I2 + `<Construction>${escapeXML(construction)}</Construction>` + L;
                const structure = mapStructure(data.dwellingType);
                if (structure) xml += I2 + `<Structure>${escapeXML(structure)}</Structure>` + L;
                const roof = mapRoof(data.roofType);
                if (roof) xml += I2 + `<Roof>${escapeXML(roof)}</Roof>` + L;

                // Pool & Dogs ‚Äî right after Roof
                xml += I2 + `<SwimmingPool>${(data.pool && data.pool !== 'None') ? 'Yes' : 'No'}</SwimmingPool>` + L;
                xml += I2 + `<SwimmingPoolFenced>${(data.pool && data.pool.includes('Ground')) ? 'Yes' : 'No'}</SwimmingPoolFenced>` + L;
                xml += I2 + `<DogOnPremises>${data.dogInfo ? 'Yes' : 'No'}</DogOnPremises>` + L;

                // Heating type
                const heating = mapHeating(data.heatingType);
                if (heating) xml += I2 + `<HeatingType>${escapeXML(heating)}</HeatingType>` + L;

                // System updates ‚Äî always emit UpdateYear (default to yrBuilt)
                xml += I2 + `<RoofingUpdate>${updateStatus(data.roofYr, yrBuilt)}</RoofingUpdate>` + L;
                xml += I2 + `<RoofingUpdateYear>${escapeXML(data.roofYr || yrBuilt)}</RoofingUpdateYear>` + L;
                xml += I2 + `<ElectricalUpdate>${updateStatus(data.elecYr, yrBuilt)}</ElectricalUpdate>` + L;
                xml += I2 + `<ElectricalUpdateYear>${escapeXML(data.elecYr || yrBuilt)}</ElectricalUpdateYear>` + L;
                xml += I2 + `<PlumbingUpdate>${updateStatus(data.plumbYr, yrBuilt)}</PlumbingUpdate>` + L;
                xml += I2 + `<PlumbingUpdateYear>${escapeXML(data.plumbYr || yrBuilt)}</PlumbingUpdateYear>` + L;
                xml += I2 + `<HeatingUpdate>${updateStatus(data.heatYr, yrBuilt)}</HeatingUpdate>` + L;
                xml += I2 + `<HeatingUpdateYear>${escapeXML(data.heatYr || yrBuilt)}</HeatingUpdateYear>` + L;

                xml += I2 + '<UnderConstruction>No</UnderConstruction>' + L;
                if (data.sqFt) xml += I2 + `<SquareFootage>${escapeXML(data.sqFt)}</SquareFootage>` + L;
                const purchaseDate = normalizeDate(data.purchaseDate);
                if (purchaseDate) xml += I2 + `<PurchaseDate>${purchaseDate}</PurchaseDate>` + L;

                xml += I2 + `<Trampoline>${(data.trampoline && data.trampoline !== 'None') ? 'Yes' : 'No'}</Trampoline>` + L;
                xml += I2 + `<BusinessOnPremises>${data.businessOnProperty ? 'Yes' : 'No'}</BusinessOnPremises>` + L;
                xml += I2 + `<FirstMortgagee>${data.mortgagee ? 'Yes' : 'No'}</FirstMortgagee>` + L;
                xml += I2 + '<SecondMortgagee>No</SecondMortgagee>' + L;
                xml += I2 + '<ThirdMortgagee>No</ThirdMortgagee>' + L;
                xml += I2 + '<EquityLineOfCredit>No</EquityLineOfCredit>' + L;
                xml += I2 + '<CoSigner>No</CoSigner>' + L;
                xml += I2 + '<NumberOfOtherInterests>0</NumberOfOtherInterests>' + L;

                const foundation = mapFoundation(data.foundation);
                if (foundation) xml += I2 + `<Foundation>${escapeXML(foundation)}</Foundation>` + L;
                if (data.roofShape) xml += I2 + `<RoofDesign>${escapeXML(data.roofShape)}</RoofDesign>` + L;
                xml += I + '</RatingInfo>' + L;

                // ‚îÄ‚îÄ ReplacementCost ‚Äî always emit dwelling value (default 0) ‚îÄ‚îÄ
                xml += I + '<ReplacementCost>' + L;
                const dwellingCov = cleanNum(data.dwellingCoverage) || '0';
                xml += I2 + `<ReplacementCost>${escapeXML(dwellingCov)}</ReplacementCost>` + L;
                xml += I2 + `<Dwelling>${escapeXML(dwellingCov)}</Dwelling>` + L;
                xml += I2 + '<LossOfUse>0</LossOfUse>' + L;
                const liability = cleanNum(data.personalLiability) || '0';
                xml += I2 + `<PersonalLiability>${escapeXML(liability)}</PersonalLiability>` + L;
                const medPay = cleanNum(data.medicalPayments) || '0';
                xml += I2 + `<MedicalPayments>${escapeXML(medPay)}</MedicalPayments>` + L;
                const deductible = cleanNum(data.homeDeductible);
                xml += I2 + '<DeductibeInfo>' + L;
                xml += I3 + `<Deductible>${escapeXML(deductible || '1000')}</Deductible>` + L;
                xml += I2 + '</DeductibeInfo>' + L;
                xml += I2 + '<RatingCredits>' + L;
                xml += I3 + '<RetireesCredit>No</RetireesCredit>' + L;
                xml += I3 + '<MatureDiscount>No</MatureDiscount>' + L;
                xml += I3 + '<RetirementCommunity>No</RetirementCommunity>' + L;
                xml += I3 + '<LimitedAccessCommunity>No</LimitedAccessCommunity>' + L;
                xml += I3 + '<GatedCommunity>No</GatedCommunity>' + L;
                xml += I3 + '<Multipolicy>No</Multipolicy>' + L;
                xml += I3 + '<NonSmoker>Yes</NonSmoker>' + L;
                xml += I2 + '</RatingCredits>' + L;
                xml += I + '</ReplacementCost>' + L;

                // ‚îÄ‚îÄ Endorsements ‚îÄ‚îÄ
                xml += I + '<Endorsements>' + L;
                xml += I2 + '<SpecialPersonalProperty>No</SpecialPersonalProperty>' + L;
                xml += I2 + '<ProtectiveDevices>' + L;
                xml += I3 + '<BurglarAlarm>' + L;
                const hasDeadbolt = (data.burglarAlarm && data.burglarAlarm !== 'None') ? 'Yes' : 'No';
                xml += I4 + `<DeadBolt>${hasDeadbolt}</DeadBolt>` + L;
                xml += I4 + '<VisibleToNeighbor>No</VisibleToNeighbor>' + L;
                xml += I4 + '<MannedSecurity>No</MannedSecurity>' + L;
                xml += I3 + '</BurglarAlarm>' + L;
                xml += I2 + '</ProtectiveDevices>' + L;
                xml += I2 + '<Sinkhole>' + L;
                xml += I3 + '<SinkholeCollapse>No</SinkholeCollapse>' + L;
                xml += I2 + '</Sinkhole>' + L;
                xml += I + '</Endorsements>' + L;

                // ‚îÄ‚îÄ GeneralInfo ‚îÄ‚îÄ
                xml += I + '<GeneralInfo>' + L;
                xml += I2 + `<RatingStateCode>${escapeXML(state)}</RatingStateCode>` + L;
                xml += I + '</GeneralInfo>' + L;

                // ‚îÄ‚îÄ ExtendedInfo blocks (agency credentials for WA rater) ‚îÄ‚îÄ
                xml += I + '<ExtendedInfo name="ICQ|CARRIERS|ST_WA">' + L;
                xml += I2 + '<valuepair name="carriers_list">' + L;
                xml += I3 + '<value>1029,835,1157,388,429</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I + '</ExtendedInfo>' + L;

                xml += I + '<ExtendedInfo name="ICQ|CROSSREF|ST_WA">' + L;
                xml += I2 + '<valuepair name="343">' + L;
                xml += I3 + '<value>1029</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="225">' + L;
                xml += I3 + '<value>835</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="377">' + L;
                xml += I3 + '<value>1157</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="35">' + L;
                xml += I3 + '<value>388</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="13">' + L;
                xml += I3 + '<value>429</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I + '</ExtendedInfo>' + L;

                xml += I + '<ExtendedInfo name="ICQ|NAME_VALUE_PAIRS">' + L;
                xml += I2 + '<valuepair name="coverage_paperless_common">' + L;
                xml += I3 + '<value>Yes</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="prior_liabilityasiMI">' + L;
                xml += I3 + '<value>org.asicorp_301K+</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="paidinfullasixmlny">' + L;
                xml += I3 + '<value>org.asicorp_MortgageBilled</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="booktransfer">' + L;
                xml += I3 + '<value />' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="textPurchaseDate">' + L;
                xml += I3 + '<value />' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="textInspectionDate">' + L;
                xml += I3 + '<value />' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="endorsements_equipbreakdown_common">' + L;
                xml += I3 + '<value>No</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="endorsements_serviceline_common">' + L;
                xml += I3 + '<value>No</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="textOrdinanceOrLawPercent">' + L;
                xml += I3 + '<value />' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="bicycleamt">' + L;
                xml += I3 + '<value />' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="homeshieldUT_asi">' + L;
                xml += I3 + '<value>None</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="packagesafecoWA">' + L;
                xml += I3 + '<value>A</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="packagexmlKY">' + L;
                xml += I3 + '<value>org.asicorp_PPDNone</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="coverage_winddeductible__377">' + L;
                xml += I3 + '<value>1000</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="acvxml3__377">' + L;
                xml += I3 + '<value>org.asicorp_RC</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="agentcode__343">' + L;
                xml += I3 + '<value>0057</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="cyber_common__343">' + L;
                xml += I3 + '<value>N</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="graduate__225">' + L;
                xml += I3 + '<value>N</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="agentid__35">' + L;
                xml += I3 + '<value>013575</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="producername__35">' + L;
                xml += I3 + '<value />' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="safeco_personalproperty__35">' + L;
                xml += I3 + '<value>No</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="agencycode__13">' + L;
                xml += I3 + '<value>0cfj97</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="coveragelevel__13">' + L;
                xml += I3 + '<value />' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="solarpanels__13">' + L;
                xml += I3 + '<value />' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="carstall__13">' + L;
                xml += I3 + '<value />' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="autopolicylimit__13">' + L;
                xml += I3 + '<value />' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="accidentsaz__13">' + L;
                xml += I3 + '<value>0</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I + '</ExtendedInfo>' + L;

                xml += I + '<ExtendedInfo name="ICQ|CARRIERSTAB|ST_WA">' + L;
                xml += I2 + '<valuepair name="coverage_winddeductible__377">' + L;
                xml += I3 + '<value>1157</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="acvxml3__377">' + L;
                xml += I3 + '<value>1157</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="agentcode__343">' + L;
                xml += I3 + '<value>1029</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="cyber_common__343">' + L;
                xml += I3 + '<value>1029</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="graduate__225">' + L;
                xml += I3 + '<value>835</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="agentid__35">' + L;
                xml += I3 + '<value>388</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="producername__35">' + L;
                xml += I3 + '<value>388</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="safeco_personalproperty__35">' + L;
                xml += I3 + '<value>388</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="agencycode__13">' + L;
                xml += I3 + '<value>429</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="coveragelevel__13">' + L;
                xml += I3 + '<value>429</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="solarpanels__13">' + L;
                xml += I3 + '<value>429</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="carstall__13">' + L;
                xml += I3 + '<value>429</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="autopolicylimit__13">' + L;
                xml += I3 + '<value>429</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="accidentsaz__13">' + L;
                xml += I3 + '<value>429</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="__completed__">' + L;
                xml += I3 + '<value>true</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="__carriers_list_at_last_run__">' + L;
                xml += I3 + '<value>1029,835,1157,388,429</value>' + L;
                xml += I2 + '</valuepair>' + L;
                xml += I2 + '<valuepair name="__last_run_datetime__">' + L;
                xml += I3 + `<value>${new Date().toISOString().split('.')[0]}</value>` + L;
                xml += I2 + '</valuepair>' + L;
                xml += I + '</ExtendedInfo>' + L;

                xml += '</EZHOME>' + L;

                return {
                    ok: true,
                    content: xml,
                    filename: `${lastName || 'Lead'}_EZLynx_Home.xml`,
                    mime: 'application/xml;charset=utf-8'
                };
            },

            toast(msg, duration, useHtml) {
                const t = document.getElementById('toast');
                if (useHtml) {
                    t.innerHTML = msg;
                } else {
                    t.innerText = msg;
                }
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), duration || 2500);
            },

            downloadFile(content, filename, mime) {
                const blob = new Blob([content], { type: mime });
                this.downloadBlob(blob, filename);
            },

            downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            },

            // --- Export History ---

            logExport(type, filename) {
                const clientName = `${this.data.firstName || ''} ${this.data.lastName || ''}`.trim() || 'Unknown';
                const entry = {
                    type,
                    filename,
                    clientName,
                    exportedAt: new Date().toISOString(),
                    qType: (document.querySelector('input[name="qType"]:checked') || {}).value || 'unknown'
                };
                // Save to localStorage
                const key = 'altech_export_history';
                let history = [];
                try { history = JSON.parse(localStorage.getItem(key) || '[]'); } catch (e) {}
                history.unshift(entry);
                history = history.slice(0, 200);
                localStorage.setItem(key, JSON.stringify(history));
                // Also save to disk (fire-and-forget)
                fetch('/local/export-history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                }).catch(() => {});
            },

            async loadExportHistory() {
                const container = document.getElementById('exportHistoryList');
                if (!container) return;
                // Try disk first, fall back to localStorage
                let entries = [];
                try {
                    const res = await fetch('/local/export-history');
                    if (res.ok) {
                        const data = await res.json();
                        entries = data.entries || [];
                    }
                } catch (e) {}
                if (entries.length === 0) {
                    try { entries = JSON.parse(localStorage.getItem('altech_export_history') || '[]'); } catch (e) {}
                }
                if (entries.length === 0) {
                    container.innerHTML = '<p style="color:var(--text-secondary);font-style:italic;">No exports yet. Export a file to see it here.</p>';
                    return;
                }
                const typeLabels = { CMSMTF: 'üìÇ HawkSoft', XML: 'üöó Auto XML', HomeXML: 'üè† Home XML', BothXML: 'üì¶ Both XML', PDF: 'üìÑ PDF', Text: 'üìù Text', CSV: 'üìä CSV' };
                container.innerHTML = `
                    <div style="max-height:300px;overflow-y:auto;">
                        <table style="width:100%;border-collapse:collapse;font-size:13px;">
                            <thead><tr style="text-align:left;border-bottom:1px solid var(--border);">
                                <th style="padding:6px 8px;">Type</th>
                                <th style="padding:6px 8px;">Client</th>
                                <th style="padding:6px 8px;">File</th>
                                <th style="padding:6px 8px;">Date</th>
                            </tr></thead>
                            <tbody>
                                ${entries.slice(0, 50).map(e => {
                                    const d = new Date(e.exportedAt);
                                    const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                                    return `<tr style="border-bottom:1px solid color-mix(in srgb, var(--border) 50%, transparent);">
                                        <td style="padding:6px 8px;white-space:nowrap;">${typeLabels[e.type] || this._escapeAttr(e.type || '')}</td>
                                        <td style="padding:6px 8px;font-weight:500;">${this._escapeAttr(e.clientName || '')}</td>
                                        <td style="padding:6px 8px;font-family:monospace;font-size:12px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${this._escapeAttr(e.filename || '')}</td>
                                        <td style="padding:6px 8px;white-space:nowrap;color:var(--text-secondary);">${dateStr}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top:8px;text-align:right;">
                        <button class="btn btn-tertiary" onclick="if(confirm('Clear export history?')){localStorage.removeItem('altech_export_history');fetch('/local/export-history',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})}).catch(()=>{});App.loadExportHistory();}">Clear History</button>
                    </div>
                `;
            },

            // === CLIENT HISTORY ===
            clientHistoryKey: 'altech_client_history',

            getClientHistory() {
                try {
                    return JSON.parse(localStorage.getItem(this.clientHistoryKey)) || [];
                } catch (e) {
                    console.warn('[ClientHistory] Corrupt JSON:', e);
                    return [];
                }
            },

            saveClientHistory(clients) {
                safeSave(this.clientHistoryKey, JSON.stringify(clients));
            },

            getClientSummary(data) {
                const parts = [];
                const qType = (data.qType || '').toLowerCase();
                if (qType === 'home' || qType === 'both') parts.push('Home');
                const vehicleCount = (data.vehicles && data.vehicles.length) || 0;
                if (qType === 'auto' || qType === 'both') {
                    parts.push(vehicleCount ? `${vehicleCount} Car${vehicleCount > 1 ? 's' : ''}` : 'Auto');
                }
                return parts.join(', ') || 'Quote';
            },

            saveClient() {
                const snapshot = JSON.parse(JSON.stringify(this.data || {}));
                const firstName = (snapshot.firstName || '').trim();
                const lastName = (snapshot.lastName || '').trim();
                if (!firstName && !lastName) {
                    this.toast('‚ö†Ô∏è Enter a client name before saving');
                    return;
                }
                const clients = this.getClientHistory();
                const id = `ch_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
                const name = [firstName, lastName].filter(Boolean).join(' ');
                clients.unshift({
                    id,
                    name,
                    summary: this.getClientSummary(snapshot),
                    savedAt: new Date().toISOString(),
                    data: snapshot
                });
                // Cap at 50 entries
                if (clients.length > 50) clients.length = 50;
                this.saveClientHistory(clients);
                this.renderClientHistory();
                this.toast(`‚úÖ ${name} saved to Client History`);
            },

            loadClientFromHistory(id) {
                const clients = this.getClientHistory();
                const client = clients.find(c => c.id === id);
                if (!client) return;
                this.applyData(client.data);
                // Persist loaded data
                if (this.encryptionEnabled) {
                    CryptoHelper.encrypt(this.data).then(encrypted => safeSave(this.storageKey, encrypted));
                } else {
                    safeSave(this.storageKey, JSON.stringify(this.data));
                }
                this.toast(`‚úÖ Restored ${client.name}`);
            },

            autoSaveClient() {
                const snapshot = JSON.parse(JSON.stringify(this.data || {}));
                const firstName = (snapshot.firstName || '').trim();
                const lastName = (snapshot.lastName || '').trim();
                if (!firstName && !lastName) return; // No name = nothing to save

                const clients = this.getClientHistory();
                const name = [firstName, lastName].filter(Boolean).join(' ');

                // Dedup: update existing entry if same name + address combo
                const addr = `${snapshot.addrStreet || ''} ${snapshot.addrCity || ''} ${snapshot.addrState || ''}`.trim().toLowerCase();
                const existingIdx = clients.findIndex(c => {
                    const cName = (c.name || '').toLowerCase();
                    const cAddr = `${c.data.addrStreet || ''} ${c.data.addrCity || ''} ${c.data.addrState || ''}`.trim().toLowerCase();
                    return cName === name.toLowerCase() && addr && cAddr === addr;
                });

                if (existingIdx >= 0) {
                    // Update existing entry with latest data
                    clients[existingIdx].data = snapshot;
                    clients[existingIdx].summary = this.getClientSummary(snapshot);
                    clients[existingIdx].savedAt = new Date().toISOString();
                    // Move to top
                    const [updated] = clients.splice(existingIdx, 1);
                    clients.unshift(updated);
                } else {
                    // New client ‚Äî add to top
                    const id = `ch_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
                    clients.unshift({
                        id,
                        name,
                        summary: this.getClientSummary(snapshot),
                        savedAt: new Date().toISOString(),
                        data: snapshot
                    });
                }

                // Cap at 50 entries
                if (clients.length > 50) clients.length = 50;
                this.saveClientHistory(clients);
                this.renderClientHistory();
                // Schedule cloud sync
                if (typeof CloudSync !== 'undefined') {
                    try { CloudSync.schedulePush(); } catch(e) { /* ok */ }
                }
            },

            deleteClientFromHistory(id) {
                const clients = this.getClientHistory();
                const filtered = clients.filter(c => c.id !== id);
                this.saveClientHistory(filtered);
                this.renderClientHistory();
                this.toast('üóëÔ∏è Client removed');
                if (typeof CloudSync !== 'undefined') {
                    try { CloudSync.schedulePush(); } catch(e) { /* ok */ }
                }
            },

            startFresh() {
                this.data = {};
                this.drivers = [];
                this.vehicles = [];
                // Clear all form inputs
                document.querySelectorAll('#mainContainer input, #mainContainer select, #mainContainer textarea').forEach(el => {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = false;
                    } else {
                        el.value = '';
                    }
                });
                // Save empty state
                safeSave(this.storageKey, JSON.stringify(this.data));
                this.handleType();
                this.next();
                this.toast('‚ú® Fresh form ready');
            },

            renderStep0ClientHistory() {
                const container = document.getElementById('step0ClientHistoryList');
                if (!container) return;
                const clients = this.getClientHistory().slice(0, 5);
                if (!clients.length) {
                    container.innerHTML = '<div class="hint" style="text-align:center;padding:12px 0;">No previous clients yet</div>';
                    return;
                }
                container.innerHTML = '<div style="font-weight:600;font-size:13px;color:var(--text-secondary);margin-bottom:8px;">Recent Clients</div>' +
                    clients.map(c => {
                        const date = new Date(c.savedAt).toLocaleDateString();
                        const addr = [c.data.addrCity, c.data.addrState].filter(Boolean).join(', ');
                        return `<div class="ch-row">
                            <div class="ch-info">
                                <span class="ch-name">${this.escapeHTML(c.name)}</span>
                                <span class="ch-meta">${this.escapeHTML(c.summary)}${addr ? ' ‚Ä¢ ' + this.escapeHTML(addr) : ''} ‚Ä¢ ${date}</span>
                            </div>
                            <div class="ch-actions">
                                <button class="btn btn-primary btn-sm" onclick="App.loadClientFromHistory('${c.id}'); App.next();">Restore</button>
                            </div>
                        </div>`;
                    }).join('');
            },

            renderClientHistory() {
                const container = document.getElementById('clientHistoryList');
                if (!container) return;
                const clients = this.getClientHistory();
                if (!clients.length) {
                    container.innerHTML = '<div class="hint" style="text-align:center;padding:24px 0;">No saved clients yet.<br>Clients are saved automatically when you complete the form.</div>';
                    return;
                }
                container.innerHTML = clients.map(c => {
                    const date = new Date(c.savedAt).toLocaleDateString();
                    const addr = [c.data.addrCity, c.data.addrState].filter(Boolean).join(', ');
                    return `<div class="ch-row">
                        <div class="ch-info">
                            <span class="ch-name">${this.escapeHTML(c.name)}</span>
                            <span class="ch-meta">${this.escapeHTML(c.summary)}${addr ? ' ‚Ä¢ ' + this.escapeHTML(addr) : ''} ‚Ä¢ ${date}</span>
                        </div>
                        <div class="ch-actions">
                            <button class="btn btn-primary btn-sm" onclick="App.loadClientFromHistory('${c.id}')">Restore</button>
                            <button class="btn btn-tertiary btn-sm" onclick="App.deleteClientFromHistory('${c.id}')">‚úï</button>
                        </div>
                    </div>`;
                }).join('');
            },

            escapeHTML(str) {
                if (!str) return '';
                const d = document.createElement('div');
                d.textContent = str;
                return d.innerHTML;
            },

            async getQuotes() {
                const encrypted = localStorage.getItem(this.quotesKey);
                if (!encrypted) return [];
                
                if (this.encryptionEnabled) {
                    const decrypted = await CryptoHelper.decrypt(encrypted);
                    return decrypted || [];
                } else {
                    try { return JSON.parse(encrypted); }
                    catch (e) { console.warn('[getQuotes] Corrupt JSON:', e); return []; }
                }
            },

            async saveQuotes(quotes) {
                if (this.encryptionEnabled) {
                    const encrypted = await CryptoHelper.encrypt(quotes);
                    safeSave(this.quotesKey, encrypted);
                } else {
                    safeSave(this.quotesKey, JSON.stringify(quotes));
                }
            },

            getQuoteTitle(data) {
                const lastName = data.lastName?.trim();
                const firstName = data.firstName?.trim();
                const name = lastName ? `${lastName}, ${firstName || ''}`.trim() : (firstName || `Draft - ${new Date().toLocaleDateString()}`);
                const type = (data.qType || 'quote').toUpperCase();
                return `${name} ‚Ä¢ ${type}`;
            },

            getQuoteMeta(quote) {
                const updated = new Date(quote.updatedAt).toLocaleString();
                return `Updated ${updated}`;
            },

            async autoSaveCurrentQuote() {
                const snapshot = JSON.parse(JSON.stringify(this.data || {}));
                const quotes = await this.getQuotes();
                const autoId = 'current_draft';
                
                // Remove any existing auto-saved draft
                const filtered = quotes.filter(q => q.id !== autoId);
                
                // Add current data as auto-selected draft at top
                const baseTitle = this.getQuoteTitle(snapshot);
                const title = `${baseTitle} (Current Draft)`;
                filtered.unshift({ id: autoId, title, data: snapshot, updatedAt: new Date().toISOString() });
                await this.saveQuotes(filtered);
                this.selectedQuoteIds.add(autoId);
                await this.renderQuoteList();
                
                // Auto-select the current draft
                setTimeout(() => {
                    const checkbox = document.querySelector(`.quote-checkbox[data-id="${autoId}"]`);
                    if (checkbox) checkbox.checked = true;
                }, 50);
            },

            async saveQuote() {
                const snapshot = JSON.parse(JSON.stringify(this.data || {}));
                const quotes = await this.getQuotes();
                
                // Check for duplicates based on address
                const address = `${snapshot.addrStreet || ''} ${snapshot.addrCity || ''} ${snapshot.addrState || ''}`.trim().toLowerCase();
                const duplicates = quotes.filter(q => {
                    const qAddr = `${q.data.addrStreet || ''} ${q.data.addrCity || ''} ${q.data.addrState || ''}`.trim().toLowerCase();
                    return qAddr && address && qAddr === address;
                });
                
                // Show duplicate warning modal if found
                if (duplicates.length > 0) {
                    const confirmed = await this.showDuplicateWarning(duplicates);
                    if (!confirmed) return; // User canceled
                }
                
                const id = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
                const title = this.getQuoteTitle(snapshot);
                quotes.unshift({ 
                    id, 
                    title, 
                    data: snapshot, 
                    updatedAt: new Date().toISOString(),
                    starred: false,
                    isDuplicate: duplicates.length > 0
                });
                await this.saveQuotes(quotes);
                await this.renderQuoteList();
                this.toast('‚úÖ Draft saved to library');
            },

            async loadQuote(id) {
                const quotes = await this.getQuotes();
                const quote = quotes.find(q => q.id === id);
                if (!quote) return;
                this.applyData(quote.data);
                
                // Save loaded data with encryption
                if (this.encryptionEnabled) {
                    const encrypted = await CryptoHelper.encrypt(this.data);
                    safeSave(this.storageKey, encrypted);
                } else {
                    safeSave(this.storageKey, JSON.stringify(this.data));
                }
                this.toast('‚úÖ Draft loaded');
            },

            async deleteQuote(id) {
                const quotes = await this.getQuotes();
                const filtered = quotes.filter(q => q.id !== id);
                await this.saveQuotes(filtered);
                this.selectedQuoteIds.delete(id);
                await this.renderQuoteList();
                this.toast('üóëÔ∏è Draft removed');
            },

            async renameQuote(id) {
                const quotes = await this.getQuotes();
                const quote = quotes.find(q => q.id === id);
                if (!quote) return;
                const next = prompt('Rename draft', quote.title);
                if (next === null) return;
                quote.title = next.trim() || quote.title;
                quote.updatedAt = new Date().toISOString();
                await this.saveQuotes(quotes);
                await this.renderQuoteList();
            },

            startNewDraft() {
                if (!confirm('Start a new draft? Current form will be cleared.')) return;
                localStorage.removeItem(this.storageKey);
                location.reload();
            },

            /**
             * Shows a session dialog when opening the intake tool with existing data.
             * Returns: 'continue' | 'fresh' | 'save-fresh'
             */
            _showIntakeSessionDialog() {
                return new Promise(resolve => {
                    // Check if there's meaningful data worth prompting about
                    const raw = localStorage.getItem(this.storageKey);
                    if (!raw) return resolve('continue'); // No data ‚Äî go straight to form
                    let parsed;
                    try { parsed = JSON.parse(raw); } catch { return resolve('continue'); }
                    const hasName = (parsed.firstName || '').trim() || (parsed.lastName || '').trim();
                    const hasAddress = (parsed.addrStreet || '').trim();
                    const hasType = (parsed.qType || '').trim();
                    if (!hasName && !hasAddress && !hasType) return resolve('continue'); // Trivial data

                    // Build display info
                    const name = [parsed.firstName, parsed.lastName].filter(Boolean).join(' ') || 'Unnamed client';
                    const type = (parsed.qType || '').toUpperCase() || 'QUOTE';
                    const addr = parsed.addrStreet ? `${parsed.addrStreet}, ${parsed.addrCity || ''} ${parsed.addrState || ''}`.replace(/,\s*$/, '') : '';

                    const overlay = document.createElement('div');
                    overlay.className = 'auth-modal-overlay';
                    overlay.id = 'intakeSessionDialog';
                    overlay.style.display = 'flex';
                    overlay.innerHTML = `
                        <div class="auth-modal intake-session-modal">
                            <div class="intake-session-icon">üìã</div>
                            <div class="auth-modal-header">
                                <h3>Existing Intake Found</h3>
                                <p class="auth-subtitle">You have an in-progress intake</p>
                            </div>
                            <div class="intake-session-preview">
                                <div class="intake-session-name">${this._escapeHTML(name)}</div>
                                <div class="intake-session-meta">
                                    ${type}${addr ? ' ¬∑ ' + this._escapeHTML(addr) : ''}
                                </div>
                            </div>
                            <div class="intake-session-actions">
                                <button class="btn-auth btn-auth-primary intake-session-btn" data-choice="continue">
                                    Continue Editing
                                </button>
                                <button class="btn-auth btn-auth-secondary intake-session-btn" data-choice="save-fresh">
                                    Save Draft & Start Fresh
                                </button>
                                <button class="btn-auth btn-auth-ghost intake-session-btn" data-choice="fresh">
                                    Discard & Start Fresh
                                </button>
                            </div>
                        </div>
                    `;

                    overlay.addEventListener('click', (e) => {
                        const btn = e.target.closest('[data-choice]');
                        if (!btn) return;
                        const choice = btn.dataset.choice;
                        overlay.remove();
                        resolve(choice);
                    });

                    document.body.appendChild(overlay);
                });
            },

            /** Save current form data as a named draft (used by session dialog) */
            async _saveCurrentAsDraft() {
                const raw = localStorage.getItem(this.storageKey);
                if (!raw) return;
                let snapshot;
                try { snapshot = JSON.parse(raw); } catch { return; }
                const quotes = await this.getQuotes();
                const id = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
                const title = this.getQuoteTitle(snapshot);
                quotes.unshift({
                    id,
                    title,
                    data: snapshot,
                    updatedAt: new Date().toISOString(),
                    starred: false
                });
                await this.saveQuotes(quotes);
                this.toast('üíæ Previous intake saved as draft');
            },

            _escapeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str || '';
                return div.innerHTML;
            },

            clearAllDrafts() {
                if (!confirm('Clear all saved drafts?')) return;
                localStorage.removeItem(this.quotesKey);
                this.selectedQuoteIds.clear();
                this.renderQuoteList();
                this.toast('üßπ Drafts cleared');
            },

            async renderQuoteList() {
                const list = document.getElementById('quoteList');
                if (!list) return;
                list.innerHTML = '';
                const quotes = await this.getQuotes();
                if (!quotes.length) {
                    const empty = document.createElement('div');
                    empty.className = 'hint';
                    empty.textContent = 'No drafts saved yet. Click ‚ÄúSave Draft‚Äù to create one.';
                    list.appendChild(empty);
                    return;
                }
                quotes.forEach(q => {
                    const row = document.createElement('div');
                    row.className = 'quote-card';
                    row.setAttribute('data-quote-id', q.id);
                    const addr = `${q.data.addrStreet || ''} ${q.data.addrCity || ''} ${q.data.addrState || ''}`.trim();
                    row.setAttribute('data-search-text', `${q.title} ${addr} ${this.getQuoteMeta(q)}`);

                    // Header with name and star
                    const header = document.createElement('div');
                    header.className = 'quote-card-header';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'quote-checkbox';
                    checkbox.dataset.id = q.id;
                    checkbox.checked = this.selectedQuoteIds.has(q.id);
                    checkbox.onchange = () => {
                        if (checkbox.checked) {
                            this.selectedQuoteIds.add(q.id);
                        } else {
                            this.selectedQuoteIds.delete(q.id);
                        }
                    };
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'quote-name';
                    nameSpan.textContent = q.title;
                    
                    const starBtn = document.createElement('button');
                    starBtn.className = 'quote-star';
                    starBtn.textContent = q.starred ? '‚≠ê' : '‚òÜ';
                    starBtn.title = q.starred ? 'Remove from favorites' : 'Add to favorites';
                    starBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.toggleQuoteStar(q.id);
                    };
                    
                    if (q.starred) row.classList.add('starred');
                    
                    header.appendChild(nameSpan);
                    header.appendChild(starBtn);
                    header.prepend(checkbox);

                    // Stats
                    const stats = document.createElement('div');
                    stats.className = 'quote-stats';
                    const statsText = this.getQuoteStats(q);
                    stats.innerHTML = statsText;

                    // Actions
                    const actions = document.createElement('div');
                    actions.className = 'quote-actions';

                    const loadBtn = document.createElement('button');
                    loadBtn.className = 'quote-action-btn';
                    loadBtn.textContent = 'üì• Load';
                    loadBtn.onclick = () => this.loadQuote(q.id);

                    const dupBtn = document.createElement('button');
                    dupBtn.className = 'quote-action-btn';
                    dupBtn.textContent = 'üìã Copy';
                    dupBtn.onclick = () => this.duplicateQuote(q.id);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'quote-action-btn delete';
                    deleteBtn.textContent = 'üóëÔ∏è Delete';
                    deleteBtn.onclick = () => this.deleteQuote(q.id);

                    actions.appendChild(loadBtn);
                    actions.appendChild(dupBtn);
                    actions.appendChild(deleteBtn);

                    row.appendChild(header);
                    row.appendChild(stats);
                    row.appendChild(actions);
                    list.appendChild(row);
                });

                // Also update Quick Start drafts panel
                this.renderQuickStartDrafts(quotes);
            },

            renderQuickStartDrafts(quotes) {
                const card = document.getElementById('quickStartDraftsCard');
                const container = document.getElementById('quickStartDraftList');
                if (!card || !container) return;
                if (!quotes || !quotes.length) {
                    card.style.display = 'none';
                    container.innerHTML = '';
                    return;
                }
                card.style.display = '';
                container.innerHTML = '';
                quotes.slice(0, 10).forEach(q => {
                    const row = document.createElement('div');
                    row.className = 'qs-draft-row';
                    row.onclick = () => this.loadQuote(q.id);

                    const info = document.createElement('div');
                    info.className = 'qs-draft-info';
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'qs-draft-name';
                    nameSpan.textContent = q.title;
                    info.appendChild(nameSpan);
                    const meta = document.createElement('span');
                    meta.className = 'qs-draft-meta';
                    const qType = q.qType ? q.qType.toUpperCase() : '';
                    const dateStr = q.timestamp ? new Date(q.timestamp).toLocaleDateString() : '';
                    meta.textContent = [qType, dateStr].filter(Boolean).join(' ¬∑ ');
                    info.appendChild(meta);

                    const delBtn = document.createElement('button');
                    delBtn.className = 'qs-draft-delete';
                    delBtn.textContent = '‚úï';
                    delBtn.title = 'Delete draft';
                    delBtn.onclick = (e) => { e.stopPropagation(); if (confirm('Delete "' + q.title + '"?')) this.deleteQuote(q.id); };

                    row.appendChild(info);
                    row.appendChild(delBtn);
                    container.appendChild(row);
                });
            },

            filterQuotes(searchTerm) {
                const term = (searchTerm || '').toLowerCase();
                const cards = document.querySelectorAll('[data-quote-id]');
                cards.forEach(card => {
                    const text = (card.getAttribute('data-search-text') || '').toLowerCase();
                    card.style.display = text.includes(term) ? '' : 'none';
                });
            },

            selectAllQuotes() {
                this.getQuotes().then(quotes => {
                    this.selectedQuoteIds = new Set(quotes.map(q => q.id));
                    this.renderQuoteList();
                    this.toast('‚úÖ All drafts selected');
                });
            },

            clearQuoteSelection() {
                this.selectedQuoteIds.clear();
                this.renderQuoteList();
                this.toast('‚úñ Selection cleared');
            },
            
            async toggleQuoteStar(quoteId) {
                const quotes = await this.getQuotes();
                const quote = quotes.find(q => q.id === quoteId);
                if (!quote) return;
                quote.starred = !quote.starred;
                quote.updatedAt = new Date().toISOString();
                await this.saveQuotes(quotes);
                await this.renderQuoteList();
                this.toast(quote.starred ? '‚≠ê Added to favorites' : '‚òÜ Removed from favorites');
            },
            
            showDuplicateWarning(duplicates) {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay active';
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            modal.remove();
                            resolve(false);
                        }
                    };
                    
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <span class="modal-icon">‚ö†Ô∏è</span>
                                <h2 class="modal-title">Possible Duplicate</h2>
                            </div>
                            <div class="modal-body">
                                <p>We found ${duplicates.length} similar quote(s) for this address:</p>
                                <ul style="margin: 12px 0; padding-left: 20px;">
                                    ${duplicates.map(d => `<li><strong>${this._escapeAttr(d.title)}</strong> - ${new Date(d.updatedAt).toLocaleDateString()}</li>`).join('')}
                                </ul>
                                <p>Do you want to save this as a new quote anyway?</p>
                            </div>
                            <div class="modal-actions">
                                <button class="modal-btn modal-btn-secondary" id="dup-cancel-btn">Cancel</button>
                                <button class="modal-btn modal-btn-primary" id="dup-save-btn">Save Anyway</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    modal.querySelector('#dup-cancel-btn').addEventListener('click', () => {
                        modal.remove();
                        resolve(false);
                    });
                    modal.querySelector('#dup-save-btn').addEventListener('click', () => {
                        modal.remove();
                        resolve(true);
                    });
                });
            },
            
            async duplicateQuote(quoteId) {
                const quotes = await this.getQuotes();
                const quote = quotes.find(q => q.id === quoteId);
                if (!quote) return;
                
                // Check for duplicate addresses
                const copiedAddr = `${quote.data.addrStreet || ''} ${quote.data.addrCity || ''}`.trim();
                const hasDuplicate = quotes.some(q => q.id !== quoteId && 
                    `${q.data.addrStreet || ''} ${q.data.addrCity || ''}`.trim() === copiedAddr && 
                    copiedAddr);
                
                if (hasDuplicate && !confirm('‚ö†Ô∏è A quote with this address already exists. Continue copying?')) {
                    return;
                }
                
                // Copy property data, clear personal info
                const newData = JSON.parse(JSON.stringify(quote.data));
                newData.firstName = '';
                newData.lastName = '';
                newData.email = '';
                newData.phone = '';
                newData.dob = '';
                
                this.data = newData;
                this.save();
                this.updateUI();
                this.renderQuoteList();
                this.toast('üìã Draft copied! (personal info cleared)');
            },
            
            getQuoteStats(q) {
                const d = q.data || {};
                    const badges = [];
                
                    // Coverage type badge
                    if (d.qType) {
                        const typeClass = d.qType === 'home' ? 'badge-home' : (d.qType === 'auto' ? 'badge-auto' : 'badge-both');
                        badges.push(`<span class="quote-badge ${typeClass}">${d.qType.toUpperCase()}</span>`);
                    }
                
                    // Duplicate indicator
                    if (q.isDuplicate) {
                        badges.push(`<span class="quote-badge badge-duplicate">‚ö†Ô∏è DUPLICATE</span>`);
                    }
                
                    // Multi-driver/vehicle badges
                    if (d.drivers && d.drivers.length > 0) {
                        badges.push(`<span class="quote-badge" style="background: rgba(142, 142, 147, 0.12); color: #636366;">üë§ ${d.drivers.length} driver${d.drivers.length > 1 ? 's' : ''}</span>`);
                    }
                    if (d.vehicles && d.vehicles.length > 0) {
                        badges.push(`<span class="quote-badge" style="background: rgba(142, 142, 147, 0.12); color: #636366;">üöó ${d.vehicles.length} vehicle${d.vehicles.length > 1 ? 's' : ''}</span>`);
                    }
                
                    // Property/location info
                    const details = [];
                    if (d.addrCity && d.addrState) details.push(`üìç ${d.addrCity}, ${d.addrState}`);
                    if (d.yrBuilt) details.push(`üè† ${d.yrBuilt}`);
                
                const updatedTime = new Date(q.updatedAt || q.timestamp).toLocaleDateString();
                    details.push(`üïê ${updatedTime}`);
                
                    return badges.join('') + '<br><span style="font-size: 12px; color: var(--text-secondary);">' + details.join(' ‚Ä¢ ') + '</span>';
            },

            getSelectedQuoteIds() {
                if (this.selectedQuoteIds && this.selectedQuoteIds.size) {
                    return Array.from(this.selectedQuoteIds);
                }
                return Array.from(document.querySelectorAll('.quote-checkbox:checked'))
                    .map(cb => cb.dataset.id);
            },

            sanitizeFilename(name) {
                return name.replace(/[^a-z0-9\-_. ]/gi, '').replace(/\s+/g, '_').slice(0, 80) || 'quote';
            },

            async exportSelectedZip() {
                if (!window.JSZip) {
                    this.toast('‚ö†Ô∏è ZIP export unavailable.');
                    return;
                }
                const ids = this.getSelectedQuoteIds();
                if (!ids.length) {
                    this.toast('‚ö†Ô∏è Select drafts to export.');
                    return;
                }
                const quotes = (await this.getQuotes()).filter(q => ids.includes(q.id));
                const zip = new JSZip();
                const errors = [];

                for (const q of quotes) {
                    const folderName = this.sanitizeFilename(q.title);
                    const folder = zip.folder(folderName);

                    // Auto XML
                    const qType = q.qType || q.data?.qType || 'both';
                    if (qType === 'auto' || qType === 'both') {
                        const xml = this.buildXML(q.data);
                        if (xml.ok) {
                            folder.file(xml.filename, xml.content);
                        } else {
                            errors.push(`${q.title}: Auto XML - ${xml.error.replace('‚ö†Ô∏è ', '')}`);
                        }
                    }

                    // Home XML
                    if (qType === 'home' || qType === 'both') {
                        const homeXml = this.buildHomeXML(q.data);
                        if (homeXml.ok) {
                            folder.file(homeXml.filename, homeXml.content);
                        } else {
                            errors.push(`${q.title}: Home XML - ${homeXml.error.replace('‚ö†Ô∏è ', '')}`);
                        }
                    }

                    const cmsmtf = this.buildCMSMTF(q.data);
                    folder.file(cmsmtf.filename, cmsmtf.content);

                    const csv = this.buildCSV(q.data);
                    folder.file(csv.filename, csv.content);

                    const pdf = await this.buildPDF(q.data);
                    folder.file(pdf.filename, pdf.blob);
                }

                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const zipName = `Altech_Quotes_${new Date().toISOString().split('T')[0]}.zip`;
                this.downloadBlob(zipBlob, zipName);

                if (errors.length) {
                    this.toast('‚ö†Ô∏è Some XML exports were skipped.');
                    console.warn('ZIP export warnings:', errors);
                } else {
                    this.toast('üì¶ ZIP downloaded');
                }
            },

            async exportAllZip() {
                const quotes = await this.getQuotes();
                if (!quotes.length) {
                    this.toast('‚ö†Ô∏è No drafts to export.');
                    return;
                }
                this.selectedQuoteIds = new Set(quotes.map(q => q.id));
                await this.renderQuoteList();
                await this.exportSelectedZip();
            },
            
            reset() {
                if(confirm("Delete all data and start over?")) {
                    localStorage.removeItem(this.storageKey);
                    location.reload();
                }
            },

            blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1]; // Remove data:application/zip;base64, prefix
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            },

            // PLUGIN NAVIGATION
            updateBackButtonVisibility() {
                const backButton = document.getElementById('backToHome');
                if (!backButton) return;

                const containers = document.querySelectorAll('.plugin-container');
                const anyActive = Array.from(containers).some(container => {
                    if (container.classList.contains('active')) return true;
                    return window.getComputedStyle(container).display !== 'none';
                });

                backButton.style.display = anyActive ? 'flex' : 'none';
                document.body.classList.toggle('tool-active', anyActive);
                this.updateBreadcrumb();
            },

            getActiveToolKey() {
                const toolMap = {
                    quoting: 'quotingTool',
                    coi: 'coiTool',
                    prospect: 'prospectTool',
                    compliance: 'complianceTool',
                    qna: 'qnaTool',
                    email: 'emailTool',
                    quickref: 'quickrefTool',
                    accounting: 'accountingTool',
                    ezlynx: 'ezlynxTool',
                    quotecompare: 'quoteCompareTool'
                };

                return Object.keys(toolMap).find(key => {
                    const el = document.getElementById(toolMap[key]);
                    if (!el) return false;
                    if (el.classList.contains('active')) return true;
                    return window.getComputedStyle(el).display !== 'none';
                }) || '';
            },

            updateBreadcrumb() {
                const bar = document.getElementById('breadcrumbBar');
                if (!bar) return;

                const toolKey = this.getActiveToolKey();
                if (!toolKey) {
                    bar.style.display = 'none';
                    return;
                }

                const crumbs = [
                    '<a href="#home" onclick="App.goHome(); return false;" style="color:var(--apple-blue);text-decoration:none;">Home</a>',
                    this.toolNames[toolKey] || toolKey
                ];

                if (toolKey === 'quoting') {
                    const curId = this.flow?.[this.step];
                    const stepName = this.stepTitles?.[curId];
                    if (stepName) crumbs.push(stepName);
                }

                bar.innerHTML = crumbs.join(' <span style="opacity:0.4;">&rsaquo;</span> ');
                bar.style.display = 'flex';
            },

            observePluginVisibility() {
                const containers = document.querySelectorAll('.plugin-container');
                if (!containers.length) return;

                const observer = new MutationObserver(() => this.updateBackButtonVisibility());
                containers.forEach(container => {
                    observer.observe(container, {
                        attributes: true,
                        attributeFilter: ['class', 'style']
                    });
                });

                this.updateBackButtonVisibility();
            },

            async navigateTo(toolName, options = {}) {
                // Look up tool from config array (single source of truth)
                const entry = this.toolConfig.find(t => t.key === toolName);
                if (!entry) return;

                document.getElementById('landingPage').style.display = 'none';

                document.querySelectorAll('.plugin-container').forEach(tool => {
                    tool.classList.remove('active');
                    tool.style.display = 'none';
                });

                const tool = document.getElementById(entry.containerId);
                if (!tool) return;

                // Lazy-load plugin HTML from external file on first access
                if (entry.htmlFile && !tool.dataset.loaded) {
                    try {
                        const resp = await fetch(entry.htmlFile);
                        if (resp.ok) {
                            tool.innerHTML = await resp.text();
                            tool.dataset.loaded = 'true';
                        } else {
                            console.error('[navigateTo] Failed to load plugin HTML:', entry.htmlFile, resp.status);
                            tool.innerHTML = `<div style="padding:2rem;text-align:center;color:var(--text-secondary,#666)">
                                <p style="font-size:1.1rem;margin-bottom:1rem">‚ö†Ô∏è Failed to load ${entry.name || entry.key}</p>
                                <button onclick="delete this.closest('.plugin-container').dataset.loaded; App.navigateTo('${entry.key}')"
                                    style="padding:0.5rem 1.5rem;border-radius:8px;border:none;background:var(--apple-blue,#007AFF);color:#fff;cursor:pointer;font-size:0.95rem">
                                    Retry
                                </button>
                            </div>`;
                        }
                    } catch(e) {
                        console.error('[navigateTo] Error loading plugin HTML:', entry.htmlFile, e);
                        tool.innerHTML = `<div style="padding:2rem;text-align:center;color:var(--text-secondary,#666)">
                            <p style="font-size:1.1rem;margin-bottom:1rem">‚ö†Ô∏è Connection error loading ${entry.name || entry.key}</p>
                            <button onclick="delete this.closest('.plugin-container').dataset.loaded; App.navigateTo('${entry.key}')"
                                style="padding:0.5rem 1.5rem;border-radius:8px;border:none;background:var(--apple-blue,#007AFF);color:#fff;cursor:pointer;font-size:0.95rem">
                                Retry
                            </button>
                        </div>`;
                    }
                }

                tool.classList.add('active');
                tool.style.display = 'block';
                try {
                    // Quoting tool uses App.init(); all others use their module's init()
                    if (entry.key === 'quoting') {
                        if (!this.initialized) {
                            // Check for existing form data before init
                            const choice = await this._showIntakeSessionDialog();
                            if (choice === 'fresh') {
                                // Clear form data, then init blank
                                localStorage.removeItem(this.storageKey);
                                this.data = {};
                                this.drivers = [];
                                this.vehicles = [];
                                localStorage.removeItem('altech_drivers');
                                localStorage.removeItem('altech_vehicles');
                            } else if (choice === 'save-fresh') {
                                // Save current as draft, then clear
                                await this._saveCurrentAsDraft();
                                localStorage.removeItem(this.storageKey);
                                this.data = {};
                                this.drivers = [];
                                this.vehicles = [];
                                localStorage.removeItem('altech_drivers');
                                localStorage.removeItem('altech_vehicles');
                            }
                            // 'continue' ‚Äî just proceed with existing data
                            await this.init();
                        }
                    } else if (entry.initModule) {
                        const mod = window[entry.initModule];
                        if (mod?.init) await mod.init();
                    }
                } catch(e) {
                    console.error('[navigateTo] init error for', toolName, e);
                }

                if (options.syncHash !== false) {
                    const nextHash = `#${toolName}`;
                    if (window.location.hash !== nextHash) {
                        this._routerNavigating = true;
                        history.pushState(null, '', nextHash);
                        this._routerNavigating = false;
                    }
                }

                this.updateBackButtonVisibility();
                this.updateBreadcrumb();
                window.scrollTo(0, 0);
            },

            openTool(toolName) {
                this.navigateTo(toolName);
            },

            updateLandingGreeting() {
                const el = document.getElementById('landingGreeting');
                if (!el) return;
                const h = new Date().getHours();
                const greeting = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';

                // Use signed-in user's display name, fall back to prompt
                const user = typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser;
                if (user) {
                    const rawName = user.displayName || user.email.split('@')[0];
                    const name = rawName.charAt(0).toUpperCase() + rawName.slice(1);
                    el.textContent = greeting + ', ' + name;
                } else {
                    el.innerHTML = greeting + ' ‚òÄÔ∏è <a href="#" onclick="Auth.showModal(); return false;" style="color:var(--apple-blue);text-decoration:none;font-weight:600;">Sign in</a> for cloud sync';
                }
            },

            // Render landing page tool grid from toolConfig (config-driven)
            renderLandingTools() {
                const mainGrid = document.getElementById('toolsGrid');
                const quickrefGrid = document.getElementById('quickrefGrid');

                // Category labels for bento section headers
                const categoryLabels = {
                    quoting: 'Quoting & Sales',
                    docs: 'Documents & Compliance',
                    ops: 'Operations'
                };

                const renderCard = (t) => {
                    const badgeHtml = t.badge ? `<span class="tool-notify-badge" id="${t.badge}"></span>` : '';
                    const safeTitle = t.title.replace(/&/g, '&amp;');
                    return `<div class="tool-row" onclick="App.navigateTo('${t.key}')">
                        <div class="tool-icon ${t.color}">${t.icon}</div>${badgeHtml}
                        <div class="tool-row-content"><div class="tool-title">${safeTitle}</div></div>
                    </div>`;
                };

                if (mainGrid) {
                    const visible = this.toolConfig.filter(t => !t.hidden && t.section !== 'quickref');
                    // Group by category, preserving config order
                    const seen = [];
                    const groups = {};
                    visible.forEach(t => {
                        const cat = t.category || 'other';
                        if (!groups[cat]) { groups[cat] = []; seen.push(cat); }
                        groups[cat].push(t);
                    });
                    mainGrid.innerHTML = seen.map(cat => {
                        const label = categoryLabels[cat];
                        const cards = groups[cat].map(renderCard).join('');
                        return `<div class="bento-category" data-category="${cat}">
                            ${label ? `<h3 class="bento-label">${label}</h3>` : ''}
                            <div class="bento-cards">${cards}</div>
                        </div>`;
                    }).join('');
                }
                if (quickrefGrid) {
                    quickrefGrid.innerHTML = this.toolConfig
                        .filter(t => t.section === 'quickref')
                        .map(renderCard).join('');
                }
            },

            updateCGLBadge() {
                const badge = document.getElementById('cglBadge');
                if (!badge) return;
                try {
                    const raw = localStorage.getItem('altech_cgl_cache');
                    if (!raw) { badge.textContent = ''; badge.dataset.count = '0'; return; }
                    const cached = JSON.parse(raw);
                    const policies = cached.policies || [];
                    // Load state to check verified/dismissed
                    let verified = {}, dismissed = {};
                    const stateRaw = localStorage.getItem('altech_cgl_state');
                    if (stateRaw) {
                        const st = JSON.parse(stateRaw);
                        verified = st.verifiedPolicies || {};
                        dismissed = st.dismissedPolicies || {};
                    }
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    let urgent = 0;
                    policies.forEach(p => {
                        if (verified[p.policyNumber] || dismissed[p.policyNumber]) return;
                        if (!p.expirationDate) return;
                        const exp = new Date(p.expirationDate);
                        exp.setHours(0, 0, 0, 0);
                        const days = Math.round((exp - now) / 86400000);
                        if (days <= 14) urgent++;
                    });
                    badge.textContent = urgent > 0 ? String(urgent) : '';
                    badge.dataset.count = String(urgent);
                } catch (e) {
                    badge.textContent = '';
                    badge.dataset.count = '0';
                }
            },

            goHome() {
                // Hide all tools
                document.querySelectorAll('.plugin-container').forEach(tool => {
                    tool.classList.remove('active');
                    tool.style.display = 'none';
                });

                this.updateBackButtonVisibility();
                document.body.classList.remove('tool-active');
                const backButton = document.getElementById('backToHome');
                if (backButton) backButton.style.display = 'none';
                const breadcrumb = document.getElementById('breadcrumbBar');
                if (breadcrumb) breadcrumb.style.display = 'none';

                // Show landing page
                const lp = document.getElementById('landingPage');
                if (lp) lp.style.display = 'flex';

                // Update greeting
                this.updateLandingGreeting();

                // Update CGL badge
                this.updateCGLBadge();

                // Sync hash to #home (avoid re-trigger via _routerNavigating guard)
                if (window.location.hash !== '#home') {
                    this._routerNavigating = true;
                    history.replaceState(null, '', '#home');
                    this._routerNavigating = false;
                }

                // Scroll to top
                window.scrollTo(0, 0);
            }
        };
        window.initPlaces = () => App.initPlaces();

        // Expose App globally for testing and external tool access
        window.App = App;

        window.onload = async () => {
            // Apply dark mode preference FIRST ‚Äî before any tool rendering
            App.loadDarkMode();

            // Initialize cloud sync (non-blocking)
            if (typeof FirebaseConfig !== 'undefined' && FirebaseConfig.sdkLoaded) {
                FirebaseConfig.init().then(() => {
                    if (typeof Auth !== 'undefined') Auth.init();
                }).catch(e => console.warn('[App] Firebase init skipped:', e.message));
            }

            // Render landing page tools from config
            App.renderLandingTools();

            // Set landing greeting
            App.updateLandingGreeting();
            App.updateCGLBadge();

            // Show reminder badges + check for alerts
            if (typeof Reminders !== 'undefined') {
                Reminders.init();
                Reminders.checkAlerts();
            }

            // Don't auto-init the quoting tool anymore
            // It will init when user clicks the card
            App.observePluginVisibility();

            // ‚îÄ‚îÄ Hash Router: initial route ‚îÄ‚îÄ
            const hash = window.location.hash.replace('#', '');
            if (!hash || hash === 'home') {
                // Default to #home ‚Äî show dashboard
                if (window.location.hash !== '#home') {
                    history.replaceState(null, '', '#home');
                }
                App.goHome();
            } else {
                // Deep-link into a specific tool
                await App.navigateTo(hash, { syncHash: false });
            }

            // ‚îÄ‚îÄ Hash Router: handle back/forward & hash changes ‚îÄ‚îÄ
            window.addEventListener('hashchange', async () => {
                if (App._routerNavigating) return; // guard against programmatic hash sets
                const toolId = window.location.hash.replace('#', '');
                if (!toolId || toolId === 'home') {
                    App.goHome();
                } else {
                    await App.navigateTo(toolId, { syncHash: false });
                }
            });
        };
    </script>
    <script src="js/coi.js"></script>
    <script src="js/prospect.js"></script>

    </div> <!-- End quotingTool container -->

    <!-- COI GENERATOR TOOL CONTAINER -->
    <div id="coiTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- PROSPECT INVESTIGATOR TOOL CONTAINER -->
    <div id="prospectTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- CGL COMPLIANCE DASHBOARD CONTAINER -->
    <div id="complianceTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- POLICY Q&A ASSISTANT TOOL CONTAINER -->
    <div id="qnaTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- EMAIL COMPOSER TOOL CONTAINER -->
    <div id="emailTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- QUICK REFERENCE TOOL CONTAINER -->
    <div id="quickrefTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- ACCOUNTING EXPORT TOOL CONTAINER -->
    <div id="accountingTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- HAWKSOFT EXPORT TOOL CONTAINER -->
    <div id="hawksoftTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- VIN DECODER TOOL CONTAINER -->
    <div id="vinDecoderTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- EZLYNX QUOTER TOOL CONTAINER -->
    <div id="ezlynxTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- QUOTE COMPARE TOOL CONTAINER -->
    <div id="quoteCompareTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- TASK REMINDERS TOOL CONTAINER -->
    <div id="remindersTool" class="plugin-container">
        <!-- Plugin HTML loaded dynamically from plugins/ -->
    </div>

    <!-- Sync indicator toast -->
    <div id="syncIndicator" class="sync-indicator" style="display:none"></div>

    <!-- ‚ïê‚ïê Auth Modal ‚ïê‚ïê -->
    <div id="authModal" class="auth-modal-overlay" style="display:none">
        <div class="auth-modal">
            <button class="auth-close" onclick="Auth.closeModal()">&times;</button>

            <!-- Login View -->
            <div class="auth-view" data-auth-view="login" style="display:block">
                <div class="auth-brand">
                    <div class="auth-brand-logo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    </div>
                    <div class="auth-brand-name">Altech</div>
                </div>
                <div class="auth-modal-header">
                    <h3>Welcome Back</h3>
                    <p class="auth-subtitle">Sign in to sync your data across devices</p>
                </div>
                <form class="auth-form" onsubmit="Auth.handleLoginSubmit(event)">
                    <div class="auth-field">
                        <label for="authLoginEmail">Email</label>
                        <input type="email" id="authLoginEmail" placeholder="you@company.com" required autocomplete="email">
                    </div>
                    <div class="auth-field">
                        <label for="authLoginPassword">Password</label>
                        <input type="password" id="authLoginPassword" placeholder="Enter your password" required autocomplete="current-password">
                    </div>
                    <div class="auth-error" style="display:none"></div>
                    <button type="submit" class="btn-auth btn-auth-primary">Sign In</button>
                </form>
                <div class="auth-links">
                    <button type="button" class="auth-link" onclick="Auth.switchView('signup')">Create account</button>
                    <button type="button" class="auth-link" onclick="Auth.switchView('reset')">Forgot password?</button>
                </div>
            </div>

            <!-- Signup View -->
            <div class="auth-view" data-auth-view="signup" style="display:none">
                <div class="auth-brand">
                    <div class="auth-brand-logo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    </div>
                    <div class="auth-brand-name">Altech</div>
                </div>
                <div class="auth-modal-header">
                    <h3>Create Account</h3>
                    <p class="auth-subtitle">Get started with cloud sync for your team</p>
                </div>
                <form class="auth-form" onsubmit="Auth.handleSignupSubmit(event)">
                    <div class="auth-field">
                        <label for="authSignupName">Display Name</label>
                        <input type="text" id="authSignupName" placeholder="Your name" autocomplete="name">
                    </div>
                    <div class="auth-field">
                        <label for="authSignupEmail">Email</label>
                        <input type="email" id="authSignupEmail" placeholder="you@company.com" required autocomplete="email">
                    </div>
                    <div class="auth-field">
                        <label for="authSignupPassword">Password</label>
                        <input type="password" id="authSignupPassword" placeholder="At least 6 characters" required minlength="6" autocomplete="new-password">
                    </div>
                    <div class="auth-field">
                        <label for="authSignupConfirm">Confirm Password</label>
                        <input type="password" id="authSignupConfirm" placeholder="Re-enter your password" required minlength="6" autocomplete="new-password">
                    </div>
                    <div class="auth-error" style="display:none"></div>
                    <button type="submit" class="btn-auth btn-auth-primary">Create Account</button>
                </form>
                <div class="auth-links">
                    <button type="button" class="auth-link" onclick="Auth.switchView('login')">Already have an account? Sign in</button>
                </div>
            </div>

            <!-- Reset Password View -->
            <div class="auth-view" data-auth-view="reset" style="display:none">
                <div class="auth-modal-header">
                    <h3>Reset Password</h3>
                    <p class="auth-subtitle">Enter your email and we'll send you a reset link</p>
                </div>
                <form class="auth-form" onsubmit="Auth.handleResetSubmit(event)">
                    <div class="auth-field">
                        <label for="authResetEmail">Email Address</label>
                        <input type="email" id="authResetEmail" placeholder="you@company.com" required autocomplete="email">
                    </div>
                    <div class="auth-error" style="display:none"></div>
                    <div class="auth-success" style="display:none"></div>
                    <button type="submit" class="btn-auth btn-auth-primary">Send Reset Link</button>
                </form>
                <div class="auth-links">
                    <button type="button" class="auth-link" onclick="Auth.switchView('login')">Back to sign in</button>
                </div>
            </div>

            <!-- Account View (signed in) -->
            <div class="auth-view" data-auth-view="account" style="display:none">
                <div class="auth-modal-header">
                    <div class="auth-account-avatar" id="authAccountAvatar">A</div>
                    <h3>Your Account</h3>
                </div>
                <div class="auth-account-info">
                    <div class="auth-field">
                        <label>Email</label>
                        <p id="authAccountEmail" class="auth-readonly"></p>
                    </div>
                    <div class="auth-field">
                        <label for="authAccountName">Display Name</label>
                        <div style="display:flex;gap:0.5rem;align-items:stretch">
                            <input type="text" id="authAccountName" placeholder="Your name" style="flex:1">
                            <button class="btn-auth btn-auth-small btn-auth-secondary" onclick="Auth.updateName(document.getElementById('authAccountName').value)" style="white-space:nowrap">Update</button>
                        </div>
                    </div>
                    <div class="auth-divider">sync</div>
                    <div class="auth-sync-status">
                        <span id="authSyncStatus">Ready to sync</span>
                        <button class="btn-auth btn-auth-small btn-auth-primary" style="margin-top:0;width:auto;padding:0.4rem 1rem" onclick="CloudSync.fullSync()">Sync Now</button>
                    </div>
                </div>
                <div class="auth-account-actions">
                    <button class="btn-auth btn-auth-secondary" onclick="Auth.logout()">Sign Out</button>
                    <button class="btn-auth btn-auth-danger btn-auth-small" onclick="CloudSync.deleteCloudData()">Delete Cloud Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plugin scripts (loaded after DOM) -->
    <script src="js/quick-ref.js"></script>
    <script src="js/accounting-export.js"></script>
    <script src="js/compliance-dashboard.js?v=20260217j"></script>
    <script src="js/ezlynx-tool.js"></script>
    <script src="js/quote-compare.js"></script>
    <script src="js/email-composer.js"></script>
    <script src="js/policy-qa.js"></script>
    <script src="js/reminders.js"></script>
    <script src="js/hawksoft-export.js"></script>
    <script src="js/vin-decoder.js"></script>

<script src="js/data-backup.js"></script>
<script src="js/firebase-config.js"></script>
<script src="js/auth.js"></script>
<script src="js/cloud-sync.js"></script>

</body>
</html>
