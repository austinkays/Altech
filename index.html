<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230066cc' width='100' height='100'/><text y='70' x='50' text-anchor='middle' font-size='60' fill='white'>AL</text></svg>">
    <title>Altech Field Lead</title>
    <script src="validation.js"></script>
    <style>
        /* === APPLE-INSPIRED THEME === */
        :root {
            --apple-blue: #007AFF;
            --apple-blue-hover: #0051D5;
            --apple-gray: #8E8E93;
            --success: #34C759;
            --danger: #FF3B30;
            --bg: #F2F2F7;
            --bg-card: #FFFFFF;
            --bg-input: #F2F2F7;
            --text: #000000;
            --text-secondary: #8E8E93;
            --border: #E5E5EA;
            --shadow: rgba(0, 0, 0, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overscroll-behavior-y: none;
            font-weight: 400;
        }

        /* === HEADER === */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: calc(env(safe-area-inset-top) + 16px) 20px 16px;
            border-bottom: 1px solid var(--border);
            z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 22px; }
        .logo-icon { width: 40px; height: 40px; background: var(--apple-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; color: white; }
        .save-indicator { font-size: 13px; color: var(--success); opacity: 0; transition: opacity 0.3s; font-weight: 500; }
        .step-title { font-size: 14px; color: var(--text-secondary); font-weight: 600; text-align: center; margin-bottom: 8px; }
        
        .progress-track { height: 3px; background: var(--border); border-radius: 1.5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--apple-blue); width: 0%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        /* === MAIN === */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; -webkit-overflow-scrolling: touch; }
        .hidden { display: none !important; }
        .card { background: var(--bg-card); border: none; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06); }
        h2 { font-size: 20px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
        h3 { font-size: 17px; font-weight: 600; margin: 24px 0 12px; color: var(--text); }
        .section-subtitle { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; font-weight: 400; }
        
        /* === INPUTS === */
        input, select, textarea {
            width: 100%; padding: 14px 16px; font-size: 17px !important; 
            background: var(--bg-input); border: none; border-radius: 10px; 
            color: var(--text); margin-bottom: 12px; transition: all 0.2s;
            font-family: inherit;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            background: var(--bg-card);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15), 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .label { font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        
        /* === QUOTE LIBRARY SEARCH === */
        .quote-search-container { margin-bottom: 16px; }
        .quote-search-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 15px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            transition: all 0.2s;
            font-family: inherit;
        }
        .quote-search-input:focus {
            outline: none;
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        .quote-card {
            background: var(--bg-card);
            border: 1.5px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.2s;
            position: relative;
        }
        .quote-card:hover {
            border-color: var(--apple-blue);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
        }
        .quote-card.starred {
            border-color: var(--apple-blue);
            background: rgba(0, 122, 255, 0.02);
        }
        .quote-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }
        .quote-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 6px;
            accent-color: var(--apple-blue);
            cursor: pointer;
        }
        .quote-name { font-weight: 600; font-size: 14px; color: var(--text); }
        .quote-star {
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s;
            background: none;
            border: none;
            padding: 0;
        }
        .quote-star:hover { transform: scale(1.2); }
        .quote-stats {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .quote-stat-item { display: inline-block; margin-right: 12px; }
        .quote-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .quote-action-btn {
            flex: 1;
            min-width: 60px;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 600;
            background: var(--bg-input);
            color: var(--apple-blue);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .quote-action-btn:hover {
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--apple-blue);
        }
        .quote-action-btn.delete {
            color: #ff3b30;
            border-color: #ff3b30;
        }
        .quote-action-btn.delete:hover { background: rgba(255, 59, 48, 0.1); }
        
        /* === UTILITY BUTTONS === */
        .utility-buttons { display: flex; gap: 8px; margin-top: 8px; }
        .btn-utility {
            flex: 1;
            padding: 10px 12px;
            font-size: 13px;
            font-weight: 600;
            background: var(--bg-card);
            color: var(--apple-blue);
            border: 1.5px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
        }
        .btn-utility:hover {
            background: rgba(0, 122, 255, 0.05);
            border-color: var(--apple-blue);
            transform: translateY(-1px);
        }
        .btn-utility:active {
            transform: translateY(0);
        }
        .btn-utility:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* === FORM ENHANCEMENTS === */
        .collapsible-section {
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }
        .collapsible-section.hidden {
            display: none;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .field-hint {
            font-size: 12px;
            color: #ff9500;
            margin-top: 4px;
            padding: 6px 8px;
            background: rgba(255, 149, 0, 0.08);
            border-radius: 6px;
            border-left: 3px solid #ff9500;
            display: none;
        }
        .field-hint.show { display: block; }
        .field-error {
            color: #ff3b30;
            font-size: 12px;
            margin-top: 4px;
        }
        .btn-same-as-above {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            background: var(--bg-input);
            color: var(--apple-blue);
            border: 1.5px dashed var(--apple-blue);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
            width: 100%;
            text-align: center;
        }
        .btn-same-as-above:hover {
            background: rgba(0, 122, 255, 0.08);
        }
        .btn-same-as-above:active {
            transform: scale(0.98);
        }
        
        /* === DATA PREVIEW MODAL === */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        .satellite-section {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            text-align: center;
        }
        .satellite-thumbnail {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid var(--border);
        }
        .satellite-thumbnail:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
            border-color: var(--apple-blue);
        }
        .satellite-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
            margin-bottom: 8px;
        }
        .satellite-links {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .satellite-links a {
            font-size: 11px;
            padding: 6px 12px;
            background: var(--apple-blue);
            color: white;
            border-radius: 4px;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        .satellite-links a:hover {
            opacity: 0.8;
        }
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        .data-item {
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .data-item.conflict {
            border-color: var(--warning);
            background: rgba(255, 149, 0, 0.05);
        }
        .data-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .data-item-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .data-source {
            font-size: 11px;
            color: var(--apple-blue);
            background: rgba(0, 122, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        .conflict-badge {
            font-size: 11px;
            color: var(--warning);
            background: rgba(255, 149, 0, 0.15);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .data-value-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .data-value-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .data-value-option input[type="radio"] {
            width: auto;
            margin: 0;
        }
        .data-value-option label {
            flex: 1;
            font-size: 15px;
            color: var(--text);
            margin: 0;
            cursor: pointer;
        }
        .data-value-option .source-tag {
            font-size: 10px;
            color: var(--text-secondary);
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 3px;
        }
        .data-value input[type="text"] {
            width: 100%;
            padding: 8px;
            font-size: 15px;
            margin: 0;
        }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }
        .modal-footer button {
            flex: 1;
        }
        
        /* === RADIO CARDS === */
        .radio-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .radio-card input { display: none; }
        .radio-card-content {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: white; padding: 20px 8px; border-radius: 12px; border: 2px solid var(--border);
            cursor: pointer; transition: all 0.2s;
            font-size: 14px; font-weight: 600; color: var(--text);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }
        .radio-card input:checked + .radio-card-content { 
            border-color: var(--apple-blue); 
            background: rgba(0, 122, 255, 0.08);
            color: var(--apple-blue);
        }
        .radio-card-content:active { transform: scale(0.97); }

        /* === FOOTER === */
        footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 12px 20px calc(12px + env(safe-area-inset-bottom));
            display: flex; gap: 12px; z-index: 100;
        }
        .btn { flex: 1; padding: 18px 24px; border-radius: 14px; font-weight: 600; font-size: 17px; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--apple-blue); color: white; box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3); }
        .btn-primary:active { background: var(--apple-blue-hover); transform: scale(0.98); }
        .btn-secondary { background: rgba(0, 122, 255, 0.06); color: var(--apple-blue); border: none; }
        .btn-secondary:active { background: var(--bg-input); }
        .btn-secondary:disabled { opacity: 0.4; }

        /* === UTILS === */
        .toast {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            background: var(--text); color: white; padding: 12px 24px; border-radius: 24px;
            font-weight: 600; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 200;
            font-size: 15px;
        }
        .toast.show { opacity: 1; }
        .hint { font-size: 14px; color: var(--text-secondary); background: var(--bg-input); padding: 12px 16px; border-radius: 10px; margin-bottom: 16px; line-height: 1.4; }
        .divider { height: 1px; background: var(--border); margin: 24px 0; }
        
        /* === QUOTE CARDS (Beautiful Modern Design) === */
        .quote-list { display: flex; flex-direction: column; gap: 12px; }
        .quote-card { 
            background: white; 
            border-radius: 16px; 
            padding: 16px; 
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        .quote-card:hover { 
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.12);
            border-color: rgba(0, 122, 255, 0.3);
        }
        .quote-card.starred {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFFFFF 100%);
            border-color: #FFD60A;
        }
        .quote-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .quote-name {
            font-weight: 600;
            font-size: 17px;
            color: var(--text);
        }
        .quote-star {
            background: transparent;
            border: none;
            font-size: 22px;
            cursor: pointer;
            padding: 4px;
            transition: transform 0.2s;
        }
        .quote-star:hover { transform: scale(1.2); }
        .quote-star:active { transform: scale(0.9); }
        .quote-stats {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .quote-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-home { background: rgba(52, 199, 89, 0.12); color: #1C7C34; }
        .badge-auto { background: rgba(0, 122, 255, 0.12); color: #0066CC; }
        .badge-both { background: rgba(175, 82, 222, 0.12); color: #7C3AAB; }
        .badge-duplicate {
            background: rgba(255, 149, 0, 0.15);
            color: #B24A00;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .quote-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .quote-action-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quote-action-btn:hover {
            background: var(--bg-input);
            border-color: var(--apple-blue);
        }
        .quote-action-btn:active { transform: scale(0.96); }
        
        /* === DRIVER/VEHICLE CARDS === */
        .driver-vehicle-card {
            background: linear-gradient(135deg, #F8FAFF 0%, #FFFFFF 100%);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.2s;
        }
        .driver-vehicle-card:hover {
            border-color: var(--apple-blue);
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.08);
        }
        .driver-vehicle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .driver-vehicle-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--apple-blue);
            font-weight: 700;
        }
        .remove-btn {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.3);
            border-radius: 10px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .remove-btn:hover {
            background: rgba(255, 59, 48, 0.2);
            transform: rotate(90deg);
        }
        
        .btn-tertiary { background: var(--bg-input); color: var(--text); border: 1px solid var(--border); }
        .icon-btn { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
        .icon-btn svg { width: 16px; height: 16px; }
        
        /* === DUPLICATE WARNING MODAL === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.2s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .modal-icon {
            font-size: 32px;
        }
        .modal-title {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
        }
        .modal-body {
            margin-bottom: 24px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
        }
        .modal-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-btn-primary {
            background: var(--apple-blue);
            color: white;
        }
        .modal-btn-secondary {
            background: var(--bg-input);
            color: var(--text);
        }
        .scan-actions { display: flex; flex-direction: column; gap: 10px; }
        .scan-preview { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 12px; }
        .scan-thumb { width: 100%; height: 90px; object-fit: cover; border-radius: 10px; border: 1px solid var(--border); }
        .scan-row { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .scan-field { display: grid; grid-template-columns: 1fr; gap: 6px; }
        .confidence-pill { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 4px 8px; border-radius: 999px; background: rgba(0,0,0,0.04); }
        .confidence-low { background: rgba(255, 149, 0, 0.15); color: #B24A00; }
        .confidence-high { background: rgba(52, 199, 89, 0.15); color: #1C7C34; }
        .btn-full { width: 100%; }

        /* === MAP PREVIEWS === */
        .map-preview-card { background: linear-gradient(180deg, #F9FBFF 0%, #FFFFFF 100%); }
        .map-previews { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .map-preview-item { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .map-preview-label { font-weight: 600; color: var(--text); margin-bottom: 8px; }
        .map-preview-img { width: 100%; height: 180px; object-fit: cover; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-input); cursor: pointer; }
        .map-preview-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        @media (min-width: 720px) {
            .map-previews { grid-template-columns: 1fr 1fr; }
            .map-preview-img { height: 200px; }
        }
        .export-card { border: 1px solid var(--border); background: var(--bg-card); }
        .export-stack { display: flex; flex-direction: column; gap: 12px; }
        .export-row { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .export-summary { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-weight: 600; }
        details.export-details summary { list-style: none; }
        details.export-details summary::-webkit-details-marker { display: none; }
        details.export-details[open] .export-summary::after { content: "‚Äì"; }
        details.export-details .export-summary::after { content: "+"; font-weight: 700; }
        @media (min-width: 720px) {
            .export-row { grid-template-columns: 1fr 1fr; }
            .export-row-3 { grid-template-columns: 1fr 1fr auto; align-items: end; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-top">
            <div class="logo"><div class="logo-icon">üè†</div> Insurance Intake</div>
            <div id="saveIndicator" class="save-indicator">‚úì Saved</div>
        </div>
        <div id="stepTitle" class="step-title">Step 1 of 4: Client Information</div>
        <div class="progress-track"><div id="progressBar" class="progress-fill"></div></div>
    </header>

    <main id="mainContainer">
        <!-- STEP 0: POLICY SCAN -->
        <div id="step-0" class="step">
            <div class="card">
                <h2>üì∏ Scan Policy</h2>
                <p class="section-subtitle">Take photos or upload PDFs of existing policies. AI will extract data to auto-fill the form below. Review extracted data before applying.</p>

                <div class="scan-actions">
                    <button class="btn btn-primary" onclick="App.openScanPicker()">Scan Policy</button>
                    <button class="btn btn-secondary" onclick="App.clearScan()">Clear Scan</button>
                    <input id="policyScanInput" type="file" accept="image/*,application/pdf" capture="environment" multiple class="hidden" />
                </div>

                <div id="scanPreview" class="scan-preview"></div>
                <div id="scanStatus" class="hint hidden"></div>
            </div>

            <div class="card">
                <h3>Review Extracted Data</h3>
                <p class="section-subtitle">Verify and edit before applying to the form.</p>
                <div id="scanResults"></div>
                <button class="btn btn-primary" style="margin-top:12px;" onclick="App.applyExtractedData()">Apply to Form</button>
            </div>

            <div class="card">
                <h3>üìÑ Document Intelligence (Phase 7)</h3>
                <p class="section-subtitle">Analyze tax docs, deeds, or declarations to extract structured data.</p>

                <div class="scan-actions">
                    <button class="btn btn-secondary" onclick="App.openDocIntelPicker()">Upload Documents</button>
                    <button class="btn btn-primary" onclick="App.analyzeDocuments()">Analyze Documents</button>
                    <button class="btn btn-secondary" onclick="App.applyDocIntelToForm()">Apply to Form</button>
                    <button class="btn btn-tertiary" onclick="App.clearDocIntel()">Clear</button>
                    <input id="docIntelInput" type="file" accept="image/*,application/pdf" multiple class="hidden" />
                </div>

                <div id="docIntelPreview" class="scan-preview"></div>
                <div id="docIntelStatus" class="hint hidden"></div>
                <div id="docIntelResults"></div>
            </div>
        </div>

        <!-- STEP 1: CLIENT INFORMATION -->
        <div id="step-1" class="step">
            <div class="card">
                <h2>About You</h2>
                <p class="section-subtitle">Let's start with your basic information</p>
                
                <div class="grid-2">
                    <div><label class="label">First Name</label><input type="text" id="firstName" placeholder="John" autocomplete="given-name"></div>
                    <div><label class="label">Last Name</label><input type="text" id="lastName" placeholder="Smith" autocomplete="family-name"></div>
                </div>
                
                <label class="label">Email Address</label>
                <input type="email" id="email" placeholder="john@example.com" autocomplete="email">
                
                <div class="grid-2">
                    <div><label class="label">Phone Number</label><input type="tel" id="phone" placeholder="(555) 123-4567" autocomplete="tel"></div>
                    <div><label class="label">Date of Birth</label><input type="date" id="dob"></div>
                </div>
            </div>

            <div class="card">
                <h2>Demographics</h2>
                <p class="section-subtitle">This helps us find the best coverage options</p>
                
                <label class="label">Marital Status</label>
                <select id="maritalStatus">
                    <option value="">Select...</option>
                    <option value="Single">Single</option>
                    <option value="Married">Married</option>
                    <option value="Domestic Partner">Domestic Partner</option>
                    <option value="Widowed">Widowed</option>
                    <option value="Separated">Separated</option>
                    <option value="Divorced">Divorced</option>
                </select>
                
                <label class="label">Education Level</label>
                <select id="education">
                    <option value="">Select...</option>
                    <option value="No High School Diploma">No High School Diploma</option>
                    <option value="High School Diploma">High School Diploma</option>
                    <option value="Some College - No Degree">Some College - No Degree</option>
                    <option value="Vocational/Technical Degree">Vocational/Technical Degree</option>
                    <option value="Associates Degree">Associates Degree</option>
                    <option value="Bachelors">Bachelors</option>
                    <option value="Masters">Masters</option>
                    <option value="Phd">PhD</option>
                    <option value="Medical Degree">Medical Degree</option>
                    <option value="Law Degree">Law Degree</option>
                </select>
                
                <label class="label">Industry / Occupation</label>
                <select id="industry">
                    <option value="">Select...</option>
                    <option value="Homemaker/House person">Homemaker/House person</option>
                    <option value="Retired">Retired</option>
                    <option value="Disabled">Disabled</option>
                    <option value="Unemployed">Unemployed</option>
                    <option value="Student">Student</option>
                    <option value="Agriculture/Forestry/Fishing">Agriculture/Forestry/Fishing</option>
                    <option value="Art/Design/Media">Art/Design/Media</option>
                    <option value="Banking/Finance/Real Estate">Banking/Finance/Real Estate</option>
                    <option value="Business/Sales/Office">Business/Sales/Office</option>
                    <option value="Construction/Energy Trades">Construction/Energy Trades</option>
                    <option value="Education/Library">Education/Library</option>
                    <option value="Engineer/Architect/Science/Math">Engineer/Architect/Science/Math</option>
                    <option value="Government/Military">Government/Military</option>
                    <option value="Information Technology">Information Technology</option>
                    <option value="Insurance">Insurance</option>
                    <option value="Legal/Law Enforcement/Security">Legal/Law Enforcement/Security</option>
                    <option value="Maintenance/Repair/Housekeeping">Maintenance/Repair/Housekeeping</option>
                    <option value="Manufacturing/Production">Manufacturing/Production</option>
                    <option value="Medical/Social Services/Religion">Medical/Social Services/Religion</option>
                    <option value="Personal Care/Service">Personal Care/Service</option>
                    <option value="Restaurant/Hotel Services">Restaurant/Hotel Services</option>
                    <option value="Sports/Recreation">Sports/Recreation</option>
                    <option value="Travel/Transportation/Warehousing">Travel/Transportation/Warehousing</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>

        <!-- STEP 2: COVERAGE TYPE -->
        <div id="step-2" class="step hidden">
            <div class="card">
                <h2>What would you like to insure?</h2>
                <p class="section-subtitle">Select the coverage type(s) you need</p>
                
                <div class="radio-grid">
                    <label class="radio-card"><input type="radio" name="qType" value="home" onchange="App.handleType()">
                        <div class="radio-card-content">
                            <span style="font-size:48px">üè†</span>
                            <span style="margin-top:12px; font-size:16px; font-weight:600">HOME</span>
                            <span style="font-size:13px; color:var(--text-secondary); margin-top:4px">Property insurance</span>
                        </div>
                    </label>
                    <label class="radio-card"><input type="radio" name="qType" value="auto" onchange="App.handleType()">
                        <div class="radio-card-content">
                            <span style="font-size:48px">üöó</span>
                            <span style="margin-top:12px; font-size:16px; font-weight:600">AUTO</span>
                            <span style="font-size:13px; color:var(--text-secondary); margin-top:4px">Vehicle insurance</span>
                        </div>
                    </label>
                    <label class="radio-card"><input type="radio" name="qType" value="both" checked onchange="App.handleType()">
                        <div class="radio-card-content">
                            <span style="font-size:48px">üéØ</span>
                            <span style="margin-top:12px; font-size:16px; font-weight:600">BOTH</span>
                            <span style="font-size:13px; color:var(--text-secondary); margin-top:4px">Home + Auto bundle</span>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- STEP 3: PROPERTY DETAILS -->
        <div id="step-3" class="step hidden">
            <div class="card">
                <h2>Property Location</h2>
                <p class="section-subtitle">Where is the property located?</p>
                
                <label class="label">Street Address</label>
                <input type="text" id="addrStreet" placeholder="123 Main St" autocomplete="off">
                
                <div class="grid-2">
                    <div><label class="label">City</label><input type="text" id="addrCity" placeholder="Vancouver" autocomplete="off"></div>
                    <div><label class="label">State</label><input type="text" id="addrState" value="WA" autocomplete="off"></div>
                </div>
                <div>
                    <label class="label">Zip Code</label>
                    <input type="tel" id="addrZip" placeholder="98686">
                    <div class="utility-buttons">
                        <button class="btn-utility" onclick="App.openZillow()" title="Search this address on Zillow">
                            üîç Zillow
                        </button>
                        <button class="btn-utility" onclick="App.openGIS()" title="Open county GIS/assessor page" id="gisBtn">
                            üó∫Ô∏è County GIS
                        </button>
                    </div>
                    <button class="btn-primary" onclick="App.smartAutoFill()" style="margin-top: 12px; width: 100%; font-size: 14px; padding: 12px;" id="smartFillBtn">
                        üõ°Ô∏è Scan for Hazards (AI-Powered)
                    </button>
                    <p style="font-size: 11px; color: var(--text-secondary); margin-top: 6px; text-align: center;">
                        Uses satellite imagery to detect pools, trampolines, and other property features. AI-powered analysis.
                    </p>
                </div>
            </div>

            <div class="card map-preview-card">
                <h2>Property Views</h2>
                <p class="section-subtitle">A friendly preview of the home from the street and above</p>
                <div class="map-previews">
                    <div class="map-preview-item">
                        <div class="map-preview-label">Street View</div>
                        <img id="streetViewImg" class="map-preview-img" alt="Street View preview" />
                        <div class="map-preview-actions">
                            <button class="btn-utility" onclick="App.openStreetView()">üö∂ Open Street View</button>
                        </div>
                    </div>
                    <div class="map-preview-item">
                        <div class="map-preview-label">Satellite View</div>
                        <img id="satelliteViewImg" class="map-preview-img" alt="Satellite preview" />
                        <div class="map-preview-actions">
                            <button class="btn-utility" onclick="App.openGoogleMaps()">üó∫Ô∏è Open Maps</button>
                            <button class="btn-utility" onclick="App.openGoogleEarth()">üõ∞Ô∏è Open Earth</button>
                        </div>
                    </div>
                </div>
                <div id="mapPreviewHint" class="hint">Enter an address to load previews.</div>
            </div>

            <div class="card">
                <h2>Home Basics</h2>
                <p class="section-subtitle">Tell us about your property</p>
                
                <label class="label">Dwelling Usage</label>
                <select id="dwellingUsage">
                    <option value="">Select...</option>
                    <option value="Primary">Primary</option>
                    <option value="Secondary">Secondary</option>
                    <option value="Seasonal">Seasonal</option>
                    <option value="Rental">Rental</option>
                    <option value="Vacant">Vacant</option>
                </select>
                
                <label class="label">Occupancy Type</label>
                <select id="occupancyType">
                    <option value="">Select...</option>
                    <option value="Owner Occupied">Owner Occupied</option>
                    <option value="Tenant Occupied">Tenant Occupied</option>
                </select>
                
                <label class="label">Dwelling Type</label>
                <select id="dwellingType">
                    <option value="">Select...</option>
                    <option value="Single Family">Single Family</option>
                    <option value="Condo">Condo</option>
                    <option value="Townhome">Townhome</option>
                    <option value="Row House">Row House</option>
                    <option value="Duplex">Duplex</option>
                    <option value="Triplex">Triplex</option>
                    <option value="Fourplex">Fourplex</option>
                </select>
                
                <div class="grid-2">
                    <div><label class="label">Number of Stories</label><input type="number" id="numStories" min="1" max="5" value="1"></div>
                    <div><label class="label">Full Bathrooms</label><input type="number" id="fullBaths" min="1" max="10" value="2"></div>
                </div>
                
                <div class="grid-2">
                    <div><label class="label">Square Footage</label><input type="tel" id="sqFt" placeholder="2000"></div>
                    <div><label class="label">Year Built</label><input type="tel" id="yrBuilt" placeholder="1990" oninput="App.checkUpdates()"></div>
                </div>
                
                <label class="label">Home Purchase Date</label>
                <input type="date" id="purchaseDate">
            </div>

            <div class="card">
                <h2>Construction Details</h2>
                <p class="section-subtitle">Construction and materials</p>
                
                <label class="label">Construction Style</label>
                <select id="constructionStyle">
                    <option value="">Select...</option>
                    <option value="Frame">Frame</option>
                    <option value="Masonry Veneer">Masonry Veneer</option>
                    <option value="Masonry">Masonry</option>
                    <option value="Stucco">Stucco</option>
                    <option value="Log">Log</option>
                    <option value="Adobe">Adobe</option>
                </select>
                
                <label class="label">Exterior Walls</label>
                <select id="exteriorWalls">
                    <option value="">Select...</option>
                    <option value="Vinyl Siding">Vinyl Siding</option>
                    <option value="Wood Siding">Wood Siding</option>
                    <option value="Brick">Brick</option>
                    <option value="Stucco">Stucco</option>
                    <option value="Fiber Cement">Fiber Cement</option>
                    <option value="Aluminum">Aluminum</option>
                </select>
                
                <label class="label">Foundation Type</label>
                <select id="foundation">
                    <option value="">Select...</option>
                    <option value="Slab">Slab</option>
                    <option value="Crawlspace">Crawlspace</option>
                    <option value="Basement (Finished)">Basement (Finished)</option>
                    <option value="Basement (Unfinished)">Basement (Unfinished)</option>
                    <option value="Pier/Pile">Pier/Pile</option>
                </select>
                
                <label class="label">Kitchen/Bath Quality</label>
                <select id="kitchenQuality">
                    <option value="">Select...</option>
                    <option value="Builder's Grade">Builder's Grade</option>
                    <option value="Semi-Custom">Semi-Custom</option>
                    <option value="Custom">Custom</option>
                </select>
            </div>

            <div class="card">
                <h2>Roof Information</h2>
                <p class="section-subtitle">Roof specifications</p>
                
                <div class="grid-2">
                    <div><label class="label">Roof Type</label>
                        <select id="roofType">
                            <option value="">Select...</option>
                            <option value="Asphalt/Composite Shingle">Asphalt/Composite Shingle</option>
                            <option value="Architectural Shingle">Architectural Shingle</option>
                            <option value="Metal">Metal</option>
                            <option value="Clay Tile">Clay Tile</option>
                            <option value="Concrete Tile">Concrete Tile</option>
                            <option value="Wood Shake">Wood Shake</option>
                            <option value="Slate">Slate</option>
                            <option value="Tar & Gravel">Tar & Gravel</option>
                        </select>
                    </div>
                    <div><label class="label">Roof Shape</label>
                        <select id="roofShape">
                            <option value="">Select...</option>
                            <option value="Gable">Gable</option>
                            <option value="Hip">Hip</option>
                            <option value="Flat">Flat</option>
                            <option value="Gambrel">Gambrel</option>
                        </select>
                    </div>
                </div>
                
                <label class="label">Year Roof Updated</label>
                <input type="tel" id="roofYr" placeholder="2015">
            </div>

            <div id="updatesCard" class="card hidden">
                <h2>System Updates</h2>
                <p class="section-subtitle">When were these systems last updated? (Home built before 2000)</p>
                
                <div class="grid-2">
                    <div><label class="label">Heating Updated (Year)</label><input type="tel" id="heatYr" placeholder="2010"></div>
                    <div><label class="label">Plumbing Updated (Year)</label><input type="tel" id="plumbYr" placeholder="2010"></div>
                </div>
                <label class="label">Electrical Updated (Year)</label>
                <input type="tel" id="elecYr" placeholder="2010">
            </div>

            <div class="card">
                <h2>Systems & Utilities</h2>
                <p class="section-subtitle">Heating and cooling systems</p>
                
                <label class="label">Heating Type</label>
                <select id="heatingType">
                    <option value="">Select...</option>
                    <option value="Forced Air - Gas">Forced Air - Gas</option>
                    <option value="Forced Air - Electric">Forced Air - Electric</option>
                    <option value="Heat Pump">Heat Pump</option>
                    <option value="Boiler (Steam/Water)">Boiler (Steam/Water)</option>
                    <option value="Electric Baseboard">Electric Baseboard</option>
                    <option value="Oil/Kerosene">Oil/Kerosene</option>
                </select>
                
                <label class="label">Cooling System</label>
                <select id="cooling">
                    <option value="">Select...</option>
                    <option value="Central Air">Central Air</option>
                    <option value="Window Units">Window Units</option>
                    <option value="None">None</option>
                </select>
            </div>

            <div class="card">
                <h2>Safety & Location</h2>
                <p class="section-subtitle">Fire protection and security</p>
                
                <div class="grid-3">
                    <div><label class="label">Distance to Fire Station (Miles)</label><input type="number" id="fireStationDist" step="0.1" placeholder="2.5"></div>
                    <div><label class="label">Feet to Fire Hydrant</label><input type="number" id="fireHydrantFeet" placeholder="500"></div>
                    <div><label class="label">Protection Class (1-10)</label><input type="number" id="protectionClass" min="1" max="10" placeholder="5"></div>
                </div>
                
                <label class="label">Burglar Alarm</label>
                <select id="burglarAlarm">
                    <option value="">Select...</option>
                    <option value="None">None</option>
                    <option value="Local">Local Only</option>
                    <option value="Monitored">Monitored</option>
                </select>
                
                <label class="label">Fire Alarm</label>
                <select id="fireAlarm">
                    <option value="">Select...</option>
                    <option value="None">None</option>
                    <option value="Local">Local Only</option>
                    <option value="Monitored">Monitored</option>
                </select>
                
                <label class="label">Sprinkler System</label>
                <select id="sprinklers">
                    <option value="">Select...</option>
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                </select>
            </div>
        </div>

        <!-- STEP 4: VEHICLE & DRIVER INFO -->
        <div id="step-4" class="step hidden">
            <div class="card">
                <h2>Drivers</h2>
                <p class="section-subtitle">Add all household drivers (you can add more later)</p>
                
                <div id="driversList"></div>
                
                <button class="btn btn-secondary" style="margin-top: 12px;" onclick="App.addDriver()">+ Add Driver</button>
            </div>

            <div class="card">
                <h2>Vehicles</h2>
                <p class="section-subtitle">Add all vehicles to insure</p>
                
                <div id="vehiclesList"></div>
                
                <button class="btn btn-secondary" style="margin-top: 12px;" onclick="App.addVehicle()">+ Add Vehicle</button>
            </div>
        </div>

        <!-- STEP 5: RISK FACTORS & ADDITIONAL INFO -->
        <div id="step-5" class="step hidden">
            <div class="card">
                <h2>Risk Factors</h2>
                <p class="section-subtitle">Help us understand potential risk factors</p>
                
                <label class="label">Swimming Pool</label>
                <select id="pool">
                    <option value="">Select...</option>
                    <option value="None">None</option>
                    <option value="Above Ground">Above Ground</option>
                    <option value="In Ground">In Ground</option>
                    <option value="In Ground with Slide">In Ground with Slide</option>
                </select>
                
                <label class="label">Trampoline</label>
                <select id="trampoline">
                    <option value="">Select...</option>
                    <option value="None">None</option>
                    <option value="Yes">Yes</option>
                    <option value="Yes with Safety Net">Yes with Safety Net</option>
                </select>
                
                <label class="label">Wood Burning Stove</label>
                <select id="woodStove">
                    <option value="">Select...</option>
                    <option value="None">None</option>
                    <option value="Yes">Yes</option>
                </select>
                
                <label class="label">Dogs / Pets</label>
                <textarea id="dogInfo" placeholder="Breed, age, behavior history (if applicable)" rows="2"></textarea>
                
                <label class="label">Business on Property</label>
                <textarea id="businessOnProperty" placeholder="Describe any business operations" rows="2"></textarea>
            </div>

            <div class="card">
                <h2>Insurance History</h2>
                <p class="section-subtitle">Your current and prior coverage</p>
                
                <label class="label">Current Liability Limits</label>
                <select id="liabilityLimits">
                    <option value="">Select...</option>
                    <option value="25/50">25/50</option>
                    <option value="50/100">50/100</option>
                    <option value="100/300">100/300</option>
                    <option value="250/500">250/500</option>
                    <option value="500/500">500/500</option>
                </select>
                
                <div class="grid-2">
                    <div><label class="label">Home Deductible</label><input type="text" id="homeDeductible" placeholder="$1000"></div>
                    <div><label class="label">Auto Deductible</label><input type="text" id="autoDeductible" placeholder="$500"></div>
                </div>
                
                <label class="label">Prior Insurance Carrier</label>
                <input type="text" id="priorCarrier" placeholder="e.g., State Farm">
                
                <div class="grid-2">
                    <div><label class="label">Years with Prior Carrier</label><input type="number" id="priorYears" placeholder="5"></div>
                    <div><label class="label">Prior Policy Expiration</label><input type="date" id="priorExp"></div>
                </div>
                
                <label class="label">Accidents (Last 5 Years)</label>
                <textarea id="accidents" placeholder="Date, description, claim amount" rows="2"></textarea>
                
                <label class="label">Violations / Tickets (Last 3 Years)</label>
                <textarea id="violations" placeholder="Date, type of violation" rows="2"></textarea>
                
                <label class="label">Student GPA (if applicable)</label>
                <input type="text" id="studentGPA" placeholder="3.5">
            </div>

            <div class="card">
                <h2>Additional Information</h2>
                <p class="section-subtitle">Help us serve you better</p>
                
                <label class="label">Mortgagee / Lienholder</label>
                <input type="text" id="mortgagee" placeholder="Bank name and address">
                
                <label class="label">Additional Insured Parties</label>
                <textarea id="additionalInsureds" placeholder="Names and relationships" rows="2"></textarea>
                
                <label class="label">Best Time to Contact</label>
                <input type="text" id="contactTime" placeholder="Morning, afternoon, evening">
                
                <label class="label">How did you hear about us?</label>
                <select id="referralSource">
                    <option value="">Select...</option>
                    <option value="Google Search">Google Search</option>
                    <option value="Social Media">Social Media</option>
                    <option value="Referral">Referral from Friend/Family</option>
                    <option value="Advertisement">Advertisement</option>
                    <option value="Other">Other</option>
                </select>
                
                <div style="margin-top:20px;">
                    <label style="display:flex; align-items:start; gap:10px; cursor:pointer;">
                        <input type="checkbox" id="tcpaConsent" style="margin-top:4px;">
                        <span style="font-size:13px; color:var(--text-secondary); line-height:1.4;">I consent to receive communications via phone, text, and email regarding insurance quotes and services.</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- STEP 6: REVIEW & EXPORT -->
        <div id="step-6" class="step hidden">
            <div class="card">
                <h2>‚úì Application Complete</h2>
                <p class="section-subtitle">Choose how you'd like to export this information</p>
            </div>

            <div class="card export-card">
                <h3>EZLynx XML (Recommended)</h3>
                <p class="section-subtitle">Complete XML file ready for instant quoting</p>
                <button class="btn btn-primary btn-full" onclick="App.exportXML()">üì• Download EZLynx XML File</button>
                <div class="hint" style="margin-top:12px">
                    Import to EZLynx using Applicants ‚Üí Import ‚Üí HawkSoft. All data auto-populates for immediate quoting.
                </div>
            </div>

            <div class="card export-card">
                <h3>PDF Summary</h3>
                <p class="section-subtitle">Clean, readable reference copy for review or sharing</p>
                <button class="btn btn-secondary btn-full" onclick="App.exportPDF()">üìÑ Download PDF Summary</button>
                <div class="hint" style="margin-top:12px">
                    Nicely formatted PDF showing all application details.
                </div>
            </div>

            <div class="divider"></div>

            <div class="card export-card">
                <details class="export-details">
                    <summary class="export-summary">
                        <span>More Options</span>
                    </summary>
                    <div class="export-stack" style="margin-top:12px;">
                        <div>
                            <h4 style="font-size:15px; font-weight:600; margin-bottom:8px;">Quote Library</h4>
                            <p class="section-subtitle">Save multiple drafts and batch export when ready</p>
                            <div class="export-row">
                                <button class="btn btn-secondary" onclick="App.saveQuote()">üíæ Save Draft</button>
                                <button class="btn btn-tertiary" onclick="App.startNewDraft()">‚ûï New Draft</button>
                            </div>
                            <div class="export-row">
                                <button class="btn btn-secondary" onclick="App.exportSelectedZip()">üì¶ Download ZIP (Selected)</button>
                                <button class="btn btn-tertiary" onclick="App.exportAllZip()">üì¶ Export All ZIP</button>
                            </div>
                            <div class="export-row">
                                <button class="btn btn-tertiary" onclick="App.selectAllQuotes()">‚úÖ Select All</button>
                                <button class="btn btn-tertiary" onclick="App.clearQuoteSelection()">‚úñ Clear Selection</button>
                                <button class="btn btn-tertiary" onclick="App.clearAllDrafts()">üßπ Clear Drafts</button>
                            </div>
                            <div class="export-row">
                                <input id="quoteSearch" class="quote-search-input" type="text" placeholder="Search drafts" oninput="App.filterQuotes(this.value)">
                            </div>
                            <div id="quoteList" class="quote-list"></div>
                            <div class="hint">Select drafts to include in the ZIP. Use Load to resume any draft.</div>
                        </div>

                        <div class="divider"></div>

                        <div>
                            <h4 style="font-size:15px; font-weight:600; margin-bottom:8px;">Batch Import (CSV)</h4>
                            <p class="section-subtitle">Upload a spreadsheet to create multiple drafts at once</p>
                            <div class="export-row">
                                <button class="btn btn-secondary" onclick="App.downloadCSVTemplate()">üìÑ Download CSV Template</button>
                                <button class="btn btn-tertiary" onclick="App.openBatchImport()">‚¨ÜÔ∏è Import CSV</button>
                                <input id="batchCsvInput" type="file" accept=".csv" class="hidden" onchange="App.handleBatchImport(this.files[0])" />
                            </div>
                            <div class="hint">Required columns: First Name, Last Name, Address Line 1, City, State Code, Zip Code.</div>
                        </div>
                    </div>
                </details>
            </div>

            <div class="card export-card">
                <button class="btn btn-tertiary btn-full" onclick="App.reset()">üóëÔ∏è Clear All Data & Start New</button>
            </div>
        </div>
    </main>

    <!-- Data Preview Modal Container -->
    <div id="modalContainer"></div>

    <footer>
        <button id="btnBack" class="btn btn-secondary" onclick="App.prev()">Back</button>
        <button id="btnNext" class="btn btn-primary" onclick="App.next()">Next</button>
    </footer>

    <div id="toast" class="toast">Message</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Load Google Places API dynamically with key from server or environment (optional - form works without it)
        (async function loadPlacesAPI() {
            try {
                let apiKey = null;
                
                // Try fetching from server endpoint first (Vercel production)
                try {
                    const res = await fetch('/api/places-config.js');
                    if (res.ok) {
                        const data = await res.json();
                        apiKey = data.apiKey;
                    }
                } catch (e) {
                    // Server endpoint not available, try alternative methods
                }
                
                // If no key from server, try checking window for injected key
                if (!apiKey && window.__PLACES_API_KEY__) {
                    apiKey = window.__PLACES_API_KEY__;
                }
                
                // If still no key, check if it was passed as query parameter (local dev)
                if (!apiKey && window.location.search) {
                    const params = new URLSearchParams(window.location.search);
                    apiKey = params.get('placesKey');
                }
                
                if (!apiKey) {
                    console.info('‚ÑπÔ∏è Google Places API not configured - address autocomplete disabled. For local dev, set PLACES_API_KEY env var or add ?placesKey=... to URL');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initPlaces`;
                script.async = true;
                script.defer = true;
                script.onerror = () => console.warn('‚ö†Ô∏è Places API script failed to load - address autocomplete disabled');
                document.head.appendChild(script);
                console.info('‚úì Places API loaded');
            } catch (err) {
                console.warn('‚ÑπÔ∏è Places API not available:', err.message);
            }
        })();
    </script>
    <script>
        // üîí Encryption Utilities (AES-256-GCM via Web Crypto API)
        const CryptoHelper = {
            userPIN: null, // Set by user for extra protection
            
            async promptForPIN() {
                // Check if PIN is stored (hashed)
                const storedHash = localStorage.getItem('altech_pin_hash');
                
                if (storedHash) {
                    // User has PIN set - verify it
                    const pin = prompt('Enter your PIN to access encrypted data:');
                    if (!pin) return null;
                    
                    const hash = await this.hashPIN(pin);
                    if (hash !== storedHash) {
                        alert('‚ùå Incorrect PIN. Data cannot be decrypted.');
                        return null;
                    }
                    this.userPIN = pin;
                    return pin;
                } else {
                    // First time - ask if they want to set a PIN
                    const wantsPIN = confirm('üîê Would you like to set a PIN for extra security? (You can skip this)');
                    if (!wantsPIN) return 'no-pin';
                    
                    const pin = prompt('Create a 4-8 digit PIN (REMEMBER THIS - cannot be recovered):');
                    if (!pin || pin.length < 4) {
                        alert('PIN must be at least 4 digits');
                        return null;
                    }
                    
                    const hash = await this.hashPIN(pin);
                    localStorage.setItem('altech_pin_hash', hash);
                    this.userPIN = pin;
                    return pin;
                }
            },
            
            async hashPIN(pin) {
                const encoder = new TextEncoder();
                const data = encoder.encode(pin + 'altech_salt_2026');
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },

            async getEncryptionKey() {
                // Generate or retrieve encryption key (now with optional PIN)
                const fingerprint = await this.getDeviceFingerprint();
                
                // If PIN is set, include it in key derivation
                const keySource = this.userPIN ? `${fingerprint}:${this.userPIN}` : fingerprint;
                
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    new TextEncoder().encode(keySource),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                );
                
                const salt = new TextEncoder().encode('altech_v6_salt_2026');
                return await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt', 'decrypt']
                );
            },

            async getDeviceFingerprint() {
                // Create semi-persistent device fingerprint
                // Combines browser info + stored UUID
                let uuid = localStorage.getItem('altech_device_uuid');
                if (!uuid) {
                    uuid = this.generateUUID();
                    localStorage.setItem('altech_device_uuid', uuid);
                }
                
                const browserInfo = `${navigator.userAgent}|${screen.width}x${screen.height}|${navigator.language}`;
                return `${uuid}:${browserInfo}`;
            },

            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },

            async encrypt(data) {
                try {
                    const key = await this.getEncryptionKey();
                    const iv = crypto.getRandomValues(new Uint8Array(12)); // GCM standard IV
                    const encodedData = new TextEncoder().encode(JSON.stringify(data));
                    
                    const encrypted = await crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv },
                        key,
                        encodedData
                    );
                    
                    // Combine IV + encrypted data for storage
                    const combined = new Uint8Array(iv.length + encrypted.byteLength);
                    combined.set(iv, 0);
                    combined.set(new Uint8Array(encrypted), iv.length);
                    
                    // Convert to base64 for localStorage
                    return btoa(String.fromCharCode(...combined));
                } catch (error) {
                    console.error('Encryption failed:', error);
                    // Fallback: store unencrypted (backwards compatible)
                    return JSON.stringify(data);
                }
            },

            async decrypt(encryptedData) {
                try {
                    // Try decrypting first
                    const key = await this.getEncryptionKey();
                    const combined = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
                    
                    const iv = combined.slice(0, 12);
                    const data = combined.slice(12);
                    
                    const decrypted = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv },
                        key,
                        data
                    );
                    
                    const decoded = new TextDecoder().decode(decrypted);
                    return JSON.parse(decoded);
                } catch (error) {
                    // Fallback: try parsing as plain JSON (backwards compatible)
                    try {
                        return JSON.parse(encryptedData);
                    } catch (e) {
                        console.error('Decryption failed:', error);
                        return null;
                    }
                }
            }
        };

        const App = {
            data: {},
            step: 0,
            flow: [],
            storageKey: 'altech_v6',
            quotesKey: 'altech_v6_quotes',
            docIntelKey: 'altech_v6_docintel',
            scanFiles: [],
            extractedData: null,
            encryptionEnabled: true, // Toggle encryption on/off
            drivers: [], // Array of driver objects
            vehicles: [], // Array of vehicle objects
            selectedQuoteIds: new Set(),
            docIntelFiles: [],
            docIntelResults: null,
            mapApiKey: null,
            mapPreviewCache: {},
            mapPreviewTimer: null,
            
            workflows: {
                home: ['step-0', 'step-1', 'step-2', 'step-3', 'step-5', 'step-6'],
                auto: ['step-0', 'step-1', 'step-2', 'step-4', 'step-5', 'step-6'],
                both: ['step-0', 'step-1', 'step-2', 'step-3', 'step-4', 'step-5', 'step-6']
            },

            stepTitles: {
                'step-0': 'Policy Scan',
                'step-1': 'Personal Information',
                'step-2': 'Coverage Type',
                'step-3': 'Property Details',
                'step-4': 'Vehicle & Driver Info',
                'step-5': 'Risk Factors & Additional Info',
                'step-6': 'Review & Export'
            },

            async init() {
                // Prompt for PIN if encryption enabled and PIN is set
                if (this.encryptionEnabled) {
                    const pin = await CryptoHelper.promptForPIN();
                    if (pin === null) {
                        alert('Cannot access encrypted data without PIN. Please refresh and try again.');
                        return;
                    }
                }
                
                await this.load();
                await this.loadDocIntelResults();
                await this.loadDriversVehicles(); // Load multi-driver/vehicle data
                this.handleType(); // Set initial flow
                await this.renderQuoteList();

                const scanInput = document.getElementById('policyScanInput');
                if (scanInput) {
                    scanInput.addEventListener('change', (e) => this.handleScanFiles(e));
                }

                const docIntelInput = document.getElementById('docIntelInput');
                if (docIntelInput) {
                    docIntelInput.addEventListener('change', (e) => this.handleDocIntelFiles(e));
                }
                
                // Auto-save listeners
                document.querySelectorAll('input, select, textarea').forEach(el => {
                    el.addEventListener('input', (e) => this.save(e));
                    el.addEventListener('change', (e) => this.save(e));
                    
                    // Real-time validation on blur
                    el.addEventListener('blur', (e) => {
                        if (typeof Validation === 'undefined') return;
                        const id = e.target.id;
                        
                        // Field-specific validation
                        let result;
                        switch(id) {
                            case 'email':
                                result = Validation.email(e.target.value);
                                break;
                            case 'phone':
                                result = Validation.phone(e.target.value);
                                break;
                            case 'dob':
                                result = Validation.dob(e.target.value);
                                break;
                            case 'addrState':
                                result = Validation.stateCode(e.target.value);
                                break;
                            case 'addrZip':
                                result = Validation.zipCode(e.target.value);
                                break;
                            case 'yrBuilt':
                            case 'roofYr':
                            case 'heatYr':
                                result = Validation.year(e.target.value, 'Year');
                                break;
                            case 'firstName':
                            case 'lastName':
                                result = Validation.required(e.target.value, e.target.previousElementSibling?.textContent || 'This field');
                                break;
                        }
                        
                        if (result) {
                            if (result.valid) {
                                Validation.clearError(id);
                            } else {
                                Validation.showError(id, result.message);
                            }
                        }
                    });
                });
                // Phone format
                document.getElementById('phone').addEventListener('input', this.fmtPhone);

                // Map previews: update when address fields change
                ['addrStreet', 'addrCity', 'addrState', 'addrZip'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', () => this.scheduleMapPreviewUpdate());
                        el.addEventListener('change', () => this.scheduleMapPreviewUpdate());
                    }
                });

                // Initial preview render if address already exists
                this.updateMapPreviews();
            },

            initPlaces() {
                const streetInput = document.getElementById('addrStreet');
                if (!streetInput || !window.google?.maps?.places) return;

                let sessionToken = new google.maps.places.AutocompleteSessionToken();
                const autocomplete = new google.maps.places.Autocomplete(streetInput, {
                    types: ['address'],
                    componentRestrictions: { country: 'us' },
                    fields: ['address_components', 'formatted_address'],
                    sessionToken
                });

                const refreshSessionToken = () => {
                    sessionToken = new google.maps.places.AutocompleteSessionToken();
                    autocomplete.setOptions({ sessionToken });
                };

                streetInput.addEventListener('focus', () => refreshSessionToken());

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (!place || !place.address_components) {
                        this.toast('‚ö†Ô∏è Address not found. Try a different entry.');
                        return;
                    }

                    const parts = {
                        street_number: '',
                        route: '',
                        locality: '',
                        postal_town: '',
                        administrative_area_level_1: '',
                        postal_code: ''
                    };

                    place.address_components.forEach((component) => {
                        const type = component.types?.[0];
                        if (type && Object.prototype.hasOwnProperty.call(parts, type)) {
                            parts[type] = component.short_name || component.long_name || '';
                        }
                    });

                    const street = [parts.street_number, parts.route].filter(Boolean).join(' ').trim();
                    const city = parts.locality || parts.postal_town || '';
                    const state = parts.administrative_area_level_1 || '';
                    const zip = parts.postal_code || '';

                    this.setFieldValue('addrStreet', street || place.formatted_address || '');
                    this.setFieldValue('addrCity', city);
                    this.setFieldValue('addrState', state);
                    this.setFieldValue('addrZip', zip);

                    this.scheduleMapPreviewUpdate();

                    refreshSessionToken();
                });
            },

            setFieldValue(id, value) {
                const el = document.getElementById(id);
                if (!el) return;
                el.value = value || '';
                this.data[id] = el.value;
                localStorage.setItem(this.storageKey, JSON.stringify(this.data));

                if (id === 'vin') {
                    this.decodeVin(el);
                }
            },

            openScanPicker() {
                const input = document.getElementById('policyScanInput');
                if (input) input.click();
            },

            openDocIntelPicker() {
                const input = document.getElementById('docIntelInput');
                if (input) input.click();
            },

            clearScan() {
                this.scanFiles = [];
                this.extractedData = null;
                const preview = document.getElementById('scanPreview');
                if (preview) preview.innerHTML = '';
                const results = document.getElementById('scanResults');
                if (results) results.innerHTML = '';
                const status = document.getElementById('scanStatus');
                if (status) {
                    status.classList.add('hidden');
                    status.textContent = '';
                }
                const input = document.getElementById('policyScanInput');
                if (input) input.value = '';
            },

            clearDocIntel() {
                this.docIntelFiles = [];
                this.docIntelResults = null;
                localStorage.removeItem(this.docIntelKey);
                const preview = document.getElementById('docIntelPreview');
                if (preview) preview.innerHTML = '';
                const results = document.getElementById('docIntelResults');
                if (results) results.innerHTML = '';
                const status = document.getElementById('docIntelStatus');
                if (status) {
                    status.classList.add('hidden');
                    status.textContent = '';
                }
                const input = document.getElementById('docIntelInput');
                if (input) input.value = '';
            },

            async handleScanFiles(e) {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                this.scanFiles = files;
                await this.renderScanPreview(files);
                await this.processScan();
            },

            async handleDocIntelFiles(e) {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                this.docIntelFiles = files;
                await this.renderDocIntelPreview(files);
            },

            async renderScanPreview(files) {
                const preview = document.getElementById('scanPreview');
                if (!preview) return;
                preview.innerHTML = '';

                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const url = URL.createObjectURL(file);
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'scan-thumb';
                        img.onload = () => URL.revokeObjectURL(url);
                        preview.appendChild(img);
                    } else {
                        const chip = document.createElement('div');
                        chip.className = 'hint';
                        chip.textContent = `PDF: ${file.name}`;
                        preview.appendChild(chip);
                    }
                }
            },

            async renderDocIntelPreview(files) {
                const preview = document.getElementById('docIntelPreview');
                if (!preview) return;
                preview.innerHTML = '';

                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const url = URL.createObjectURL(file);
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'scan-thumb';
                        img.onload = () => URL.revokeObjectURL(url);
                        preview.appendChild(img);
                    } else {
                        const chip = document.createElement('div');
                        chip.className = 'hint';
                        chip.textContent = `PDF: ${file.name}`;
                        preview.appendChild(chip);
                    }
                }
            },

            async optimizeImage(file) {
                const bitmap = await createImageBitmap(file, { imageOrientation: 'from-image' });
                const canvas = document.createElement('canvas');
                canvas.width = bitmap.width;
                canvas.height = bitmap.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(bitmap, 0, 0);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const contrast = 1.1;
                const intercept = 128 * (1 - contrast);

                for (let i = 0; i < data.length; i += 4) {
                    data[i] = data[i] * contrast + intercept;
                    data[i + 1] = data[i + 1] * contrast + intercept;
                    data[i + 2] = data[i + 2] * contrast + intercept;
                }

                ctx.putImageData(imageData, 0, 0);
                const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                return blob || file;
            },

            async fileToInlineData(file) {
                const reader = new FileReader();
                const blob = file.type.startsWith('image/') ? await this.optimizeImage(file) : file;

                return new Promise((resolve, reject) => {
                    reader.onload = () => {
                        const result = reader.result;
                        const base64 = result.split(',')[1];
                        resolve({
                            mimeType: blob.type || file.type || 'application/octet-stream',
                            data: base64
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            },

            async processScan() {
                if (!this.scanFiles.length) return;

                const status = document.getElementById('scanStatus');
                if (status) {
                    status.classList.remove('hidden');
                    status.textContent = '‚è≥ Extracting policy data...';
                }

                try {
                    const inlineData = [];
                    for (const file of this.scanFiles) {
                        inlineData.push(await this.fileToInlineData(file));
                    }

                    const response = await fetch('/api/policy-scan.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files: inlineData })
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err?.error || 'Unable to extract policy data');
                    }

                    const result = await response.json();
                    this.extractedData = result;
                    this.renderExtractionReview(result);

                    if (status) {
                        status.textContent = '‚úÖ Extraction complete. Review below.';
                    }
                } catch (err) {
                    if (status) status.textContent = '‚ö†Ô∏è ' + err.message;
                }
            },

            async analyzeDocuments() {
                const files = this.docIntelFiles.length ? this.docIntelFiles : this.scanFiles;
                if (!files.length) {
                    this.toast('‚ö†Ô∏è Upload documents first.');
                    return;
                }

                const status = document.getElementById('docIntelStatus');
                if (status) {
                    status.classList.remove('hidden');
                    status.textContent = '‚è≥ Analyzing documents...';
                }

                try {
                    const inlineData = [];
                    for (const file of files) {
                        inlineData.push(await this.fileToInlineData(file));
                    }

                    const response = await fetch('/api/document-intel.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files: inlineData })
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err?.error || 'Unable to analyze documents');
                    }

                    const result = await response.json();
                    this.docIntelResults = result;
                    await this.saveDocIntelResults(result);
                    this.renderDocIntelResults(result);

                    if (status) {
                        status.textContent = '‚úÖ Document analysis complete.';
                    }
                } catch (err) {
                    if (status) status.textContent = '‚ö†Ô∏è ' + err.message;
                }
            },

            renderDocIntelResults(result) {
                const container = document.getElementById('docIntelResults');
                if (!container) return;
                container.innerHTML = '';

                if (!result) return;

                const warnings = this.getDocIntelWarnings(result);
                if (warnings.length) {
                    const warn = document.createElement('div');
                    warn.className = 'hint';
                    warn.textContent = '‚ö†Ô∏è ' + warnings.join(' | ');
                    container.appendChild(warn);
                }

                const summary = document.createElement('div');
                summary.className = 'hint';
                summary.textContent = result.summary || 'Document analysis complete.';
                container.appendChild(summary);

                const fields = result.fields || {};
                const fieldsCard = document.createElement('div');
                fieldsCard.className = 'scan-field';

                const fieldsTitle = document.createElement('label');
                fieldsTitle.className = 'label';
                fieldsTitle.textContent = 'Review Extracted Fields';
                fieldsCard.appendChild(fieldsTitle);

                const fieldList = document.createElement('div');
                fieldList.className = 'grid-2';

                const renderInput = (labelText, key, placeholder = '') => {
                    const wrap = document.createElement('div');
                    const label = document.createElement('label');
                    label.className = 'label';
                    label.textContent = labelText;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = fields[key] || '';
                    input.placeholder = placeholder;
                    input.oninput = (e) => this.updateDocIntelField(key, e.target.value);
                    wrap.appendChild(label);
                    wrap.appendChild(input);
                    fieldList.appendChild(wrap);
                };

                renderInput('Owner Name', 'ownerName', 'John Doe');
                renderInput('Policy Number', 'policyNumber', 'ABC123');
                renderInput('Effective Date', 'effectiveDate', 'YYYY-MM-DD');
                renderInput('Expiration Date', 'expirationDate', 'YYYY-MM-DD');
                renderInput('Year Built', 'yearBuilt', '1999');
                renderInput('Assessed Value', 'assessedValue', '450000');
                renderInput('Mortgagee', 'mortgagee', 'Lender Name');
                renderInput('Address Line 1', 'addressLine1', '123 Main St');
                renderInput('City', 'city', 'Seattle');
                renderInput('State', 'state', 'WA');
                renderInput('Zip', 'zip', '98101');

                fieldsCard.appendChild(fieldList);
                container.appendChild(fieldsCard);

                const docs = result.documents || [];
                docs.forEach(doc => {
                    const card = document.createElement('div');
                    card.className = 'scan-field';

                    const title = document.createElement('label');
                    title.className = 'label';
                    title.textContent = doc.title || doc.type || 'Document';

                    const detail = document.createElement('div');
                    detail.className = 'hint';
                    detail.textContent = doc.details || doc.notes || 'No details extracted.';

                    card.appendChild(title);
                    card.appendChild(detail);
                    container.appendChild(card);
                });
            },

            async updateDocIntelField(key, value) {
                if (!this.docIntelResults) return;
                if (!this.docIntelResults.fields) this.docIntelResults.fields = {};
                this.docIntelResults.fields[key] = value;
                await this.saveDocIntelResults(this.docIntelResults);
            },

            getDocIntelWarnings(result) {
                const warnings = [];
                const fields = result?.fields || {};
                if (fields.yearBuilt && this.data.yrBuilt) {
                    const diff = Math.abs(parseInt(fields.yearBuilt, 10) - parseInt(this.data.yrBuilt, 10));
                    if (!Number.isNaN(diff) && diff >= 2) {
                        warnings.push(`Year built mismatch (${fields.yearBuilt} vs ${this.data.yrBuilt})`);
                    }
                }
                if (!fields.ownerName && (fields.deedBook || fields.apn)) {
                    warnings.push('Owner name missing from document extraction');
                }
                if (fields.assessedValue && !this.data.propertyValue) {
                    warnings.push('Assessed value found ‚Äî consider setting property value');
                }
                return warnings;
            },

            applyDocIntelToForm() {
                if (!this.docIntelResults) {
                    this.toast('‚ö†Ô∏è Run document analysis first.');
                    return;
                }
                const fields = this.docIntelResults.fields || {};

                const setIfEmpty = (id, value) => {
                    if (!value) return;
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (!el.value) {
                        el.value = value;
                        this.data[id] = value;
                    }
                };

                setIfEmpty('yrBuilt', fields.yearBuilt);
                setIfEmpty('addrStreet', fields.addressLine1);
                setIfEmpty('addrCity', fields.city);
                setIfEmpty('addrState', fields.state);
                setIfEmpty('addrZip', fields.zip);
                setIfEmpty('mortgagee', fields.mortgagee);
                setIfEmpty('purchaseDate', fields.purchaseDate);

                if (fields.assessedValue && !this.data.propertyValue) {
                    this.data.propertyValue = fields.assessedValue;
                }

                this.data.docIntel = {
                    source: fields.source || 'Document Intelligence',
                    yearBuilt: fields.yearBuilt || '',
                    assessedValue: fields.assessedValue || '',
                    ownerName: fields.ownerName || '',
                    policyNumber: fields.policyNumber || '',
                    effectiveDate: fields.effectiveDate || '',
                    expirationDate: fields.expirationDate || '',
                    mortgagee: fields.mortgagee || ''
                };

                this.save({ target: { id: 'docIntel', value: JSON.stringify(this.data.docIntel) } });
                this.toast('‚úÖ Document data applied');
            },

            async saveDocIntelResults(result) {
                if (!result) return;
                if (this.encryptionEnabled) {
                    const encrypted = await CryptoHelper.encrypt(result);
                    localStorage.setItem(this.docIntelKey, encrypted);
                } else {
                    localStorage.setItem(this.docIntelKey, JSON.stringify(result));
                }
            },

            async loadDocIntelResults() {
                const stored = localStorage.getItem(this.docIntelKey);
                if (!stored) return;

                if (this.encryptionEnabled) {
                    const decrypted = await CryptoHelper.decrypt(stored);
                    if (decrypted) this.docIntelResults = decrypted;
                } else {
                    this.docIntelResults = JSON.parse(stored);
                }

                if (this.docIntelResults) {
                    this.renderDocIntelResults(this.docIntelResults);
                }
            },

            renderExtractionReview(result) {
                const results = document.getElementById('scanResults');
                if (!results) return;
                results.innerHTML = '';

                const fields = result?.fields || {};
                const confidence = result?.confidence || {};
                const issues = result?.quality_issues || [];

                if (issues.length) {
                    const warn = document.createElement('div');
                    warn.className = 'hint';
                    warn.textContent = '‚ö†Ô∏è ' + issues.join(' | ');
                    results.appendChild(warn);
                }

                const renderField = (id, label, value) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'scan-field';

                    const labelEl = document.createElement('label');
                    labelEl.className = 'label';
                    labelEl.textContent = label;

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = value || '';
                    input.dataset.field = id;

                    const conf = typeof confidence[id] === 'number' ? confidence[id] : null;
                    if (conf !== null) {
                        const pill = document.createElement('span');
                        pill.className = 'confidence-pill ' + (conf < 0.6 ? 'confidence-low' : 'confidence-high');
                        pill.textContent = `${Math.round(conf * 100)}% confidence`;
                        wrapper.appendChild(pill);
                    }

                    wrapper.appendChild(labelEl);
                    wrapper.appendChild(input);
                    results.appendChild(wrapper);
                };

                renderField('firstName', 'First Name', fields.firstName);
                renderField('lastName', 'Last Name', fields.lastName);
                renderField('dob', 'Date of Birth', fields.dob);
                renderField('phone', 'Phone', fields.phone);
                renderField('email', 'Email', fields.email);
                renderField('addrStreet', 'Street Address', fields.addrStreet);
                renderField('addrCity', 'City', fields.addrCity);
                renderField('addrState', 'State', fields.addrState);
                renderField('addrZip', 'ZIP', fields.addrZip);
                renderField('vin', 'VIN', fields.vin);
                renderField('vehDesc', 'Vehicle Description', fields.vehDesc);
                renderField('liabilityLimits', 'Liability Limits', fields.liabilityLimits);
                renderField('homeDeductible', 'Home Deductible', fields.homeDeductible);
                renderField('autoDeductible', 'Auto Deductible', fields.autoDeductible);
                renderField('priorCarrier', 'Prior Carrier', fields.priorCarrier);
                renderField('priorExp', 'Prior Expiration', fields.priorExp);
            },

            applyExtractedData() {
                const results = document.getElementById('scanResults');
                if (!results) return;
                const inputs = results.querySelectorAll('input[data-field]');
                inputs.forEach((input) => this.setFieldValue(input.dataset.field, input.value));
                this.toast('‚úÖ Extracted data applied');
            },

            handleType() {
                const t = document.querySelector('input[name="qType"]:checked')?.value || 'both';
                this.flow = this.workflows[t];
                
                // Move to next step automatically after selection
                if (this.step === 2) {
                    this.step++;
                }
                
                // Reset step if out of bounds
                if (this.step >= this.flow.length) this.step = 0;
                this.updateUI();
                this.save({ target: document.querySelector('input[name="qType"]:checked') });
            },

            updateUI() {
                document.querySelectorAll('.step').forEach(e => e.classList.add('hidden'));
                const curId = this.flow[this.step];
                document.getElementById(curId).classList.remove('hidden');
                
                // Render drivers/vehicles when landing on step 4
                if (curId === 'step-4') {
                    this.renderDrivers();
                    this.renderVehicles();
                    
                    // Auto-add primary applicant as first driver if empty
                    if (this.drivers.length === 0 && this.data.firstName) {
                        this.drivers.push({
                            id: `driver_${Date.now()}`,
                            firstName: this.data.firstName || '',
                            lastName: this.data.lastName || '',
                            dob: this.data.dob || '',
                            dlNum: '',
                            dlState: 'WA',
                            relationship: 'Self'
                        });
                        this.renderDrivers();
                    }
                }
                
                // Auto-select current data when landing on export page
                if (curId === 'step-6') {
                    this.autoSaveCurrentQuote();
                }
                
                // Update step title
                const stepTitle = document.getElementById('stepTitle');
                const totalSteps = this.flow.length;
                const currentStep = this.step + 1;
                const stepName = this.stepTitles[curId] || 'Step';
                stepTitle.textContent = `Step ${currentStep} of ${totalSteps}: ${stepName}`;
                
                // Progress
                const pct = ((this.step + 1) / this.flow.length) * 100;
                document.getElementById('progressBar').style.width = pct + '%';
                
                // Buttons
                const back = document.getElementById('btnBack');
                const next = document.getElementById('btnNext');
                back.disabled = this.step === 0;
                next.textContent = this.step === this.flow.length - 1 ? 'Finish' : 'Next';
                
                document.getElementById('mainContainer').scrollTo(0,0);
            },

            next() {
                // Validate current step before proceeding
                const curStepId = this.flow[this.step];
                const stepNumber = parseInt(curStepId.split('-')[1]);
                
                if (typeof Validation !== 'undefined') {
                    const errors = Validation.validateStep(stepNumber);
                    
                    // Clear all previous errors
                    document.querySelectorAll('.validation-error').forEach(e => e.remove());
                    document.querySelectorAll('input, select, textarea').forEach(el => {
                        el.style.borderColor = '';
                        el.style.background = '';
                    });
                    
                    // Show new errors
                    if (errors.length > 0) {
                        errors.forEach(err => {
                            if (err.field) {
                                Validation.showError(err.field, err.message);
                            }
                        });
                        
                        // Scroll to first error
                        const firstError = document.querySelector('.validation-error');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        this.toast('‚ö†Ô∏è Please fix validation errors before continuing');
                        return; // Don't proceed
                    }
                }
                
                if (this.step < this.flow.length - 1) {
                    this.step++;
                    this.updateUI();
                }
            },
            prev() {
                if (this.step > 0) {
                    this.step--;
                    this.updateUI();
                }
            },

            async save(e) {
                const k = e.target.id || e.target.name;
                this.data[k] = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                
                // Encrypt before storing
                if (this.encryptionEnabled) {
                    const encrypted = await CryptoHelper.encrypt(this.data);
                    localStorage.setItem(this.storageKey, encrypted);
                } else {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                }
                
                const ind = document.getElementById('saveIndicator');
                ind.style.opacity = 1;
                setTimeout(() => ind.style.opacity = 0, 1500);
            },

            async load() {
                const s = localStorage.getItem(this.storageKey);
                if (!s) return;
                
                // Try decrypting first
                if (this.encryptionEnabled) {
                    const decrypted = await CryptoHelper.decrypt(s);
                    if (decrypted) {
                        this.applyData(decrypted);
                    }
                } else {
                    this.applyData(JSON.parse(s));
                }
            },

            applyData(data) {
                this.data = data || {};
                Object.keys(this.data).forEach(k => {
                    const el = document.getElementById(k);
                    if(el) {
                        if(el.type === 'checkbox') {
                            el.checked = this.data[k];
                        } else {
                            el.value = this.data[k];
                        }
                    }
                    if(k === 'qType') {
                        const r = document.querySelector(`input[name="qType"][value="${this.data[k]}"]`);
                        if(r) r.checked = true;
                    }
                });
                this.checkUpdates();
                this.handleType();
            },

            // === PROGRESSIVE DISCLOSURE ===
            checkUpdates() {
                const yrBuilt = document.getElementById('yrBuilt').value;
                const updatesCard = document.getElementById('updatesCard');
                
                if(yrBuilt && parseInt(yrBuilt) < 2000) {
                    updatesCard.classList.remove('hidden');
                } else {
                    updatesCard.classList.add('hidden');
                }
            },

            // === FEATURES ===
            async decodeVin(el) {
                const v = el.value.toUpperCase();
                if(v.length === 17) {
                    try {
                        document.getElementById('vinResult').innerText = "üîç Decoding...";
                        const r = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${v}?format=json`);
                        const d = await r.json();
                        const r1 = d.Results[0];
                        const desc = `${r1.ModelYear} ${r1.Make} ${r1.Model}`;
                        document.getElementById('vehDesc').value = desc;
                        document.getElementById('vinResult').innerText = "‚úì " + desc;
                        this.data.vehDesc = desc; // Force save
                    } catch(e) { document.getElementById('vinResult').innerText = "‚ö†Ô∏è Decode Error"; }
                }
            },

            fmtPhone(e) {
                let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            },

            // === MAP PREVIEWS (Street View + Satellite) ===
            async ensureMapApiKey() {
                if (this.mapApiKey) return this.mapApiKey;
                try {
                    // Try fetching from Vercel serverless function first
                    let res = await fetch('/api/places-config.js');
                    if (res.ok) {
                        const { apiKey } = await res.json();
                        if (apiKey) {
                            this.mapApiKey = apiKey;
                            return this.mapApiKey;
                        }
                    }
                } catch (e) {}
                
                try {
                    // Fallback: fetch from JSON config file (for local dev)
                    const res = await fetch('/api/config.json');
                    if (res.ok) {
                        const { apiKey } = await res.json();
                        if (apiKey) {
                            this.mapApiKey = apiKey;
                            return this.mapApiKey;
                        }
                    }
                } catch (e) {}
                
                return null;
            },

            getFullAddress(data = this.data) {
                const parts = [data.addrStreet, data.addrCity, data.addrState, data.addrZip].filter(Boolean);
                return parts.join(', ').trim();
            },

            getMapUrls(address) {
                if (!address || !this.mapApiKey) return null;
                const encoded = encodeURIComponent(address);
                const streetViewUrl = `https://maps.googleapis.com/maps/api/streetview?size=640x360&location=${encoded}&fov=80&pitch=0&key=${this.mapApiKey}`;
                const satelliteUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${encoded}&zoom=19&size=640x360&maptype=satellite&key=${this.mapApiKey}`;
                return { streetViewUrl, satelliteUrl };
            },

            async updateMapPreviews() {
                const hint = document.getElementById('mapPreviewHint');
                const streetImg = document.getElementById('streetViewImg');
                const satImg = document.getElementById('satelliteViewImg');
                if (!streetImg || !satImg) return;

                streetImg.onclick = () => this.openStreetView();
                satImg.onclick = () => this.openGoogleMaps();

                const address = this.getFullAddress();
                if (!address) {
                    if (hint) hint.textContent = 'Enter an address to load previews.';
                    streetImg.removeAttribute('src');
                    satImg.removeAttribute('src');
                    return;
                }

                const apiKey = await this.ensureMapApiKey();
                if (!apiKey) {
                    if (hint) hint.textContent = 'Map previews unavailable (API key not configured).';
                    return;
                }

                const cached = this.mapPreviewCache[address];
                if (cached) {
                    streetImg.src = cached.streetViewUrl;
                    satImg.src = cached.satelliteUrl;
                    if (hint) hint.textContent = ' '; 
                    return;
                }

                const urls = this.getMapUrls(address);
                if (!urls) return;

                this.mapPreviewCache[address] = urls;
                streetImg.src = urls.streetViewUrl;
                satImg.src = urls.satelliteUrl;
                if (hint) hint.textContent = ' '; 
            },

            scheduleMapPreviewUpdate() {
                clearTimeout(this.mapPreviewTimer);
                this.mapPreviewTimer = setTimeout(() => this.updateMapPreviews(), 450);
            },

            openGoogleMaps() {
                const address = this.getFullAddress();
                if (!address) return;
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`, '_blank');
            },

            openGoogleEarth() {
                const address = this.getFullAddress();
                if (!address) return;
                window.open(`https://earth.google.com/web/search/${encodeURIComponent(address)}`, '_blank');
            },

            async openStreetView() {
                const address = this.getFullAddress();
                if (!address) return;

                try {
                    const apiKey = await this.ensureMapApiKey();
                    if (apiKey) {
                        const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`;
                        const res = await fetch(geocodeUrl);
                        if (res.ok) {
                            const data = await res.json();
                            const loc = data?.results?.[0]?.geometry?.location;
                            if (loc && typeof loc.lat === 'number' && typeof loc.lng === 'number') {
                                window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${loc.lat},${loc.lng}`, '_blank');
                                return;
                            }
                        }
                    }
                } catch (e) {}

                window.open(`https://www.google.com/maps/@?api=1&map_action=pano&query=${encodeURIComponent(address)}`, '_blank');
            },

            async fetchImageDataUrl(url) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) return null;
                    const buffer = await res.arrayBuffer();
                    const bytes = new Uint8Array(buffer);
                    const base64 = btoa(String.fromCharCode(...bytes));
                    const contentType = res.headers.get('content-type') || 'image/jpeg';
                    const format = contentType.includes('png') ? 'PNG' : 'JPEG';
                    return { dataUrl: `data:${contentType};base64,${base64}`, format };
                } catch (e) {
                    return null;
                }
            },

            async getMapImages(address) {
                const apiKey = await this.ensureMapApiKey();
                if (!apiKey || !address) return null;
                const urls = this.getMapUrls(address);
                if (!urls) return null;

                const cacheKey = `${address}::data`;
                if (this.mapPreviewCache[cacheKey]) return this.mapPreviewCache[cacheKey];

                const [street, sat] = await Promise.all([
                    this.fetchImageDataUrl(urls.streetViewUrl),
                    this.fetchImageDataUrl(urls.satelliteUrl)
                ]);

                const result = {
                    streetView: street,
                    satellite: sat
                };
                this.mapPreviewCache[cacheKey] = result;
                return result;
            },

            // === MULTIPLE DRIVERS/VEHICLES ===
            addDriver() {
                const id = `driver_${Date.now()}`;
                const driver = {
                    id,
                    firstName: '',
                    lastName: '',
                    dob: '',
                    dlNum: '',
                    dlState: 'WA',
                    relationship: 'Self'
                };
                this.drivers.push(driver);
                this.renderDrivers();
                this.saveDriversVehicles();
            },

            removeDriver(id) {
                this.drivers = this.drivers.filter(d => d.id !== id);
                this.renderDrivers();
                this.saveDriversVehicles();
            },

            updateDriver(id, field, value) {
                const driver = this.drivers.find(d => d.id === id);
                if (driver) {
                    driver[field] = value;
                    this.saveDriversVehicles();
                }
            },

            openDriverLicensePicker(driverId) {
                const input = document.getElementById(`dlScan_${driverId}`);
                if (input) input.click();
            },

            async handleDriverLicenseFile(driverId, file) {
                if (!file) return;
                const previewUrl = URL.createObjectURL(file);
                const result = await this.processDriverLicenseImage(file);
                if (!result?.success) {
                    URL.revokeObjectURL(previewUrl);
                    this.toast('‚ö†Ô∏è Unable to read driver license.');
                    return;
                }

                const driver = this.drivers.find(d => d.id === driverId);
                if (!driver) return;

                driver.dlScanPreview = previewUrl;
                driver.dlScanConfidence = result.confidence || '';

                const data = result.data || {};

                if (!driver.firstName && data.firstName) driver.firstName = data.firstName;
                if (!driver.lastName && data.lastName) driver.lastName = data.lastName;
                if (!driver.dob && data.dob) driver.dob = data.dob;
                if (!driver.dlNum && data.licenseNumber) driver.dlNum = data.licenseNumber;
                if (!driver.dlState && data.licenseState) driver.dlState = data.licenseState;

                const setFieldIfEmpty = (id, value) => {
                    if (!value) return;
                    const el = document.getElementById(id);
                    if (!el || el.value) return;
                    el.value = value;
                    this.save({ target: { id, value } });
                };

                setFieldIfEmpty('addrStreet', data.addressLine1);
                setFieldIfEmpty('addrCity', data.city);
                setFieldIfEmpty('addrState', data.state);
                setFieldIfEmpty('addrZip', data.zip);

                this.saveDriversVehicles();
                this.renderDrivers();
                this.toast('‚úÖ License data captured');
            },

            async processDriverLicenseImage(imageFile) {
                if (!imageFile) return null;

                const reader = new FileReader();
                return new Promise((resolve) => {
                    reader.onload = async (e) => {
                        const base64Data = e.target.result.split(',')[1];

                        try {
                            const response = await fetch('/api/vision-processor.js', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'scanDriverLicense',
                                    base64Data,
                                    mimeType: imageFile.type || 'image/jpeg'
                                })
                            });

                            const result = await response.json();
                            resolve(result);
                        } catch (error) {
                            console.error('Driver license scan error:', error);
                            resolve({ success: false, error: error.message });
                        }
                    };
                    reader.readAsDataURL(imageFile);
                });
            },

            renderDrivers() {
                const container = document.getElementById('driversList');
                if (!container) return;
                
                if (this.drivers.length === 0) {
                    container.innerHTML = '<div class="hint">üë§ No drivers added yet. Click "+ Add Driver" below to get started.</div>';
                    return;
                }
                
                container.innerHTML = this.drivers.map((driver, index) => {
                    const isPrimary = index === 0;
                    const relationshipLabel = driver.relationship
                        ? (driver.relationship === 'Self' && isPrimary ? '‚Ä¢ Self' : (driver.relationship !== 'Self' ? `‚Ä¢ ${driver.relationship}` : ''))
                        : '';

                    return `
                    <div class="driver-vehicle-card">
                        <div class="driver-vehicle-header">
                            <h3>üë§ Driver ${index + 1} ${relationshipLabel}</h3>
                            <button class="remove-btn" onclick="App.removeDriver('${driver.id}')" title="Remove driver">√ó</button>
                        </div>
                        
                        <div class="grid-2">
                            <div>
                                <label class="label">First Name</label>
                                <input type="text" value="${driver.firstName || ''}" 
                                    onchange="App.updateDriver('${driver.id}', 'firstName', this.value)" 
                                    placeholder="First name">
                            </div>
                            <div>
                                <label class="label">Last Name</label>
                                <input type="text" value="${driver.lastName || ''}" 
                                    onchange="App.updateDriver('${driver.id}', 'lastName', this.value)" 
                                    placeholder="Last name">
                            </div>
                        </div>
                        
                        <div class="grid-2">
                            <div>
                                <label class="label">Date of Birth</label>
                                <input type="date" value="${driver.dob || ''}" 
                                    onchange="App.updateDriver('${driver.id}', 'dob', this.value)">
                            </div>
                            <div>
                                <label class="label">Relationship</label>
                                <select onchange="App.updateDriver('${driver.id}', 'relationship', this.value)">
                                    ${isPrimary ? `<option value="Self" ${driver.relationship === 'Self' ? 'selected' : ''}>üôã Self (Primary)</option>` : ''}
                                    <option value="Spouse" ${driver.relationship === 'Spouse' ? 'selected' : ''}>üíë Spouse/Partner</option>
                                    <option value="Child" ${driver.relationship === 'Child' ? 'selected' : ''}>üë∂ Child</option>
                                    <option value="Parent" ${driver.relationship === 'Parent' ? 'selected' : ''}>üëµ Parent</option>
                                    <option value="Other" ${driver.relationship === 'Other' ? 'selected' : ''}>üë• Other Household Member</option>
                                </select>
                            </div>
                        </div>

                        <label class="label">Occupation</label>
                        <input type="text" value="${driver.occupation || ''}" 
                            onchange="App.updateDriver('${driver.id}', 'occupation', this.value)" 
                            placeholder="Occupation">
                        
                        <label class="label">Driver's License</label>
                        <div class="export-row" style="margin-bottom:10px; align-items:center;">
                            <button class="btn btn-tertiary" onclick="App.openDriverLicensePicker('${driver.id}')">üì∏ Scan Driver's License</button>
                            <input id="dlScan_${driver.id}" type="file" accept="image/*" class="hidden" onchange="App.handleDriverLicenseFile('${driver.id}', this.files[0])" />
                            ${driver.dlScanPreview ? `<img src="${driver.dlScanPreview}" alt="DL preview" style="width:48px;height:32px;object-fit:cover;border-radius:6px;border:1px solid var(--border);" />` : ''}
                            ${driver.dlScanConfidence ? `<span class="hint" style="margin:0; padding:6px 10px;">${driver.dlScanConfidence}% confidence</span>` : ''}
                        </div>
                        <div class="grid-2">
                            <input type="text" value="${driver.dlNum || ''}" 
                                onchange="App.updateDriver('${driver.id}', 'dlNum', this.value)" 
                                style="text-transform:uppercase;font-family:monospace" 
                                placeholder="License #">
                            <input type="text" value="${driver.dlState || 'WA'}" 
                                onchange="App.updateDriver('${driver.id}', 'dlState', this.value)" 
                                placeholder="State" maxlength="2" style="text-transform:uppercase">
                        </div>
                    </div>
                `;
                }).join('');
            },

            addVehicle() {
                const id = `vehicle_${Date.now()}`;
                const vehicle = {
                    id,
                    vin: '',
                    year: '',
                    make: '',
                    model: '',
                    use: 'Commute',
                    miles: '12000',
                    primaryDriver: ''
                };
                this.vehicles.push(vehicle);
                this.renderVehicles();
                this.saveDriversVehicles();
            },

            removeVehicle(id) {
                this.vehicles = this.vehicles.filter(v => v.id !== id);
                this.renderVehicles();
                this.saveDriversVehicles();
            },

            updateVehicle(id, field, value) {
                const vehicle = this.vehicles.find(v => v.id === id);
                if (vehicle) {
                    vehicle[field] = value;
                    this.saveDriversVehicles();
                }
            },

            async decodeVehicleVin(id, vin) {
                const vehicle = this.vehicles.find(v => v.id === id);
                if (!vehicle) return;
                
                const vinUpper = vin.toUpperCase();
                vehicle.vin = vinUpper;
                
                if (vinUpper.length === 17) {
                    try {
                        const r = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vinUpper}?format=json`);
                        const d = await r.json();
                        const r1 = d.Results[0];
                        
                        vehicle.year = r1.ModelYear || '';
                        vehicle.make = r1.Make || '';
                        vehicle.model = r1.Model || '';
                        
                        this.renderVehicles();
                        this.saveDriversVehicles();
                    } catch(e) {
                        console.error('VIN decode error:', e);
                    }
                }
            },

            renderVehicles() {
                const container = document.getElementById('vehiclesList');
                if (!container) return;
                
                if (this.vehicles.length === 0) {
                    container.innerHTML = '<div class="hint">üöó No vehicles added yet. Click "+ Add Vehicle" below to get started.</div>';
                    return;
                }
                
                const driverOptions = this.drivers.map(d => 
                    `<option value="${d.id}">${d.firstName} ${d.lastName}</option>`
                ).join('');
                
                container.innerHTML = this.vehicles.map((vehicle, index) => `
                    <div class="driver-vehicle-card">
                        <div class="driver-vehicle-header">
                            <h3>üöó Vehicle ${index + 1} ${vehicle.year && vehicle.make ? `‚Ä¢ ${vehicle.year} ${vehicle.make}` : ''}</h3>
                            <button class="remove-btn" onclick="App.removeVehicle('${vehicle.id}')" title="Remove vehicle">√ó</button>
                        </div>
                        
                        <label class="label">VIN (17 Characters) - Auto-fills year/make/model</label>
                        <input type="text" maxlength="17" value="${vehicle.vin || ''}" 
                            onchange="App.decodeVehicleVin('${vehicle.id}', this.value)" 
                            style="text-transform:uppercase;font-family:monospace" 
                            placeholder="1HG...">
                        
                        <div class="grid-2" style="grid-template-columns: 80px 1fr 1fr;">
                            <div>
                                <label class="label">Year</label>
                                <input type="text" value="${vehicle.year || ''}" 
                                    onchange="App.updateVehicle('${vehicle.id}', 'year', this.value)" 
                                    placeholder="2020">
                            </div>
                            <div>
                                <label class="label">Make</label>
                                <input type="text" value="${vehicle.make || ''}" 
                                    onchange="App.updateVehicle('${vehicle.id}', 'make', this.value)" 
                                    placeholder="Honda">
                            </div>
                            <div>
                                <label class="label">Model</label>
                                <input type="text" value="${vehicle.model || ''}" 
                                    onchange="App.updateVehicle('${vehicle.id}', 'model', this.value)" 
                                    placeholder="Civic">
                            </div>
                        </div>
                        
                        <div class="grid-2">
                            <div>
                                <label class="label">Primary Use</label>
                                <select onchange="App.updateVehicle('${vehicle.id}', 'use', this.value)">
                                    <option value="Commute" ${vehicle.use === 'Commute' ? 'selected' : ''}>üè¢ Commute</option>
                                    <option value="Pleasure" ${vehicle.use === 'Pleasure' ? 'selected' : ''}>üå¥ Pleasure</option>
                                    <option value="Business" ${vehicle.use === 'Business' ? 'selected' : ''}>üíº Business</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">Annual Mileage</label>
                                <input type="number" value="${vehicle.miles || '12000'}" 
                                    onchange="App.updateVehicle('${vehicle.id}', 'miles', this.value)" 
                                    placeholder="12000">
                            </div>
                        </div>
                        
                        <label class="label">Primary Driver</label>
                        <select onchange="App.updateVehicle('${vehicle.id}', 'primaryDriver', this.value)">
                            <option value="">Select driver...</option>
                            ${driverOptions}
                        </select>
                    </div>
                `).join('');
            },

            async saveDriversVehicles() {
                this.data.drivers = this.drivers;
                this.data.vehicles = this.vehicles;
                
                // Encrypt and save
                if (this.encryptionEnabled) {
                    const encrypted = await CryptoHelper.encrypt(this.data);
                    localStorage.setItem(this.storageKey, encrypted);
                } else {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                }
            },

            async loadDriversVehicles() {
                if (this.data.drivers && Array.isArray(this.data.drivers)) {
                    this.drivers = this.data.drivers;
                } else {
                    // Migrate old single driver/vehicle to new format
                    if (this.data.dlNum || this.data.vin) {
                        this.drivers = [{
                            id: `driver_${Date.now()}`,
                            firstName: this.data.firstName || '',
                            lastName: this.data.lastName || '',
                            dob: this.data.dob || '',
                            dlNum: this.data.dlNum || '',
                            dlState: this.data.dlState || 'WA',
                            relationship: 'Self'
                        }];
                    }
                }

                // Cleanup any stale object URLs in stored drivers
                if (Array.isArray(this.drivers)) {
                    this.drivers.forEach(d => {
                        if (d.dlScanPreview && d.dlScanPreview.startsWith('blob:')) {
                            d.dlScanPreview = '';
                        }
                    });
                }
                
                if (this.data.vehicles && Array.isArray(this.data.vehicles)) {
                    this.vehicles = this.data.vehicles;
                } else {
                    // Migrate old single vehicle
                    if (this.data.vin || this.data.vehDesc) {
                        const parts = (this.data.vehDesc || '').match(/(\d{4})\s+(.+?)\s+(.+)/);
                        this.vehicles = [{
                            id: `vehicle_${Date.now()}`,
                            vin: this.data.vin || '',
                            year: parts ? parts[1] : '',
                            make: parts ? parts[2] : '',
                            model: parts ? parts[3] : '',
                            use: this.data.use || 'Commute',
                            miles: this.data.miles || '12000',
                            primaryDriver: ''
                        }];
                    }
                }
                
                this.renderDrivers();
                this.renderVehicles();
            },

            openZillow() {
                const a = `${this.data.addrStreet || ''} ${this.data.addrCity || ''} ${this.data.addrState || ''} ${this.data.addrZip || ''}`;
                window.open(`https://www.zillow.com/homes/${encodeURIComponent(a)}_rb/`);
            },

            openPropertyResearch() {
                const address = this.data.addrStreet || '';
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const zip = this.data.addrZip || '';
                
                if (!address || !city || !state) {
                    alert('Please enter a complete address (street, city, and state) first.');
                    return;
                }
                
                // Open research tools in new tabs/windows
                const addr = `${address} ${city} ${state} ${zip}`.trim();
                const zillowUrl = `https://www.zillow.com/homes/${encodeURIComponent(addr)}_rb/`;
                window.open(zillowUrl, 'zillow');
                
                // Also trigger GIS if available
                setTimeout(() => this.openGIS(), 500);
            },

            async smartAutoFill() {
                const address = this.data.addrStreet || '';
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const zip = this.data.addrZip || '';
                
                if (!address || !city || !state) {
                    alert('Please enter a complete address (street, city, and state) first.');
                    return;
                }
                
                const btn = document.getElementById('smartFillBtn');
                const originalText = btn.innerHTML;
                const county = this.getCountyFromCity(city, state);
                
                try {
                    let rawParcelData = null;
                    let dataSource = null;
                    
                    // PHASE 1: Try ArcGIS API first (Official County Data)
                    btn.disabled = true;
                    btn.innerHTML = 'üîÑ Querying official county records...';
                    
                    const arcgisResponse = await fetch(`/api/arcgis-consumer.js?address=${encodeURIComponent(address)}&city=${encodeURIComponent(city)}&state=${encodeURIComponent(state)}&county=${encodeURIComponent(county)}`);
                    
                    if (arcgisResponse.ok) {
                        const arcgisData = await arcgisResponse.json();
                        
                        if (arcgisData.success && arcgisData.parcelData) {
                            rawParcelData = arcgisData.parcelData;
                            dataSource = 'phase1-arcgis';
                        }
                    }
                    
                    // PHASE 2: Try Headless Browser scraping (for non-API counties)
                    if (!rawParcelData) {
                        btn.innerHTML = 'üîÑ Accessing county database...';
                        
                        const gisUrl = this.getGISUrlForCounty(city, state);
                        const browserResponse = await fetch(`/api/headless-browser.js?address=${encodeURIComponent(address)}&city=${encodeURIComponent(city)}&state=${encodeURIComponent(state)}&county=${encodeURIComponent(county)}&gisUrl=${encodeURIComponent(gisUrl || '')}`);
                        
                        if (browserResponse.ok) {
                            const browserData = await browserResponse.json();
                            
                            if (browserData.success && browserData.parcelData) {
                                rawParcelData = browserData.parcelData;
                                dataSource = 'phase2-browser';
                            }
                        }
                    }
                    
                    // PHASE 3: RAG Pattern - Interpret raw data with Gemini
                    if (rawParcelData) {
                        btn.innerHTML = 'üß† Standardizing property data...';
                        
                        const ragResponse = await fetch('/api/rag-interpreter.js', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                rawParcelData: rawParcelData,
                                county: county
                            })
                        });
                        
                        if (ragResponse.ok) {
                            const ragData = await ragResponse.json();
                            
                            if (ragData.success && ragData.parcelData) {
                                // Phase 3 Success: Got interpreted parcel data (99% confidence)
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                                
                                // Show RAG-interpreted data with highest confidence
                                this.showParcelDataPopup(ragData.parcelData, address, city, state, 0.99, dataSource);
                                return;
                            }
                        }
                        
                        // RAG interpretation failed, show raw data from Phase 1 or 2
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        
                        const confidence = dataSource === 'phase1-arcgis' ? 0.95 : 0.85;
                        this.showParcelDataPopup(rawParcelData, address, city, state, confidence, dataSource);
                        return;
                    }
                    
                    // PHASE 4: Try Vision Processing (Images, PDFs, Aerial analysis)
                    // This is the enrichment layer - adds visual/document data to the form
                    btn.innerHTML = 'üëÅÔ∏è Analyzing visual data...';
                    
                    // For now, this is a placeholder for future integration
                    // Vision processing would happen here if user uploads images/PDFs
                    // Example: await this.processVisionData(address, city, state);
                    
                    // FALLBACK: No official data available, try satellite hazard detection
                    btn.innerHTML = 'üîÑ Analyzing satellite imagery...';
                    
                    const hazardResponse = await fetch('/api/smart-extract.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, city, state, zip })
                    });
                    
                    if (!hazardResponse.ok) {
                        throw new Error('Failed to analyze property');
                    }
                    
                    const result = await hazardResponse.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Analysis failed');
                    }
                    
                    // Reset button
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    
                    // Show elegant hazard detection popup
                    const fullAddress = `${address}, ${city}, ${state} ${zip || ''}`.trim();
                    this.showHazardDetectionPopup(result.data, result.satelliteImage, fullAddress);
                    
                } catch (error) {
                    console.error('Smart auto-fill error:', error);
                    btn.innerHTML = '‚ùå Failed';
                    alert('Failed to retrieve property data.\n\nTry:\n- Manually entering details\n- Using Zillow or GIS lookup\n- Checking County property records');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 3000);
                }
            },

            getGISUrlForCounty(city, state) {
                // Returns the GIS URL for browser fallback (from existing openGIS() method)
                // This allows Phase 2 to access the same county websites
                const countyMappings = {
                    'WA': {
                        'Vancouver': 'https://www.clark.wa.gov/GIS/',
                        'Seattle': 'https://gis.kingcounty.gov/',
                        'Tacoma': 'https://gis.piercecountywa.gov/',
                        'Spokane': 'https://www.spokanecounty.org/government/assessor/'
                    },
                    'OR': {
                        'Portland': 'https://ggis.multco.us/',
                        'Salem': 'https://www.marionco.us/assessor/',
                        'Eugene': 'https://www.lanecountygov.org/'
                    },
                    'AZ': {
                        'Phoenix': 'https://gis.maricopa.gov/',
                        'Tucson': 'https://www.pimacountyassessor.com/'
                    }
                };
                
                const stateMap = countyMappings[state];
                return stateMap ? stateMap[city] || '' : '';
            },

            showParcelDataPopup(parcelData, address, city, state, confidence = 1.0, dataSource = 'unknown') {
                // Display official county parcel data in confirmation popup
                // confidence: 1.0 = ArcGIS API, 0.99 = RAG interpreted, 0.85 = browser scraping
                // dataSource: 'phase1-arcgis', 'phase2-browser', or 'phase3-rag'
                
                const modal = document.createElement('div');
                modal.id = 'parcelDataModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                // Determine title and styling based on confidence/data source
                let titleText = '‚úì Official County Parcel Data Found';
                let titleColor = '#28a745';
                let warningText = null;
                
                if (confidence === 0.99) {
                    titleText = '‚úì Property Data Verified & Standardized';
                    titleColor = '#28a745';
                    warningText = '‚úÖ Data has been verified by AI and standardized for accuracy (99% confidence).';
                } else if (confidence === 0.95) {
                    titleText = '‚úì Official County Parcel Data Found';
                    titleColor = '#28a745';
                } else if (confidence < 0.95) {
                    titleText = '‚úì Extracted County Data (Browser)';
                    titleColor = '#ffc107';
                    warningText = '‚ö† Data extracted from county website (' + Math.round(confidence * 100) + '% confidence). Please review before submitting.';
                }
                
                const title = document.createElement('h2');
                title.textContent = titleText;
                title.style.cssText = `margin: 0 0 16px 0; color: ${titleColor};`;
                
                const addressLine = document.createElement('p');
                addressLine.style.cssText = 'color: #666; margin: 8px 0; font-size: 14px;';
                addressLine.textContent = `${address}, ${city}, ${state} ‚Ä¢ Parcel: ${parcelData.parcelId}`;
                
                content.appendChild(title);
                content.appendChild(addressLine);
                
                // Add appropriate warning/confirmation banner
                if (warningText) {
                    const banner = document.createElement('p');
                    const bannerBgColor = confidence === 0.99 ? '#d4edda' : '#fff3cd';
                    const bannerBorderColor = confidence === 0.99 ? '#28a745' : '#ffc107';
                    const bannerTextColor = confidence === 0.99 ? '#155724' : '#856404';
                    banner.style.cssText = `background: ${bannerBgColor}; border-left: 4px solid ${bannerBorderColor}; padding: 8px 12px; margin: 12px 0; font-size: 12px; color: ${bannerTextColor}; border-radius: 3px;`;
                    banner.textContent = warningText;
                    content.appendChild(banner);
                }
                
                const grid = document.createElement('div');
                grid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0;';
                
                const fields = [
                    { label: 'Year Built', value: parcelData.yearBuilt || 'N/A' },
                    { label: 'Lot Size', value: parcelData.lotSizeAcres > 0 ? `${parcelData.lotSizeAcres.toFixed(2)} acres` : 'N/A' },
                    { label: 'Total Sq Ft', value: parcelData.totalSqft > 0 ? parcelData.totalSqft.toLocaleString() : 'N/A' },
                    { label: 'Stories', value: parcelData.stories > 0 ? parcelData.stories : 'N/A' },
                    { label: 'Garage Sq Ft', value: parcelData.garageSqft > 0 ? parcelData.garageSqft.toLocaleString() : 'N/A' },
                    { label: 'Land Use', value: parcelData.landUse || 'N/A' }
                ];
                
                fields.forEach(field => {
                    const box = document.createElement('div');
                    box.style.cssText = 'background: #f5f5f5; padding: 12px; border-radius: 6px;';
                    
                    const label = document.createElement('div');
                    label.style.cssText = 'font-size: 12px; color: #999; text-transform: uppercase; margin-bottom: 4px;';
                    label.textContent = field.label;
                    
                    const value = document.createElement('div');
                    value.style.cssText = 'font-size: 16px; font-weight: 600; color: #333;';
                    value.textContent = field.value;
                    
                    box.appendChild(label);
                    box.appendChild(value);
                    grid.appendChild(box);
                });
                
                const buttonBox = document.createElement('div');
                buttonBox.style.cssText = 'display: flex; gap: 12px; margin-top: 20px;';
                
                const useBtn = document.createElement('button');
                useBtn.textContent = '‚úì Use This Data';
                useBtn.style.cssText = `
                    flex: 1;
                    padding: 12px;
                    background: #28a745;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                `;
                useBtn.onclick = () => {
                    this.applyParcelData(parcelData);
                    this.closeParcelModal();
                };
                
                const skipBtn = document.createElement('button');
                skipBtn.textContent = '‚úó Skip';
                skipBtn.style.cssText = `
                    flex: 1;
                    padding: 12px;
                    background: #6c757d;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                `;
                skipBtn.onclick = () => this.closeParcelModal();
                
                buttonBox.appendChild(useBtn);
                buttonBox.appendChild(skipBtn);
                
                content.appendChild(title);
                content.appendChild(addressLine);
                content.appendChild(grid);
                content.appendChild(buttonBox);
                modal.appendChild(content);
                
                modal.onclick = (e) => {
                    if (e.target === modal) this.closeParcelModal();
                };
                
                document.body.appendChild(modal);
            },

            closeParcelModal() {
                const modal = document.getElementById('parcelDataModal');
                if (modal) {
                    modal.style.opacity = '0';
                    modal.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => modal.remove(), 300);
                }
            },

            applyParcelData(parcelData) {
                // Auto-fill form fields from official county parcel data
                if (parcelData.yearBuilt) {
                    document.getElementById('yearBuilt').value = parcelData.yearBuilt;
                    this.data.yearBuilt = parcelData.yearBuilt;
                }
                
                if (parcelData.stories > 0) {
                    document.getElementById('numStories').value = parcelData.stories;
                    this.data.numStories = parcelData.stories;
                }
                
                if (parcelData.garageSqft > 0) {
                    // Estimate garage spaces (1 space ‚âà 180 sq ft)
                    const garageSpaces = Math.round(parcelData.garageSqft / 180);
                    document.getElementById('garageSpaces').value = garageSpaces;
                    this.data.garageSpaces = garageSpaces;
                }
                
                if (parcelData.lotSizeAcres > 0) {
                    document.getElementById('lotSize').value = parcelData.lotSizeAcres.toFixed(2);
                    this.data.lotSize = parcelData.lotSizeAcres.toFixed(2);
                }
                
                if (parcelData.totalSqft > 0) {
                    document.getElementById('squareFeet').value = parcelData.totalSqft;
                    this.data.squareFeet = parcelData.totalSqft;
                }
                
                // Save changes
                localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                
                // Show success toast
                this.showSaveIndicator();
            },

            showHazardDetectionPopup(detections, satelliteImage, address) {
                // Extract hazard information
                const hazards = {
                    pool: detections.pool === 'yes',
                    trampoline: detections.trampoline === 'yes',
                    deck: detections.deck === 'yes',
                    roofType: detections.roofType && detections.roofType !== 'unknown' ? detections.roofType : null,
                    numStories: detections.numStories && detections.numStories !== 'unknown' ? detections.numStories : null,
                    garageSpaces: detections.garageSpaces && detections.garageSpaces !== 'unknown' ? detections.garageSpaces : null,
                };
                
                // Count detected hazards
                const hazardCount = [hazards.pool, hazards.trampoline, hazards.deck].filter(Boolean).length;
                
                // Create elegant popup
                const modalHTML = `
                    <div class="modal-overlay" id="hazardDetectionModal">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h2>üõ°Ô∏è Property Analysis Complete</h2>
                                <p style="font-size: 13px; color: var(--text-secondary); margin: 8px 0 0 0;">
                                    ${address}
                                </p>
                            </div>
                            
                            <div class="modal-body">
                                ${satelliteImage ? `
                                    <div style="margin-bottom: 20px;">
                                        <p style="font-size: 12px; font-weight: 600; margin: 0 0 8px 0;">üõ∞Ô∏è Satellite Image</p>
                                        <img 
                                            src="data:image/png;base64,${satelliteImage}" 
                                            style="width: 100%; height: auto; border-radius: 12px; border: 1px solid var(--border); cursor: pointer;"
                                            onclick="App.viewSatelliteFullscreen(this.src)"
                                            title="Click to view fullscreen"
                                        >
                                        <p style="font-size: 11px; color: var(--text-secondary); margin: 6px 0 0 0; text-align: center;">Tap to view fullscreen</p>
                                    </div>
                                ` : ''}
                                
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                                    <p style="font-size: 12px; font-weight: 600; margin: 0 0 12px 0; color: var(--text);">Hazards Detected ${hazardCount > 0 ? `(${hazardCount})` : ''}</p>
                                    
                                    <div style="display: grid; gap: 8px;">
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="hazard_pool" ${hazards.pool ? 'checked' : ''} style="cursor: pointer;">
                                            <span style="font-size: 14px;">üèä Pool ${hazards.pool ? '‚úì Detected' : '(Not detected)'}</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="hazard_trampoline" ${hazards.trampoline ? 'checked' : ''} style="cursor: pointer;">
                                            <span style="font-size: 14px;">üé™ Trampoline ${hazards.trampoline ? '‚úì Detected' : '(Not detected)'}</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="hazard_deck" ${hazards.deck ? 'checked' : ''} style="cursor: pointer;">
                                            <span style="font-size: 14px;">üõãÔ∏è Deck/Patio ${hazards.deck ? '‚úì Detected' : '(Not detected)'}</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
                                    <p style="font-size: 12px; font-weight: 600; margin: 0 0 12px 0; color: var(--text);">Property Details</p>
                                    
                                    <div style="display: grid; gap: 8px;">
                                        ${hazards.numStories ? `
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="font-size: 14px;">üìä Stories:</span>
                                                <span style="font-size: 14px; font-weight: 600;">${hazards.numStories}</span>
                                            </div>
                                        ` : ''}
                                        ${hazards.roofType ? `
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="font-size: 14px;">üè† Roof Type:</span>
                                                <span style="font-size: 14px; font-weight: 600;">${hazards.roofType}</span>
                                            </div>
                                        ` : ''}
                                        ${hazards.garageSpaces ? `
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="font-size: 14px;">üöó Garage Spaces:</span>
                                                <span style="font-size: 14px; font-weight: 600;">${hazards.garageSpaces}</span>
                                            </div>
                                        ` : ''}
                                        ${!hazards.numStories && !hazards.roofType && !hazards.garageSpaces ? `
                                            <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">No additional details detected in satellite image.</p>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-footer">
                                <button class="btn-secondary" onclick="App.closeHazardModal()">Cancel</button>
                                <button class="btn-primary" onclick="App.applyHazardDetections()">‚úÖ Apply to Form</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existing = document.getElementById('hazardDetectionModal');
                if (existing) existing.remove();
                
                // Add to page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Show modal
                setTimeout(() => {
                    document.getElementById('hazardDetectionModal').classList.add('active');
                }, 10);
                
                // Store for later use
                this.detectedHazards = hazards;
            },

            closeHazardModal() {
                const modal = document.getElementById('hazardDetectionModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            },

            applyHazardDetections() {
                // Get user-confirmed hazards from checkboxes
                const pool = document.getElementById('hazard_pool')?.checked || false;
                const trampoline = document.getElementById('hazard_trampoline')?.checked || false;
                const deck = document.getElementById('hazard_deck')?.checked || false;
                
                // Apply to form
                if (pool) {
                    this.data.hasPool = 'yes';
                    const poolEl = document.getElementById('hasPool');
                    if (poolEl) poolEl.value = 'yes';
                }
                
                if (trampoline) {
                    this.data.hasTrampoline = 'yes';
                    const trampolineEl = document.getElementById('hasTrampoline');
                    if (trampolineEl) trampolineEl.value = 'yes';
                }
                
                if (deck) {
                    this.data.hasDeck = 'yes';
                    const deckEl = document.getElementById('hasDeck');
                    if (deckEl) deckEl.value = 'yes';
                }
                
                // Save to localStorage
                this.save({ target: { id: 'hasPool', value: pool ? 'yes' : '' } });
                
                // Show confirmation
                const hazardList = [pool ? 'üèä Pool' : null, trampoline ? 'üé™ Trampoline' : null, deck ? 'üõãÔ∏è Deck' : null].filter(Boolean);
                alert(`‚úÖ Applied to form:\n\n${hazardList.length > 0 ? hazardList.join('\n') : 'No hazards selected'}`);
                
                // Close modal
                this.closeHazardModal();
            },

            // Phase 4: Vision Processing Methods
            
            async processVisionImage(imageFile) {
                /**
                 * Process a property image (roof, foundation, exterior, etc.)
                 * Sends base64-encoded image to vision-processor.js
                 */
                if (!imageFile) return null;
                
                const reader = new FileReader();
                return new Promise((resolve) => {
                    reader.onload = async (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        
                        try {
                            const response = await fetch('/api/vision-processor.js', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'processImage',
                                    base64Data: base64Data,
                                    mimeType: imageFile.type || 'image/jpeg',
                                    imageType: 'property',
                                    county: this.getCountyFromCity(this.data.addrCity, this.data.addrState)
                                })
                            });
                            
                            const result = await response.json();
                            resolve(result);
                        } catch (error) {
                            console.error('Vision image processing error:', error);
                            resolve({ success: false, error: error.message });
                        }
                    };
                    reader.readAsDataURL(imageFile);
                });
            },

            async processVisionPDF(pdfFile, documentType = 'tax_summary') {
                /**
                 * Process a property document PDF (tax summary, assessment, etc.)
                 * Sends base64-encoded PDF to vision-processor.js
                 */
                if (!pdfFile) return null;
                
                const reader = new FileReader();
                return new Promise((resolve) => {
                    reader.onload = async (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        
                        try {
                            const response = await fetch('/api/vision-processor.js', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'processPDF',
                                    base64Data: base64Data,
                                    documentType: documentType,
                                    county: this.getCountyFromCity(this.data.addrCity, this.data.addrState)
                                })
                            });
                            
                            const result = await response.json();
                            resolve(result);
                        } catch (error) {
                            console.error('Vision PDF processing error:', error);
                            resolve({ success: false, error: error.message });
                        }
                    };
                    reader.readAsDataURL(pdfFile);
                });
            },

            async analyzeAerialImage(lat, lng) {
                /**
                 * Analyze satellite/aerial image for hazard assessment
                 * Uses Google Satellite imagery for flood, wildfire, wind hazards
                 */
                if (!lat || !lng) return null;
                
                try {
                    // Get satellite image first (using existing Google Maps API)
                    const imageUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=18&size=640x640&maptype=satellite&key=${process.env.GOOGLE_API_KEY}`;
                    
                    // Fetch image and convert to base64
                    const imageResponse = await fetch(imageUrl);
                    const blob = await imageResponse.blob();
                    const reader = new FileReader();
                    
                    return new Promise((resolve) => {
                        reader.onload = async (e) => {
                            const base64Data = e.target.result.split(',')[1];
                            
                            try {
                                const response = await fetch('/api/vision-processor.js', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        action: 'analyzeAerial',
                                        base64Data: base64Data,
                                        lat: lat,
                                        lng: lng,
                                        county: this.getCountyFromCity(this.data.addrCity, this.data.addrState)
                                    })
                                });
                                
                                const result = await response.json();
                                resolve(result);
                            } catch (error) {
                                console.error('Aerial analysis error:', error);
                                resolve({ success: false, error: error.message, hazards: [] });
                            }
                        };
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error('Aerial image retrieval error:', error);
                    return { success: false, error: error.message, hazards: [] };
                }
            },

            async consolidateVisionData(visionResults) {
                /**
                 * Consolidate results from multiple vision processing calls
                 * Returns standardized property data
                 */
                if (!visionResults) return null;
                
                try {
                    const response = await fetch('/api/vision-processor.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'consolidate',
                            visionResults: visionResults
                        })
                    });
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('Vision data consolidation error:', error);
                    return null;
                }
            },

            showVisionResultsPopup(visionData, imageType) {
                /**
                 * Display vision processing results in popup
                 * Allows user to confirm and apply extracted data
                 */
                if (!visionData || !visionData.success) {
                    alert('‚ùå Vision processing failed. Please try again.');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.id = 'visionResultsModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                const title = document.createElement('h2');
                title.textContent = `üëÅÔ∏è Vision Analysis Results (${imageType})`;
                title.style.cssText = 'margin: 0 0 16px 0; color: #007AFF;';
                
                const dataDiv = document.createElement('div');
                dataDiv.style.cssText = 'background: #f5f5f5; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                
                let dataHTML = '<p style="margin: 0; font-size: 14px;">';
                const rawData = visionData.rawData || {};
                
                for (const [key, value] of Object.entries(rawData)) {
                    if (value && value !== 'N/A' && value !== '') {
                        dataHTML += `<strong>${key}:</strong> ${value}<br>`;
                    }
                }
                
                dataHTML += '</p>';
                dataDiv.innerHTML = dataHTML;
                
                const confirmDiv = document.createElement('div');
                confirmDiv.style.cssText = 'display: flex; gap: 8px; margin-top: 16px;';
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.style.cssText = `
                    flex: 1;
                    padding: 12px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    background: white;
                    color: #333;
                    cursor: pointer;
                    font-weight: 500;
                `;
                cancelBtn.onclick = () => modal.remove();
                
                const applyBtn = document.createElement('button');
                applyBtn.textContent = '‚úÖ Apply Data';
                applyBtn.style.cssText = `
                    flex: 1;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #007AFF;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                `;
                applyBtn.onclick = () => {
                    this.applyVisionData(rawData);
                    modal.remove();
                };
                
                confirmDiv.appendChild(cancelBtn);
                confirmDiv.appendChild(applyBtn);
                
                content.appendChild(title);
                content.appendChild(dataDiv);
                content.appendChild(confirmDiv);
                modal.appendChild(content);
                document.body.appendChild(modal);
            },

            applyVisionData(data) {
                /**
                 * Apply vision-extracted data to form fields
                 */
                const fieldMappings = {
                    'year_built': 'yearBuilt',
                    'yearBuilt': 'yearBuilt',
                    'roof_type': 'roofType',
                    'roofType': 'roofType',
                    'stories': 'numStories',
                    'garage_spaces': 'numGarages',
                    'garageSpaces': 'numGarages',
                    'lot_size': 'lotSize',
                    'lotSize': 'lotSize',
                    'total_sqft': 'totalSqft',
                    'totalSqft': 'totalSqft'
                };
                
                for (const [visionKey, formKey] of Object.entries(fieldMappings)) {
                    if (data[visionKey]) {
                        const formElement = document.getElementById(formKey);
                        if (formElement) {
                            formElement.value = data[visionKey];
                            this.data[formKey] = data[visionKey];
                            this.save({ target: { id: formKey, value: data[visionKey] } });
                        }
                    }
                }
                
                alert(`‚úÖ Applied vision data to form`);
            },

            // Phase 5: Historical Data & Comparative Analysis Methods

            async analyzePropertyHistory() {
                /**
                 * Analyze property value history and market trends
                 * Called from Step 6 or property research section
                 */
                const address = this.data.addrStreet || '';
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const yearBuilt = this.data.yearBuilt || null;
                const county = this.getCountyFromCity(city, state);
                
                if (!address || !city || !state) {
                    alert('Please enter a complete address first.');
                    return;
                }
                
                try {
                    // Show loading state
                    const btn = document.getElementById('analyzeHistoryBtn');
                    const originalText = btn ? btn.innerHTML : 'Analyzing...';
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = 'üìä Analyzing property history...';
                    }
                    
                    // Call Phase 5: Value history analysis
                    const response = await fetch('/api/historical-analyzer.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'analyzeValues',
                            address: address,
                            city: city,
                            state: state,
                            county: county,
                            yearBuilt: yearBuilt ? parseInt(yearBuilt) : null
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showHistoryAnalysisPopup(result.data, address, city, state);
                    } else {
                        alert(`‚ùå History analysis failed: ${result.error || 'Unknown error'}`);
                    }
                    
                    // Reset button
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('Property history analysis error:', error);
                    alert('‚ùå Failed to analyze property history.');
                    const btn = document.getElementById('analyzeHistoryBtn');
                    if (btn) btn.disabled = false;
                }
            },

            async analyzeInsuranceTrends() {
                /**
                 * Analyze historical insurance rates and trends
                 */
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const county = this.getCountyFromCity(city, state);
                
                if (!county || !state) {
                    alert('Please enter a complete address first.');
                    return;
                }
                
                try {
                    const btn = document.getElementById('analyzeInsuranceBtn');
                    const originalText = btn ? btn.innerHTML : 'Analyzing...';
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = 'üìà Analyzing insurance trends...';
                    }
                    
                    const response = await fetch('/api/historical-analyzer.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'analyzeInsurance',
                            city: city,
                            state: state,
                            county: county,
                            riskLevel: 'all'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showInsuranceAnalysisPopup(result.data, county, state);
                    } else {
                        alert(`‚ùå Insurance analysis failed: ${result.error || 'Unknown error'}`);
                    }
                    
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('Insurance analysis error:', error);
                    alert('‚ùå Failed to analyze insurance trends.');
                    const btn = document.getElementById('analyzeInsuranceBtn');
                    if (btn) btn.disabled = false;
                }
            },

            async compareToMarket() {
                /**
                 * Compare property to market baseline and comparables
                 */
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const county = this.getCountyFromCity(city, state);
                const yearBuilt = this.data.yearBuilt || null;
                // Estimate property value if not provided
                const propertyValue = parseInt(this.data.propertyValue) || 500000;
                const sqft = parseInt(this.data.totalSqft) || null;
                
                if (!city || !state) {
                    alert('Please enter a complete address first.');
                    return;
                }
                
                try {
                    const btn = document.getElementById('compareMarketBtn');
                    const originalText = btn ? btn.innerHTML : 'Comparing...';
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = 'üîç Comparing to market...';
                    }
                    
                    const response = await fetch('/api/historical-analyzer.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'compareMarket',
                            city: city,
                            state: state,
                            county: county,
                            propertyValue: propertyValue,
                            yearBuilt: yearBuilt ? parseInt(yearBuilt) : null,
                            sqft: sqft
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showMarketComparisonPopup(result.data, city, state);
                    } else {
                        alert(`‚ùå Market comparison failed: ${result.error || 'Unknown error'}`);
                    }
                    
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('Market comparison error:', error);
                    alert('‚ùå Failed to compare to market.');
                    const btn = document.getElementById('compareMarketBtn');
                    if (btn) btn.disabled = false;
                }
            },

            async generatePropertyTimeline() {
                /**
                 * Generate comprehensive property timeline report
                 */
                const address = this.data.addrStreet || '';
                const city = this.data.addrCity || '';
                const state = this.data.addrState || '';
                const county = this.getCountyFromCity(city, state);
                const yearBuilt = this.data.yearBuilt || null;
                const propertyValue = parseInt(this.data.propertyValue) || 500000;
                const sqft = parseInt(this.data.totalSqft) || null;
                
                if (!address || !city || !state) {
                    alert('Please enter a complete address first.');
                    return;
                }
                
                try {
                    const btn = document.getElementById('timelineBtn');
                    const originalText = btn ? btn.innerHTML : 'Generating...';
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = 'üìÖ Generating timeline...';
                    }
                    
                    const response = await fetch('/api/historical-analyzer.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'generateTimeline',
                            address: address,
                            city: city,
                            state: state,
                            county: county,
                            yearBuilt: yearBuilt ? parseInt(yearBuilt) : null,
                            propertyValue: propertyValue,
                            sqft: sqft
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showTimelinePopup(result.data, address, city, state);
                    } else {
                        alert(`‚ùå Timeline generation failed: ${result.error || 'Unknown error'}`);
                    }
                    
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('Timeline generation error:', error);
                    alert('‚ùå Failed to generate timeline.');
                    const btn = document.getElementById('timelineBtn');
                    if (btn) btn.disabled = false;
                }
            },

            showHistoryAnalysisPopup(data, address, city, state) {
                /**
                 * Display property value history analysis
                 */
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 600px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                const title = document.createElement('h2');
                title.textContent = 'üìä Property Value History';
                title.style.cssText = 'margin: 0 0 16px 0; color: #28a745;';
                
                const addressLine = document.createElement('p');
                addressLine.style.cssText = 'color: #666; margin: 0 0 24px 0; font-size: 14px;';
                addressLine.textContent = `${address}, ${city}, ${state}`;
                
                const historyDiv = document.createElement('div');
                historyDiv.style.cssText = 'margin-bottom: 24px;';
                
                if (data.valueHistory) {
                    let historyHTML = '<p style="font-weight: 600; margin-bottom: 12px;">Estimated Values Over Time:</p>';
                    historyHTML += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                    historyHTML += '<tr style="background: #f5f5f5;"><th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Time Period</th><th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Est. Value</th></tr>';
                    
                    if (data.valueHistory.tenYearsAgo) {
                        historyHTML += `<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">10 years ago</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #eee;">$${data.valueHistory.tenYearsAgo.estimatedValue?.toLocaleString()}</td></tr>`;
                    }
                    if (data.valueHistory.fiveYearsAgo) {
                        historyHTML += `<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">5 years ago</td><td style="text-align: right; padding: 8px; border-bottom: 1px solid #eee;">$${data.valueHistory.fiveYearsAgo.estimatedValue?.toLocaleString()}</td></tr>`;
                    }
                    if (data.valueHistory.current) {
                        historyHTML += `<tr><td style="padding: 8px; font-weight: 600; background: #fff3cd;">Current</td><td style="text-align: right; padding: 8px; font-weight: 600; background: #fff3cd;">$${data.valueHistory.current.estimatedValue?.toLocaleString()}</td></tr>`;
                    }
                    
                    historyHTML += '</table>';
                    historyDiv.innerHTML = historyHTML;
                }
                
                if (data.appreciationRate) {
                    const rateDiv = document.createElement('div');
                    rateDiv.style.cssText = 'background: #e8f5e9; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    rateDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Appreciation Rate</p>
                        <p style="margin: 0; font-size: 14px;">Annual Average: <strong>${(data.appreciationRate.annualAverage * 100).toFixed(1)}%</strong></p>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;">${data.appreciationRate.comparison}</p>
                    `;
                    content.appendChild(rateDiv);
                }
                
                if (data.currentTrend) {
                    const trendDiv = document.createElement('div');
                    trendDiv.style.cssText = 'background: #e3f2fd; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    trendDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Current Market Trend</p>
                        <p style="margin: 0; font-size: 14px;">${data.currentTrend}</p>
                    `;
                    content.appendChild(trendDiv);
                }
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úì Close';
                closeBtn.style.cssText = `
                    width: 100%;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #007AFF;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 14px;
                `;
                closeBtn.onclick = () => modal.remove();
                
                content.appendChild(addressLine);
                content.appendChild(historyDiv);
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
            },

            showInsuranceAnalysisPopup(data, county, state) {
                /**
                 * Display insurance analysis and trends
                 */
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 600px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                const title = document.createElement('h2');
                title.textContent = 'üìà Insurance Trends Analysis';
                title.style.cssText = 'margin: 0 0 8px 0; color: #ff9800;';
                
                const subtitle = document.createElement('p');
                subtitle.textContent = `${county} County, ${state}`;
                subtitle.style.cssText = 'margin: 0 0 24px 0; color: #666; font-size: 14px;';
                
                if (data.homeownersInsurance) {
                    const insuranceDiv = document.createElement('div');
                    insuranceDiv.style.cssText = 'background: #fff3e0; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    insuranceDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Homeowners Insurance Trend</p>
                        <p style="margin: 0; font-size: 14px;"><strong>${data.homeownersInsurance.trend}</strong></p>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;">Causes: ${data.homeownersInsurance.causes?.join(', ') || 'Multiple factors'}</p>
                    `;
                    content.appendChild(insuranceDiv);
                }
                
                if (data.ratePrediction) {
                    const predictionDiv = document.createElement('div');
                    predictionDiv.style.cssText = 'background: #f3e5f5; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    predictionDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Rate Prediction (Next 3 Years)</p>
                        <p style="margin: 0; font-size: 14px;"><strong>${data.ratePrediction.nextThreeYears}</strong></p>
                        <p style="margin: 8px 0 0 0; font-size: 13px; font-weight: 600;">Mitigation:</p>
                        <ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 13px;">
                            ${data.ratePrediction.mitigation?.map(m => `<li>${m}</li>`).join('') || '<li>Consult with insurance agent</li>'}
                        </ul>
                    `;
                    content.appendChild(predictionDiv);
                }
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úì Close';
                closeBtn.style.cssText = `
                    width: 100%;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #007AFF;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 14px;
                    margin-top: 16px;
                `;
                closeBtn.onclick = () => modal.remove();
                
                content.appendChild(title);
                content.appendChild(subtitle);
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
            },

            showMarketComparisonPopup(data, city, state) {
                /**
                 * Display market comparison and positioning
                 */
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 600px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                const title = document.createElement('h2');
                title.textContent = 'üîç Market Comparison';
                title.style.cssText = 'margin: 0 0 8px 0; color: #1976d2;';
                
                const subtitle = document.createElement('p');
                subtitle.textContent = `${city}, ${state}`;
                subtitle.style.cssText = 'margin: 0 0 24px 0; color: #666; font-size: 14px;';
                
                if (data.valuationAssessment) {
                    const assessmentDiv = document.createElement('div');
                    assessmentDiv.style.cssText = 'background: #e8f5e9; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    assessmentDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Valuation Assessment</p>
                        <p style="margin: 0; font-size: 14px;"><strong>Price/SqFt: $${data.valuationAssessment.pricePerSqft}</strong> (Market Avg: $${data.valuationAssessment.marketAverage})</p>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;">${data.valuationAssessment.assessment}</p>
                    `;
                    content.appendChild(assessmentDiv);
                }
                
                if (data.neighborhoodPositioning) {
                    const positionDiv = document.createElement('div');
                    positionDiv.style.cssText = 'background: #e3f2fd; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    positionDiv.innerHTML = `
                        <p style="margin: 0 0 8px 0; font-weight: 600;">Neighborhood Positioning</p>
                        <p style="margin: 0; font-size: 14px;"><strong>Similar Properties:</strong> $${data.neighborhoodPositioning.similar?.range || 'N/A'}</p>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: #666;"><strong>Trend:</strong> ${data.neighborhoodPositioning.trend}</p>
                    `;
                    content.appendChild(positionDiv);
                }
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úì Close';
                closeBtn.style.cssText = `
                    width: 100%;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #007AFF;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 14px;
                    margin-top: 16px;
                `;
                closeBtn.onclick = () => modal.remove();
                
                content.appendChild(title);
                content.appendChild(subtitle);
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
            },

            showTimelinePopup(data, address, city, state) {
                /**
                 * Display property timeline report
                 */
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 700px;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    font-family: system-ui, sans-serif;
                `;
                
                const title = document.createElement('h2');
                title.textContent = 'üìÖ Property Timeline Report';
                title.style.cssText = 'margin: 0 0 16px 0; color: #9c27b0;';
                
                const addressLine = document.createElement('p');
                addressLine.style.cssText = 'color: #666; margin: 0 0 24px 0; font-size: 14px;';
                addressLine.textContent = `${address}, ${city}, ${state}`;
                
                if (data.timeline && Array.isArray(data.timeline)) {
                    let timelineHTML = '';
                    data.timeline.forEach((item, idx) => {
                        timelineHTML += `
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                                <p style="margin: 0 0 4px 0; font-weight: 600; color: #333;">üïê ${item.year}</p>
                                <p style="margin: 0 0 8px 0; font-size: 14px; font-weight: 500;">${item.event}</p>
                                <p style="margin: 0 0 4px 0; font-size: 13px; color: #666;">${item.context}</p>
                                <p style="margin: 0; font-size: 13px; color: #1976d2;"><strong>Relevance:</strong> ${item.relevance}</p>
                            </div>
                        `;
                    });
                    content.innerHTML += timelineHTML;
                }
                
                if (data.valueProjection) {
                    const projectionDiv = document.createElement('div');
                    projectionDiv.style.cssText = 'background: #f5f5f5; border-radius: 8px; padding: 16px; margin-bottom: 16px;';
                    projectionDiv.innerHTML = `
                        <p style="margin: 0 0 12px 0; font-weight: 600;">Value Projections</p>
                        <table style="width: 100%; font-size: 13px;">
                            <tr><td>Current:</td><td style="text-align: right;"><strong>$${data.valueProjection.current?.toLocaleString()}</strong></td></tr>
                            <tr><td>5 Years:</td><td style="text-align: right;">$${data.valueProjection.fiveYears?.toLocaleString()}</td></tr>
                            <tr><td>10 Years:</td><td style="text-align: right;">$${data.valueProjection.tenYears?.toLocaleString()}</td></tr>
                        </table>
                    `;
                    content.appendChild(projectionDiv);
                }
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úì Close';
                closeBtn.style.cssText = `
                    width: 100%;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    background: #007AFF;
                    color: white;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 14px;
                    margin-top: 16px;
                `;
                closeBtn.onclick = () => modal.remove();
                
                content.appendChild(title);
                content.appendChild(addressLine);
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
            },

            showDataPreview(data, sources, conflicts = {}, satelliteImage = null, address = '') {
                // Create modal HTML
                const modalHTML = `
                    <div class="modal-overlay" id="dataPreviewModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>üìã Review Extracted Data</h2>
                                <p style="font-size: 13px; color: var(--text-secondary); margin: 8px 0 0 0;">
                                    Review and edit before applying to form
                                </p>
                            </div>
                            <div class="modal-body" id="dataPreviewBody">
                                ${satelliteImage ? this.renderSatelliteSection(satelliteImage, address) : ''}
                                ${this.renderDataItems(data, conflicts)}
                            </div>
                            <div class="modal-footer">
                                <button class="btn-secondary" onclick="App.closeDataPreview()">Cancel</button>
                                <button class="btn-primary" onclick="App.applyPreviewData()">‚úÖ Apply Selected Data</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existing = document.getElementById('dataPreviewModal');
                if (existing) existing.remove();
                
                // Add to page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Show modal
                setTimeout(() => {
                    document.getElementById('dataPreviewModal').classList.add('active');
                }, 10);
                
                // Store data for later use
                this.previewData = data;
                this.previewConflicts = conflicts;
                this.previewAddress = address;
            },

            renderSatelliteSection(satelliteImage, address) {
                const googleMapsUrl = `https://maps.google.com/maps?q=${encodeURIComponent(address)}`;
                const googleEarthUrl = `https://earth.google.com/web/search/${encodeURIComponent(address)}`;
                
                return `
                    <div class="satellite-section">
                        <p style="font-size: 12px; font-weight: 600; margin: 0 0 8px 0; color: var(--text);">üõ∞Ô∏è Satellite View</p>
                        <img 
                            src="data:image/png;base64,${satelliteImage}" 
                            class="satellite-thumbnail" 
                            onclick="App.viewSatelliteFullscreen(this.src)"
                            title="Click to view fullscreen"
                        >
                        <p class="satellite-label">Tap to view fullscreen</p>
                        <div class="satellite-links">
                            <a href="${googleMapsUrl}" target="_blank">üìç Google Maps</a>
                            <a href="${googleEarthUrl}" target="_blank">üåç Google Earth</a>
                        </div>
                    </div>
                `;
            },

            viewSatelliteFullscreen(imageSrc) {
                const modal = `
                    <div class="modal-overlay" id="fullscreenImageModal" style="display: flex;">
                        <div style="position: relative; max-width: 90%; max-height: 90%; display: flex; align-items: center; justify-content: center;">
                            <img src="${imageSrc}" style="max-width: 100%; max-height: 100%; border-radius: 8px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                            <button onclick="document.getElementById('fullscreenImageModal').remove()" 
                                    style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">
                                ‚úï
                            </button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
                document.getElementById('fullscreenImageModal').classList.add('active');
            },

            renderDataItems(data, conflicts) {
                const fieldLabels = {
                    yrBuilt: 'Year Built',
                    sqFt: 'Square Footage',
                    numStories: 'Number of Stories',
                    fullBaths: 'Full Bathrooms',
                    dwellingType: 'Dwelling Type',
                    dwellingUsage: 'Dwelling Usage',
                    constructionStyle: 'Construction Style',
                    exteriorWalls: 'Exterior Walls',
                    roofType: 'Roof Type',
                    roofYr: 'Roof Year',
                    roofShape: 'Roof Shape',
                    heatingType: 'Heating Type',
                    foundation: 'Foundation Type',
                    pool: 'Pool',
                    trampoline: 'Trampoline',
                    fireplace: 'Fireplace',
                    garageSpaces: 'Garage Spaces',
                    lotSize: 'Lot Size'
                };
                
                let html = '';
                
                for (const [key, label] of Object.entries(fieldLabels)) {
                    const value = data[key];
                    const conflict = conflicts?.[key];
                    
                    if (!value && !conflict) continue;
                    
                    const hasConflict = conflict && conflict.length > 1;
                    
                    html += `
                        <div class="data-item ${hasConflict ? 'conflict' : ''}">
                            <div class="data-item-header">
                                <span class="data-item-label">${label}</span>
                                ${hasConflict ? '<span class="conflict-badge">‚ö†Ô∏è Conflict</span>' : ''}
                            </div>
                            <div class="data-value-group">
                    `;
                    
                    if (hasConflict) {
                        // Show all conflicting values with radio buttons
                        conflict.forEach((option, idx) => {
                            const checked = idx === 0 ? 'checked' : '';
                            html += `
                                <div class="data-value-option">
                                    <input type="radio" name="field_${key}" value="${option.value}" id="${key}_${idx}" ${checked}>
                                    <label for="${key}_${idx}">${option.value}</label>
                                    <span class="source-tag">${option.source}</span>
                                </div>
                            `;
                        });
                        // Add manual edit option
                        html += `
                            <div class="data-value-option">
                                <input type="radio" name="field_${key}" value="custom" id="${key}_custom">
                                <input type="text" id="${key}_custom_value" placeholder="Enter custom value" 
                                       onclick="document.getElementById('${key}_custom').checked = true">
                            </div>
                        `;
                    } else {
                        // Single value - show as editable input
                        const source = data[key + '_source'] || 'AI';
                        html += `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="text" class="data-value" id="field_${key}" value="${value}">
                                <span class="data-source">${source}</span>
                            </div>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                return html || '<p style="text-align: center; color: var(--text-secondary);">No data extracted</p>';
            },

            closeDataPreview() {
                const modal = document.getElementById('dataPreviewModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            },

            applyPreviewData() {
                const fieldsUpdated = [];
                
                // Get all data items
                const dataItems = document.querySelectorAll('.data-item');
                
                dataItems.forEach(item => {
                    const label = item.querySelector('.data-item-label').textContent;
                    const isConflict = item.classList.contains('conflict');
                    
                    if (isConflict) {
                        // Get selected radio button value
                        const radios = item.querySelectorAll('input[type="radio"]');
                        const selected = Array.from(radios).find(r => r.checked);
                        
                        if (selected) {
                            const fieldKey = selected.name.replace('field_', '');
                            let value;
                            
                            if (selected.value === 'custom') {
                                value = document.getElementById(fieldKey + '_custom_value').value;
                            } else {
                                value = selected.value;
                            }
                            
                            if (value) {
                                this.setFieldValue(fieldKey, value);
                                fieldsUpdated.push(label);
                            }
                        }
                    } else {
                        // Get input value directly
                        const input = item.querySelector('.data-value');
                        if (input && input.value) {
                            const fieldKey = input.id.replace('field_', '');
                            this.setFieldValue(fieldKey, input.value);
                            fieldsUpdated.push(label);
                        }
                    }
                });
                
                this.closeDataPreview();
                
                if (fieldsUpdated.length > 0) {
                    alert(`‚úÖ Applied ${fieldsUpdated.length} fields!\n\n${fieldsUpdated.join('\n')}`);
                }
            },

            getCountyFromCity(city, state) {
                // Map city to county for display and reference
                const cityToCounty = {
                    'WA': {
                        'vancouver': 'Clark', 'camas': 'Clark', 'battle ground': 'Clark', 'ridgefield': 'Clark', 'la center': 'Clark', 'washougal': 'Clark',
                        'seattle': 'King', 'bellevue': 'King', 'redmond': 'King', 'kent': 'King', 'renton': 'King', 'federal way': 'King', 'kirkland': 'King', 'auburn': 'King', 'sammamish': 'King', 'bothell': 'King',
                        'tacoma': 'Pierce', 'lakewood': 'Pierce', 'puyallup': 'Pierce', 'bonney lake': 'Pierce', 'university place': 'Pierce',
                        'everett': 'Snohomish', 'marysville': 'Snohomish', 'lynnwood': 'Snohomish', 'edmonds': 'Snohomish', 'mountlake terrace': 'Snohomish',
                        'spokane': 'Spokane', 'spokane valley': 'Spokane',
                        'bremerton': 'Kitsap', 'silverdale': 'Kitsap', 'poulsbo': 'Kitsap',
                        'olympia': 'Thurston', 'lacey': 'Thurston', 'tumwater': 'Thurston',
                        'bellingham': 'Whatcom',
                        'yakima': 'Yakima',
                        'longview': 'Cowlitz', 'kelso': 'Cowlitz',
                    },
                    'OR': {
                        'portland': 'Multnomah', 'gresham': 'Multnomah', 'troutdale': 'Multnomah', 'wood village': 'Multnomah', 'fairview': 'Multnomah',
                        'beaverton': 'Washington', 'hillsboro': 'Washington', 'tigard': 'Washington', 'tualatin': 'Washington', 'lake oswego': 'Washington', 'west linn': 'Washington', 'sherwood': 'Washington', 'forest grove': 'Washington', 'cornelius': 'Washington',
                        'oregon city': 'Clackamas', 'milwaukie': 'Clackamas', 'happy valley': 'Clackamas', 'wilsonville': 'Clackamas', 'canby': 'Clackamas', 'sandy': 'Clackamas', 'estacada': 'Clackamas',
                        'eugene': 'Lane', 'springfield': 'Lane', 'cottage grove': 'Lane', 'creswell': 'Lane', 'veneta': 'Lane',
                        'salem': 'Marion', 'keizer': 'Marion', 'woodburn': 'Marion', 'silverton': 'Marion',
                        'bend': 'Deschutes', 'redmond': 'Deschutes', 'sisters': 'Deschutes', 'la pine': 'Deschutes',
                        'medford': 'Jackson', 'ashland': 'Jackson', 'central point': 'Jackson', 'phoenix': 'Jackson', 'talent': 'Jackson',
                        'albany': 'Linn', 'lebanon': 'Linn', 'sweet home': 'Linn',
                        'roseburg': 'Douglas', 'sutherlin': 'Douglas', 'winston': 'Douglas',
                    },
                    'AZ': {
                        'phoenix': 'Maricopa', 'mesa': 'Maricopa', 'chandler': 'Maricopa', 'scottsdale': 'Maricopa', 'glendale': 'Maricopa', 'tempe': 'Maricopa', 'peoria': 'Maricopa', 'surprise': 'Maricopa', 'gilbert': 'Maricopa', 'avondale': 'Maricopa', 'goodyear': 'Maricopa', 'buckeye': 'Maricopa', 'el mirage': 'Maricopa', 'queen creek': 'Maricopa', 'cave creek': 'Maricopa', 'fountain hills': 'Maricopa', 'paradise valley': 'Maricopa',
                        'tucson': 'Pima', 'oro valley': 'Pima', 'marana': 'Pima', 'sahuarita': 'Pima',
                        'casa grande': 'Pinal', 'apache junction': 'Pinal', 'coolidge': 'Pinal', 'eloy': 'Pinal', 'florence': 'Pinal', 'maricopa': 'Pinal',
                        'prescott': 'Yavapai', 'prescott valley': 'Yavapai', 'chino valley': 'Yavapai', 'cottonwood': 'Yavapai', 'sedona': 'Yavapai',
                        'flagstaff': 'Coconino', 'williams': 'Coconino',
                        'lake havasu city': 'Mohave', 'kingman': 'Mohave', 'bullhead city': 'Mohave',
                        'yuma': 'Yuma', 'san luis': 'Yuma', 'somerton': 'Yuma',
                    }
                };
                
                if (cityToCounty[state] && cityToCounty[state][city]) {
                    return cityToCounty[state][city];
                }
                return null;
            },

            openGIS() {
                const address = this.data.addrStreet || '';
                const city = (this.data.addrCity || '').toLowerCase();
                const state = (this.data.addrState || '').toUpperCase();
                const zip = this.data.addrZip || '';
                
                if (!address || !city || !state) {
                    alert('Please enter a complete address (street, city, and state) first.');
                    return;
                }
                
                // Washington State County GIS mapping
                const waCountyGIS = {
                    // Clark County - County Assessor GIS
                    'vancouver': 'https://www.clark.wa.gov/GIS/',
                    'camas': 'https://www.clark.wa.gov/GIS/',
                    'battle ground': 'https://www.clark.wa.gov/GIS/',
                    'ridgefield': 'https://www.clark.wa.gov/GIS/',
                    'la center': 'https://www.clark.wa.gov/GIS/',
                    'washougal': 'https://www.clark.wa.gov/GIS/',
                    
                    // King County
                    'seattle': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'bellevue': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'redmond': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'kent': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'renton': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'federal way': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'kirkland': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'auburn': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'sammamish': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    'bothell': 'https://blue.kingcounty.com/Assessor/eRealProperty/default.aspx',
                    
                    // Pierce County
                    'tacoma': 'https://atip.piercecountywa.gov/app/parcel-search',
                    'lakewood': 'https://atip.piercecountywa.gov/app/parcel-search',
                    'puyallup': 'https://atip.piercecountywa.gov/app/parcel-search',
                    'bonney lake': 'https://atip.piercecountywa.gov/app/parcel-search',
                    'university place': 'https://atip.piercecountywa.gov/app/parcel-search',
                    
                    // Snohomish County
                    'everett': 'https://scopi.snoco.org/',
                    'marysville': 'https://scopi.snoco.org/',
                    'lynnwood': 'https://scopi.snoco.org/',
                    'edmonds': 'https://scopi.snoco.org/',
                    'mountlake terrace': 'https://scopi.snoco.org/',
                    
                    // Spokane County
                    'spokane': 'https://mapgis.spokanecounty.org/SCGIS2/Parcel/',
                    'spokane valley': 'https://mapgis.spokanecounty.org/SCGIS2/Parcel/',
                    
                    // Kitsap County
                    'bremerton': 'https://psearch.kitsapgov.com/psearch/',
                    'silverdale': 'https://psearch.kitsapgov.com/psearch/',
                    'poulsbo': 'https://psearch.kitsapgov.com/psearch/',
                    
                    // Thurston County
                    'olympia': 'https://taxlot.co.thurston.wa.us/',
                    'lacey': 'https://taxlot.co.thurston.wa.us/',
                    'tumwater': 'https://taxlot.co.thurston.wa.us/',
                    
                    // Whatcom County
                    'bellingham': 'https://www.whatcomcounty.us/1476/Online-Property-Search',
                    
                    // Yakima County
                    'yakima': 'https://www.co.yakima.wa.us/497/Property-Information-Public-Inquiry',
                    
                    // Cowlitz County
                    'longview': 'https://cowlitzassessor.us/',
                    'kelso': 'https://cowlitzassessor.us/',
                };
                
                // Oregon County GIS mapping
                const orCountyGIS = {
                    // Multnomah County
                    'portland': 'https://www.portlandmaps.com/',
                    'gresham': 'https://www.portlandmaps.com/',
                    'troutdale': 'https://www.portlandmaps.com/',
                    'wood village': 'https://www.portlandmaps.com/',
                    'fairview': 'https://www.portlandmaps.com/',
                    
                    // Washington County
                    'beaverton': 'https://www.washingtoncountyor.gov/propertysearch',
                    'hillsboro': 'https://www.washingtoncountyor.gov/propertysearch',
                    'tigard': 'https://www.washingtoncountyor.gov/propertysearch',
                    'tualatin': 'https://www.washingtoncountyor.gov/propertysearch',
                    'lake oswego': 'https://www.washingtoncountyor.gov/propertysearch',
                    'west linn': 'https://www.washingtoncountyor.gov/propertysearch',
                    'sherwood': 'https://www.washingtoncountyor.gov/propertysearch',
                    'forest grove': 'https://www.washingtoncountyor.gov/propertysearch',
                    'cornelius': 'https://www.washingtoncountyor.gov/propertysearch',
                    
                    // Clackamas County
                    'oregon city': 'https://ormap.clackamas.us/',
                    'milwaukie': 'https://ormap.clackamas.us/',
                    'happy valley': 'https://ormap.clackamas.us/',
                    'wilsonville': 'https://ormap.clackamas.us/',
                    'canby': 'https://ormap.clackamas.us/',
                    'sandy': 'https://ormap.clackamas.us/',
                    'estacada': 'https://ormap.clackamas.us/',
                    
                    // Lane County
                    'eugene': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                    'springfield': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                    'cottage grove': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                    'creswell': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                    'veneta': 'https://apps.lanecounty.org/PropertyAccountInformation/',
                    
                    // Marion County
                    'salem': 'https://apps.co.marion.or.us/PropertySearch/',
                    'keizer': 'https://apps.co.marion.or.us/PropertySearch/',
                    'woodburn': 'https://apps.co.marion.or.us/PropertySearch/',
                    'silverton': 'https://apps.co.marion.or.us/PropertySearch/',
                    
                    // Deschutes County
                    'bend': 'https://dial.deschutes.org/',
                    'redmond': 'https://dial.deschutes.org/',
                    'sisters': 'https://dial.deschutes.org/',
                    'la pine': 'https://dial.deschutes.org/',
                    
                    // Jackson County
                    'medford': 'https://jacksoncountyor.org/assessor/GIS',
                    'ashland': 'https://jacksoncountyor.org/assessor/GIS',
                    'central point': 'https://jacksoncountyor.org/assessor/GIS',
                    'phoenix': 'https://jacksoncountyor.org/assessor/GIS',
                    'talent': 'https://jacksoncountyor.org/assessor/GIS',
                    
                    // Linn County
                    'albany': 'https://www.linncountyassessor.com/',
                    'lebanon': 'https://www.linncountyassessor.com/',
                    'sweet home': 'https://www.linncountyassessor.com/',
                    
                    // Douglas County
                    'roseburg': 'https://apps.co.douglas.or.us/onlineservices/PropertyViewer/',
                    'sutherlin': 'https://apps.co.douglas.or.us/onlineservices/PropertyViewer/',
                    'winston': 'https://apps.co.douglas.or.us/onlineservices/PropertyViewer/',
                };
                
                // Arizona County GIS mapping
                const azCountyGIS = {
                    // Maricopa County
                    'phoenix': 'https://mcassessor.maricopa.gov/',
                    'mesa': 'https://mcassessor.maricopa.gov/',
                    'chandler': 'https://mcassessor.maricopa.gov/',
                    'scottsdale': 'https://mcassessor.maricopa.gov/',
                    'glendale': 'https://mcassessor.maricopa.gov/',
                    'tempe': 'https://mcassessor.maricopa.gov/',
                    'peoria': 'https://mcassessor.maricopa.gov/',
                    'surprise': 'https://mcassessor.maricopa.gov/',
                    'gilbert': 'https://mcassessor.maricopa.gov/',
                    'avondale': 'https://mcassessor.maricopa.gov/',
                    'goodyear': 'https://mcassessor.maricopa.gov/',
                    'buckeye': 'https://mcassessor.maricopa.gov/',
                    'el mirage': 'https://mcassessor.maricopa.gov/',
                    'queen creek': 'https://mcassessor.maricopa.gov/',
                    'cave creek': 'https://mcassessor.maricopa.gov/',
                    'fountain hills': 'https://mcassessor.maricopa.gov/',
                    'paradise valley': 'https://mcassessor.maricopa.gov/',
                    
                    // Pima County
                    'tucson': 'https://www.asr.pima.gov/assessor/',
                    'oro valley': 'https://www.asr.pima.gov/assessor/',
                    'marana': 'https://www.asr.pima.gov/assessor/',
                    'sahuarita': 'https://www.asr.pima.gov/assessor/',
                    
                    // Pinal County
                    'casa grande': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    'apache junction': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    'coolidge': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    'eloy': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    'florence': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    'maricopa': 'https://gis.pinalcountyaz.gov/parcelviewer/',
                    
                    // Yavapai County
                    'prescott': 'https://gis.yavapaiaz.gov/Html5Viewer/index.html',
                    'prescott valley': 'https://gis.yavapaiaz.gov/Html5Viewer/index.html',
                    'chino valley': 'https://gis.yavapaiaz.gov/Html5Viewer/index.html',
                    'cottonwood': 'https://gis.yavapaiaz.gov/Html5Viewer/index.html',
                    'sedona': 'https://gis.yavapaiaz.gov/Html5Viewer/index.html',
                    
                    // Coconino County
                    'flagstaff': 'https://www.coconino.az.gov/1302/GIS-Maps-Data',
                    'williams': 'https://www.coconino.az.gov/1302/GIS-Maps-Data',
                    
                    // Mohave County
                    'lake havasu city': 'https://gis.mohave.gov/Html5Viewer/Index.html',
                    'kingman': 'https://gis.mohave.gov/Html5Viewer/Index.html',
                    'bullhead city': 'https://gis.mohave.gov/Html5Viewer/Index.html',
                    
                    // Yuma County
                    'yuma': 'https://www.yumacountyaz.gov/government/assessor',
                    'san luis': 'https://www.yumacountyaz.gov/government/assessor',
                    'somerton': 'https://www.yumacountyaz.gov/government/assessor',
                };
                
                // Check if we have a direct GIS link for this city
                if (state === 'WA' && waCountyGIS[city]) {
                    window.open(waCountyGIS[city], '_blank');
                    return;
                }
                
                if (state === 'OR' && orCountyGIS[city]) {
                    window.open(orCountyGIS[city], '_blank');
                    return;
                }
                
                if (state === 'AZ' && azCountyGIS[city]) {
                    window.open(azCountyGIS[city], '_blank');
                    return;
                }
                
                // Detect county and show it to user
                const county = this.getCountyFromCity(city, state);
                
                // Fallback: Try to open general county assessor search
                const searchAddress = encodeURIComponent(`${address} ${city} ${state} ${zip}`);
                let message = '';
                
                if (county) {
                    message = `üìç County Detected: ${county} County, ${state}\n\nOpening county assessor search...`;
                    console.log(`County detected: ${county} County, ${state}`);
                } else {
                    message = `üìç City/County: ${city}, ${state}\n\nOpening general assessor search...`;
                }
                
                // Show notification
                const toast = document.createElement('div');
                toast.textContent = message.split('\n')[0];
                toast.style.cssText = 'position:fixed;top:80px;right:20px;background:#007AFF;color:white;padding:12px 20px;border-radius:8px;font-size:14px;z-index:9999;';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
                
                if (state === 'WA') {
                    window.open(`https://www.dor.wa.gov/find-taxes-rates/property-tax/county-assessors`, '_blank');
                } else if (state === 'OR') {
                    window.open(`https://www.oregon.gov/dor/forms/pages/county-assessor.aspx`, '_blank');
                } else if (state === 'AZ') {
                    window.open(`https://azdor.gov/property-appraisal/county-assessors-information`, '_blank');
                } else {
                    // Generic Google search for county GIS
                    window.open(`https://www.google.com/search?q=${city}+${state}+county+gis+assessor+property+search`, '_blank');
                }
            },

            // === NOTES & EXPORT ===
            getNotesForData(data) {
                return `
=== CLIENT INFORMATION ===
Name: ${data.firstName || ''} ${data.lastName || ''}
Email: ${data.email || ''}
Phone: ${data.phone || ''}
DOB: ${data.dob || ''}
Marital Status: ${data.maritalStatus || ''}
Education: ${data.education || ''}
Industry: ${data.industry || ''}

=== PROPERTY DETAILS ===
Address: ${data.addrStreet || ''}, ${data.addrCity || ''}, ${data.addrState || ''} ${data.addrZip || ''}
Dwelling Type: ${data.dwellingType || ''} (${data.dwellingUsage || ''})
Year Built: ${data.yrBuilt || ''} | Square Feet: ${data.sqFt || ''}
Stories: ${data.numStories || ''} | Bathrooms: ${data.fullBaths || ''}
Construction: ${data.constructionStyle || ''} | Walls: ${data.exteriorWalls || ''}
Foundation: ${data.foundation || ''}
Roof: ${data.roofType || ''} (${data.roofShape || ''}) - Updated: ${data.roofYr || ''}
Heating: ${data.heatingType || ''} (Updated: ${data.heatYr || ''})
Cooling: ${data.cooling || ''}
Plumbing Updated: ${data.plumbYr || ''}
Electrical Updated: ${data.elecYr || ''}

=== SAFETY & SYSTEMS ===
Fire Station: ${data.fireStationDist || ''} miles | Hydrant: ${data.fireHydrantFeet || ''} feet
Protection Class: ${data.protectionClass || ''}
Burglar Alarm: ${data.burglarAlarm || ''}
Fire Alarm: ${data.fireAlarm || ''}
Sprinklers: ${data.sprinklers || ''}

=== RISK FACTORS ===
Pool: ${data.pool || 'No'}
Trampoline: ${data.trampoline || 'No'}
Wood Stove: ${data.woodStove || 'No'}
Dog: ${data.dogInfo || 'None'}
Business on Property: ${data.businessOnProperty || 'No'}

=== AUTO INFORMATION ===
Vehicle: ${data.vehDesc || ''}
VIN: ${data.vin || ''}
Driver's License: ${data.dlNum || ''} (${data.dlState || ''})
Usage: ${data.use || ''} | Annual Miles: ${data.miles || ''}
Commute Distance: ${data.commuteDist || ''} miles
Ride Sharing: ${data.rideSharing || 'No'}
Telematics: ${data.telematics || ''}

=== INSURANCE HISTORY ===
Current Liability: ${data.liabilityLimits || ''}
Deductibles: Home ${data.homeDeductible || ''} / Auto ${data.autoDeductible || ''}
Prior Carrier: ${data.priorCarrier || ''} (${data.priorYears || ''} years)
Prior Expiration: ${data.priorExp || ''}
Accidents: ${data.accidents || 'None'}
Violations: ${data.violations || 'None'}
Student GPA: ${data.studentGPA || 'N/A'}

=== ADDITIONAL INFO ===
Mortgagee: ${data.mortgagee || ''}
Additional Insureds: ${data.additionalInsureds || 'None'}
Import Notes: ${data.importNotes || ''}
Purchase Date: ${data.purchaseDate || ''}
Kitchen/Bath Quality: ${data.kitchenQuality || ''}
Best Contact Time: ${data.contactTime || ''}
Referral Source: ${data.referralSource || ''}
TCPA Consent: ${data.tcpaConsent ? 'Yes' : 'No'}

=== DOCUMENT INTELLIGENCE ===
Year Built (Doc): ${data.docIntel?.yearBuilt || ''}
Assessed Value (Doc): ${data.docIntel?.assessedValue || ''}
Owner Name (Doc): ${data.docIntel?.ownerName || ''}
Policy Number (Doc): ${data.docIntel?.policyNumber || ''}
Effective Date (Doc): ${data.docIntel?.effectiveDate || ''}
Expiration Date (Doc): ${data.docIntel?.expirationDate || ''}
Mortgagee (Doc): ${data.docIntel?.mortgagee || ''}
                `.trim();
            },

            getNotes() {
                return this.getNotesForData(this.data);
            },

            copyNotes() {
                navigator.clipboard.writeText(this.getNotes());
                this.toast('üìã Copied to Clipboard!');
            },

            async exportPDF() {
                const result = await this.buildPDF(this.data);
                this.downloadBlob(result.blob, result.filename);
                this.toast('‚úì PDF downloaded successfully');
            },

            exportText() {
                const result = this.buildText(this.data);
                this.downloadFile(result.content, result.filename, result.mime);
                this.toast('üìù Text summary downloaded');
            },

            async buildPDF(data) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const address = this.getFullAddress(data);
                const mapImages = await this.getMapImages(address);

                // Banner image (Street View)
                let y = 20;
                if (mapImages?.streetView?.dataUrl) {
                    const bannerHeight = 65;
                    doc.addImage(mapImages.streetView.dataUrl, mapImages.streetView.format, 10, 10, 190, bannerHeight);
                    y = 85;
                }

                doc.setFontSize(18);
                doc.setTextColor(0, 122, 255);
                doc.text('Insurance Application Summary', 105, y - 12, { align: 'center' });

                // Satellite thumbnail near header
                if (mapImages?.satellite?.dataUrl) {
                    doc.setFontSize(9);
                    doc.setTextColor(60, 60, 60);
                    doc.text('Satellite View', 150, y - 18);
                    doc.addImage(mapImages.satellite.dataUrl, mapImages.satellite.format, 150, y - 15, 45, 45);
                    doc.setTextColor(0, 0, 0);
                    const mapAddress = this.getFullAddress(data);
                    if (mapAddress) {
                        doc.setFontSize(8);
                        doc.setTextColor(0, 122, 255);
                        doc.textWithLink('Open in Maps', 150, y + 32, {
                            url: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapAddress)}`
                        });
                        doc.textWithLink('Open in Earth', 150, y + 38, {
                            url: `https://earth.google.com/web/search/${encodeURIComponent(mapAddress)}`
                        });
                        doc.setTextColor(0, 0, 0);
                    }
                }
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                
                
                const addSection = (title, fields) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(title, 15, y);
                    y += 7;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    
                    fields.forEach(([label, value]) => {
                        if (value) {
                            if (y > 280) {
                                doc.addPage();
                                y = 20;
                            }
                            const text = `${label}: ${value}`;
                            const lines = doc.splitTextToSize(text, 180);
                            doc.text(lines, 20, y);
                            y += (lines.length * 5);
                        }
                    });
                    y += 5;
                };
                
                addSection('Personal Information', [
                    ['Name', `${data.firstName || ''} ${data.lastName || ''}`],
                    ['Date of Birth', data.dob || ''],
                    ['Email', data.email || ''],
                    ['Phone', data.phone || ''],
                    ['Marital Status', data.maritalStatus || ''],
                    ['Education', data.education || ''],
                    ['Industry', data.industry || ''],
                    ['Quote Type', data.qType || '']
                ]);
                
                if (data.qType === 'home' || data.qType === 'both') {
                    addSection('Property Information', [
                        ['Address', `${data.addrStreet || ''}, ${data.addrCity || ''}, ${data.addrState || ''} ${data.addrZip || ''}`],
                        ['Year Built', data.yrBuilt || ''],
                        ['Square Footage', data.sqFt || ''],
                        ['Stories', data.numStories || ''],
                        ['Bathrooms', data.fullBaths || ''],
                        ['Dwelling Type', data.dwellingType || ''],
                        ['Dwelling Usage', data.dwellingUsage || ''],
                        ['Construction Style', data.constructionStyle || ''],
                        ['Exterior Walls', data.exteriorWalls || ''],
                        ['Foundation', data.foundation || ''],
                        ['Roof Type', data.roofType || ''],
                        ['Roof Year', data.roofYr || ''],
                        ['Roof Shape', data.roofShape || '']
                    ]);
                    
                    addSection('Home Systems & Safety', [
                        ['Heating Type', data.heatingType || ''],
                        ['Heating Year', data.heatYr || ''],
                        ['Cooling', data.cooling || ''],
                        ['Plumbing Year', data.plumbYr || ''],
                        ['Electrical Year', data.elecYr || ''],
                        ['Fire Station Distance', data.fireStationDist || ''],
                        ['Fire Hydrant Distance', data.fireHydrantFeet || ''],
                        ['Protection Class', data.protectionClass || ''],
                        ['Burglar Alarm', data.burglarAlarm || ''],
                        ['Fire Alarm', data.fireAlarm || ''],
                        ['Sprinklers', data.sprinklers || '']
                    ]);
                }
                
                addSection('Risk Factors', [
                    ['Pool', data.pool || ''],
                    ['Trampoline', data.trampoline || ''],
                    ['Wood Stove', data.woodStove || ''],
                    ['Dogs', data.dogInfo || ''],
                    ['Business on Property', data.businessOnProperty || '']
                ]);
                
                if (data.qType === 'auto' || data.qType === 'both') {
                    addSection('Vehicle Information', [
                        ['VIN', data.vin || ''],
                        ['Vehicle', data.vehDesc || ''],
                        ['License Number', data.dlNum || ''],
                        ['License State', data.dlState || ''],
                        ['Vehicle Use', data.use || ''],
                        ['Annual Miles', data.miles || ''],
                        ['Commute Distance', data.commuteDist || ''],
                        ['Ridesharing', data.rideSharing || ''],
                        ['Telematics', data.telematics || '']
                    ]);
                }
                
                addSection('Coverage & History', [
                    ['Liability Limits', data.liabilityLimits || ''],
                    ['Home Deductible', data.homeDeductible || ''],
                    ['Auto Deductible', data.autoDeductible || ''],
                    ['Prior Carrier', data.priorCarrier || ''],
                    ['Prior Years', data.priorYears || ''],
                    ['Prior Expiration', data.priorExp || ''],
                    ['Accidents', data.accidents || ''],
                    ['Violations', data.violations || ''],
                    ['Student GPA', data.studentGPA || '']
                ]);
                
                addSection('Additional Information', [
                    ['Mortgagee', data.mortgagee || ''],
                    ['Additional Insureds', data.additionalInsureds || ''],
                    ['Best Contact Time', data.contactTime || ''],
                    ['Referral Source', data.referralSource || ''],
                    ['TCPA Consent', data.tcpaConsent ? 'Yes' : 'No']
                ]);
                
                const fileName = `Insurance_Application_${data.lastName || 'Client'}_${new Date().toISOString().split('T')[0]}.pdf`;
                return { blob: doc.output('blob'), filename: fileName };
            },

            buildText(data) {
                const content = this.getNotesForData(data);
                const fileName = `Insurance_Application_${data.lastName || 'Client'}_${new Date().toISOString().split('T')[0]}.txt`;
                return { content, filename: fileName, mime: 'text/plain;charset=utf-8' };
            },

            exportCSV() {
                const result = this.buildCSV(this.data);
                this.downloadFile(result.content, result.filename, result.mime);
                this.toast('üì• CSV Generated!');
            },

            buildCSV(data) {
                const h = this.getCSVHeaders();
                const flatNotes = this.getNotesForData(data).replace(/\n/g, ' | ');
                const row = [
                    data.firstName, data.lastName, data.addrStreet, data.addrCity, data.addrState, data.addrZip,
                    data.phone, data.email, data.dob, flatNotes, data.qType
                ].map(v => `"${v||''}"`).join(',');

                const csv = h.join(',') + "\n" + row;
                return { content: csv, filename: `Lead_${data.lastName || 'Export'}.csv`, mime: 'text/csv' };
            },

            getCSVHeaders() {
                return ["First Name","Last Name","Address Line 1","City","State Code","Zip Code","Mobile Phone","Email","Date of Birth","Notes","Quote Type"];
            },

            downloadCSVTemplate() {
                const headers = this.getCSVHeaders();
                const sample = [
                    'Jane','Doe','123 Main St','Seattle','WA','98101','2065551212','jane@example.com','1985-05-12','Follow up','home'
                ].map(v => `"${v}"`).join(',');
                const content = `${headers.join(',')}\n${sample}`;
                this.downloadFile(content, 'Altech_Batch_Template.csv', 'text/csv');
                this.toast('üìÑ CSV template downloaded');
            },

            openBatchImport() {
                const input = document.getElementById('batchCsvInput');
                if (!input) return;
                input.value = '';
                input.click();
            },

            async handleBatchImport(file) {
                if (!file) return;
                const text = await file.text();
                const parsed = this.parseCSV(text);
                if (!parsed || !parsed.rows.length) {
                    this.toast('‚ö†Ô∏è CSV has no rows.');
                    return;
                }

                const quotes = await this.getQuotes();
                const errors = [];
                let created = 0;

                parsed.rows.forEach((row, index) => {
                    const data = this.mapCsvRowToData(parsed.headers, row);
                    if (!data.addrStreet || !data.addrCity || !data.addrState) {
                        errors.push(`Row ${index + 2}: Missing address fields`);
                        return;
                    }

                    const id = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
                    const title = this.getQuoteTitle(data);
                    quotes.unshift({
                        id,
                        title,
                        data,
                        updatedAt: new Date().toISOString(),
                        starred: false,
                        isDuplicate: false
                    });
                    created += 1;
                });

                await this.saveQuotes(quotes);
                await this.renderQuoteList();

                if (created) {
                    this.toast(`‚úÖ Imported ${created} draft${created > 1 ? 's' : ''}`);
                }
                if (errors.length) {
                    console.warn('Batch import warnings:', errors);
                    this.toast('‚ö†Ô∏è Some rows were skipped.');
                }
            },

            parseCSV(text) {
                if (!text) return { headers: [], rows: [] };
                const rows = [];
                let cur = '';
                let row = [];
                let inQuotes = false;

                for (let i = 0; i < text.length; i++) {
                    const ch = text[i];
                    const next = text[i + 1];

                    if (ch === '"') {
                        if (inQuotes && next === '"') {
                            cur += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                        continue;
                    }

                    if (ch === ',' && !inQuotes) {
                        row.push(cur);
                        cur = '';
                        continue;
                    }

                    if ((ch === '\n' || ch === '\r') && !inQuotes) {
                        if (ch === '\r' && next === '\n') i++;
                        row.push(cur);
                        cur = '';
                        if (row.some(cell => cell.trim().length)) {
                            rows.push(row);
                        }
                        row = [];
                        continue;
                    }

                    cur += ch;
                }

                if (cur.length || row.length) {
                    row.push(cur);
                    if (row.some(cell => cell.trim().length)) {
                        rows.push(row);
                    }
                }

                const headers = (rows.shift() || []).map(h => h.trim());
                return { headers, rows };
            },

            mapCsvRowToData(headers, row) {
                const data = {};
                headers.forEach((header, i) => {
                    const key = header.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const value = (row[i] || '').trim();

                    const map = {
                        firstname: 'firstName',
                        lastname: 'lastName',
                        addressline1: 'addrStreet',
                        city: 'addrCity',
                        statecode: 'addrState',
                        zipcode: 'addrZip',
                        mobilephone: 'phone',
                        email: 'email',
                        dateofbirth: 'dob',
                        notes: 'importNotes',
                        quotetype: 'qType'
                    };

                    const field = map[key];
                    if (field) data[field] = value;
                });

                if (data.addrState) data.addrState = data.addrState.toUpperCase();
                if (data.qType) {
                    const qt = data.qType.toLowerCase();
                    if (['home','auto','both'].includes(qt)) data.qType = qt;
                }
                return data;
            },

            exportCMSMTF() {
                const result = this.buildCMSMTF(this.data);
                this.downloadFile(result.content, result.filename, result.mime);
                this.toast('üì• HawkSoft File Generated!');
            },

            buildCMSMTF(data) {
                const fields = [
                    { tag: 'NAM', value: `${data.firstName || ''} ${data.lastName || ''}`.trim() },
                    { tag: 'ADD', value: data.addrStreet },
                    { tag: 'CTY', value: data.addrCity },
                    { tag: 'STA', value: data.addrState },
                    { tag: 'ZIP', value: data.addrZip },
                    { tag: 'PHN', value: data.phone ? data.phone.replace(/\D/g, '') : '' },
                    { tag: 'EML', value: data.email },
                    { tag: 'DOB', value: data.dob },
                    { tag: 'L1', value: data.roofYr },
                    { tag: 'L2', value: data.roofType },
                    { tag: 'L3', value: data.heatingType },
                    { tag: 'L4', value: data.heatYr },
                    { tag: 'L5', value: data.plumbYr },
                    { tag: 'L6', value: data.elecYr },
                    { tag: 'L7', value: data.pool },
                    { tag: 'L8', value: data.dogInfo },
                    { tag: 'L9', value: data.kitchenQuality },
                    { tag: 'L10', value: data.burglarAlarm },
                    { tag: 'C1', value: data.liabilityLimits },
                    { tag: 'C2', value: data.priorCarrier },
                    { tag: 'C3', value: data.priorYears },
                    { tag: 'C4', value: data.accidents },
                    { tag: 'C5', value: data.violations },
                    { tag: 'C6', value: data.miles },
                    { tag: 'C7', value: data.commuteDist },
                    { tag: 'C8', value: data.rideSharing },
                    { tag: 'C9', value: data.telematics },
                    { tag: 'C10', value: data.studentGPA },
                    { tag: 'R1', value: `Home: ${data.homeDeductible || ''} / Auto: ${data.autoDeductible || ''}` },
                    { tag: 'R2', value: data.trampoline },
                    { tag: 'R3', value: data.woodStove },
                    { tag: 'R4', value: data.businessOnProperty },
                    { tag: 'R5', value: data.purchaseDate },
                    { tag: 'R6', value: data.mortgagee },
                    { tag: 'R7', value: data.additionalInsureds },
                    { tag: 'R8', value: data.contactTime },
                    { tag: 'R9', value: data.referralSource },
                    { tag: 'R10', value: data.tcpaConsent ? 'Yes - Consented' : 'No' },
                    { tag: 'DWELLING_TYPE', value: data.dwellingType },
                    { tag: 'DWELLING_USAGE', value: data.dwellingUsage },
                    { tag: 'YEAR_BUILT', value: data.yrBuilt },
                    { tag: 'SQ_FT', value: data.sqFt },
                    { tag: 'STORIES', value: data.numStories },
                    { tag: 'BATHROOMS', value: data.fullBaths },
                    { tag: 'CONSTRUCTION', value: data.constructionStyle },
                    { tag: 'EXTERIOR_WALLS', value: data.exteriorWalls },
                    { tag: 'FOUNDATION', value: data.foundation },
                    { tag: 'ROOF_SHAPE', value: data.roofShape },
                    { tag: 'COOLING', value: data.cooling },
                    { tag: 'FIRE_ALARM', value: data.fireAlarm },
                    { tag: 'SPRINKLERS', value: data.sprinklers },
                    { tag: 'PROTECTION_CLASS', value: data.protectionClass },
                    { tag: 'VIN', value: data.vin },
                    { tag: 'VEH', value: data.vehDesc },
                    { tag: 'DL_NUM', value: data.dlNum },
                    { tag: 'DL_STATE', value: data.dlState },
                    { tag: 'VEHICLE_USE', value: data.use },
                    { tag: 'MARITAL_STATUS', value: data.maritalStatus },
                    { tag: 'EDUCATION', value: data.education },
                    { tag: 'INDUSTRY', value: data.industry }
                ];

                const content = fields
                    .filter(f => f.value && f.value.toString().trim() !== '')
                    .map(f => `[${f.tag}]${f.value}`)
                    .join('\n');

                return { content, filename: `Lead_${data.lastName || 'Export'}.cmsmtf`, mime: 'text/plain;charset=utf-8' };
            },

            exportXML() {
                const result = this.buildXML(this.data);
                if (!result.ok) {
                    this.toast(result.error);
                    return;
                }
                this.downloadFile(result.content, result.filename, result.mime);
                this.toast('üì• EZLynx XML File Generated!');
            },

            buildXML(data) {
                const escapeXML = (str) => {
                    if (!str) return '';
                    return String(str)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&apos;');
                };

                const normalizeDate = (dateStr) => {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    if (Number.isNaN(d.getTime())) return '';
                    const year = d.getUTCFullYear();
                    const currentYear = new Date().getUTCFullYear();
                    if (year < 1900 || year > currentYear) return '';
                    return d.toISOString().split('T')[0];
                };

                const parseVehicle = (desc) => {
                    const match = desc?.match(/(\d{4})\s+([A-Z]+)\s+(.+)/i);
                    return {
                        year: match?.[1] || '',
                        make: match?.[2] || '',
                        model: match?.[3]?.trim() || ''
                    };
                };

                const state = (data.addrState || '').trim().toUpperCase();
                const dob = normalizeDate(data.dob);
                if (!data.firstName || !data.lastName) {
                    return { ok: false, error: '‚ö†Ô∏è First and last name are required for EZLynx XML.' };
                }
                if (!state || !/^[A-Z]{2}$/.test(state)) {
                    return { ok: false, error: '‚ö†Ô∏è A valid 2-letter state is required for EZLynx XML.' };
                }
                if (!dob) {
                    return { ok: false, error: '‚ö†Ô∏è A valid DOB is required for EZLynx XML.' };
                }

                const phone = data.phone ? data.phone.replace(/\D/g, '') : '';
                const { year, make, model } = parseVehicle(data.vehDesc);
                const streetRaw = (data.addrStreet || '').trim();
                const streetMatch = streetRaw.match(/^(\d+)\s+(.*)$/);
                const streetNumber = streetMatch?.[1] || '';
                const streetName = streetMatch?.[2] || streetRaw;

                let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
                xml += '<EZAUTO xmlns="http://www.ezlynx.com/XMLSchema/Auto/V200">\n';

                xml += '  <Applicant>\n';
                xml += '    <ApplicantType>Applicant</ApplicantType>\n';
                xml += '    <PersonalInfo>\n';
                xml += '      <Name>\n';
                xml += `        <FirstName>${escapeXML(data.firstName)}</FirstName>\n`;
                xml += '        <MiddleName></MiddleName>\n';
                xml += `        <LastName>${escapeXML(data.lastName)}</LastName>\n`;
                xml += '      </Name>\n';
                xml += `      <DOB>${dob}</DOB>\n`;
                if (data.maritalStatus) {
                    xml += `      <MaritalStatus>${escapeXML(data.maritalStatus)}</MaritalStatus>\n`;
                }
                xml += '      <Relation>Insured</Relation>\n';
                xml += '    </PersonalInfo>\n';
                xml += '    <Address>\n';
                xml += '      <AddressCode>StreetAddress</AddressCode>\n';
                xml += '      <Addr1>\n';
                xml += `        <StreetName>${escapeXML(streetName)}</StreetName>\n`;
                xml += `        <StreetNumber>${escapeXML(streetNumber)}</StreetNumber>\n`;
                xml += '      </Addr1>\n';
                xml += `      <City>${escapeXML(data.addrCity)}</City>\n`;
                xml += `      <StateCode>${escapeXML(state)}</StateCode>\n`;
                xml += `      <Zip5>${escapeXML(data.addrZip)}</Zip5>\n`;
                if (phone) {
                    xml += '      <Phone id="1">\n';
                    xml += '        <PhoneType>Mobile</PhoneType>\n';
                    xml += `        <PhoneNumber>${escapeXML(phone)}</PhoneNumber>\n`;
                    xml += '        <Extension></Extension>\n';
                    xml += '      </Phone>\n';
                }
                if (data.email) {
                    xml += `      <Email>${escapeXML(data.email)}</Email>\n`;
                }
                xml += '    </Address>\n';
                xml += '  </Applicant>\n';

                if (data.priorCarrier || data.priorYears || data.priorExp) {
                    xml += '  <PriorPolicyInfo>\n';
                    if (data.priorCarrier) {
                        xml += `    <PriorCarrier>${escapeXML(data.priorCarrier)}</PriorCarrier>\n`;
                    }
                    if (data.priorExp) {
                        xml += `    <Expiration>${normalizeDate(data.priorExp)}</Expiration>\n`;
                    }
                    if (data.priorYears) {
                        xml += '    <YearsWithPriorCarrier>\n';
                        xml += `      <Years>${escapeXML(data.priorYears)}</Years>\n`;
                        xml += '    </YearsWithPriorCarrier>\n';
                    }
                    xml += '  </PriorPolicyInfo>\n';
                }

                xml += '  <Drivers>\n';
                xml += '    <Driver id="1">\n';
                xml += '      <Name>\n';
                xml += `        <FirstName>${escapeXML(data.firstName)}</FirstName>\n`;
                xml += `        <LastName>${escapeXML(data.lastName)}</LastName>\n`;
                xml += '      </Name>\n';
                xml += `      <DOB>${dob}</DOB>\n`;
                if (data.dlNum) {
                    xml += `      <DLNumber>${escapeXML(data.dlNum)}</DLNumber>\n`;
                }
                if (data.dlState) {
                    xml += `      <DLState>${escapeXML(data.dlState)}</DLState>\n`;
                }
                if (data.maritalStatus) {
                    xml += `      <MaritalStatus>${escapeXML(data.maritalStatus)}</MaritalStatus>\n`;
                }
                xml += '      <Relation>Insured</Relation>\n';
                xml += '      <GoodStudent>No</GoodStudent>\n';
                xml += '      <MATDriver>No</MATDriver>\n';
                xml += '      <Rated>Rated</Rated>\n';
                xml += '    </Driver>\n';
                xml += '  </Drivers>\n';

                if (data.vin || data.vehDesc) {
                    xml += '  <Vehicles>\n';
                    xml += '    <Vehicle id="1">\n';
                    xml += '      <UseVinLookup>Yes</UseVinLookup>\n';
                    if (year) {
                        xml += `      <Year>${escapeXML(year)}</Year>\n`;
                    }
                    if (data.vin) {
                        xml += `      <Vin>${escapeXML(data.vin)}</Vin>\n`;
                    }
                    if (make) {
                        xml += `      <Make>${escapeXML(make)}</Make>\n`;
                    }
                    if (model) {
                        xml += `      <Model>${escapeXML(model)}</Model>\n`;
                    }
                    xml += '      <Anti-Theft>None</Anti-Theft>\n';
                    xml += '      <PassiveRestraints>None</PassiveRestraints>\n';
                    xml += '    </Vehicle>\n';
                    xml += '  </Vehicles>\n';

                    if (data.miles) {
                        xml += '  <VehiclesUse>\n';
                        xml += '    <VehicleUse id="1">\n';
                        xml += `      <AnnualMiles>${escapeXML(data.miles)}</AnnualMiles>\n`;
                        xml += '    </VehicleUse>\n';
                        xml += '  </VehiclesUse>\n';
                    }
                }

                if (data.liabilityLimits || data.autoDeductible) {
                    xml += '  <Coverages>\n';
                    if (data.liabilityLimits) {
                        xml += '    <GeneralCoverage>\n';
                        xml += `      <BI>${escapeXML(data.liabilityLimits)}</BI>\n`;
                        xml += '    </GeneralCoverage>\n';
                    }
                    if (data.autoDeductible) {
                        xml += '    <VehicleCoverage id="1">\n';
                        xml += `      <CollisionDeductible>${escapeXML(data.autoDeductible)}</CollisionDeductible>\n`;
                        xml += '    </VehicleCoverage>\n';
                    }
                    xml += '  </Coverages>\n';
                }

                xml += '</EZAUTO>\n';

                return {
                    ok: true,
                    content: xml,
                    filename: `${data.lastName || 'Lead'}_EZLynx.xml`,
                    mime: 'application/xml;charset=utf-8'
                };
            },

            toast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2500);
            },

            downloadFile(content, filename, mime) {
                const blob = new Blob([content], { type: mime });
                this.downloadBlob(blob, filename);
            },

            downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            },

            async getQuotes() {
                const encrypted = localStorage.getItem(this.quotesKey);
                if (!encrypted) return [];
                
                if (this.encryptionEnabled) {
                    const decrypted = await CryptoHelper.decrypt(encrypted);
                    return decrypted || [];
                } else {
                    return JSON.parse(encrypted);
                }
            },

            async saveQuotes(quotes) {
                if (this.encryptionEnabled) {
                    const encrypted = await CryptoHelper.encrypt(quotes);
                    localStorage.setItem(this.quotesKey, encrypted);
                } else {
                    localStorage.setItem(this.quotesKey, JSON.stringify(quotes));
                }
            },

            getQuoteTitle(data) {
                const lastName = data.lastName?.trim();
                const firstName = data.firstName?.trim();
                const name = lastName ? `${lastName}, ${firstName || ''}`.trim() : (firstName || `Draft - ${new Date().toLocaleDateString()}`);
                const type = (data.qType || 'quote').toUpperCase();
                return `${name} ‚Ä¢ ${type}`;
            },

            getQuoteMeta(quote) {
                const updated = new Date(quote.updatedAt).toLocaleString();
                return `Updated ${updated}`;
            },

            async autoSaveCurrentQuote() {
                const snapshot = JSON.parse(JSON.stringify(this.data || {}));
                const quotes = await this.getQuotes();
                const autoId = 'current_draft';
                
                // Remove any existing auto-saved draft
                const filtered = quotes.filter(q => q.id !== autoId);
                
                // Add current data as auto-selected draft at top
                const baseTitle = this.getQuoteTitle(snapshot);
                const title = `${baseTitle} (Current Draft)`;
                filtered.unshift({ id: autoId, title, data: snapshot, updatedAt: new Date().toISOString() });
                await this.saveQuotes(filtered);
                this.selectedQuoteIds.add(autoId);
                await this.renderQuoteList();
                
                // Auto-select the current draft
                setTimeout(() => {
                    const checkbox = document.querySelector(`.quote-checkbox[data-id="${autoId}"]`);
                    if (checkbox) checkbox.checked = true;
                }, 50);
            },

            async saveQuote() {
                const snapshot = JSON.parse(JSON.stringify(this.data || {}));
                const quotes = await this.getQuotes();
                
                // Check for duplicates based on address
                const address = `${snapshot.addrStreet || ''} ${snapshot.addrCity || ''} ${snapshot.addrState || ''}`.trim().toLowerCase();
                const duplicates = quotes.filter(q => {
                    const qAddr = `${q.data.addrStreet || ''} ${q.data.addrCity || ''} ${q.data.addrState || ''}`.trim().toLowerCase();
                    return qAddr && address && qAddr === address;
                });
                
                // Show duplicate warning modal if found
                if (duplicates.length > 0) {
                    const confirmed = await this.showDuplicateWarning(duplicates);
                    if (!confirmed) return; // User canceled
                }
                
                const id = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
                const title = this.getQuoteTitle(snapshot);
                quotes.unshift({ 
                    id, 
                    title, 
                    data: snapshot, 
                    updatedAt: new Date().toISOString(),
                    starred: false,
                    isDuplicate: duplicates.length > 0
                });
                await this.saveQuotes(quotes);
                await this.renderQuoteList();
                this.toast('‚úÖ Draft saved to library');
            },

            async loadQuote(id) {
                const quotes = await this.getQuotes();
                const quote = quotes.find(q => q.id === id);
                if (!quote) return;
                this.applyData(quote.data);
                
                // Save loaded data with encryption
                if (this.encryptionEnabled) {
                    const encrypted = await CryptoHelper.encrypt(this.data);
                    localStorage.setItem(this.storageKey, encrypted);
                } else {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                }
                this.toast('‚úÖ Draft loaded');
            },

            async deleteQuote(id) {
                const quotes = await this.getQuotes();
                const filtered = quotes.filter(q => q.id !== id);
                await this.saveQuotes(filtered);
                this.selectedQuoteIds.delete(id);
                await this.renderQuoteList();
                this.toast('üóëÔ∏è Draft removed');
            },

            async renameQuote(id) {
                const quotes = await this.getQuotes();
                const quote = quotes.find(q => q.id === id);
                if (!quote) return;
                const next = prompt('Rename draft', quote.title);
                if (next === null) return;
                quote.title = next.trim() || quote.title;
                quote.updatedAt = new Date().toISOString();
                await this.saveQuotes(quotes);
                await this.renderQuoteList();
            },

            startNewDraft() {
                if (!confirm('Start a new draft? Current form will be cleared.')) return;
                localStorage.removeItem(this.storageKey);
                location.reload();
            },

            clearAllDrafts() {
                if (!confirm('Clear all saved drafts?')) return;
                localStorage.removeItem(this.quotesKey);
                this.selectedQuoteIds.clear();
                this.renderQuoteList();
                this.toast('üßπ Drafts cleared');
            },

            async renderQuoteList() {
                const list = document.getElementById('quoteList');
                if (!list) return;
                list.innerHTML = '';
                const quotes = await this.getQuotes();
                if (!quotes.length) {
                    const empty = document.createElement('div');
                    empty.className = 'hint';
                    empty.textContent = 'No drafts saved yet. Click ‚ÄúSave Draft‚Äù to create one.';
                    list.appendChild(empty);
                    return;
                }
                quotes.forEach(q => {
                    const row = document.createElement('div');
                    row.className = 'quote-card';
                    row.setAttribute('data-quote-id', q.id);
                    const addr = `${q.data.addrStreet || ''} ${q.data.addrCity || ''} ${q.data.addrState || ''}`.trim();
                    row.setAttribute('data-search-text', `${q.title} ${addr} ${this.getQuoteMeta(q)}`);

                    // Header with name and star
                    const header = document.createElement('div');
                    header.className = 'quote-card-header';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'quote-checkbox';
                    checkbox.dataset.id = q.id;
                    checkbox.checked = this.selectedQuoteIds.has(q.id);
                    checkbox.onchange = () => {
                        if (checkbox.checked) {
                            this.selectedQuoteIds.add(q.id);
                        } else {
                            this.selectedQuoteIds.delete(q.id);
                        }
                    };
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'quote-name';
                    nameSpan.textContent = q.title;
                    
                    const starBtn = document.createElement('button');
                    starBtn.className = 'quote-star';
                    starBtn.textContent = q.starred ? '‚≠ê' : '‚òÜ';
                    starBtn.title = q.starred ? 'Remove from favorites' : 'Add to favorites';
                    starBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.toggleQuoteStar(q.id);
                    };
                    
                    if (q.starred) row.classList.add('starred');
                    
                    header.appendChild(nameSpan);
                    header.appendChild(starBtn);
                    header.prepend(checkbox);

                    // Stats
                    const stats = document.createElement('div');
                    stats.className = 'quote-stats';
                    const statsText = this.getQuoteStats(q);
                    stats.innerHTML = statsText;

                    // Actions
                    const actions = document.createElement('div');
                    actions.className = 'quote-actions';

                    const loadBtn = document.createElement('button');
                    loadBtn.className = 'quote-action-btn';
                    loadBtn.textContent = 'üì• Load';
                    loadBtn.onclick = () => this.loadQuote(q.id);

                    const dupBtn = document.createElement('button');
                    dupBtn.className = 'quote-action-btn';
                    dupBtn.textContent = 'üìã Copy';
                    dupBtn.onclick = () => this.duplicateQuote(q.id);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'quote-action-btn delete';
                    deleteBtn.textContent = 'üóëÔ∏è Delete';
                    deleteBtn.onclick = () => this.deleteQuote(q.id);

                    actions.appendChild(loadBtn);
                    actions.appendChild(dupBtn);
                    actions.appendChild(deleteBtn);

                    row.appendChild(header);
                    row.appendChild(stats);
                    row.appendChild(actions);
                    list.appendChild(row);
                });
            },

            filterQuotes(searchTerm) {
                const term = (searchTerm || '').toLowerCase();
                const cards = document.querySelectorAll('[data-quote-id]');
                cards.forEach(card => {
                    const text = (card.getAttribute('data-search-text') || '').toLowerCase();
                    card.style.display = text.includes(term) ? '' : 'none';
                });
            },

            selectAllQuotes() {
                this.getQuotes().then(quotes => {
                    this.selectedQuoteIds = new Set(quotes.map(q => q.id));
                    this.renderQuoteList();
                    this.toast('‚úÖ All drafts selected');
                });
            },

            clearQuoteSelection() {
                this.selectedQuoteIds.clear();
                this.renderQuoteList();
                this.toast('‚úñ Selection cleared');
            },
            
            async toggleQuoteStar(quoteId) {
                const quotes = await this.getQuotes();
                const quote = quotes.find(q => q.id === quoteId);
                if (!quote) return;
                quote.starred = !quote.starred;
                quote.updatedAt = new Date().toISOString();
                await this.saveQuotes(quotes);
                await this.renderQuoteList();
                this.toast(quote.starred ? '‚≠ê Added to favorites' : '‚òÜ Removed from favorites');
            },
            
            showDuplicateWarning(duplicates) {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay';
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            modal.remove();
                            resolve(false);
                        }
                    };
                    
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <span class="modal-icon">‚ö†Ô∏è</span>
                                <h2 class="modal-title">Possible Duplicate</h2>
                            </div>
                            <div class="modal-body">
                                <p>We found ${duplicates.length} similar quote(s) for this address:</p>
                                <ul style="margin: 12px 0; padding-left: 20px;">
                                    ${duplicates.map(d => `<li><strong>${d.title}</strong> - ${new Date(d.updatedAt).toLocaleDateString()}</li>`).join('')}
                                </ul>
                                <p>Do you want to save this as a new quote anyway?</p>
                            </div>
                            <div class="modal-actions">
                                <button class="modal-btn modal-btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                                <button class="modal-btn modal-btn-primary" onclick="this.closest('.modal-overlay').setAttribute('data-confirmed', 'true'); this.closest('.modal-overlay').remove();">Save Anyway</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    modal.addEventListener('remove', () => {
                        resolve(modal.getAttribute('data-confirmed') === 'true');
                    });
                });
            },
            
            duplicateQuote(quoteId) {
                const quote = this.getQuotes().find(q => q.id === quoteId);
                if (!quote) return;
                
                // Check for duplicate addresses
                const copiedAddr = `${quote.data.addrStreet || ''} ${quote.data.addrCity || ''}`.trim();
                const hasDuplicate = this.getQuotes().some(q => q.id !== quoteId && 
                    `${q.data.addrStreet || ''} ${q.data.addrCity || ''}`.trim() === copiedAddr && 
                    copiedAddr);
                
                if (hasDuplicate && !confirm('‚ö†Ô∏è A quote with this address already exists. Continue copying?')) {
                    return;
                }
                
                // Copy property data, clear personal info
                const newData = JSON.parse(JSON.stringify(quote.data));
                newData.firstName = '';
                newData.lastName = '';
                newData.email = '';
                newData.phone = '';
                newData.dob = '';
                
                this.data = newData;
                this.save();
                this.updateUI();
                this.renderQuoteList();
                this.toast('üìã Draft copied! (personal info cleared)');
            },
            
            getQuoteStats(q) {
                const d = q.data || {};
                    const badges = [];
                
                    // Coverage type badge
                    if (d.qType) {
                        const typeClass = d.qType === 'home' ? 'badge-home' : (d.qType === 'auto' ? 'badge-auto' : 'badge-both');
                        badges.push(`<span class="quote-badge ${typeClass}">${d.qType.toUpperCase()}</span>`);
                    }
                
                    // Duplicate indicator
                    if (q.isDuplicate) {
                        badges.push(`<span class="quote-badge badge-duplicate">‚ö†Ô∏è DUPLICATE</span>`);
                    }
                
                    // Multi-driver/vehicle badges
                    if (d.drivers && d.drivers.length > 0) {
                        badges.push(`<span class="quote-badge" style="background: rgba(142, 142, 147, 0.12); color: #636366;">üë§ ${d.drivers.length} driver${d.drivers.length > 1 ? 's' : ''}</span>`);
                    }
                    if (d.vehicles && d.vehicles.length > 0) {
                        badges.push(`<span class="quote-badge" style="background: rgba(142, 142, 147, 0.12); color: #636366;">üöó ${d.vehicles.length} vehicle${d.vehicles.length > 1 ? 's' : ''}</span>`);
                    }
                
                    // Property/location info
                    const details = [];
                    if (d.addrCity && d.addrState) details.push(`üìç ${d.addrCity}, ${d.addrState}`);
                    if (d.yrBuilt) details.push(`üè† ${d.yrBuilt}`);
                
                const updatedTime = new Date(q.updatedAt || q.timestamp).toLocaleDateString();
                    details.push(`üïê ${updatedTime}`);
                
                    return badges.join('') + '<br><span style="font-size: 12px; color: var(--text-secondary);">' + details.join(' ‚Ä¢ ') + '</span>';
            },

            getSelectedQuoteIds() {
                if (this.selectedQuoteIds && this.selectedQuoteIds.size) {
                    return Array.from(this.selectedQuoteIds);
                }
                return Array.from(document.querySelectorAll('.quote-checkbox:checked'))
                    .map(cb => cb.dataset.id);
            },

            sanitizeFilename(name) {
                return name.replace(/[^a-z0-9\-_. ]/gi, '').replace(/\s+/g, '_').slice(0, 80) || 'quote';
            },

            async exportSelectedZip() {
                if (!window.JSZip) {
                    this.toast('‚ö†Ô∏è ZIP export unavailable.');
                    return;
                }
                const ids = this.getSelectedQuoteIds();
                if (!ids.length) {
                    this.toast('‚ö†Ô∏è Select drafts to export.');
                    return;
                }
                const quotes = (await this.getQuotes()).filter(q => ids.includes(q.id));
                const zip = new JSZip();
                const errors = [];

                for (const q of quotes) {
                    const folderName = this.sanitizeFilename(q.title);
                    const folder = zip.folder(folderName);

                    const xml = this.buildXML(q.data);
                    if (xml.ok) {
                        folder.file(xml.filename, xml.content);
                    } else {
                        errors.push(`${q.title}: ${xml.error.replace('‚ö†Ô∏è ', '')}`);
                    }

                    const cmsmtf = this.buildCMSMTF(q.data);
                    folder.file(cmsmtf.filename, cmsmtf.content);

                    const csv = this.buildCSV(q.data);
                    folder.file(csv.filename, csv.content);

                    const pdf = await this.buildPDF(q.data);
                    folder.file(pdf.filename, pdf.blob);
                }

                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const zipName = `Altech_Quotes_${new Date().toISOString().split('T')[0]}.zip`;
                this.downloadBlob(zipBlob, zipName);

                if (errors.length) {
                    this.toast('‚ö†Ô∏è Some XML exports were skipped.');
                    console.warn('ZIP export warnings:', errors);
                } else {
                    this.toast('üì¶ ZIP downloaded');
                }
            },

            async exportAllZip() {
                const quotes = await this.getQuotes();
                if (!quotes.length) {
                    this.toast('‚ö†Ô∏è No drafts to export.');
                    return;
                }
                this.selectedQuoteIds = new Set(quotes.map(q => q.id));
                await this.renderQuoteList();
                await this.exportSelectedZip();
            },
            
            reset() {
                if(confirm("Delete all data and start over?")) {
                    localStorage.removeItem(this.storageKey);
                    location.reload();
                }
            },

            blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1]; // Remove data:application/zip;base64, prefix
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }
        };
        window.initPlaces = () => App.initPlaces();

        window.onload = () => App.init();
    </script>
</body>
</html>