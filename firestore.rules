rules_version = '2';

// ── Altech Multi-Tenant Firestore Security Rules ──────────────────────────
//
// Data model:
//   users/{uid}/sync/{docType}   — per-user sync documents
//   users/{uid}/quotes/{quoteId} — per-user quote drafts
//
// Principle: authenticated users can only read/write their own data.
// No cross-tenant data access is possible regardless of client-side code.
//
// Deploy:  firebase deploy --only firestore:rules
// Test:    firebase emulators:start --only firestore
// ──────────────────────────────────────────────────────────────────────────

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ────────────────────────────────────────────────

    // User must be authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Requesting user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Ensure incoming writes contain only allowed fields (no field injection)
    function hasOnlyAllowedFields(allowedFields) {
      return request.resource.data.keys().hasOnly(allowedFields);
    }

    // Reject writes that are suspiciously large (> 1 MB encoded JSON)
    function isReasonableSize() {
      return request.resource.data.size() < 1048576;
    }

    // Check if the user has an active Pro subscription
    // Usage: isPaidSubscriber(request.auth.uid) in premium-gated rules
    function isPaidSubscriber(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)/sync/subscription)
        && get(/databases/$(database)/documents/users/$(userId)/sync/subscription).data.active == true
        && get(/databases/$(database)/documents/users/$(userId)/sync/subscription).data.plan == 'pro';
    }

    // ── User data ────────────────────────────────────────────────────────

    // All documents under users/{uid}/** are strictly per-tenant
    match /users/{userId} {
      // Users can read/write their own profile doc (email, displayName, isAdmin, isBlocked, etc.)
      // isAdmin and isBlocked are server-managed — block client writes to those fields
      allow read: if isOwner(userId);
      allow create: if isOwner(userId)
        && isReasonableSize()
        && !('isAdmin' in request.resource.data)
        && !('isBlocked' in request.resource.data);
      allow update: if isOwner(userId)
        && isReasonableSize()
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'isBlocked']);

      // Admins can read any user profile (for the admin panel user list)
      allow read: if isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;

      // Admins can update any user's isAdmin/isBlocked fields
      allow update: if isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isAdmin', 'isBlocked']);
    }

    // Sync documents: settings, currentForm, cglState, clientHistory, etc.
    match /users/{userId}/sync/{docType} {
      // Subscription doc is server-managed (Stripe webhook) — read-only for owner
      allow read:  if isOwner(userId);
      allow write: if isOwner(userId) && isReasonableSize() && docType != 'subscription';

      // Deny deletion of system docs by accident — only explicit action allowed
      allow delete: if isOwner(userId) && docType != 'subscription';
    }

    // Quote drafts
    match /users/{userId}/quotes/{quoteId} {
      allow read:   if isOwner(userId);
      allow create: if isOwner(userId) && isReasonableSize();
      allow update: if isOwner(userId) && isReasonableSize();
      allow delete: if isOwner(userId);
    }

    // ── Catch-all: deny everything not explicitly allowed ────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
