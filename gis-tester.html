<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS Auto-Fill Tester</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .controls { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #d0d0d0; }
        .progress { background: #e0e0e0; height: 8px; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; }
        .stat-value { font-size: 32px; font-weight: 700; }
        .stat-label { opacity: 0.9; font-size: 14px; margin-top: 4px; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .results-table th { background: #f5f5f5; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; }
        .results-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .results-table tr:hover { background: #f9f9f9; }
        .status-icon { font-size: 18px; }
        .loading { color: #667eea; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .pending { color: #999; }
        .log { background: #1e1e1e; color: #50fa7b; padding: 16px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 300px; overflow-y: auto; margin-top: 20px; }
        .log-entry { margin: 4px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç GIS Auto-Fill Tester</h1>
        <p class="subtitle">Test hybrid GIS system with 30 real addresses across WA, OR, AZ</p>

        <div class="controls">
            <button class="btn-primary" onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
            <button class="btn-secondary" onclick="runStateTests('WA')">Test Washington (10)</button>
            <button class="btn-secondary" onclick="runStateTests('OR')">Test Oregon (10)</button>
            <button class="btn-secondary" onclick="runStateTests('AZ')">Test Arizona (10)</button>
            <button class="btn-secondary" onclick="exportResults()">üíæ Export Results</button>
            <button class="btn-secondary" onclick="clearResults()">üîÑ Clear</button>
        </div>

        <div class="progress" id="progress" style="display:none;">
            <div class="progress-bar" id="progressBar" style="width:0%"></div>
        </div>

        <div class="stats" style="display:none;" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalTested">0</div>
                <div class="stat-label">Addresses Tested</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successCount">0</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgTime">0s</div>
                <div class="stat-label">Avg Response Time</div>
            </div>
        </div>

        <table class="results-table" id="resultsTable">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Address</th>
                    <th>County</th>
                    <th>Source</th>
                    <th>Parcel ID</th>
                    <th>Year</th>
                    <th>Sqft</th>
                    <th>Beds</th>
                    <th>Baths</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                <tr>
                    <td colspan="10" style="text-align:center; padding:40px; color:#999;">
                        Click "Run All Tests" to start testing
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="log" id="log" style="display:none;"></div>
    </div>

    <script>
        const testAddresses = [
            { state: 'WA', address: '2202 NE 154th Ave', city: 'Vancouver', zip: '98684', county: 'Clark' },
            { state: 'WA', address: '529 W 25th St', city: 'Vancouver', zip: '98660', county: 'Clark' },
            { state: 'WA', address: '11115 NW 26th Ave', city: 'Vancouver', zip: '98685', county: 'Clark' },
            { state: 'WA', address: '311 NW 110th St', city: 'Vancouver', zip: '98685', county: 'Clark' },
            { state: 'WA', address: '16710 NE 96th St', city: 'Vancouver', zip: '98682', county: 'Clark' },
            { state: 'WA', address: '2901 SE Balboa Dr', city: 'Vancouver', zip: '98683', county: 'Clark' },
            { state: 'WA', address: '10125 NE 45th Ct', city: 'Vancouver', zip: '98686', county: 'Clark' },
            { state: 'WA', address: '4209 NE 90th St', city: 'Vancouver', zip: '98665', county: 'Clark' },
            { state: 'WA', address: '10511 NE 99th Ave', city: 'Vancouver', zip: '98662', county: 'Clark' },
            { state: 'WA', address: '12705 NE 49th Way', city: 'Vancouver', zip: '98682', county: 'Clark' },
            { state: 'OR', address: '4015 N Albina Ave', city: 'Portland', zip: '97227', county: 'Multnomah' },
            { state: 'OR', address: '4015 N Colonial Ave', city: 'Portland', zip: '97227', county: 'Multnomah' },
            { state: 'OR', address: '4015 N Concord Ave', city: 'Portland', zip: '97227', county: 'Multnomah' },
            { state: 'OR', address: '4015 N Haight Ave', city: 'Portland', zip: '97227', county: 'Multnomah' },
            { state: 'OR', address: '4015 N Overlook Blvd', city: 'Portland', zip: '97227', county: 'Multnomah' },
            { state: 'OR', address: '4015 N Williams Ave', city: 'Portland', zip: '97227', county: 'Multnomah' },
            { state: 'OR', address: '4015 NE 125th Pl', city: 'Portland', zip: '97230', county: 'Multnomah' },
            { state: 'OR', address: '4015 NE 130th Pl', city: 'Portland', zip: '97230', county: 'Multnomah' },
            { state: 'OR', address: '4015 NE 138th Ave', city: 'Portland', zip: '97230', county: 'Multnomah' },
            { state: 'OR', address: '4015 NE 62nd Ave', city: 'Portland', zip: '97213', county: 'Multnomah' },
            { state: 'AZ', address: '3916 E Eugie Ave', city: 'Phoenix', zip: '85032', county: 'Maricopa' },
            { state: 'AZ', address: '2217 E Sheridan St', city: 'Phoenix', zip: '85006', county: 'Maricopa' },
            { state: 'AZ', address: '2511 E Earll Dr', city: 'Phoenix', zip: '85016', county: 'Maricopa' },
            { state: 'AZ', address: '225 W Alice Ave', city: 'Phoenix', zip: '85021', county: 'Maricopa' },
            { state: 'AZ', address: '2217 W Wayland Rd', city: 'Phoenix', zip: '85041', county: 'Maricopa' },
            { state: 'AZ', address: '640 E Boca Raton Rd', city: 'Phoenix', zip: '85022', county: 'Maricopa' },
            { state: 'AZ', address: '3318 W Fraktur Rd', city: 'Phoenix', zip: '85041', county: 'Maricopa' },
            { state: 'AZ', address: '26121 N 19th Ln', city: 'Phoenix', zip: '85085', county: 'Maricopa' },
            { state: 'AZ', address: '23004 N 38th Pl', city: 'Phoenix', zip: '85050', county: 'Maricopa' },
            { state: 'AZ', address: '2818 W Minton St', city: 'Phoenix', zip: '85041', county: 'Maricopa' }
        ];

        let results = [];
        let testing = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#50fa7b' : type === 'error' ? '#ff5555' : '#8be9fd';
            logDiv.innerHTML += `<div class="log-entry" style="color:${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testAddress(addr, index, total) {
            const startTime = Date.now();
            const fullAddress = `${addr.address}, ${addr.city}, ${addr.state} ${addr.zip}`;

            log(`Testing ${index + 1}/${total}: ${fullAddress}`);
            updateProgress((index / total) * 100);

            try {
                const response = await fetch(`/api/arcgis-consumer?address=${encodeURIComponent(addr.address)}&city=${addr.city}&state=${addr.state}&county=${addr.county}`);
                const data = await response.json();
                const responseTime = ((Date.now() - startTime) / 1000).toFixed(2);

                const result = {
                    address: fullAddress,
                    county: addr.county,
                    state: addr.state,
                    success: data.success,
                    source: data.source || 'Individual County API',
                    parcelId: data.parcelData?.parcelId || 'N/A',
                    yearBuilt: data.parcelData?.yearBuilt || 0,
                    totalSqft: data.parcelData?.totalSqft || 0,
                    bedrooms: data.parcelData?.bedrooms || 0,
                    bathrooms: data.parcelData?.bathrooms || 0,
                    responseTime: responseTime,
                    error: data.error || null
                };

                results.push(result);
                addResultRow(result);

                if (data.success) {
                    log(`‚úÖ Success: ${addr.county} County - ${result.parcelId}`, 'success');
                } else {
                    log(`‚ùå Failed: ${fullAddress} - ${data.error}`, 'error');
                }

                // Update stats
                updateStats();

                // Delay to respect rate limits
                await new Promise(resolve => setTimeout(resolve, 2000));

            } catch (error) {
                const result = {
                    address: fullAddress,
                    county: addr.county,
                    state: addr.state,
                    success: false,
                    error: error.message,
                    responseTime: ((Date.now() - startTime) / 1000).toFixed(2)
                };
                results.push(result);
                addResultRow(result);
                log(`‚ùå Error: ${fullAddress} - ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            if (testing) return;
            testing = true;
            results = [];
            clearResults();
            document.getElementById('stats').style.display = 'grid';
            document.getElementById('progress').style.display = 'block';
            log('üöÄ Starting GIS Auto-Fill Tests...', 'info');

            for (let i = 0; i < testAddresses.length; i++) {
                await testAddress(testAddresses[i], i, testAddresses.length);
            }

            updateProgress(100);
            testing = false;
            log(`\n‚úÖ Testing Complete! Success Rate: ${calculateSuccessRate()}%`, 'success');
        }

        async function runStateTests(state) {
            if (testing) return;
            testing = true;
            results = [];
            clearResults();
            document.getElementById('stats').style.display = 'grid';
            document.getElementById('progress').style.display = 'block';

            const stateAddresses = testAddresses.filter(addr => addr.state === state);
            log(`üöÄ Testing ${stateAddresses.length} addresses in ${state}...`, 'info');

            for (let i = 0; i < stateAddresses.length; i++) {
                await testAddress(stateAddresses[i], i, stateAddresses.length);
            }

            updateProgress(100);
            testing = false;
            log(`\n‚úÖ ${state} Testing Complete!`, 'success');
        }

        function addResultRow(result) {
            const tbody = document.getElementById('resultsBody');
            if (results.length === 1) {
                tbody.innerHTML = ''; // Clear placeholder
            }

            const statusIcon = result.success ? '<span class="status-icon success">‚úÖ</span>' : '<span class="status-icon error">‚ùå</span>';
            const sourceDisplay = result.source?.includes('Aggregator') ? 'üåê State' : 'üìç County';

            const row = `
                <tr>
                    <td>${statusIcon}</td>
                    <td>${result.address}</td>
                    <td>${result.county}</td>
                    <td>${sourceDisplay}</td>
                    <td>${result.parcelId || 'N/A'}</td>
                    <td>${result.yearBuilt || '-'}</td>
                    <td>${result.totalSqft || '-'}</td>
                    <td>${result.bedrooms || '-'}</td>
                    <td>${result.bathrooms || '-'}</td>
                    <td>${result.responseTime}s</td>
                </tr>
            `;
            tbody.innerHTML += row;
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = `${percent}%`;
        }

        function updateStats() {
            const successCount = results.filter(r => r.success).length;
            const successRate = results.length > 0 ? ((successCount / results.length) * 100).toFixed(1) : 0;
            const avgTime = results.length > 0 ? (results.reduce((sum, r) => sum + parseFloat(r.responseTime || 0), 0) / results.length).toFixed(2) : 0;

            document.getElementById('totalTested').textContent = results.length;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('successRate').textContent = `${successRate}%`;
            document.getElementById('avgTime').textContent = `${avgTime}s`;
        }

        function calculateSuccessRate() {
            if (results.length === 0) return 0;
            const successCount = results.filter(r => r.success).length;
            return ((successCount / results.length) * 100).toFixed(1);
        }

        function clearResults() {
            results = [];
            document.getElementById('resultsBody').innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px; color:#999;">Click "Run All Tests" to start testing</td></tr>';
            document.getElementById('log').innerHTML = '';
            document.getElementById('log').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('progress').style.display = 'none';
            updateProgress(0);
        }

        function exportResults() {
            if (results.length === 0) {
                alert('No results to export. Run tests first.');
                return;
            }

            const dataStr = JSON.stringify(results, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gis-test-results-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            log('üì• Results exported to JSON', 'success');
        }
    </script>
</body>
</html>
